// ═══════════════════════════════════════════════════════════════
// game/controller.ts
// 游戏总控 - 资源管理器、实体管理器、游戏总控中心
// ═══════════════════════════════════════════════════════════════

import {
    冠军实体,
    可袭击地点实体,
    喽啰池,
    实体基类,
    母畜实体,
    领主实体,
} from '../core/entities';

import { 工厂管理器 } from '../core/factories';
import { 系统管理器, 游戏总控接口 } from '../core/managers';
import { 战斗管理器, 喽啰池管理接口 } from '../core/combat';

// ═══════════════════════════════════════════════════════════════
// 类型定义
// ═══════════════════════════════════════════════════════════════

type 武装等级 = '未武装' | '低级武装' | '中级武装' | '高级武装' | '精英武装';

interface 资源状态 {
    士气: number;
    最大士气: number;
    催淫母乳: number;
}

interface 实体统计 {
    领主数量: number;
    冠军数量: number;
    母畜数量: number;
    地点数量: number;
    喽啰池数量: number;
    喽啰总数: number;
}

// ═══════════════════════════════════════════════════════════════
// 资源管理器
// ═══════════════════════════════════════════════════════════════

class 资源管理器 {
    private 士气: number;
    private 最大士气: number;
    private 催淫母乳: number;

    constructor(初始配置: Partial<资源状态> = {}) {
        this.士气 = 初始配置.士气 ?? 50;
        this.最大士气 = 初始配置.最大士气 ?? 100;
        this.催淫母乳 = 初始配置.催淫母乳 ?? 0;
    }

    // ─── 士气操作 ───

    获取士气(): number {
        return this.士气;
    }

    获取最大士气(): number {
        return this.最大士气;
    }

    修改士气(增量: number): number {
        this.士气 = Math.max(0, Math.min(this.最大士气, this.士气 + 增量));
        return this.士气;
    }

    设置士气(值: number): void {
        this.士气 = Math.max(0, Math.min(this.最大士气, 值));
    }

    设置最大士气(值: number): void {
        this.最大士气 = Math.max(0, 值);
        if (this.士气 > this.最大士气) {
            this.士气 = this.最大士气;
        }
    }

    获取士气百分比(): number {
        return this.最大士气 > 0 ? (this.士气 / this.最大士气) * 100 : 0;
    }

    // ─── 催淫母乳操作 ───

    获取催淫母乳数量(): number {
        return this.催淫母乳;
    }

    修改催淫母乳数量(增量: number): number {
        this.催淫母乳 = Math.max(0, this.催淫母乳 + 增量);
        return this.催淫母乳;
    }

    设置催淫母乳数量(值: number): void {
        this.催淫母乳 = Math.max(0, 值);
    }

    // ─── 状态查询 ───

    获取资源状态(): 资源状态 {
        return {
            士气: this.士气,
            最大士气: this.最大士气,
            催淫母乳: this.催淫母乳,
        };
    }

    // ─── 回合结算 ───

    回合结算(): void {
        const 衰减上限 = 10;
        const 理论衰减 = Math.floor(this.士气 / 8)
        const 衰减 = Math.min(理论衰减, 衰减上限);
        this.修改士气(-衰减);
    }
}

// ═══════════════════════════════════════════════════════════════
// 实体管理器
// ═══════════════════════════════════════════════════════════════

class 实体管理器 {
    private 领主实例: 领主实体 | null;
    private 冠军表: Map<string, 冠军实体>;
    private 母畜表: Map<string, 母畜实体>;
    private 地点表: Map<string, 可袭击地点实体>;
    private 喽啰池表: Map<string, 喽啰池>;
    private 无将领喽啰池: 喽啰池;

    constructor() {
        this.领主实例 = null;
        this.冠军表 = new Map();
        this.母畜表 = new Map();
        this.地点表 = new Map();
        this.喽啰池表 = new Map();
        this.无将领喽啰池 = new 喽啰池();
        this.初始化无将领喽啰池();
    }

    private 初始化无将领喽啰池(): void {
        // 注册所有武装等级
        this.无将领喽啰池.注册武装等级('低级武装', { 战斗力: 110, 描述: '初级武装的喽啰' });
        this.无将领喽啰池.注册武装等级('中级武装', { 战斗力: 120, 描述: '中级武装的喽啰' });
        this.无将领喽啰池.注册武装等级('高级武装', { 战斗力: 160, 描述: '高级武装的喽啰' });
        this.无将领喽啰池.注册武装等级('精英武装', { 战斗力: 300, 描述: '精英武装的喽啰' });
    }

    // ─── 领主管理 ───

    设置领主(领主: 领主实体): void {
        this.领主实例 = 领主;
    }

    获取领主(): 领主实体 | null {
        return this.领主实例;
    }

    // ─── 冠军管理 ───

    添加冠军(冠军: 冠军实体): void {
        this.冠军表.set(冠军.实体ID, 冠军);

        // 注册冠军的喽啰池
        const 喽啰池实例 = 冠军.获取喽啰池();
        if (喽啰池实例) {
            this.喽啰池表.set(喽啰池实例.实体ID, 喽啰池实例);
        }
    }

    移除冠军(冠军ID: string): boolean {
        const 冠军 = this.冠军表.get(冠军ID);
        if (!冠军) return false;

        // 移除关联的喽啰池
        const 喽啰池实例 = 冠军.获取喽啰池();
        if (喽啰池实例) {
            this.喽啰池表.delete(喽啰池实例.实体ID);
        }

        this.冠军表.delete(冠军ID);
        return true;
    }

    获取冠军(冠军ID: string): 冠军实体 | null {
        return this.冠军表.get(冠军ID) ?? null;
    }

    获取所有冠军(): 冠军实体[] {
        return Array.from(this.冠军表.values());
    }

    // ─── 母畜管理 ───

    添加母畜(母畜: 母畜实体): void {
        this.母畜表.set(母畜.实体ID, 母畜);
    }

    移除母畜(母畜ID: string): boolean {
        return this.母畜表.delete(母畜ID);
    }

    获取母畜(母畜ID: string): 母畜实体 | null {
        return this.母畜表.get(母畜ID) ?? null;
    }

    获取所有母畜(): 母畜实体[] {
        return Array.from(this.母畜表.values());
    }

    // ─── 地点管理 ───

    添加地点(地点: 可袭击地点实体): void {
        this.地点表.set(地点.实体ID, 地点);
    }

    移除地点(地点ID: string): boolean {
        return this.地点表.delete(地点ID);
    }

    获取地点(地点ID: string): 可袭击地点实体 | null {
        return this.地点表.get(地点ID) ?? null;
    }

    获取所有地点(): 可袭击地点实体[] {
        return Array.from(this.地点表.values());
    }

    // ─── 喽啰池管理 ───

    获取无将领喽啰池(): 喽啰池 {
        return this.无将领喽啰池;
    }

    获取所有将领喽啰池(): Map<string, 喽啰池> {
        const 将领池表 = new Map<string, 喽啰池>();
        for (const [id, 池] of this.喽啰池表) {
            if (池.获取将领() !== null) {
                将领池表.set(id, 池);
            }
        }
        return 将领池表;
    }

    获取喽啰总数(): number {
        let 总数 = this.无将领喽啰池.获取总数量();
        for (const 池 of this.喽啰池表.values()) {
            总数 += 池.获取总数量();
        }
        return 总数;
    }

    // ─── 通用实体查询 ───

    获取实体(实体ID: string): 实体基类 | null {
        // 检查领主
        if (this.领主实例?.实体ID === 实体ID) {
            return this.领主实例;
        }

        // 检查冠军
        if (this.冠军表.has(实体ID)) {
            return this.冠军表.get(实体ID)!;
        }

        // 检查母畜
        if (this.母畜表.has(实体ID)) {
            return this.母畜表.get(实体ID)!;
        }

        // 检查地点
        if (this.地点表.has(实体ID)) {
            return this.地点表.get(实体ID)!;
        }

        // 检查喽啰池
        if (this.喽啰池表.has(实体ID)) {
            return this.喽啰池表.get(实体ID)!;
        }

        if (this.无将领喽啰池.实体ID === 实体ID) {
            return this.无将领喽啰池;
        }

        return null;
    }

    // ─── 统计 ───

    获取实体统计(): 实体统计 {
        return {
            领主数量: this.领主实例 ? 1 : 0,
            冠军数量: this.冠军表.size,
            母畜数量: this.母畜表.size,
            地点数量: this.地点表.size,
            喽啰池数量: this.喽啰池表.size + 1, // +1 for 无将领池
            喽啰总数: this.获取喽啰总数(),
        };
    }
}

// ═══════════════════════════════════════════════════════════════
// 游戏总控
// ═══════════════════════════════════════════════════════════════

class 游戏总控 implements 游戏总控接口 {
    private 资源管理器实例: 资源管理器;
    private 实体管理器实例: 实体管理器;
    private 工厂管理器实例: 工厂管理器;
    private 系统管理器实例: 系统管理器;
    private 战斗管理器实例: 战斗管理器;

    // 接口实现对象
    readonly 地点管理: {
        获取地点: (地点ID: string) => 可袭击地点实体 | null;
    };

    readonly 母畜管理: {
        从劝诱获取母畜: (母畜: 母畜实体) => void;
        移除母畜: (母畜ID: string) => void;
    };

    readonly 冠军管理: {
        从生育获取冠军: (冠军: 冠军实体) => void;
    };

    readonly 喽啰池管理: {
        获取喽啰总数: () => number;
        获取无将领喽啰池: () => 喽啰池;
        武装升级: (数量: number, 武装等级: 武装等级) => boolean;
    };

    readonly 资源管理: {
        获取士气: () => number;
        修改士气: (增量: number) => number;
        获取催淫母乳数量: () => number;
        修改催淫母乳数量: (增量: number) => number;
    };

    readonly 实体管理: {
        获取实体: (实体ID: string) => 实体基类 | null;
    };

    constructor(配置: {
        工厂管理器: 工厂管理器;
        初始资源?: Partial<资源状态>;
    }) {
        this.资源管理器实例 = new 资源管理器(配置.初始资源);
        this.实体管理器实例 = new 实体管理器();
        this.工厂管理器实例 = 配置.工厂管理器;
        this.系统管理器实例 = new 系统管理器();

        // 初始化系统管理器
        this.系统管理器实例.初始化(this, this.工厂管理器实例);

        // 创建喽啰池管理接口适配器
        const 喽啰池管理适配器: 喽啰池管理接口 = {
            获取无将领喽啰池: () => this.实体管理器实例.获取无将领喽啰池(),
            获取所有将领喽啰池: () => this.实体管理器实例.获取所有将领喽啰池(),
        };

        // 创建战斗管理器
        this.战斗管理器实例 = new 战斗管理器({
            任务管理器: this.系统管理器实例.任务管理器,
            喽啰池管理: 喽啰池管理适配器,
            获取将领: (将领ID: string) => this.实体管理器实例.获取冠军(将领ID),
            获取地点: (地点ID: string) => this.实体管理器实例.获取地点(地点ID),
        });

        // ─── 绑定接口实现 ───

        this.地点管理 = {
            获取地点: (地点ID: string) => this.实体管理器实例.获取地点(地点ID),
        };

        this.母畜管理 = {
            从劝诱获取母畜: (母畜: 母畜实体) => {
                母畜.设置属性('来源', '劝诱获取');
                this.实体管理器实例.添加母畜(母畜);
            },
            移除母畜: (母畜ID: string) => {
                this.实体管理器实例.移除母畜(母畜ID);
            },
        };

        this.冠军管理 = {
            从生育获取冠军: (冠军: 冠军实体) => {
                this.实体管理器实例.添加冠军(冠军);
            },
        };

        this.喽啰池管理 = {
            获取喽啰总数: () => this.实体管理器实例.获取喽啰总数(),
            获取无将领喽啰池: () => this.实体管理器实例.获取无将领喽啰池(),
            武装升级: (数量: number, 目标等级: 武装等级) => {
                return this.执行武装升级(数量, 目标等级);
            },
        };

        this.资源管理 = {
            获取士气: () => this.资源管理器实例.获取士气(),
            修改士气: (增量: number) => this.资源管理器实例.修改士气(增量),
            获取催淫母乳数量: () => this.资源管理器实例.获取催淫母乳数量(),
            修改催淫母乳数量: (增量: number) => this.资源管理器实例.修改催淫母乳数量(增量),
        };

        this.实体管理 = {
            获取实体: (实体ID: string) => this.实体管理器实例.获取实体(实体ID),
        };
    }

    // ─── 武装升级逻辑 ───

    private 执行武装升级(数量: number, 目标等级: 武装等级): boolean {
        const 无将领池 = this.实体管理器实例.获取无将领喽啰池();

        // 武装等级优先级列表（从低到高）
        const 等级优先级: 武装等级[] = ['未武装', '低级武装', '中级武装', '高级武装', '精英武装'];
        const 目标索引 = 等级优先级.indexOf(目标等级);

        if (目标索引 <= 0) {
            return false; // 无法升级到未武装或无效等级
        }

        let 剩余需求 = 数量;

        // 从低等级开始寻找可升级的喽啰
        for (let i = 0; i < 目标索引 && 剩余需求 > 0; i++) {
            const 来源等级 = 等级优先级[i];
            const 来源数量 = 无将领池.获取分组数量(来源等级);

            if (来源数量 <= 0) continue;

            const 可升级数量 = Math.min(来源数量, 剩余需求);

            // 执行升级
            无将领池.减少喽啰(可升级数量, 来源等级);
            无将领池.增加喽啰(可升级数量, 目标等级);

            剩余需求 -= 可升级数量;
        }

        return 剩余需求 < 数量; // 至少升级了一些
    }

    // ─── 领主管理 ───

    获取领主(): 领主实体 {
        const 领主 = this.实体管理器实例.获取领主();
        if (!领主) {
            throw new Error('领主未初始化');
        }
        return 领主;
    }

    设置领主(领主: 领主实体): void {
        this.实体管理器实例.设置领主(领主);
    }

    // ─── 系统访问器 ───

    获取资源管理器(): 资源管理器 {
        return this.资源管理器实例;
    }

    获取实体管理器(): 实体管理器 {
        return this.实体管理器实例;
    }

    获取工厂管理器(): 工厂管理器 {
        return this.工厂管理器实例;
    }

    获取系统管理器(): 系统管理器 {
        return this.系统管理器实例;
    }

    获取战斗管理器(): 战斗管理器 {
        return this.战斗管理器实例;
    }

    // ─── 便捷方法 ───

    获取任务管理器() {
        return this.系统管理器实例.任务管理器;
    }

    获取法术管理器() {
        return this.系统管理器实例.法术管理器;
    }

    获取黑市管理器() {
        return this.系统管理器实例.黑市管理器;
    }

    获取回合管理器() {
        return this.系统管理器实例.回合管理器;
    }

    // ─── 实体快捷操作 ───

    添加冠军(冠军: 冠军实体): void {
        this.实体管理器实例.添加冠军(冠军);
    }

    添加母畜(母畜: 母畜实体): void {
        this.实体管理器实例.添加母畜(母畜);
    }

    添加地点(地点: 可袭击地点实体): void {
        this.实体管理器实例.添加地点(地点);
    }

    获取冠军(冠军ID: string): 冠军实体 | null {
        return this.实体管理器实例.获取冠军(冠军ID);
    }

    获取母畜(母畜ID: string): 母畜实体 | null {
        return this.实体管理器实例.获取母畜(母畜ID);
    }

    获取地点(地点ID: string): 可袭击地点实体 | null {
        return this.实体管理器实例.获取地点(地点ID);
    }

    获取所有冠军(): 冠军实体[] {
        return this.实体管理器实例.获取所有冠军();
    }

    获取所有母畜(): 母畜实体[] {
        return this.实体管理器实例.获取所有母畜();
    }

    获取所有地点(): 可袭击地点实体[] {
        return this.实体管理器实例.获取所有地点();
    }

    // ─── 回合流程 ───

    结束回合() {
        // 资源结算
        this.资源管理器实例.回合结算();

        // 系统结算
        return this.系统管理器实例.回合管理器.结束回合();
    }

    // ─── 战斗流程 ───

    执行战斗() {
        const 结果 = this.战斗管理器实例.执行战斗();

        // 处理战斗结果
        if (结果.成功 && 结果.胜利 && 结果.俘获母畜) {
            for (const 母畜ID of 结果.俘获母畜) {
                // 母畜已经在战斗管理器中被从地点移除
                // 需要从地点实体获取并添加到玩家
                // 这里假设母畜实体已经被正确处理
            }
        }

        return 结果;
    }

    // ─── 游戏状态 ───

    获取游戏状态() {
        return {
            回合数: this.系统管理器实例.回合管理器.获取当前回合(),
            资源状态: this.资源管理器实例.获取资源状态(),
            实体统计: this.实体管理器实例.获取实体统计(),
            领主魔力: this.实体管理器实例.获取领主()?.获取属性('魔力') ?? 0,
        };
    }
}

// ═══════════════════════════════════════════════════════════════
// 游戏初始化器
// ═══════════════════════════════════════════════════════════════

interface 游戏初始化配置 {
    领主姓名?: string;
    初始魔力?: number;
    初始士气?: number;
    初始催淫母乳?: number;
    初始喽啰数?: number;
}

function 创建游戏实例(
    工厂管理器: 工厂管理器,
    初始化配置: 游戏初始化配置 = {}
): 游戏总控 {
    // 创建游戏总控
    const 游戏 = new 游戏总控({
        工厂管理器,
        初始资源: {
            士气: 初始化配置.初始士气 ?? 50,
            催淫母乳: 初始化配置.初始催淫母乳 ?? 0,
        },
    });

    // 创建并设置领主
    const 领主 = 工厂管理器.创建领主({
        姓名: 初始化配置.领主姓名 ?? '无名领主',
        魔力: 初始化配置.初始魔力 ?? 10,
    });
    游戏.设置领主(领主);

    // 初始化喽啰
    if (初始化配置.初始喽啰数 && 初始化配置.初始喽啰数 > 0) {
        const 无将领池 = 游戏.获取实体管理器().获取无将领喽啰池();
        无将领池.增加喽啰(初始化配置.初始喽啰数, '未武装');
    }

    return 游戏;
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export {
    资源管理器,
    实体管理器,
    游戏总控,
    创建游戏实例,
};

export type {
    资源状态,
    实体统计,
    游戏初始化配置,
};
