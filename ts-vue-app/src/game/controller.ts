// ═══════════════════════════════════════════════════════════════
// game/controller.ts
// 游戏总控 - 资源管理器、实体管理器、游戏总控中心
// ═══════════════════════════════════════════════════════════════

import { 冠军实体, 可袭击地点实体, 喽啰池实体, 母畜实体, 领主实体 } from '../core/entities';

import { 工厂管理器 } from '../core/factories';

import type { 任务配置, 可执行实体, 可目标实体, 奴隶购买结果, 已发布任务, 法术执行结果, 游戏总控接口, 购买结果 } from '../types/systems';

import type { 运行时实体配置, 领主创建配置 } from '../types/index';

import type { 奴隶刷新配置, 实体类型, 武装等级, 资源状态 } from '@/types';

import type { 游戏存档数据 } from '../core/persistence';
import { 存档管理器 } from '../core/persistence';

import { 任务管理器, 回合管理器, 实体管理器, 战斗管理器, 法术管理器, 资源管理器, 黑市管理器 } from '../core/managers';
import type { 游戏初始化配置 } from '@/types/controller';
import type { n } from 'vite/dist/node/chunks/moduleRunnerTransport';

// ═══════════════════════════════════════════════════════════════
// 游戏总控
// ═══════════════════════════════════════════════════════════════

class 游戏总控 implements 游戏总控接口 {
  private 资源管理器实例: 资源管理器;
  private 实体管理器实例: 实体管理器;
  private 工厂管理器实例: 工厂管理器;
  private 战斗管理器实例: 战斗管理器;
  private 任务管理器实例: 任务管理器;
  private 法术管理器实例: 法术管理器;
  private 黑市管理器实例: 黑市管理器;
  private 回合管理器实例: 回合管理器;
  private 存档管理器实例: 存档管理器;

  // 接口实现对象
  readonly 地点管理: {
    获取地点: (地点ID: string) => 可袭击地点实体 | null;
    添加地点: (地点: 可袭击地点实体) => void;
    获取所有地点: () => 可袭击地点实体[];
  };

  readonly 母畜管理: {
    从劝诱获取母畜: (母畜: 母畜实体) => void;
    移除母畜: (母畜: 母畜实体) => void;
    添加母畜: (母畜: 母畜实体) => void;
    获取母畜: (母畜ID: string) => 母畜实体 | null;
    获取所有母畜: () => 母畜实体[];
  };

  readonly 冠军管理: {
    从生育获取冠军: (冠军: 冠军实体) => void;
    添加冠军: (冠军: 冠军实体) => void;
    获取冠军: (冠军ID: string) => 冠军实体 | null;
    获取所有冠军: () => 冠军实体[];
  };

  readonly 喽啰池管理: {
    获取喽啰总数: () => number;
    获取无将领喽啰池: () => 喽啰池实体;
    可升级数量: (目标等级: 武装等级) => number;
    武装升级: (数量: number, 武装等级: 武装等级) => boolean;
    自动分配: () => boolean;
    清空所有将领喽啰池: () => void;
    清空将领喽啰池: (冠军输入:  冠军实体 | string) => void;
    快速填充到上限: (冠军输入:  冠军实体 | string) => void;
  };

  readonly 资源管理: {
    获取士气: () => number;
    获取最大士气: () => number;
    修改士气: (增量: number) => number;
    获取催淫母乳数量: () => number;
    修改催淫母乳数量: (增量: number) => number;
    使用法术: (法术名: string,倍率: number, 目标?: 可目标实体) => { 成功: boolean; 原因?: string; 结果?: 法术执行结果 };
    购买商品: (商品名: string, 购买数量: number, 目标?: 可目标实体 | null) => 购买结果;
    购买奴隶: (商品ID: string) => 奴隶购买结果;

  };

  readonly 任务管理: {
    获取所有任务名: () => string[];
    获取任务配置: (任务名: string) => 任务配置 | undefined
    发布任务: (任务名: string, 执行人: 可执行实体, 目标?: 可目标实体) => { 成功: boolean; 任务ID?: string; 原因?: string };
    获取已发布任务列表: () => 已发布任务[];
    是否被占用: (ID: string) => boolean;
    取消任务: (任务ID: string) => { 成功: boolean; 原因?: string };
    获取剩余行动力: () => number;
    获取最大行动力: () => number;
  };

  readonly 实体管理: {
    获取实体: (实体ID: string) => 实体类型 | null;
  };

  readonly 领主管理: {
    创建领主: (配置: 领主创建配置) => 领主实体;
    获取领主: () => 领主实体;
    设置领主: (领主: 领主实体) => void;
    修改魔力: (增量: number) => number;
  };

  readonly 系统管理: {
    获取资源管理器: () => 资源管理器;
    获取实体管理器: () => 实体管理器;
    获取工厂管理器: () => 工厂管理器;
    获取战斗管理器: () => 战斗管理器;
    获取任务管理器: () => 任务管理器;
    获取法术管理器: () => 法术管理器;
    获取黑市管理器: () => 黑市管理器;
    获取回合管理器: () => 回合管理器;
  };

  readonly 战斗管理: {
    选择目标: (地点输入: 可袭击地点实体 | string) => { 成功: boolean; 原因?: string };
    获取选定目标: () => 可袭击地点实体 | null;
    取消目标选择: () => void;
    执行战斗: () => any;
    添加出战将领: (将领ID: string) => { 成功: boolean; 原因?: string };
    移除出战将领: (将领ID: string) => { 成功: boolean; 原因?: string };
    确认战斗: () => { 成功: boolean; 原因?: string };
    是否战斗: () => boolean;
    获取战斗预览: () => {
      可执行: boolean;
      原因?: string;
      目标?: {
        名称: string;
        战斗力: number;
      };
      我方?: {
        总战斗力: number;
        将领数量: number;
        行动力消耗: number;
        突袭模式: boolean;
      };
      胜率预估?: number;
    };

  }

  readonly 回合管理: {
    获取当前回合: () => number;
    结束回合: () => any;
    获取游戏状态: () => any;
  };

  readonly 存档管理: {
    保存游戏: (游戏总控: 游戏总控) => {成功: boolean; 原因?: string | undefined;};
    加载存档: () => {成功: boolean; 原因?: string | undefined;};
    获取存档管理器: () => 存档管理器;
    获取存档数据: () => 游戏存档数据 | null;
    加载存档数据: (存档: 游戏存档数据) => { 成功: boolean; 原因?: string };
  };

  constructor(配置: { 运行时配置: 运行时实体配置; 初始资源?: 游戏初始化配置 }) {
    this.工厂管理器实例 = new 工厂管理器(配置.运行时配置);
    this.资源管理器实例 = new 资源管理器(配置.初始资源);
    this.实体管理器实例 = new 实体管理器();
    this.任务管理器实例 = new 任务管理器();
    this.法术管理器实例 = new 法术管理器();
    this.黑市管理器实例 = new 黑市管理器(配置.运行时配置);
    this.回合管理器实例 = new 回合管理器();
    this.存档管理器实例 = new 存档管理器(this.工厂管理器实例);
    this.战斗管理器实例 = new 战斗管理器(this.实体管理器实例, this.任务管理器实例);
    this.黑市管理器实例.设置奴隶刷新配置(配置.运行时配置.黑市奴隶刷新配置!);
    this.初始化()


    // ─── 绑定接口实现 ───

    this.地点管理 = {
      获取地点: (地点ID: string) => this.实体管理器实例.获取地点(地点ID),
      添加地点: (地点: 可袭击地点实体) => this.实体管理器实例.添加地点(地点),
      获取所有地点: () => this.实体管理器实例.获取所有地点(),
    };

    this.母畜管理 = {
      从劝诱获取母畜: (母畜: 母畜实体) => {
        母畜.设置属性('来源', '劝诱');
        this.实体管理器实例.添加母畜(母畜);
      },
      移除母畜: (母畜: 母畜实体) => {
        this.实体管理器实例.移除母畜(母畜);
      },
      添加母畜: (母畜: 母畜实体) => this.实体管理器实例.添加母畜(母畜),
      获取母畜: (母畜ID: string) => this.实体管理器实例.获取母畜(母畜ID),
      获取所有母畜: () => this.实体管理器实例.获取所有母畜(),
    };

    this.冠军管理 = {
      从生育获取冠军: (冠军: 冠军实体) => {
        this.实体管理器实例.添加冠军(冠军);
      },
      添加冠军: (冠军: 冠军实体) => this.实体管理器实例.添加冠军(冠军),
      获取冠军: (冠军ID: string) => this.实体管理器实例.获取冠军(冠军ID),
      获取所有冠军: () => this.实体管理器实例.获取所有冠军(),
    };

    this.喽啰池管理 = {
      获取喽啰总数: () => this.实体管理器实例.获取喽啰总数(),
      获取无将领喽啰池: () => this.实体管理器实例.获取无将领喽啰池(),
      武装升级: (数量: number, 目标等级: 武装等级) => {
        const 无将领池 = this.实体管理器实例.获取无将领喽啰池();

        // 武装等级优先级列表（从低到高）
        const 等级优先级: 武装等级[] = ['未武装', '低级武装', '中级武装', '高级武装', '精英武装'];
        const 目标索引 = 等级优先级.indexOf(目标等级);

        if (目标索引 <= 0) {
          return false; // 无法升级到未武装或无效等级
        }

        let 剩余需求 = 数量;

        // 从低等级开始寻找可升级的喽啰
        for (let i = 0; i < 目标索引 && 剩余需求 > 0; i++) {
          const 来源等级 = 等级优先级[i]!;
          const 来源数量 = 无将领池.获取分组数量(来源等级);

          if (来源数量 <= 0) continue;

          const 可升级数量 = Math.min(来源数量, 剩余需求);

          // 执行升级
          无将领池.减少喽啰(可升级数量, 来源等级);
          无将领池.增加喽啰(可升级数量, 目标等级);

          剩余需求 -= 可升级数量;
        }

        return 剩余需求 < 数量;
      },
      可升级数量: (目标等级: 武装等级) => {
        const 无将领池 = this.实体管理器实例.获取无将领喽啰池();

        // 武装等级优先级列表（从低到高）
        const 等级优先级: 武装等级[] = ['未武装', '低级武装', '中级武装', '高级武装', '精英武装'];
        const 目标索引 = 等级优先级.indexOf(目标等级);

        if (目标索引 <= 0) {
          return 0;
        }

        let 可升级数量 = 0;

        for (let i = 0; i < 目标索引; i++) {
          const 等级 = 等级优先级[i]!;
          const 数量 = 无将领池.获取分组数量(等级);

          if (数量 <= 0) continue;

          可升级数量 += 数量;
        }
        return 可升级数量;
      },
      自动分配: () => {
        const 将领列表 = this.实体管理器实例.获取所有冠军().sort((a, b) => b.获取属性('智力') - a.获取属性('智力'));
        if (将领列表.length === 0) {
          return false;
        }
        将领列表.forEach(冠军 => {
          this.实体管理器实例.清空将领喽啰池(冠军);
        });
        将领列表.forEach(冠军 => {
          this.实体管理器实例.快速填充到上限(冠军);
        });
        return true;
      },
      清空所有将领喽啰池: () => {
        const 将领列表 = this.实体管理器实例.获取所有冠军();
        将领列表.forEach(将领 => {
          this.实体管理器实例.清空将领喽啰池(将领);
        });
      },
      清空将领喽啰池: (冠军输入:  冠军实体 | string) => this.实体管理器实例.清空将领喽啰池(冠军输入),
      快速填充到上限: (冠军输入:  冠军实体 | string) => this.实体管理器实例.快速填充到上限(冠军输入),
    };

    this.资源管理 = {
      获取士气: () => this.资源管理器实例.获取士气(),
      获取最大士气: () => this.资源管理器实例.获取最大士气(),
      修改士气: (增量: number) => this.资源管理器实例.修改士气(增量),
      获取催淫母乳数量: () => this.资源管理器实例.获取催淫母乳数量(),
      修改催淫母乳数量: (增量: number) => this.资源管理器实例.修改催淫母乳数量(增量),
      使用法术: (法术名: string,倍率: number,目标: 可目标实体 = null) => this.法术管理器实例.使用法术(法术名, 倍率, 目标),
      购买商品: (商品名: string, 购买数量: number, 目标: 可目标实体 | null = null) => this.黑市管理器实例.购买商品(商品名, 购买数量, 目标),
      购买奴隶: (商品ID: string) => this.黑市管理器实例.购买奴隶(商品ID),
    };

    this.任务管理 = {
      获取所有任务名: () => this.任务管理器实例.获取所有任务名(),
      获取任务配置: (任务名: string) => this.任务管理器实例.获取任务配置(任务名),
      发布任务: (任务名: string, 执行人: 可执行实体, 目标?: 可目标实体) => this.任务管理器实例.发布任务(任务名, 执行人, 目标),
      获取已发布任务列表: () => this.任务管理器实例.获取已发布任务列表(),
      是否被占用: (ID: string) => this.任务管理器实例.是否被占用(ID),
      取消任务: (任务ID: string) => this.任务管理器实例.取消任务(任务ID),
      获取剩余行动力: () => this.任务管理器实例.获取剩余行动力(),
      获取最大行动力: () => this.任务管理器实例.获取总行动力(),
    }

    this.实体管理 = {
      获取实体: (实体ID: string) => this.实体管理器实例.获取实体(实体ID),
    };

    this.领主管理 = {
      创建领主: (配置: 领主创建配置) => {
        const 领主 = this.工厂管理器实例.创建领主(配置);
        this.实体管理器实例.设置领主(领主);
        return 领主;
      },
      获取领主: () => {
        const 领主 = this.实体管理器实例.获取领主();
        if (!领主) {
          throw new Error('领主未初始化');
        }
        return 领主;
      },
      设置领主: (领主: 领主实体) => this.实体管理器实例.设置领主(领主),
      修改魔力: (数量: number) => this.实体管理器实例.获取领主()?.修改属性('魔力', 数量)!,
    };

    this.系统管理 = {
      获取资源管理器: () => this.资源管理器实例,
      获取实体管理器: () => this.实体管理器实例,
      获取工厂管理器: () => this.工厂管理器实例,
      获取战斗管理器: () => this.战斗管理器实例,
      获取任务管理器: () => this.任务管理器实例,
      获取法术管理器: () => this.法术管理器实例,
      获取黑市管理器: () => this.黑市管理器实例,
      获取回合管理器: () => this.回合管理器实例,
    };

    this.战斗管理 = {
      执行战斗: () => {
        const 结果 = this.战斗管理器实例.执行战斗();

        // 处理战斗结果
        if (结果.成功 && 结果.胜利 && 结果.俘获母畜) {
          for (const 母畜ID of 结果.俘获母畜) {
            // 母畜已经在战斗管理器中被从地点移除
            // 需要从地点实体获取并添加到玩家
            // 这里假设母畜实体已经被正确处理
          }
        }

        return 结果;
      },
      获取选定目标: () => this.战斗管理器实例.获取选定目标(),
      取消目标选择: () => this.战斗管理器实例.取消目标选择(),
      选择目标: (地点输入: 可袭击地点实体 | string) => this.战斗管理器实例.选择目标(地点输入),
      添加出战将领: (冠军输入: 冠军实体 | string) => this.战斗管理器实例.添加出战将领(冠军输入),
      移除出战将领: (冠军输入: 冠军实体 | string) => this.战斗管理器实例.移除出战将领(冠军输入),
      确认战斗: () => this.战斗管理器实例.确认战斗(),
      获取战斗预览: () => this.战斗管理器实例.获取战斗预览(),
      是否战斗 : () => this.战斗管理器实例.是否战斗,
    };

    this.回合管理 = {
      获取当前回合: () => this.回合管理器实例.获取当前回合(),
      结束回合: () => {
        // 资源结算
        this.资源管理器实例.回合结算();

        // 系统结算
        return this.回合管理器实例.结束回合();
      },
      获取游戏状态: () => {
        return {
          回合数: this.回合管理器实例.获取当前回合(),
          资源状态: this.资源管理器实例.获取资源状态(),
          实体统计: this.实体管理器实例.获取实体统计(),
          领主魔力: this.实体管理器实例.获取领主()?.获取属性('魔力') ?? 0,
        };
      }
    };

    this.存档管理 = {
      保存游戏: (游戏总控: 游戏总控) => this.存档管理器实例.保存游戏(游戏总控,1),
      加载存档: () => this.存档管理器实例.读取存档(1),
      获取存档管理器: () => this.存档管理器实例,
      获取存档数据: () => this.存档管理器实例.获取存档数据(this),
      加载存档数据: (存档: 游戏存档数据) => {
        const 成功 = this.存档管理器实例.加载存档数据(存档, this);
        return { 成功 };
      }
    };
  }

  private 初始化(): void {
    this.任务管理器实例.设置游戏总控(this);
    this.法术管理器实例.设置游戏总控(this);
    this.黑市管理器实例.设置游戏总控(this);
    this.黑市管理器实例.设置工厂管理器(this.工厂管理器实例);
    this.回合管理器实例.初始化(
      this.任务管理器实例,
      this.法术管理器实例,
      this.黑市管理器实例,
      this.战斗管理器实例,
      this.资源管理器实例,
    );
  }

  // ─── 游戏状态 ───

  // 获取游戏状态() {
  //   return {
  //     回合数: this.回合管理器实例.获取当前回合(),
  //     资源状态: this.资源管理器实例.获取资源状态(),
  //     实体统计: this.实体管理器实例.获取实体统计(),
  //     领主魔力: this.实体管理器实例.获取领主()?.获取属性('魔力') ?? 0,
  //   };
  // }
}

// ═══════════════════════════════════════════════════════════════
// 游戏初始化器
// ═══════════════════════════════════════════════════════════════

function 创建游戏实例(运行时实体配置: 运行时实体配置, 初始化配置: 游戏初始化配置 = {}): 游戏总控 {
  // 创建游戏总控
  const 游戏 = new 游戏总控({
    运行时配置: 运行时实体配置,
    初始资源: 初始化配置,
  });

  // 创建并设置领主
  const 领主 = 游戏.领主管理.创建领主({
    姓名: 初始化配置.领主姓名 ?? '无名领主',
    魔力: 初始化配置.初始魔力 ?? 10,
  });


  // 初始化喽啰
  if (初始化配置.初始喽啰数 && 初始化配置.初始喽啰数 > 0) {
    const 无将领池 = 游戏.喽啰池管理.获取无将领喽啰池();
    无将领池.增加喽啰(初始化配置.初始喽啰数, '未武装');
  }

  return 游戏;
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 创建游戏实例, 实体管理器, 游戏总控, 资源管理器 };

export type { 游戏初始化配置, 资源状态 };




