// ═══════════════════════════════════════════════════════════════
// game/controller.ts
// 游戏总控 - 资源管理器、实体管理器、游戏总控中心
// ═══════════════════════════════════════════════════════════════

import {
    冠军实体,
    可袭击地点实体,
    喽啰池实体,
    实体基类,
    母畜实体,
    领主实体,
} from '../core/entities';


import type { 母畜初始数据 } from '../core/entities';

import { 工厂管理器 } from '../core/factories';


import type { 游戏总控接口 } from '../types/systems';


import type { 喽啰池管理接口 } from '../types/managers';
import type { 实体类型, 武装等级, 资源状态, 奴隶刷新配置 } from '@/types';

import { 存档管理器 } from '../core/persistence';
import type { 游戏存档数据 } from '../core/persistence';

import { 任务管理器, 法术管理器, 黑市管理器, 回合管理器, 喽啰管理器, 战斗管理器, 资源管理器, 实体管理器 } from '../core/managers'



// ═══════════════════════════════════════════════════════════════
// 类型定义
// ═══════════════════════════════════════════════════════════════


// ═══════════════════════════════════════════════════════════════
// 游戏总控
// ═══════════════════════════════════════════════════════════════

class 游戏总控 implements 游戏总控接口 {
    private 资源管理器实例: 资源管理器;
    private 实体管理器实例: 实体管理器;
    private 工厂管理器实例: 工厂管理器;
    private 战斗管理器实例: 战斗管理器;
    private 任务管理器实例: 任务管理器;
    private 法术管理器实例: 法术管理器;
    private 黑市管理器实例: 黑市管理器;
    private 回合管理器实例: 回合管理器;
    private 存档管理器实例: 存档管理器;

    // 接口实现对象
    readonly 地点管理: {
        获取地点: (地点ID: string) => 可袭击地点实体 | null;
    };

    readonly 母畜管理: {
        从劝诱获取母畜: (母畜: 母畜实体) => void;
        移除母畜: (母畜: 母畜实体) => void;
    };

    readonly 冠军管理: {
        从生育获取冠军: (冠军: 冠军实体) => void;
    };

    readonly 喽啰池管理: {
        获取喽啰总数: () => number;
        获取无将领喽啰池: () => 喽啰池实体;
        武装升级: (数量: number, 武装等级: 武装等级) => boolean;
        自动分配: () => boolean;
        清空所有将领喽啰池: () => void;
    };

    readonly 资源管理: {
        获取士气: () => number;
        修改士气: (增量: number) => number;
        获取催淫母乳数量: () => number;
        修改催淫母乳数量: (增量: number) => number;
    };

    readonly 实体管理: {
        获取实体: (实体ID: string) => 实体类型 | null;
    };

    constructor(配置: {
        工厂管理器: 工厂管理器;
        初始资源?: Partial<资源状态>;
    }) {
        this.工厂管理器实例 = 配置.工厂管理器;
        this.资源管理器实例 = new 资源管理器(配置.初始资源);
        this.实体管理器实例 = new 实体管理器();
        this.任务管理器实例 = new 任务管理器();
        this.法术管理器实例 = new 法术管理器();
        this.黑市管理器实例 = new 黑市管理器();
        this.回合管理器实例 = new 回合管理器();
        this.存档管理器实例 = new 存档管理器(配置.工厂管理器);



        // 创建喽啰池管理接口适配器
        const 喽啰池管理适配器: 喽啰池管理接口 = {
            获取无将领喽啰池: () => this.实体管理器实例.获取无将领喽啰池(),
            获取所有将领喽啰池: () => this.实体管理器实例.获取所有将领喽啰池(),
        };

        // 创建战斗管理器
        this.战斗管理器实例 = new 战斗管理器({
            任务管理器: this.任务管理器实例,
            喽啰池管理: 喽啰池管理适配器,
            获取将领: (将领ID: string) => this.实体管理器实例.获取冠军(将领ID),
            获取地点: (地点ID: string) => this.实体管理器实例.获取地点(地点ID),
        });


        // 初始化系统管理器
        // this.系统管理器实例.初始化(this, this.工厂管理器实例);

        // ─── 绑定接口实现 ───

        this.地点管理 = {
            获取地点: (地点ID: string) => this.实体管理器实例.获取地点(地点ID),
        };

        this.母畜管理 = {
            从劝诱获取母畜: (母畜: 母畜实体) => {
                母畜.设置属性('来源', '劝诱');
                this.实体管理器实例.添加母畜(母畜);
            },
            移除母畜: (母畜: 母畜实体) => {
                this.实体管理器实例.移除母畜(母畜);
            },
        };

        this.冠军管理 = {
            从生育获取冠军: (冠军: 冠军实体) => {
                this.实体管理器实例.添加冠军(冠军);
            },
        };

        this.喽啰池管理 = {
            获取喽啰总数: () => this.实体管理器实例.获取喽啰总数(),
            获取无将领喽啰池: () => this.实体管理器实例.获取无将领喽啰池(),
            武装升级: (数量: number, 目标等级: 武装等级) => {
                return this.执行武装升级(数量, 目标等级);
            },
            自动分配: () => {
                const 将领列表 = this.实体管理器实例.获取所有冠军().sort((a, b) => b.获取属性('智力') - a.获取属性('智力'));
                if (将领列表.length === 0) {
                    return false;
                }
                将领列表.forEach(冠军 => {
                    this.实体管理器实例.清空将领喽啰池(冠军);
                });
                将领列表.forEach(冠军 => {
                    this.实体管理器实例.快速填充到上限(冠军);
                });
                return true;
            },
            清空所有将领喽啰池: () => {
                const 将领列表 = this.实体管理器实例.获取所有冠军();
                将领列表.forEach(将领 => {
                    this.实体管理器实例.清空将领喽啰池(将领);
                });
            },
        };

        this.资源管理 = {
            获取士气: () => this.资源管理器实例.获取士气(),
            修改士气: (增量: number) => this.资源管理器实例.修改士气(增量),
            获取催淫母乳数量: () => this.资源管理器实例.获取催淫母乳数量(),
            修改催淫母乳数量: (增量: number) => this.资源管理器实例.修改催淫母乳数量(增量),
        };

        this.实体管理 = {
            获取实体: (实体ID: string) => this.实体管理器实例.获取实体(实体ID),
        };
    }

    初始化(工厂管理器: 工厂管理器): void {
        this.任务管理器实例.设置游戏总控(this);
        this.法术管理器实例.设置游戏总控(this);
        this.黑市管理器实例.设置游戏总控(this);
        this.黑市管理器实例.设置工厂管理器(工厂管理器);
        this.回合管理器实例.初始化(this.任务管理器实例, this.法术管理器实例, this.黑市管理器实例, this.战斗管理器实例, this.资源管理器实例);
    }
    设置奴隶刷新配置(配置: 奴隶刷新配置): void {
        this.黑市管理器实例.设置奴隶刷新配置(配置);
    }
    设置喽啰池武装等级配置(配置: 奴隶刷新配置): void {
        this.黑市管理器实例.设置奴隶刷新配置(配置);
    }

    // ─── 武装升级逻辑 ───

    private 执行武装升级(数量: number, 目标等级: 武装等级): boolean {
        const 无将领池 = this.实体管理器实例.获取无将领喽啰池();

        // 武装等级优先级列表（从低到高）
        const 等级优先级: 武装等级[] = ['未武装', '低级武装', '中级武装', '高级武装', '精英武装'];
        const 目标索引 = 等级优先级.indexOf(目标等级);

        if (目标索引 <= 0) {
            return false; // 无法升级到未武装或无效等级
        }

        let 剩余需求 = 数量;

        // 从低等级开始寻找可升级的喽啰
        for (let i = 0; i < 目标索引 && 剩余需求 > 0; i++) {
            const 来源等级 = 等级优先级[i]!;
            const 来源数量 = 无将领池.获取分组数量(来源等级);

            if (来源数量 <= 0) continue;

            const 可升级数量 = Math.min(来源数量, 剩余需求);

            // 执行升级
            无将领池.减少喽啰(可升级数量, 来源等级);
            无将领池.增加喽啰(可升级数量, 目标等级);

            剩余需求 -= 可升级数量;
        }

        return 剩余需求 < 数量; // 至少升级了一些
    }

    // ─── 领主管理 ───

    获取领主(): 领主实体 {
        const 领主 = this.实体管理器实例.获取领主();
        if (!领主) {
            throw new Error('领主未初始化');
        }
        return 领主;
    }

    设置领主(领主: 领主实体): void {
        this.实体管理器实例.设置领主(领主);
    }

    // ─── 系统访问器 ───

    获取资源管理器(): 资源管理器 {
        return this.资源管理器实例;
    }

    获取实体管理器(): 实体管理器 {
        return this.实体管理器实例;
    }

    获取工厂管理器(): 工厂管理器 {
        return this.工厂管理器实例;
    }



    获取战斗管理器(): 战斗管理器 {
        return this.战斗管理器实例;
    }

    // ─── 便捷方法 ───

    获取任务管理器() {
        return this.任务管理器实例;
    }

    获取法术管理器() {
        return this.法术管理器实例;
    }

    获取黑市管理器() {
        return this.黑市管理器实例;
    }

    获取回合管理器() {
        return this.回合管理器实例;
    }

    // ─── 实体快捷操作 ───

    添加冠军(冠军: 冠军实体): void {
        this.实体管理器实例.添加冠军(冠军);
    }

    添加母畜(母畜: 母畜实体): void {
        this.实体管理器实例.添加母畜(母畜);
    }

    添加地点(地点: 可袭击地点实体): void {
        this.实体管理器实例.添加地点(地点);
    }

    获取冠军(冠军ID: string): 冠军实体 | null {
        return this.实体管理器实例.获取冠军(冠军ID);
    }

    获取母畜(母畜ID: string): 母畜实体 | null {
        return this.实体管理器实例.获取母畜(母畜ID);
    }

    获取地点(地点ID: string): 可袭击地点实体 | null {
        return this.实体管理器实例.获取地点(地点ID);
    }

    获取所有冠军(): 冠军实体[] {
        return this.实体管理器实例.获取所有冠军();
    }

    获取所有母畜(): 母畜实体[] {
        return this.实体管理器实例.获取所有母畜();
    }

    获取所有地点(): 可袭击地点实体[] {
        return this.实体管理器实例.获取所有地点();
    }

    // ─── 回合流程 ───

    结束回合() {
        // 资源结算
        this.资源管理器实例.回合结算();

        // 系统结算
        return this.回合管理器实例.结束回合();
    }

    // ─── 战斗流程 ───

    执行战斗() {
        const 结果 = this.战斗管理器实例.执行战斗();

        // 处理战斗结果
        if (结果.成功 && 结果.胜利 && 结果.俘获母畜) {
            for (const 母畜ID of 结果.俘获母畜) {
                // 母畜已经在战斗管理器中被从地点移除
                // 需要从地点实体获取并添加到玩家
                // 这里假设母畜实体已经被正确处理
            }
        }

        return 结果;
    }

    // ─── 游戏状态 ───

    获取游戏状态() {
        return {
            回合数: this.回合管理器实例.获取当前回合(),
            资源状态: this.资源管理器实例.获取资源状态(),
            实体统计: this.实体管理器实例.获取实体统计(),
            领主魔力: this.实体管理器实例.获取领主()?.获取属性('魔力') ?? 0,
        };
    }

    // ─── 存档系统访问 ───

    获取存档管理器(): 存档管理器 {
        return this.存档管理器实例;
    }

    // ─── 存档快捷方法 ───

    获取存档数据(): 游戏存档数据 | null { 
        return this.存档管理器实例.获取存档数据(this);
    }


    加载存档数据(存档: 游戏存档数据): { 成功: boolean; 原因?: string } {
        const 成功 = this.存档管理器实例.加载存档数据(存档, this);
        return { 成功 };
    }
}

// ═══════════════════════════════════════════════════════════════
// 游戏初始化器
// ═══════════════════════════════════════════════════════════════

interface 游戏初始化配置 {
    领主姓名?: string;
    初始魔力?: number;
    初始士气?: number;
    初始催淫母乳?: number;
    初始喽啰数?: number;
}

function 创建游戏实例(
    工厂管理器: 工厂管理器,
    初始化配置: 游戏初始化配置 = {}
): 游戏总控 {
    // 创建游戏总控
    const 游戏 = new 游戏总控({
        工厂管理器,
        初始资源: {
            士气: 初始化配置.初始士气 ?? 50,
            催淫母乳: 初始化配置.初始催淫母乳 ?? 0,
        },
    });

    // 创建并设置领主
    const 领主 = 工厂管理器.创建领主({
        姓名: 初始化配置.领主姓名 ?? '无名领主',
        魔力: 初始化配置.初始魔力 ?? 10,
    });
    游戏.设置领主(领主);

    // 初始化喽啰
    if (初始化配置.初始喽啰数 && 初始化配置.初始喽啰数 > 0) {
        const 无将领池 = 游戏.获取实体管理器().获取无将领喽啰池();
        无将领池.增加喽啰(初始化配置.初始喽啰数, '未武装');
    }

    return 游戏;
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export {
    资源管理器,
    实体管理器,
    游戏总控,
    创建游戏实例,
};

export type {
    资源状态,
    游戏初始化配置,
};
