// ═══════════════════════════════════════════════════════════════
// game/bootstrap.ts
// 游戏主入口 - 初始化与启动
// ═══════════════════════════════════════════════════════════════

import { 工厂管理器 } from '../core/factories';
import { 游戏总控, 创建游戏实例 } from './controller';
import { 初始化规则 } from '../data/rules';
import {
    运行时配置,
    游戏初始配置,
    初始地点配置,
    初始母畜配置,
    奴隶刷新配置,
} from '../data/config';

// ═══════════════════════════════════════════════════════════════
// 游戏引导器
// ═══════════════════════════════════════════════════════════════

class 游戏引导器 {
    private 游戏实例: 游戏总控 | null = null;
    private 已初始化: boolean = false;

    /**
     * 初始化并启动新游戏
     */
    启动新游戏(): 游戏总控 {
        // 1. 创建工厂管理器（注入运行时配置）
        const 工厂 = new 工厂管理器(运行时配置);

        // 2. 创建游戏总控实例
        this.游戏实例 = 创建游戏实例(工厂, {
            领主姓名: 游戏初始配置.领主姓名,
            初始魔力: 游戏初始配置.初始魔力,
            初始士气: 游戏初始配置.初始士气,
            初始催淫母乳: 游戏初始配置.初始催淫母乳,
            初始喽啰数: 游戏初始配置.初始喽啰数,
        });

        // 3. 初始化规则系统（任务、法术、黑市商品注册）

        初始化规则(
            工厂,
            this.游戏实例.获取任务管理器(),
            this.游戏实例.获取黑市管理器(),
            this.游戏实例.获取法术管理器(),
        );

        // 4. 设置奴隶刷新配置
        this.游戏实例.设置奴隶刷新配置(奴隶刷新配置);

        // 5. 生成初始可袭击地点
        this.生成初始地点(工厂);
        this.生成初始实体(工厂);

        this.已初始化 = true;
        return this.游戏实例;
    }

    /**
     * 生成初始地点
     */
    private 生成初始地点(工厂: 工厂管理器): void {
        if (!this.游戏实例) return;

        const { 生成数量, 可用类型 } = 初始地点配置;

        for (let i = 0; i < 生成数量; i++) {
            const 类型 = 可用类型[Math.floor(Math.random() * 可用类型.length)]!;
            const 地点 = 工厂.创建可袭击地点(类型, {});
            this.游戏实例.添加地点(地点);
        }
    }

    private 生成初始实体(工厂: 工厂管理器): void{
        if (!this.游戏实例) return;
        for (let i = 0; i < 游戏初始配置.初始母畜数; i++) {
            const 母畜 = 工厂.创建母畜(初始母畜配置[i]!);
            this.游戏实例.添加母畜(母畜);

        }
        for (let i = 0; i < 游戏初始配置.初始冠军数; i++) {
            const 随机母畜 = this.游戏实例.获取实体管理器().获取所有母畜()[Math.floor(Math.random() * 游戏初始配置.初始母畜数)]!;
            if (!随机母畜) continue;
            const 冠军 = 工厂.从母畜生育哥布林冠军(随机母畜, {});
            this.游戏实例.添加冠军(冠军);
        }

    }

    /**
     * 获取当前游戏实例
     */
    获取游戏(): 游戏总控 | null {
        return this.游戏实例;
    }

    /**
     * 游戏是否已初始化
     */
    是否已初始化(): boolean {
        return this.已初始化;
    }

    /**
     * 重置游戏（用于重新开始）
     */
    重置(): void {
        this.游戏实例 = null;
        this.已初始化 = false;
    }
}

// ═══════════════════════════════════════════════════════════════
// 单例导出
// ═══════════════════════════════════════════════════════════════

export const 游戏引导 = new 游戏引导器();

// 便捷函数
export function 启动游戏(): 游戏总控 {
    return 游戏引导.启动新游戏();
}

export function 获取当前游戏(): 游戏总控 | null {
    return 游戏引导.获取游戏();
}
