// ═══════════════════════════════════════════════════════════════
// data/rules.ts
// 游戏规则配置实现
// ═══════════════════════════════════════════════════════════════

import { 冠军实体, 可袭击地点实体, 喽啰池实体, 母畜实体, 领主实体 } from '../core/entities';

import { 工厂管理器 } from '../core/factories';

import type {武装等级, 游戏总控接口, 任务执行结果, 商品执行结果, 法术执行结果, 实体类型, 任务系统接口, 黑市系统接口, 法术系统接口} from '../types/index';


// ═══════════════════════════════════════════════════════════════
// 规则初始化函数
// ═══════════════════════════════════════════════════════════════

export function 初始化任务法术市场(
  工厂管理器实例: 工厂管理器,
  任务系统: 任务系统接口,
  黑市系统: 黑市系统接口,
  法术系统: 法术系统接口,
): void {
  // ─── 辅助函数 ───
  const min = Math.min;
  const floor = Math.floor;

  // ─── 数组洗牌工具 ───
  const shuffleArray = <T>(array: T[]): T[] => {
    const result = [...array];
    for (let i = result.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [result[i], result[j]] = [result[j]!, result[i]!];
    }
    return result;
  };

  // ═══════════════════════════════════════════════════════════════
  // 任务配置
  // ═══════════════════════════════════════════════════════════════

  任务系统.注册任务('调教', {
    名称: '调教',
    描述: '冠军对母畜进行调教，提升其臣服度，智力越高，效果越好',
    执行人实体类型: '冠军实体',
    目标实体类型: '母畜实体',
    前置条件: [执行人 => 执行人.实体类型 === '冠军'],
    行动力占用: _执行人 => 1,
    执行效果: (执行人, 目标母畜, _游戏总控) => {
      const 冠军 = 执行人 as 冠军实体;
      const 母畜 = 目标母畜 as 母畜实体;

      const 初始值 = 母畜.获取属性('臣服度');
      const 执行效率 = 冠军.获取效率('智力');
      const 增量 = floor(执行效率 * 10) + 5;
      const 新值 = 母畜.修改属性('臣服度', 增量);

      return {
        成功: true,
        类型: '调教',
        执行人: 冠军,
        目标: 母畜,
        变化: { 臣服度: [初始值, 新值] },
      };
    },
  });

  任务系统.注册任务('劝慰', {
    名称: '劝慰',
    描述: '母畜对其他母畜进行劝慰，提升其臣服度，魅力越高，效果越好',
    执行人实体类型: '母畜实体',
    目标实体类型: '母畜实体',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('臣服度') >= 50],
    行动力占用: _执行人 => 1,
    执行效果: (执行人, 目标母畜, _游戏总控) => {
      const 执行母畜 = 执行人 as 母畜实体;
      const 目标 = 目标母畜 as 母畜实体;
      const 执行效率 = 执行母畜.获取效率('魅力');

      const 初始值 = 目标.获取属性('臣服度');
      const 基础值 = 执行效率 * 10 + 5;
      const 种族A = 执行母畜.获取属性('种族');
      const 种族B = 目标.获取属性('种族');
      const 系数 = 种族A === 种族B ? 1.25 : 0.8;
      const 增量 = floor(基础值 * 系数);
      const 新值 = 目标.修改属性('臣服度', 增量);

      return {
        成功: true,
        类型: '劝慰',
        执行人: 执行母畜,
        目标: 目标,
        变化: { 臣服度: [初始值, 新值] },
      };
    },
  });

  任务系统.注册任务('侦察', {
    名称: '侦察',
    执行人实体类型: '冠军实体',
    目标实体类型: '可袭击地点实体',
    描述: '侦察地点，获取地点内可被侦察的母畜信息，敏捷越高，效果越好',
    前置条件: [执行人 => 执行人.实体类型 === '冠军'],
    执行效果: (执行人, 目标地点, _游戏总控) => {
      const 冠军 = 执行人 as 冠军实体;
      const 地点 = 目标地点 as 可袭击地点实体;

      const 执行效率 = 冠军.获取效率('敏捷');
      const 成功率 = 执行效率 + 0.25;

      if (Math.random() > 成功率) {
        return {
          成功: false,
          类型: '侦察',
          执行人: 冠军,
          目标: 地点,
        };
      }

      const 初始进度 = 地点.获取侦察进度();

      // 进度增加
      const 进度增量 = 执行效率 * 10 + 5;
      const 当前进度 = 地点.增加侦察进度(进度增量);

      // 侦察逻辑
      const 因子 = (执行效率 + 0.25) * (当前进度 + 25);
      const 必定侦察数 = floor(因子 / 75);
      const 额外概率 = (因子 % 75) / 75;

      let 侦察母畜总数 = 必定侦察数 + (Math.random() < 额外概率 ? 1 : 0);
      const 可侦察母畜列表 = 地点.获取潜在母畜列表();
      const 随机索引数组 = shuffleArray([...Array(可侦察母畜列表.length).keys()]);

      // 执行地点实体内部的侦察逻辑
      const 被侦察母畜列表: 母畜实体[] = [];
      for (let i = 0; i < 侦察母畜总数 && i < 可侦察母畜列表.length; i++) {
        const 被侦察母畜 = 可侦察母畜列表[随机索引数组[i]!]!;
        地点.标记母畜已侦察(被侦察母畜);
        被侦察母畜列表.push(被侦察母畜);
      }

      return {
        成功: true,
        类型: '侦察',
        执行人: 冠军,
        目标: 地点,
        变化: { 侦察进度: [初始进度, 当前进度] },
        已侦察母畜: 被侦察母畜列表,
      };
    },
  });

  任务系统.注册任务('潜入侦察', {
    名称: '潜入侦察',
    执行人实体类型: '母畜实体',
    目标实体类型: '可袭击地点实体',
    描述: '母畜潜入地点，获取地点内可被侦察的母畜信息，魅力越高，效果越好，高淫乱的母畜难以胜任',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('臣服度') >= 75],
    行动力占用: _执行人 => 1,
    执行效果: (执行人, 目标地点, _游戏总控) => {
      const 母畜 = 执行人 as 母畜实体;
      const 魅力效率 = 母畜.获取效率('魅力');
      const 淫乱惩罚 = 母畜.获取效率('淫乱度惩罚');
      const 执行效率 = 魅力效率 * 淫乱惩罚;
      const 地点 = 目标地点 as 可袭击地点实体;
      const 成功率 = 执行效率 + 0.25;

      if (Math.random() > 成功率) {
        return {
          成功: false,
          类型: '侦察',
          执行人: 母畜,
          目标: 地点,
        };
      }

      const 初始进度 = 地点.获取侦察进度();

      // 进度增加
      const 进度增量 = 执行效率 * 10 + 5;
      const 当前进度 = 地点.增加侦察进度(进度增量);

      // 侦察逻辑
      const 因子 = (执行效率 + 0.25) * (当前进度 + 25);
      const 必定侦察数 = floor(因子 / 75);
      const 额外概率 = (因子 % 75) / 75;

      let 侦察母畜总数 = 必定侦察数 + (Math.random() < 额外概率 ? 1 : 0);
      const 可侦察母畜列表 = 地点.获取潜在母畜列表();
      const 随机索引数组 = shuffleArray([...Array(可侦察母畜列表.length).keys()]);

      // 执行地点实体内部的侦察逻辑
      const 被侦察母畜列表: 母畜实体[] = [];
      for (let i = 0; i < 侦察母畜总数 && i < 可侦察母畜列表.length; i++) {
        const 被侦察母畜 = 可侦察母畜列表[随机索引数组[i]!]!;
        地点.标记母畜已侦察(被侦察母畜);
        被侦察母畜列表.push(被侦察母畜);
      }

      return {
        成功: true,
        类型: '潜入侦察',
        执行人: 母畜,
        目标: 地点,
        变化: { 侦察进度: [初始进度, 当前进度] },
        已侦察母畜: 被侦察母畜列表,
      };
    },
  });

  任务系统.注册任务('潜入劝诱', {
    名称: '潜入劝诱',
    执行人实体类型: '母畜实体',
    目标实体类型: '可袭击地点实体-母畜实体',
    描述: '母畜潜入地点，尝试与目标母畜进行劝诱，魅力越高，效果越好，高淫乱的母畜难以胜任',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('臣服度') >= 90],
    行动力占用: _执行人 => 1,
    执行效果: (执行人, 目标母畜, 游戏总控) => {
      const 执行母畜 = 执行人 as 母畜实体;
      const 目标 = 目标母畜 as 母畜实体;

      const 淫乱度惩罚 = 执行母畜.获取效率('淫乱度惩罚');
      const 目标地点 = 游戏总控!.地点管理.获取地点(目标.来源地点ID!);
      const 魅力差 = 执行母畜.获取属性('魅力') - 目标.获取属性('魅力');
      const 成功率 = ((魅力差 * 魅力差 / 4000) * 淫乱度惩罚);

      if (Math.random() > 成功率) {
        return {
          成功: false,
          类型: '潜入劝诱',
          执行人: 执行母畜,
          目标: 目标,
        };
      }

      目标地点!.移除已捕获母畜(目标);
      游戏总控!.母畜管理.从劝诱获取母畜(目标);

      return {
        成功: true,
        类型: '潜入劝诱',
        执行人: 执行母畜,
        目标: 目标,
        已获取母畜: [目标],
      };
    },
  });
// type 任务执行效果 = (执行人: 实体类型, 目标: 实体类型 | null, 游戏总控?: 游戏总控接口) => 任务执行结果;
  任务系统.注册任务('生育哥布林冠军', {
    名称: '生育哥布林冠军',
    描述: '母畜生育哥布林冠军',
    目标实体类型: null,
    执行人实体类型: '母畜实体',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('剩余生育力') >= (执行人 as 母畜实体).生育冠军消耗()],
    行动力占用: 执行人 => ((执行人 as 母畜实体).获取属性('臣服度') >= 25 ? 1 : 2),
    执行效果: (执行人, _无, 游戏总控) => {
      const 母畜 = 执行人 as 母畜实体;

      // 调用 工厂管理器.从母畜生育哥布林冠军
      const 冠军 = 工厂管理器实例.从母畜生育哥布林冠军(母畜, {});
      const 初始淫乱度 = 母畜.获取属性('淫乱度');

      if (冠军) {
        母畜.修改属性('淫乱度', 6);
        // 冠军加入玩家阵营逻辑
        游戏总控!.冠军管理.从生育获取冠军(冠军);
        母畜.消耗生育力(冠军)

        return {
          成功: true,
          类型: '生育哥布林冠军',
          执行人: 母畜,
          目标: null,
          变化: {
            淫乱度: [初始淫乱度, 母畜.获取属性('淫乱度')],
          },
          已获取冠军: [冠军],
        };
      }

      return {
        成功: false,
        类型: '生育哥布林冠军',
        执行人: 母畜,
        目标: null,
      };
    },
  });

  任务系统.注册任务('生育喽啰', {
    名称: '生育喽啰',
    描述: '母畜生育喽啰',
    执行人实体类型: '母畜实体',
    目标实体类型: null,
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('剩余生育力') >= 10],
    行动力占用: 执行人 => ((执行人 as 母畜实体).获取属性('臣服度') >= 25 ? 0 : 1),
    执行效果: (执行人, _无, 游戏总控) => {
      const 母畜 = 执行人 as 母畜实体;

      const 初始喽啰数量 = 游戏总控!.喽啰池管理.获取喽啰总数();
      const 初始淫乱度 = 母畜.获取属性('淫乱度');
      const 价值 = 母畜.获取属性('剩余生育力');
      const 数量 = min(10, floor(价值 / 10));

      母畜.消耗生育力()
      母畜.修改属性('淫乱度', 6);

      // 增加喽啰池
      const 目标喽啰池 = 游戏总控!.喽啰池管理.获取无将领喽啰池();
      目标喽啰池.增加喽啰(数量, '未武装');

      return {
        成功: true,
        类型: '生育喽啰',
        执行人: 母畜,
        目标: null,
        变化: {
          喽啰数量: [初始喽啰数量, 游戏总控!.喽啰池管理.获取喽啰总数()],
          淫乱度: [初始淫乱度, 母畜.获取属性('淫乱度')],
        },
      };
    },
  });

  任务系统.注册任务('提振士气', {
    名称: '提振士气',
    描述: '母畜提振全军士气，魅力越高，效果越好',
    执行人实体类型: '母畜实体',
    目标实体类型: null,
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('臣服度') >= 75],
    行动力占用: _执行人 => 1,
    执行效果: (执行人, _无, 游戏总控) => {
      const 母畜 = 执行人 as 母畜实体;

      const 初始士气 = 游戏总控!.资源管理.获取士气();
      const 初始淫乱度 = 母畜.获取属性('淫乱度');
      const 执行效率 = 母畜.获取效率('魅力');
      const 增量 = Math.floor(执行效率 * 8 + 10);
      const 当前士气 = 游戏总控!.资源管理.修改士气(增量);
      母畜.修改属性('淫乱度', 10);

      return {
        成功: true,
        类型: '提振士气',
        执行人: 母畜,
        目标: null,
        变化: {
          士气: [初始士气, 当前士气],
          淫乱度: [初始淫乱度, 母畜.获取属性('淫乱度')],
        },
      };
    },
  });

  任务系统.注册任务('泌乳', {
    名称: '泌乳',
    描述: '母畜泌乳，淫乱度越高，产量越高',
    执行人实体类型: '母畜实体',
    目标实体类型: null,
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('淫乱度') >= 25],
    行动力占用: 执行人 => ((执行人 as 母畜实体).获取属性('臣服度') >= 50 ? 0 : 1),
    执行效果: (执行人, _无, 游戏总控) => {
      const 母畜 = 执行人 as 母畜实体;

      const 初始淫乱度 = 母畜.获取属性('淫乱度');
      const 初始催淫母乳数量 = 游戏总控!.资源管理.获取催淫母乳数量();

      母畜.修改属性('淫乱度', 3);

      const 执行效率 = 母畜.获取效率('淫乱度');
      const 产出 = floor(执行效率 * 8 + 5);
      const 当前催淫母乳数量 = 游戏总控!.资源管理.修改催淫母乳数量(产出);

      return {
        成功: true,
        类型: '泌乳',
        执行人: 母畜,
        目标: null,
        变化: {
          催淫母乳数量: [初始催淫母乳数量, 当前催淫母乳数量],
          淫乱度: [初始淫乱度, 母畜.获取属性('淫乱度')],
        },
      };
    },
  });

  任务系统.注册任务('献祭', {
    名称: '献祭',
    描述: '献祭母畜，根据生育力和魅力获取 5 到 25 点魔力',
    执行人实体类型: '母畜实体',
    目标实体类型: null,
    行动力占用: _执行人 => 0,
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => (执行人 as 母畜实体).获取属性('淫乱度') >= 75],
    执行效果: (执行人, _无, 游戏总控) => {
      const 母畜 = 执行人 as 母畜实体;

      const 价值 = 母畜.获取属性('总生育力');
      const 执行效率 = 母畜.获取效率('魅力');
      const 魔力增量 = floor((价值 * 执行效率 + 50) / 50);

      const 领主 = 游戏总控!.领主管理.获取领主();
      const 初始魔力 = 领主.获取属性('魔力');
      领主.获得魔力(魔力增量);

      游戏总控!.母畜管理.移除母畜(母畜);
      母畜.销毁();

      return {
        成功: true,
        类型: '献祭',
        执行人: 母畜,
        目标: null,
        变化: { 魔力: [初始魔力, 领主.获取属性('魔力')] },
      };
    },
  });

  // ═══════════════════════════════════════════════════════════════
  // 黑市商品配置
  // ═══════════════════════════════════════════════════════════════

  const 武装升级效果 =
    (数量: number, 等级: 武装等级) =>
    (游戏总控: 游戏总控接口): 商品执行结果 => {
      // 优先列表定义
      const 结果 = 游戏总控.喽啰池管理.武装升级(数量, 等级)
      return {
        成功: 结果,
        类型: '武装升级',
        目标: null,
      };
    };

  黑市系统.注册商品('破旧兵刃', {
    名称: '破旧兵刃',
    价格: 1,
    类型: '装备',
    目标类型: null,
    描述: '勉强能用的武器和护甲，聊胜于无，可以武装10名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
      武装升级效果(10 * 购买数量, '低级武装')(游戏总控),
  });

  黑市系统.注册商品('标准铁剑', {
    名称: '标准铁剑',
    价格: 1,
    类型: '装备',
    目标类型: null,
    描述: '正规军队的标准装备，可靠耐用，可以武装4名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
      武装升级效果(4 * 购买数量, '中级武装')(游戏总控),
  });

  黑市系统.注册商品('骑士武装', {
    名称: '骑士武装',
    价格: 1,
    类型: '装备',
    目标类型: null,
    描述: '通过特殊渠道走私的骑士装备，品质上乘，可以武装1名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
      武装升级效果(1 * 购买数量, '高级武装')(游戏总控),
  });

  黑市系统.注册商品('附魔装备', {
    名称: '附魔装备',
    价格: 4,
    类型: '装备',
    目标类型: null,
    描述: '非常罕见的附魔装备，极大提升喽啰战斗力，可以武装1名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
      武装升级效果(1 * 购买数量, '精英武装')( 游戏总控),
  });

  黑市系统.注册商品('祝福水晶', {
    名称: '祝福水晶',
    价格: 50,
    类型: '消耗品',
    目标类型: '母畜实体',
    描述: '可以增加母畜50点的生育质量，对淫乱的母畜效果不好',
    每周限购: 1,
    执行效果: (购买数量, 目标母畜, _游戏总控) => {
      const 母畜 = 目标母畜 as 母畜实体;

      const 淫乱度惩罚 = 母畜.获取效率('淫乱度惩罚');
      const 增量 = (购买数量 * 50) * 淫乱度惩罚;
      const 初始总生育力 = 母畜.获取属性('总生育力');
      const 初始剩余生育力 = 母畜.获取属性('剩余生育力');
      母畜.修改属性('总生育力', 增量);
      母畜.修改属性('剩余生育力', 增量);

      return {
        成功: true,
        类型: '祝福水晶',
        目标: 母畜,
        变化: {
          总生育力: [初始总生育力, 母畜.获取属性('总生育力')],
          剩余生育力: [初始剩余生育力, 母畜.获取属性('剩余生育力')],
        },
      };
    },
  });

  黑市系统.注册商品('净化水晶', {
    名称: '净化水晶',
    描述: '降低 10 点淫乱度',
    价格: 25,
    类型: '消耗品',
    目标类型: '母畜实体',
    每周限购: 5,
    执行效果: (购买数量, 目标母畜, _游戏总控) => {
      const 母畜 = 目标母畜 as 母畜实体;

      const 初始淫乱 = 母畜.获取属性('淫乱度');
      const 新值 = 母畜.修改属性('淫乱度', -10 * 购买数量);

      return {
        成功: true,
        类型: '净化水晶',
        目标: 母畜,
        变化: { 淫乱度: [初始淫乱, 新值] },
      };
    },
  });

  黑市系统.注册商品('魔力水晶', {
    名称: '魔力水晶',
    描述: '回复 3 点魔力',
    价格: 15,
    类型: '消耗品',
    目标类型: '领主实体',
    每周限购: 1,
    执行效果: (购买数量, _无, 游戏总控) => {
      const 领主 = 游戏总控.领主管理.获取领主();
      const 初始魔力 = 领主.获取属性('魔力');
      const 结果 = 领主.获得魔力(3 * 购买数量);

      return {
        成功: true,
        类型: '魔力水晶',
        目标: null,
        变化: { 领主魔力: [初始魔力, 结果.当前] },
      };
    },
  });

  // ═══════════════════════════════════════════════════════════════
  // 法术配置
  // ═══════════════════════════════════════════════════════════════

  法术系统.注册法术('魔眼侦察', {
    名称: '魔眼侦察',
    价格: 1,
    目标类型: '可袭击地点实体',
    描述: '对目标地点进行侦查',
    法术倍率上限: 3,
    执行效果: (法术倍率, 目标地点, _游戏总控) => {
      const 地点 = 目标地点 as 可袭击地点实体;

      const 初始侦察进度 = 地点.获取侦察进度();
      const 新值 = 地点.增加侦察进度(20 * 法术倍率);

      return {
        成功: true,
        类型: '魔眼侦察',
        目标: 地点,
        变化: { 侦察进度: [初始侦察进度, 新值] },
      };
    },
  });

  法术系统.注册法术('意志粉碎', {
    名称: '意志粉碎',
    价格: 1,
    目标类型: '母畜实体',
    描述: '获取 10 点臣服度',
    法术倍率上限: 3,
    执行效果: (法术倍率, 目标母畜, _游戏总控) => {
      const 母畜 = 目标母畜 as 母畜实体;

      const 初始臣服 = 母畜.获取属性('臣服度');
      const 新值 = 母畜.修改属性('臣服度', 10 * 法术倍率);

      return {
        成功: true,
        类型: '意志粉碎',
        目标: 母畜,
        变化: { 臣服度: [初始臣服, 新值] },
      };
    },
  });

  法术系统.注册法术('孕力回复', {
    名称: '孕力回复',
    目标类型: '母畜实体',
    价格: 10,
    描述: '回复 50 点生育力',
    法术倍率上限: 3,
    执行效果: (法术倍率, 目标母畜, _游戏总控) => {
      const 母畜 = 目标母畜 as 母畜实体;

      const 初始剩余生育力 = 母畜.获取属性('剩余生育力');
      const 新值 = 母畜.修改属性('剩余生育力', 50 * 法术倍率);

      return {
        成功: true,
        类型: '孕力回复',
        目标: 母畜,
        变化: { 剩余生育力: [初始剩余生育力, 新值] },
      };
    },
  });

  法术系统.注册法术('士气鼓舞', {
    名称: '士气鼓舞',
    价格: 5,
    目标类型: null,
    描述: '提高30点士气',
    法术倍率上限: 3,
    执行效果: (法术倍率, _无, 游戏总控) => {
      const 初始士气 = 游戏总控.资源管理.获取士气();
      const 新值 = 游戏总控.资源管理.修改士气(30 * 法术倍率);
      return {
        成功: true,
        类型: '士气鼓舞',
        目标: null,
        变化: { 士气: [初始士气, 新值] },
      };
    },
  });
}
