============================================================
ç›®å½•ç»“æ„: D:\testcode\st\potato-character-card\ts-vue-app\src
============================================================

./
  App.vue
  main.ts
  style.css
  components/
    common/
      NotificationToast.vue
    entities/
      BroodmotherDetail.vue
      ChampionDetail.vue
      EntityDetail.vue
      EntityList.vue
      LocationDetail.vue
    layout/
      GameController.vue
      StatusBar.vue
      TabNav.vue
      TurnControl.vue
    modals/
      TurnSummaryModal.vue
    panels/
      CombatPanel.vue
      DashboardPanel.vue
      EntitiesPanel.vue
      MarketPanel.vue
      MinionPanel.vue
      TasksPanel.vue
    sidebar/
  core/
    combat.ts
    entities.ts
    factories.ts
    managers.ts
    persistence.ts
  data/
    config.ts
    rules.ts
    trait.ts
  game/
    bootstrap.ts
    controller.ts
  stores/
    gameStore.ts
  styles/
    dark-fantasy.scss
  types/
    combat.ts
    common.ts
    controller.ts
    entities.ts
    factories.ts
    index.ts
    managers.ts
    persistence.ts
    systems.ts

============================================================

<!-- App.vue -->
<script setup lang="ts">
import { onMounted } from 'vue'
import { useGameStore } from './stores/gameStore'
import GameController from './components/layout/GameController.vue'
import NotificationToast from './components/common/NotificationToast.vue'

const store = useGameStore()

onMounted(() => {
  store.åˆå§‹åŒ–()
})
</script>

<template>
  <div class="goblin-game-controller" v-if="store.å·²åˆå§‹åŒ–">
    <GameController />
    <NotificationToast />
  </div>
  <div v-else class="loading-state">
    <span class="loading-icon">âš”</span>
    <span>å”¤é†’é»‘æš—...</span>
  </div>
</template>

<style lang="scss">
@import './styles/dark-fantasy.scss';

.goblin-game-controller {
  width: 100%;
  // max-width: 480px;
  // min-width: 320px;
  font-family: 'Noto Sans SC', sans-serif;
  font-size: 18px;
  background: var(--bg-primary);
  border: 1px solid var(--border-dark);
  border-radius: 4px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 40px;
  color: var(--text-dim);
  background: var(--bg-primary);

  .loading-icon {
    animation: pulse 1.5s infinite;
  }
}

@keyframes pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}
</style>

<!-- components/common/NotificationToast.vue -->
<script setup lang="ts">
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

const iconMap = {
  success: 'âœ“',
  warning: '!',
  error: 'âœ—',
  info: 'i'
}
</script>

<template>
  <Teleport to="body">
    <TransitionGroup
      name="toast"
      tag="div"
      class="toast-container"
    >
      <div
        v-for="notification in store.é€šçŸ¥åˆ—è¡¨"
        :key="notification.id"
        class="toast"
        :class="`toast--${notification.ç±»å‹}`"
      >
        <span class="toast__icon">{{ iconMap[notification.ç±»å‹] }}</span>
        <span class="toast__message">{{ notification.æ¶ˆæ¯ }}</span>
        <button
          class="toast__close"
          @click="store.ç§»é™¤é€šçŸ¥(notification.id)"
        >Ã—</button>
      </div>
    </TransitionGroup>
  </Teleport>
</template>

<style lang="scss" scoped>
.toast-container {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-width: 280px;
}

.toast {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--bg-primary);
  border: 1px solid var(--border-dark);
  border-radius: 3px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);

  &--success {
    border-left: 3px solid var(--success);

    .toast__icon { color: var(--success); }
  }

  &--warning {
    border-left: 3px solid var(--warning);

    .toast__icon { color: var(--warning); }
  }

  &--error {
    border-left: 3px solid var(--danger);

    .toast__icon { color: var(--danger); }
  }

  &--info {
    border-left: 3px solid var(--info);

    .toast__icon { color: var(--info); }
  }

  &__icon {
    font-size: 18px;
    font-weight: bold;
  }

  &__message {
    flex: 1;
    font-size: 16px;
    color: var(--text-primary);
  }

  &__close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 20px;
    padding: 0;

    &:hover {
      color: var(--text-primary);
    }
  }
}

.toast-enter-active,
.toast-leave-active {
  transition: all 0.3s ease;
}

.toast-enter-from {
  opacity: 0;
  transform: translateX(30px);
}

.toast-leave-to {
  opacity: 0;
  transform: translateX(30px);
}
</style>

<!-- components/entities/BroodmotherDetail.vue -->
<!-- ä»‹ç»ï¼šæ¯ç•œè¯¦æƒ…é¡µé¢ - æ”¹è¿›ç‰ˆï¼Œä»»åŠ¡æ”¯æŒç›®æ ‡é€‰æ‹© -->
<script setup lang="ts">
import { computed, ref } from 'vue'
import { useGameStore } from '../../stores/gameStore'

const store = useGameStore()
const broodmother = computed(() => store.é€‰ä¸­çš„æ¯ç•œ)

// ä»»åŠ¡é€‰æ‹©çŠ¶æ€
const selectingTaskTarget = ref<string | null>(null)
const selectedTaskTarget = ref<string | null>(null)

// åŸºç¡€ä¿¡æ¯
const basicInfo = computed(() => {
  if (!broodmother.value) return []
  return [
    { label: 'ç§æ—', value: broodmother.value.è·å–å±æ€§('ç§æ—') },
    { label: 'åŸèº«ä»½', value: broodmother.value.è·å–å±æ€§('åŸèº«ä»½') },
    { label: 'å¹´é¾„', value: broodmother.value.è·å–å±æ€§('å¹´é¾„') },
  ]
})

// æ ¸å¿ƒå±æ€§
const coreStats = computed(() => {
  store.æ£€æŸ¥çŠ¶æ€æ›´æ–°();
  if (!broodmother.value) return []
  const å‰©ä½™ = broodmother.value.è·å–å±æ€§('å‰©ä½™ç”Ÿè‚²åŠ›')
  const æ€»è®¡ = broodmother.value.è·å–å±æ€§('æ€»ç”Ÿè‚²åŠ›')
  return [
    {
      label: 'ç”Ÿè‚²åŠ›',
      current: å‰©ä½™,
      max: æ€»è®¡,
      color: 'var(--accent-poison)',
      percent: æ€»è®¡ > 0 ? (å‰©ä½™ / æ€»è®¡) * 100 : 0
    },
    {
      label: 'è‡£æœåº¦',
      current: broodmother.value.è·å–å±æ€§('è‡£æœåº¦'),
      max: 100,
      color: 'var(--accent-corrupt)',
      percent: broodmother.value.è·å–å±æ€§('è‡£æœåº¦')
    },
  ]
})

// èº«ä½“å±æ€§
const bodyStats = computed(() => {
  if (!broodmother.value) return []
  return [
    { label: 'é­…åŠ›', value: broodmother.value.è·å–å±æ€§('é­…åŠ›'), icon: 'â™¥' },
    { label: 'èƒ¸å›´', value: broodmother.value.è·å–å±æ€§('èƒ¸å›´'), icon: 'â—' },
    { label: 'æ•æ„Ÿåº¦', value: broodmother.value.è·å–å±æ€§('æ•æ„Ÿåº¦'), icon: 'âœ§' },
  ]
})

// çŠ¶æ€æ ‡ç­¾
const statusTags = computed(() => {
  if (!broodmother.value) return []
  const tags: { label: string; type: string }[] = []

  const è‡£æœåº¦ = broodmother.value.è·å–å±æ€§('è‡£æœåº¦')
  if (è‡£æœåº¦ >= 80) {
    tags.push({ label: 'å®Œå…¨è‡£æœ', type: 'poison' })
  } else if (è‡£æœåº¦ >= 50) {
    tags.push({ label: 'åŠè‡£æœ', type: 'gold' })
  } else if (è‡£æœåº¦ >= 20) {
    tags.push({ label: 'æŠµæŠ—ä¸­', type: 'mana' })
  } else {
    tags.push({ label: 'æ¡€éªœä¸é©¯', type: 'blood' })
  }

  // æ£€æŸ¥æ˜¯å¦å¿™ç¢Œ
  if (broodmother.value && store.æ£€æŸ¥å®ä½“æ˜¯å¦æœ‰ä»»åŠ¡(broodmother.value.å®ä½“ID)) {
    tags.push({ label: 'æ‰§è¡Œä»»åŠ¡ä¸­', type: 'mana' })
  }

  return tags
})

// äº§å¥¶ä¿¡æ¯
const milkInfo = computed(() => {
  if (!broodmother.value) return null
  const äº§å¥¶é‡ = broodmother.value.è·å–å±æ€§('æ¯å›åˆäº§å¥¶é‡')
  const ç´¯è®¡ = broodmother.value.è·å–å±æ€§('ç´¯è®¡äº§å¥¶é‡')
  if (äº§å¥¶é‡ === undefined && ç´¯è®¡ === undefined) return null
  return {
    perTurn: äº§å¥¶é‡ ?? 0,
    total: ç´¯è®¡ ?? 0
  }
})

interface TaskConfig {
  æè¿°?: string
  éœ€è¦ç›®æ ‡?: boolean
  ç›®æ ‡å®ä½“ç±»å‹?: string[]
}

// å¯ç”¨ä»»åŠ¡
const availableTasks = computed(() => {
  if (!broodmother.value) return []
  const taskManager = store.æ¸¸æˆå®ä¾‹?.è·å–ä»»åŠ¡ç®¡ç†å™¨()
  if (!taskManager) return []

  const allTasks = taskManager.è·å–æ‰€æœ‰ä»»åŠ¡å()
  return allTasks
    .filter(taskName => {
      const config = taskManager.è·å–ä»»åŠ¡é…ç½®(taskName)
      if (!config) return false
      return config.æ‰§è¡Œäººå®ä½“ç±»å‹?.includes('æ¯ç•œå®ä½“')
    })
    .map(taskName => {
      const config = taskManager.è·å–ä»»åŠ¡é…ç½®(taskName) as TaskConfig
      return {
        name: taskName,
        needsTarget: config?.éœ€è¦ç›®æ ‡ ?? false,
        targetTypes: config?.ç›®æ ‡å®ä½“ç±»å‹ ?? []
      }
    })
})

// è·å–ä»»åŠ¡å¯é€‰ç›®æ ‡
const taskTargets = computed(() => {
  if (!selectingTaskTarget.value) return []

  const task = availableTasks.value.find(t => t.name === selectingTaskTarget.value)
  if (!task) return []

  const result: { id: string; name: string; type: string }[] = []

  if (task.targetTypes.includes('å† å†›å®ä½“')) {
    store.æ‰€æœ‰å† å†›.forEach(c => {
      result.push({ id: c.å®ä½“ID, name: c.è·å–å±æ€§('å§“å'), type: 'å† å†›' })
    })
  }

  if (task.targetTypes.includes('æ¯ç•œå®ä½“')) {
    store.æ‰€æœ‰æ¯ç•œ
      .filter(m => m.å®ä½“ID !== broodmother.value?.å®ä½“ID)
      .forEach(m => {
        result.push({ id: m.å®ä½“ID, name: m.è·å–å±æ€§('å§“å'), type: 'æ¯ç•œ' })
      })
  }

  if (task.targetTypes.includes('åœ°ç‚¹å®ä½“')) {
    store.æ‰€æœ‰åœ°ç‚¹.forEach(l => {
      result.push({ id: l.å®ä½“ID, name: l.åœ°ç‚¹åç§°, type: 'åœ°ç‚¹' })
    })
  }

  return result
})

function handleTaskClick(taskName: string, needsTarget: boolean) {
  if (!broodmother.value) return

  if (needsTarget) {
    selectingTaskTarget.value = taskName
    selectedTaskTarget.value = null
  } else {
    store.å‘å¸ƒä»»åŠ¡(taskName, broodmother.value.å®ä½“ID)
  }
}

function confirmTaskWithTarget() {
  if (!broodmother.value || !selectingTaskTarget.value) return

  store.å‘å¸ƒä»»åŠ¡(
    selectingTaskTarget.value,
    broodmother.value.å®ä½“ID,
    selectedTaskTarget.value ?? undefined
  )

  selectingTaskTarget.value = null
  selectedTaskTarget.value = null
}

function cancelTaskSelection() {
  selectingTaskTarget.value = null
  selectedTaskTarget.value = null
}

// æ£€æŸ¥æ˜¯å¦å¿™ç¢Œ
const isBusy = computed(() => {
  if (!broodmother.value) return false
  return store.æ£€æŸ¥å®ä½“æ˜¯å¦æœ‰ä»»åŠ¡(broodmother.value.å®ä½“ID)
})
</script>

<template>
  <div v-if="broodmother" class="broodmother-detail">
    <!-- å¤´éƒ¨ -->
    <div class="detail-header">
      <h4 class="detail-title">
        {{ broodmother.è·å–å±æ€§('å§“å') }}
      </h4>
      <div class="status-tags">
        <span
          v-for="tag in statusTags"
          :key="tag.label"
          class="tag"
          :class="`tag--${tag.type}`"
        >
          {{ tag.label }}
        </span>
      </div>
    </div>

    <!-- åŸºç¡€ä¿¡æ¯ -->
    <div class="info-grid">
      <div
        v-for="info in basicInfo"
        :key="info.label"
        class="info-item"
      >
        <span class="info-label">{{ info.label }}</span>
        <span class="info-value">{{ info.value }}</span>
      </div>
    </div>

    <!-- æ ¸å¿ƒå±æ€§æ¡ -->
    <div class="core-stats">
      <div
        v-for="stat in coreStats"
        :key="stat.label"
        class="stat-bar-item"
      >
        <div class="stat-bar-header">
          <span class="stat-bar-label">{{ stat.label }}</span>
          <span class="stat-bar-value">{{ stat.current }} / {{ stat.max }}</span>
        </div>
        <div class="progress-bar">
          <div
            class="progress-bar__fill"
            :style="{
              width: stat.percent + '%',
              background: stat.color
            }"
          />
        </div>
      </div>
    </div>

    <!-- èº«ä½“å±æ€§ -->
    <div class="body-stats">
      <div
        v-for="stat in bodyStats"
        :key="stat.label"
        class="body-stat"
      >
        <span class="body-stat__icon">{{ stat.icon }}</span>
        <span class="body-stat__label">{{ stat.label }}</span>
        <span class="body-stat__value">{{ stat.value }}</span>
      </div>
    </div>

    <!-- äº§å¥¶ä¿¡æ¯ -->
    <div v-if="milkInfo" class="milk-info">
      <div class="milk-row">
        <span class="milk-icon">âœ¦</span>
        <span>æ¯å›åˆäº§å¥¶</span>
        <span class="milk-value">+{{ milkInfo.perTurn }}</span>
      </div>
      <div class="milk-row">
        <span class="milk-icon">âˆ‘</span>
        <span>ç´¯è®¡äº§å‡º</span>
        <span class="milk-value">{{ milkInfo.total }}</span>
      </div>
    </div>

    <!-- æ“ä½œåŒº -->
    <div class="detail-actions">
      <div class="action-group">
        <span class="action-label">åˆ†é…ä»»åŠ¡:</span>
        <div class="task-buttons">
          <button
            v-for="task in availableTasks"
            :key="task.name"
            class="btn btn--small"
            :class="{ 'btn--needs-target': task.needsTarget }"
            :disabled="isBusy"
            @click="handleTaskClick(task.name, task.needsTarget)"
          >
            {{ task.name }}
            <span v-if="task.needsTarget" class="target-indicator">â†’</span>
          </button>
          <span v-if="availableTasks.length === 0" class="no-task">
            æ— å¯ç”¨ä»»åŠ¡
          </span>
          <span v-if="isBusy" class="busy-hint">
            (ä»»åŠ¡æ‰§è¡Œä¸­)
          </span>
        </div>
      </div>
    </div>

    <!-- ä»»åŠ¡ç›®æ ‡é€‰æ‹©å¼¹å±‚ -->
    <div v-if="selectingTaskTarget" class="target-overlay">
      <div class="target-modal">
        <div class="modal-header">
          <h4>é€‰æ‹©ä»»åŠ¡ç›®æ ‡</h4>
          <span class="modal-task">{{ selectingTaskTarget }}</span>
        </div>
        <div class="target-list">
          <button
            v-for="target in taskTargets"
            :key="target.id"
            class="target-btn"
            :class="{ 'target-btn--selected': selectedTaskTarget === target.id }"
            @click="selectedTaskTarget = target.id"
          >
            <span class="target-type">[{{ target.type }}]</span>
            <span class="target-name">{{ target.name }}</span>
          </button>
          <div v-if="taskTargets.length === 0" class="no-targets">
            æ— å¯ç”¨ç›®æ ‡
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn--small" @click="cancelTaskSelection">å–æ¶ˆ</button>
          <button
            class="btn btn--small btn--primary"
            :disabled="!selectedTaskTarget"
            @click="confirmTaskWithTarget"
          >ç¡®è®¤</button>
        </div>
      </div>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.broodmother-detail {
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: relative;
}

.detail-header {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.detail-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-primary);
}

.status-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  padding: 8px;
  background: var(--bg-secondary);
  border-radius: 2px;
}

.info-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.info-label {
  font-size: 11px;
  color: var(--text-dim);
}

.info-value {
  font-size: 13px;
  color: var(--text-primary);
}

.core-stats {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.stat-bar-item {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.stat-bar-header {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
}

.stat-bar-label {
  color: var(--text-secondary);
}

.stat-bar-value {
  color: var(--text-primary);
}

.progress-bar {
  height: 6px;
  background: var(--bg-primary);
  border-radius: 3px;
  overflow: hidden;

  &__fill {
    height: 100%;
    transition: width 0.3s;
    border-radius: 3px;
  }
}

.body-stats {
  display: flex;
  justify-content: space-around;
  padding: 8px;
  background: var(--bg-secondary);
  border-radius: 2px;
}

.body-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;

  &__icon {
    font-size: 14px;
    color: var(--accent-corrupt);
  }

  &__label {
    font-size: 11px;
    color: var(--text-dim);
  }

  &__value {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
  }
}

.milk-info {
  padding: 8px;
  background: rgba(107, 74, 124, 0.15);
  border: 1px solid rgba(107, 74, 124, 0.3);
  border-radius: 2px;
}

.milk-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-secondary);

  & + & {
    margin-top: 4px;
  }
}

.milk-icon {
  color: var(--accent-corrupt);
}

.milk-value {
  margin-left: auto;
  color: var(--accent-corrupt);
  font-weight: 500;
}

.detail-actions {
  margin-top: 4px;
}

.action-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.action-label {
  font-size: 12px;
  color: var(--text-dim);
}

.task-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  align-items: center;
}

.btn--needs-target {
  border-style: dashed;
}

.target-indicator {
  margin-left: 2px;
  font-size: 10px;
}

.no-task,
.busy-hint {
  font-size: 12px;
  color: var(--text-dim);
}

/* ç›®æ ‡é€‰æ‹©å¼¹å±‚ */
.target-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 3px;
  z-index: 10;
}

.target-modal {
  width: 90%;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: 3px;
  overflow: hidden;
}

.modal-header {
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-dark);

  h4 {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    margin: 0;
  }

  .modal-task {
    font-size: 11px;
    color: var(--accent-gold);
  }
}

.target-list {
  padding: 8px;
  max-height: 150px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.target-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-dark);
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: left;

  &:hover {
    background: var(--bg-hover);
  }

  &--selected {
    border-color: var(--accent-corrupt);
    background: var(--bg-hover);
  }
}

.target-type {
  font-size: 10px;
  color: var(--text-dim);
}

.target-name {
  font-size: 12px;
  color: var(--text-primary);
}

.no-targets {
  font-size: 12px;
  color: var(--text-dim);
  text-align: center;
  padding: 16px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-dark);
}
</style>

<!-- components/entities/ChampionDetail.vue -->
<!-- ä»‹ç»ï¼šå“¥å¸ƒæ—å† å†›çš„è¯¦æƒ…é¡µé¢ -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()
const champion = computed(() => store.é€‰ä¸­çš„å† å†›)

const stats = computed(() => {
  if (!champion.value) return []
  return [
    { label: 'åŠ›é‡', value: champion.value.è·å–å±æ€§('åŠ›é‡'), color: 'var(--accent-blood)' },
    { label: 'æ•æ·', value: champion.value.è·å–å±æ€§('æ•æ·'), color: 'var(--accent-poison)' },
    { label: 'æ™ºåŠ›', value: champion.value.è·å–å±æ€§('æ™ºåŠ›'), color: 'var(--accent-mana)' },
  ]
})

const minionInfo = computed(() => {
  if (!champion.value) return null
  const pool = champion.value.è·å–å–½å•°æ± ()
  if (!pool) return null
  return {
    current: pool.è·å–æ€»æ•°é‡(),
    max: pool.è·å–æœ€å¤§æ•°é‡(),
    power: pool.è·å–æˆ˜æ–—åŠ›()
  }
})

const availableTasks = computed(() => {
  if (!champion.value) return []
  const taskManager = store.æ¸¸æˆå®ä¾‹?.è·å–ä»»åŠ¡ç®¡ç†å™¨()
  if (!taskManager) return []

  const allTasks = taskManager.è·å–æ‰€æœ‰ä»»åŠ¡å()
  return allTasks.filter(taskName => {
    const config = taskManager.è·å–ä»»åŠ¡é…ç½®(taskName)
    if (!config) return false
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç”±æ¯ç•œæ‰§è¡Œ
    return config.æ‰§è¡Œäººå®ä½“ç±»å‹?.includes('å† å†›å®ä½“')
  })
})

function assignTask(taskName: string) {
  if (!champion.value) return
  store.å‘å¸ƒä»»åŠ¡(taskName, champion.value.å®ä½“ID)
}


</script>

<template>
  <div v-if="champion" class="champion-detail">
    <h4 class="detail-title">
      {{ champion.è·å–å±æ€§('å§“å') }}
      <span class="tag tag--blood">å† å†›</span>
    </h4>

    <!-- å±æ€§ -->
    <div class="stat-row">
      <div
        v-for="stat in stats"
        :key="stat.label"
        class="stat-item"
      >
        <span class="stat-item__label">{{ stat.label }}</span>
        <span class="stat-item__value" :style="{ color: stat.color }">
          {{ stat.value }}
        </span>
      </div>
    </div>

    <!-- å–½å•°æ±  -->
    <div v-if="minionInfo" class="minion-info">
      <div class="info-row">
        <span>å–½å•°</span>
        <span>{{ minionInfo.current }} / {{ minionInfo.max }}</span>
      </div>
      <div class="info-row">
        <span>æˆ˜æ–—åŠ›</span>
        <span class="text-accent">{{ Math.round(minionInfo.power) }}</span>
      </div>
    </div>

    <!-- æ“ä½œåŒº -->
    <div class="detail-actions">
      <div class="action-group">
        <span class="action-label">åˆ†é…ä»»åŠ¡:</span>
        <div class="task-buttons">
          <button
            v-for="task in availableTasks"
            :key="task"
            class="btn btn--small"
            @click="assignTask(task)"
          >
            {{ task }}
          </button>
          <span v-if="availableTasks.length === 0" class="no-task">
            æ— å¯ç”¨ä»»åŠ¡
          </span>
        </div>
      </div>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.champion-detail {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.detail-title {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
}

.stat-row {
  display: flex;
  gap: 12px;
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;

  &__label {
    font-size: 18px;
    color: var(--text-dim);
  }

  &__value {
    font-size: 16px;
    font-weight: 600;
  }
}

.minion-info {
  background: var(--bg-secondary);
  padding: 6px 8px;
  border-radius: 2px;
}

.info-row {
  display: flex;
  justify-content: space-between;
  font-size: 15px;
  color: var(--text-secondary);

  & + & {
    margin-top: 4px;
  }
}

.text-accent {
  color: var(--accent-gold);
}

.detail-actions {
  display: flex;
  gap: 6px;
  margin-top: 4px;
}

.action-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.action-label {
  font-size: 15px;
  color: var(--text-dim);
}

.task-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.no-task {
  font-size: 15px;
  color: var(--text-dim);
}
</style>

<!-- components/entities/EntityDetail.vue -->
<!-- ä»‹ç»ï¼šå®ä½“è¯¦æƒ… -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'
import ChampionDetail from './ChampionDetail.vue'
import BroodmotherDetail from './BroodmotherDetail.vue'
import LocationDetail from './LocationDetail.vue'

const store = useGameStore()

const detailComponent = computed(() => {
  switch (store.é€‰ä¸­å®ä½“ç±»å‹) {
    case 'å† å†›': return ChampionDetail
    case 'æ¯ç•œ': return BroodmotherDetail
    case 'åœ°ç‚¹': return LocationDetail
    default: return null
  }
})
</script>

<template>
  <div class="entity-detail">
    <button
      class="close-btn"
      @click="store.æ¸…é™¤é€‰æ‹©()"
    >Ã—</button>

    <component
      v-if="detailComponent"
      :is="detailComponent"
    />
  </div>
</template>

<style lang="scss" scoped>
.entity-detail {
  position: relative;
}

.close-btn {
  position: absolute;
  top: 0;
  right: 0;
  width: 20px;
  height: 20px;
  border: none;
  background: transparent;
  color: var(--text-dim);
  font-size: 16px;
  cursor: pointer;

  &:hover {
    color: var(--text-primary);
  }
}
</style>

<!-- components/entities/EntityList.vue -->
<!-- ä»‹ç»ï¼šå®ä½“åˆ—è¡¨ç»„ä»¶ -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'
import type { å† å†›å®ä½“, æ¯ç•œå®ä½“, å¯è¢­å‡»åœ°ç‚¹å®ä½“ } from '@/core/entities'

const props = defineProps<{
  type: 'champions' | 'broodmothers' | 'locations'
}>()

const store = useGameStore()

const entities = computed(() => {
  switch (props.type) {
    case 'champions': return store.æ‰€æœ‰å† å†›
    case 'broodmothers': return store.æ‰€æœ‰æ¯ç•œ
    case 'locations': return store.æ‰€æœ‰åœ°ç‚¹
  }
})

const entityTypeMap = {
  champions: 'å† å†›',
  broodmothers: 'æ¯ç•œ',
  locations: 'åœ°ç‚¹'
} as const

function selectEntity(entity: å† å†›å®ä½“ | æ¯ç•œå®ä½“ | å¯è¢­å‡»åœ°ç‚¹å®ä½“) {
  store.é€‰æ‹©å®ä½“(entity.å®ä½“ID, entityTypeMap[props.type])
}

function getEntityName(entity: any): string {
  if (props.type === 'locations') {
    return entity.åœ°ç‚¹åç§°
  }
  return entity.è·å–å±æ€§('å§“å')
}

function getEntitySubtext(entity: any): string {
  if (props.type === 'champions') {
    const str = entity.è·å–å±æ€§('åŠ›é‡')
    const agi = entity.è·å–å±æ€§('æ•æ·')
    const int = entity.è·å–å±æ€§('æ™ºåŠ›')
    return `åŠ›${str} æ•${agi} æ™º${int}`
  }
  if (props.type === 'broodmothers') {
    const fert = entity.è·å–å±æ€§('å‰©ä½™ç”Ÿè‚²åŠ›')
    const sub = entity.è·å–å±æ€§('è‡£æœåº¦')
    return `è‚²${fert} æœ${sub}`
  }
  if (props.type === 'locations') {
    return entity.åœ°ç‚¹ç±»å‹
  }
  return ''
}
</script>

<template>
  <div class="entity-list">
    <div
      v-for="entity in entities"
      :key="entity.å®ä½“ID"
      class="entity-item"
      :class="{ 'entity-item--selected': store.é€‰ä¸­å®ä½“ID === entity.å®ä½“ID }"
      @click="selectEntity(entity)"
    >
      <div class="entity-item__main">
        <span class="entity-item__name">{{ getEntityName(entity) }}</span>
        <span class="entity-item__sub">{{ getEntitySubtext(entity) }}</span>
      </div>
      <span class="entity-item__arrow">â€º</span>
    </div>

    <div v-if="entities.length === 0" class="empty-list">
      æš‚æ— {{ entityTypeMap[type] }}
    </div>
  </div>
</template>

<style lang="scss" scoped>
.entity-list {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.entity-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 8px;
  background: var(--bg-tertiary);
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.1s;

  &:hover {
    background: var(--bg-hover);
  }

  &--selected {
    background: var(--bg-hover);
    border-left: 2px solid var(--accent-blood);
  }

  &__main {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  &__name {
    font-size: 16px;
    color: var(--text-primary);
  }

  &__sub {
    font-size: 18px;
    color: var(--text-dim);
  }

  &__arrow {
    color: var(--text-dim);
    font-size: 20px;
  }
}

.empty-list {
  font-size: 16px;
  color: var(--text-dim);
  text-align: center;
  padding: 20px;
}
</style>

<!-- components/entities/LocationDetail.vue -->
<!-- ä»‹ç»ï¼šåœ°ç‚¹è¯¦æƒ… - æ”¹è¿›ç‰ˆï¼Œå¢åŠ ä¾¦æŸ¥ä¿¡æ¯æ˜¾ç¤º -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()
const location = computed(() => store.é€‰ä¸­çš„åœ°ç‚¹)

// åœ°ç‚¹ç±»å‹å›¾æ ‡æ˜ å°„
const typeIconMap: Record<string, string> = {
  'æ‘åº„': 'ğŸ˜',
  'åŸé•‡': 'ğŸ°',
  'è¦å¡': 'âš”',
  'çŸ¿æ´': 'â›',
  'æ£®æ—': 'ğŸŒ²',
  'æ´ç©´': 'ğŸ•³',
  'ç¥æ®¿': 'â›©',
  'å•†é˜Ÿ': 'ğŸ',
  'é»˜è®¤': 'âš‘'
}

// å¨èƒç­‰çº§
const threatLevel = computed(() => {
  if (!location.value) return null
  const power = location.value.è·å–æˆ˜æ–—åŠ›ä¼°å€¼?.()
  if (power === null || power === undefined) {
    return { label: 'æœªçŸ¥', color: 'var(--text-dim)', icon: '?' }
  }
  if (power >= 500) {
    return { label: 'æé«˜', color: 'var(--danger)', icon: 'â˜ â˜ â˜ ' }
  }
  if (power >= 300) {
    return { label: 'é«˜', color: 'var(--accent-blood)', icon: 'â˜ â˜ ' }
  }
  if (power >= 150) {
    return { label: 'ä¸­ç­‰', color: 'var(--warning)', icon: 'â˜ ' }
  }
  if (power >= 50) {
    return { label: 'ä½', color: 'var(--accent-poison)', icon: '!' }
  }
  return { label: 'å¾®å¼±', color: 'var(--text-dim)', icon: '-' }
})

// ä¾¦æŸ¥ä¿¡æ¯
const scoutInfo = computed(() => {
  if (!location.value) return null

  // gameStoreæ–¹æ³•ï¼šè·å–åœ°ç‚¹çš„ä¾¦æŸ¥è¿›åº¦ä¿¡æ¯
  // è¿”å› { å½“å‰è¿›åº¦: number, æœ€å¤§è¿›åº¦: number, ç™¾åˆ†æ¯”: number }
  const progress = store.è·å–åœ°ç‚¹ä¾¦æŸ¥è¿›åº¦(location.value.å®ä½“ID)

  return {
    progress: progress?.å½“å‰è¿›åº¦ ?? 0,
    maxProgress: progress?.æœ€å¤§è¿›åº¦ ?? 100,
    percentage: progress?.ç™¾åˆ†æ¯” ?? 0,
    isComplete: (progress?.ç™¾åˆ†æ¯” ?? 0) >= 100
  }
})

// å·²å‘ç°çš„æ¯ç•œ
const discoveredBreedingStock = computed(() => {
  if (!location.value) return []

  // gameStoreæ–¹æ³•ï¼šè·å–åœ¨è¯¥åœ°ç‚¹å·²å‘ç°çš„æ¯ç•œåˆ—è¡¨
  // è¿”å› { id: string, name: string, race: string, fertility: number }[]
  return store.è·å–åœ°ç‚¹å·²å‘ç°æ¯ç•œ(location.value.å®ä½“ID) ?? []
})

// æœªå‘ç°çš„æ¯ç•œæ•°é‡
const undiscoveredCount = computed(() => {
  if (!location.value) return null

  // gameStoreæ–¹æ³•ï¼šè·å–è¯¥åœ°ç‚¹å°šæœªä¾¦æŸ¥åˆ°çš„æ¯ç•œæ•°é‡
  // å¦‚æœå®Œå…¨æœªä¾¦æŸ¥ï¼Œè¿”å› nullï¼ˆæ˜¾ç¤ºä¸º ???ï¼‰
  return store.è·å–åœ°ç‚¹æœªå‘ç°æ¯ç•œæ•°é‡(location.value.å®ä½“ID)
})

// åœ°ç‚¹ä¿¡æ¯
const locationInfo = computed(() => {
  if (!location.value) return []
  const info: { label: string; value: string | number }[] = []

  info.push({ label: 'ç±»å‹', value: location.value.åœ°ç‚¹ç±»å‹ })

  const power = location.value.è·å–æˆ˜æ–—åŠ›ä¼°å€¼?.()
  if (power !== null && power !== undefined) {
    info.push({ label: 'æˆ˜æ–—åŠ›', value: Math.round(power) })
  }

  const çŠ¶æ€ = location.value.è·å–å±æ€§?.('çŠ¶æ€')
  if (çŠ¶æ€) {
    info.push({ label: 'çŠ¶æ€', value: çŠ¶æ€ })
  }

  return info
})

// æ˜¯å¦å·²é€‰ä¸ºæˆ˜æ–—ç›®æ ‡
const isSelectedAsTarget = computed(() => {
  if (!location.value) return false
  const combatManager = store.æ¸¸æˆå®ä¾‹?.è·å–æˆ˜æ–—ç®¡ç†å™¨()
  return combatManager?.è·å–é€‰å®šç›®æ ‡()?.å®ä½“ID === location.value.å®ä½“ID
})

// æ˜¯å¦å¯æ”»å‡»
const canAttack = computed(() => {
  if (!location.value) return false
  const çŠ¶æ€ = location.value.è·å–å±æ€§?.('çŠ¶æ€')
  return çŠ¶æ€ !== 'å·²æ”»å ' && çŠ¶æ€ !== 'åºŸå¢Ÿ'
})

function selectAsTarget() {
  if (!location.value) return
  store.é€‰æ‹©æˆ˜æ–—ç›®æ ‡(location.value.å®ä½“ID)
}

function deselectTarget() {
  store.æ¸¸æˆå®ä¾‹?.è·å–æˆ˜æ–—ç®¡ç†å™¨()?.å–æ¶ˆç›®æ ‡é€‰æ‹©()
}

function assignScoutTask() {
  if (!location.value) return
  // è·³è½¬åˆ°ä»»åŠ¡é¢æ¿å¹¶é¢„é€‰ä¾¦æŸ¥ä»»åŠ¡
  store.é¢„é€‰ä»»åŠ¡('ä¾¦æŸ¥', undefined, location.value.å®ä½“ID)
  store.åˆ‡æ¢é¢æ¿('tasks')
}
</script>

<template>
  <div v-if="location" class="location-detail">
    <!-- å¤´éƒ¨ -->
    <div class="detail-header">
      <span class="location-icon">
        {{ typeIconMap[location.åœ°ç‚¹ç±»å‹] || typeIconMap['é»˜è®¤'] }}
      </span>
      <div class="header-text">
        <h4 class="detail-title">{{ location.åœ°ç‚¹åç§° }}</h4>
        <span class="location-type">{{ location.åœ°ç‚¹ç±»å‹ }}</span>
      </div>
    </div>

    <!-- å¨èƒç­‰çº§ -->
    <div v-if="threatLevel" class="threat-display">
      <span class="threat-label">å¨èƒç­‰çº§:</span>
      <span class="threat-value" :style="{ color: threatLevel.color }">
        <span class="threat-icon">{{ threatLevel.icon }}</span>
        {{ threatLevel.label }}
      </span>
    </div>

    <!-- ä¾¦æŸ¥è¿›åº¦ -->
    <div class="scout-section">
      <div class="scout-header">
        <span class="scout-title">
          <span class="scout-icon">ğŸ‘</span>
          ä¾¦æŸ¥è¿›åº¦
        </span>
        <span class="scout-percentage" :class="{ 'complete': scoutInfo?.isComplete }">
          {{ scoutInfo?.percentage ?? 0 }}%
        </span>
      </div>

      <div class="scout-bar">
        <div
          class="scout-bar__fill"
          :style="{ width: (scoutInfo?.percentage ?? 0) + '%' }"
          :class="{ 'complete': scoutInfo?.isComplete }"
        />
      </div>

      <div class="scout-detail">
        <span>{{ scoutInfo?.progress ?? 0 }} / {{ scoutInfo?.maxProgress ?? 100 }}</span>
        <button
          v-if="!scoutInfo?.isComplete"
          class="btn btn--small"
          @click="assignScoutTask"
        >
          æ´¾é£ä¾¦æŸ¥
        </button>
      </div>
    </div>

    <!-- åœ°ç‚¹ä¿¡æ¯ -->
    <div class="info-list">
      <div
        v-for="info in locationInfo"
        :key="info.label"
        class="info-row"
      >
        <span class="info-row__label">{{ info.label }}</span>
        <span class="info-row__value">{{ info.value }}</span>
      </div>
    </div>

    <!-- å‘ç°çš„æ¯ç•œ -->
    <div class="broodmother-section">
      <div class="section-header">
        <span class="section-title">ğŸ” å‘ç°çš„æ¯ç•œ</span>
        <span class="discovery-count">
          {{ discoveredBreedingStock.length }}
          <template v-if="undiscoveredCount !== null">
            / {{ discoveredBreedingStock.length + undiscoveredCount }}
          </template>
          <template v-else>
            / ???
          </template>
        </span>
      </div>

      <div v-if="discoveredBreedingStock.length === 0" class="empty-discovery">
        <span v-if="scoutInfo?.percentage === 0">å°šæœªå¼€å§‹ä¾¦æŸ¥</span>
        <span v-else-if="!scoutInfo?.isComplete">ç»§ç»­ä¾¦æŸ¥ä»¥å‘ç°æ›´å¤š...</span>
        <span v-else>æ­¤åœ°ç‚¹æ²¡æœ‰å¯æ•è·çš„æ¯ç•œ</span>
      </div>

      <div v-else class="broodmother-list">
        <div
          v-for="bm in discoveredBreedingStock"
          :key="bm.id"
          class="broodmother-item"
        >
          <div class="bm-main">
            <span class="bm-name">{{ bm.name }}</span>
            <span class="bm-race">{{ bm.race }}</span>
          </div>
          <div class="bm-stats">
            <span class="bm-stat" title="ç”Ÿè‚²åŠ›">
              â™€ {{ bm.fertility }}
            </span>
          </div>
        </div>
      </div>

      <!-- æœªå‘ç°æç¤º -->
      <div v-if="undiscoveredCount && undiscoveredCount > 0" class="undiscovered-hint">
        <span class="hint-icon">â“</span>
        <span>è¿˜æœ‰ {{ undiscoveredCount }} ä¸ªæœªå‘ç°</span>
      </div>
      <div v-else-if="undiscoveredCount === null && !scoutInfo?.isComplete" class="undiscovered-hint unknown">
        <span class="hint-icon">â“</span>
        <span>æœªçŸ¥æ•°é‡å¾…å‘ç°</span>
      </div>
    </div>

    <!-- çŠ¶æ€æŒ‡ç¤º -->
    <div v-if="isSelectedAsTarget" class="target-indicator">
      <span class="target-icon">âš”</span>
      <span>å·²é€‰ä¸ºæ”»å‡»ç›®æ ‡</span>
    </div>

    <!-- æ“ä½œåŒº -->
    <div class="detail-actions">
      <template v-if="canAttack">
        <button
          v-if="!isSelectedAsTarget"
          class="btn btn--primary action-btn"
          @click="selectAsTarget"
        >
          <span>âš”</span> é€‰ä¸ºç›®æ ‡
        </button>
        <button
          v-else
          class="btn action-btn"
          @click="deselectTarget"
        >
          å–æ¶ˆé€‰æ‹©
        </button>
      </template>
      <div v-else class="cannot-attack">
        æ­¤åœ°ç‚¹æ— æ³•æ”»å‡»
      </div>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.location-detail {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.detail-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.location-icon {
  font-size: 24px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border-radius: 4px;
}

.header-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.detail-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-primary);
}

.location-type {
  font-size: 12px;
  color: var(--text-dim);
}

.threat-display {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-radius: 2px;
}

.threat-label {
  font-size: 13px;
  color: var(--text-secondary);
}

.threat-value {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  font-weight: 500;
}

.threat-icon {
  font-size: 12px;
}

/* ä¾¦æŸ¥è¿›åº¦æ ·å¼ */
.scout-section {
  background: var(--bg-secondary);
  border-radius: 3px;
  padding: 10px;
  border: 1px solid var(--border-dark);
}

.scout-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.scout-title {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
}

.scout-icon {
  font-size: 14px;
}

.scout-percentage {
  font-size: 14px;
  font-weight: 600;
  color: var(--accent-mana);

  &.complete {
    color: var(--success);
  }
}

.scout-bar {
  height: 6px;
  background: var(--bg-primary);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 6px;

  &__fill {
    height: 100%;
    background: var(--accent-mana);
    transition: width 0.3s ease;
    border-radius: 3px;

    &.complete {
      background: var(--success);
    }
  }
}

.scout-detail {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: var(--text-dim);
}

/* æ¯ç•œå‘ç°åŒºåŸŸ */
.broodmother-section {
  background: var(--bg-secondary);
  border-radius: 3px;
  padding: 10px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.section-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

.discovery-count {
  font-size: 12px;
  color: var(--accent-corrupt);
}

.empty-discovery {
  font-size: 12px;
  color: var(--text-dim);
  text-align: center;
  padding: 12px;
  background: var(--bg-tertiary);
  border-radius: 2px;
}

.broodmother-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 100px;
  overflow-y: auto;
}

.broodmother-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 8px;
  background: var(--bg-tertiary);
  border-radius: 2px;
}

.bm-main {
  display: flex;
  align-items: center;
  gap: 8px;
}

.bm-name {
  font-size: 13px;
  color: var(--text-primary);
}

.bm-race {
  font-size: 11px;
  color: var(--text-dim);
}

.bm-stats {
  display: flex;
  gap: 8px;
}

.bm-stat {
  font-size: 12px;
  color: var(--accent-corrupt);
}

.undiscovered-hint {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 8px;
  padding: 6px 8px;
  background: rgba(190, 149, 85, 0.15);
  border-radius: 2px;
  font-size: 12px;
  color: var(--accent-gold);

  &.unknown {
    background: rgba(74, 92, 138, 0.15);
    color: var(--accent-mana);
  }
}

.hint-icon {
  font-size: 14px;
}

/* åŸæœ‰æ ·å¼ä¿ç•™ */
.info-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 8px;
  background: var(--bg-secondary);
  border-radius: 2px;
  font-size: 13px;

  &__label {
    color: var(--text-dim);
  }

  &__value {
    color: var(--text-primary);
  }
}

.target-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px;
  background: rgba(139, 38, 53, 0.2);
  border: 1px solid var(--accent-blood);
  border-radius: 2px;
  font-size: 13px;
  color: var(--accent-blood-light);
}

.target-icon {
  font-size: 14px;
}

.detail-actions {
  margin-top: 4px;
}

.action-btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.cannot-attack {
  font-size: 13px;
  color: var(--text-dim);
  text-align: center;
  padding: 8px;
  background: var(--bg-secondary);
  border-radius: 2px;
}
</style>

<!-- components/layout/GameController.vue -->
<!-- ä»‹ç»ï¼šæ¸¸æˆæ§åˆ¶å™¨ç»„ä»¶ï¼Œç”¨äºç®¡ç†æ¸¸æˆæµç¨‹å’Œæ˜¾ç¤ºæ¸¸æˆé¢æ¿ã€‚ -->
<script setup lang="ts">
import { ref, computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'
import StatusBar from './StatusBar.vue'
import TabNav from './TabNav.vue'
import DashboardPanel from '../panels/DashboardPanel.vue'
import EntitiesPanel from '../panels/EntitiesPanel.vue'
import TasksPanel from '../panels/TasksPanel.vue'
import MinionPanel from '../panels/MinionPanel.vue'
import CombatPanel from '../panels/CombatPanel.vue'
import MarketPanel from '../panels/MarketPanel.vue'
import TurnControl from './TurnControl.vue'

const store = useGameStore()

const tabs = [
  { id: 'dashboard', label: 'æ€»è§ˆ', icon: 'âš”' },
  { id: 'entities', label: 'å®ä½“', icon: 'â™Ÿ' },
  { id: 'tasks', label: 'ä»»åŠ¡', icon: 'ğŸ“‹' },
  { id: 'minions', label: 'å–½å•°', icon: 'â˜ ' },
  { id: 'combat', label: 'æˆ˜æ–—', icon: 'ğŸ—¡' },
  { id: 'market', label: 'é»‘å¸‚', icon: 'ğŸ’€' },
] as const

type EntityTab = 'champions' | 'broodmothers' | 'locations'

const activeTab = ref<string>('dashboard')
const entitiesTab = ref<EntityTab>('champions')
</script>

<template>
  <div class="controller">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <StatusBar />

    <!-- æ ‡ç­¾å¯¼èˆª -->
    <TabNav
      :tabs="tabs"
      v-model:active="activeTab"
    />

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="controller__content">
      <KeepAlive>
        <DashboardPanel v-if="activeTab === 'dashboard'"
          :tabs="tabs"
          v-model:active="activeTab"
          v-model:activeEntities="entitiesTab"
          @update:active="activeTab = $event"
          @update:activeEntities="entitiesTab = $event"
        />
        <EntitiesPanel v-else-if="activeTab === 'entities'"
          :activeEntities="entitiesTab"
          @update:activeEntities="entitiesTab = $event"
        />
        <TasksPanel v-else-if="activeTab === 'tasks'" />
        <MinionPanel v-else-if="activeTab === 'minions'" />
        <CombatPanel v-else-if="activeTab === 'combat'" />
        <MarketPanel v-else-if="activeTab === 'market'" />
      </KeepAlive>
    </div>

    <!-- åº•éƒ¨å›åˆæ§åˆ¶ -->
    <TurnControl />
  </div>
</template>

<style lang="scss" scoped>
.controller {
  display: flex;
  flex-direction: column;
  height: 500px;

  &__content {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    background: var(--bg-secondary);
  }
}
</style>

<!-- components/layout/StatusBar.vue -->
<!-- ä»‹ç»ï¼šçŠ¶æ€æ ç»„ä»¶ -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

const stats = computed(() => [
  {
    id: 'mana',
    icon: 'â—†',
    value: store.é­”åŠ›ä¿¡æ¯.å½“å‰,
    max: store.é­”åŠ›ä¿¡æ¯.æœ€å¤§,
    color: 'var(--accent-mana)',
    label: 'é­”åŠ›'
  },
  {
    id: 'morale',
    icon: 'â™¦',
    value: store.èµ„æºçŠ¶æ€.å£«æ°”,
    max: store.èµ„æºçŠ¶æ€.æœ€å¤§å£«æ°”,
    color: 'var(--accent-blood)',
    label: 'å£«æ°”'
  },
  {
    id: 'milk',
    icon: 'âœ¦',
    value: store.èµ„æºçŠ¶æ€.å‚¬æ·«æ¯ä¹³,
    color: 'var(--accent-corrupt)',
    label: 'æ¯ä¹³'
  },
])
</script>

<template>
  <div class="status-bar">
    <div class="status-bar__lord">
      <span class="lord-icon">ğŸ‘‘</span>
      <span class="lord-name">{{ store.é¢†ä¸»?.è·å–å±æ€§('å§“å') || 'æœªå‘½å' }}</span>
    </div>

    <div class="status-bar__resources">
      <div
        v-for="stat in stats"
        :key="stat.id"
        class="resource"
        :title="`${stat.label}: ${stat.value}${stat.max ? '/' + stat.max : ''}`"
      >
        <span class="resource__icon" :style="{ color: stat.color }">{{ stat.icon }}</span>
        <span class="resource__value">{{ stat.value }}</span>
        <div v-if="stat.max" class="resource__bar">
          <div
            class="resource__bar-fill"
            :style="{
              width: (stat.value / stat.max * 100) + '%',
              background: stat.color
            }"
          />
        </div>
      </div>
    </div>

    <div class="status-bar__turn">
      ç¬¬ {{ store.å½“å‰å›åˆ }} å›åˆ
    </div>
  </div>
</template>

<style lang="scss" scoped>
.status-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 10px;
  background: var(--bg-primary);
  border-bottom: 1px solid var(--border-dark);

  &__lord {
    display: flex;
    align-items: center;
    gap: 4px;

    .lord-icon {
      font-size: 18px;
    }
    .lord-name {
      font-size: 16px;
      color: var(--accent-gold);
      font-weight: 500;
    }
  }

  &__resources {
    display: flex;
    gap: 10px;
    flex: 1;
  }

  &__turn {
    font-size: 15px;
    color: var(--text-dim);
    padding: 2px 6px;
    background: var(--bg-tertiary);
    border-radius: 2px;
  }
}

.resource {
  display: flex;
  align-items: center;
  gap: 3px;

  &__icon {
    font-size: 15px;
  }

  &__value {
    font-size: 16px;
    color: var(--text-primary);
    min-width: 20px;
  }

  &__bar {
    width: 30px;
    height: 3px;
    background: var(--bg-tertiary);
    border-radius: 1px;
    overflow: hidden;
  }

  &__bar-fill {
    height: 100%;
    transition: width 0.3s;
  }
}
</style>

<!-- components/layout/TabNav.vue -->
<!-- ä»‹ç»ï¼šé¡¶éƒ¨å¯¼èˆªæ ç»„ä»¶ -->
<script setup lang="ts">
interface Tab {
  id: string
  label: string
  icon: string
}

const props = defineProps<{
  tabs: readonly Tab[]
  active: string
}>()

const emit = defineEmits<{
  'update:active': [value: string]
}>()
</script>

<template>
  <nav class="tab-nav">
    <button
      v-for="tab in tabs"
      :key="tab.id"
      class="tab-nav__item"
      :class="{ 'tab-nav__item--active': active === tab.id }"
      @click="emit('update:active', tab.id)"
    >
      <span class="tab-icon">{{ tab.icon }}</span>
      <span class="tab-label">{{ tab.label }}</span>
    </button>
  </nav>
</template>

<style lang="scss" scoped>
.tab-nav {
  display: flex;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border-dark);

  &__item {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 0px 0px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
    border-bottom: 2px solid transparent;

    &:hover {
      color: var(--text-secondary);
      background: var(--bg-hover);
    }

    &--active {
      color: var(--text-primary);
      background: var(--bg-secondary);
      border-bottom-color: var(--accent-blood);

      .tab-icon {
        color: var(--accent-blood-light);
      }
    }
  }
}

.tab-icon {
  font-size: 20px;;
}

.tab-label {
  font-size: 16px;
}

@media (max-width: 360px) {
  .tab-label {
    display: none;
  }
}
</style>

<!-- components/layout/TurnControl.vue -->
<!-- ä»‹ç»ï¼šå›åˆæ§åˆ¶ -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

const pendingTasks = computed(() => store.å·²å‘å¸ƒä»»åŠ¡åˆ—è¡¨.length)
const hasCombat = computed(() =>
  store.æ¸¸æˆå®ä¾‹?.è·å–æˆ˜æ–—ç®¡ç†å™¨().æ˜¯å¦æˆ˜æ–— ?? false
)

function endTurn() {
  store.ç»“æŸå›åˆ()
  console.log(store.æ¸¸æˆå®ä¾‹)
}
</script>

<template>
  <div class="turn-control">
    <div class="turn-control__info">
      <span v-if="pendingTasks > 0" class="pending-badge">
        {{ pendingTasks }} ä¸ªå¾…æ‰§è¡Œä»»åŠ¡
      </span>
      <span v-if="hasCombat" class="combat-badge">
        âš” æˆ˜æ–—å·²ç¡®è®¤
      </span>
    </div>

    <button
      class="btn btn--primary turn-btn"
      @click="endTurn"
    >
      ç»“æŸå›åˆ â†’
    </button>
  </div>
</template>

<style lang="scss" scoped>
.turn-control {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  background: var(--bg-primary);
  border-top: 1px solid var(--border-dark);

  &__info {
    display: flex;
    gap: 8px;
    font-size: 15px;
  }
}

.pending-badge {
  color: var(--accent-gold);
}

.combat-badge {
  color: var(--accent-blood-light);
}

.turn-btn {
  padding: 6px 16px;
  font-size: 18px;
  font-weight: 500;
}
</style>

<!-- components/modals/TurnSummaryModal.vue -->
<!-- ä»‹ç»ï¼šå›åˆç»“ç®—å¼¹çª— -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

const summary = computed(() => store.æœ€æ–°ç»“ç®—æ‘˜è¦)

function close() {
  store.æ˜¾ç¤ºå›åˆç»“ç®—å¼¹çª— = false
}
</script>

<template>
  <Teleport to="body">
    <Transition name="modal">
      <div
        v-if="store.æ˜¾ç¤ºå›åˆç»“ç®—å¼¹çª— && summary"
        class="modal-overlay"
        @click.self="close"
      >
        <div class="modal-content">
          <header class="modal-header">
            <h3>ç¬¬ {{ summary.å›åˆæ•° }} å›åˆç»“ç®—</h3>
            <button class="close-btn" @click="close">Ã—</button>
          </header>

          <div class="modal-body">
            <!-- ä»»åŠ¡ç»“æœ -->
            <section v-if="summary.ä»»åŠ¡ç»“ç®—ç»“æœ.length > 0" class="result-section">
              <h4>ä»»åŠ¡æ‰§è¡Œ</h4>
              <div
                v-for="task in summary.ä»»åŠ¡ç»“ç®—ç»“æœ"
                :key="task.ä»»åŠ¡ID"
                class="result-item"
                :class="{ 'result-item--success': task.ç»“æœ.æˆåŠŸ, 'result-item--fail': !task.ç»“æœ.æˆåŠŸ }"
              >
                <span class="result-icon">{{ task.ç»“æœ.æˆåŠŸ ? 'âœ“' : 'âœ—' }}</span>
                <span class="result-text">
                  {{ task.ç»“æœ.ç±»å‹ }}
                  <template v-if="!task.ç»“æœ.æˆåŠŸ">
                    - {{ task.ç»“æœ.åŸå›  || 'å¤±è´¥' }}
                  </template>
                </span>
              </div>
            </section>

            <!-- æ³•æœ¯ä½¿ç”¨ -->
            <section v-if="summary.æ³•æœ¯ä½¿ç”¨è®°å½•" class="result-section">
              <h4>æ³•æœ¯æ–½æ”¾</h4>
              <div class="result-item result-item--success">
                <span class="result-icon">â—†</span>
                <span class="result-text">
                  {{ summary.æ³•æœ¯ä½¿ç”¨è®°å½•.æ³•æœ¯å }} Ã— {{ summary.æ³•æœ¯ä½¿ç”¨è®°å½•.å€ç‡ }}
                  (æ¶ˆè€— {{ summary.æ³•æœ¯ä½¿ç”¨è®°å½•.æ¶ˆè€—é­”åŠ› }} é­”åŠ›)
                </span>
              </div>
            </section>

            <!-- æˆ˜æ–—ç»“æœ -->
            <section v-if="summary.æˆ˜æ–—ç»“æœè®°å½•" class="result-section">
              <h4>æˆ˜æ–—ç»“æœ</h4>
              <div
                class="result-item"
                :class="summary.æˆ˜æ–—ç»“æœè®°å½•.èƒœåˆ© ? 'result-item--success' : 'result-item--fail'"
              >
                <span class="result-icon">âš”</span>
                <span class="result-text">
                  {{ summary.æˆ˜æ–—ç»“æœè®°å½•.èƒœåˆ© ? 'èƒœåˆ©' : 'æˆ˜è´¥' }}
                  <template v-if="summary.æˆ˜æ–—ç»“æœè®°å½•.æˆ˜æŸæ¯”ä¾‹">
                    (æˆ˜æŸ {{ Math.round(summary.æˆ˜æ–—ç»“æœè®°å½•.æˆ˜æŸæ¯”ä¾‹ * 100) }}%)
                  </template>
                </span>
              </div>
            </section>

            <div v-if="summary.ä»»åŠ¡ç»“ç®—ç»“æœ.length === 0 && !summary.æ³•æœ¯ä½¿ç”¨è®°å½• && !summary.æˆ˜æ–—ç»“æœè®°å½•" class="empty-result">
              æœ¬å›åˆæ— é‡è¦äº‹ä»¶
            </div>
          </div>

          <footer class="modal-footer">
            <button class="btn btn--primary" @click="close">
              ç¡®è®¤
            </button>
          </footer>
        </div>
      </div>
    </Transition>
  </Teleport>
</template>

<style lang="scss" scoped>
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.modal-content {
  width: 90%;
  max-width: 360px;
  max-height: 80vh;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: 4px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-dark);

  h3 {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
  }
}

.close-btn {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 18px;
  cursor: pointer;

  &:hover {
    color: var(--text-primary);
  }
}

.modal-body {
  padding: 12px;
  overflow-y: auto;
  flex: 1;
}

.result-section {
  margin-bottom: 12px;

  &:last-child {
    margin-bottom: 0;
  }

  h4 {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }
}

.result-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  background: var(--bg-tertiary);
  border-radius: 2px;
  margin-bottom: 4px;

  &:last-child {
    margin-bottom: 0;
  }

  &--success {
    .result-icon { color: var(--success); }
  }

  &--fail {
    .result-icon { color: var(--danger); }
  }
}

.result-icon {
  font-size: 16px;
  font-weight: bold;
}

.result-text {
  font-size: 16px;
  color: var(--text-primary);
}

.empty-result {
  font-size: 16px;
  color: var(--text-dim);
  text-align: center;
  padding: 20px;
}

.modal-footer {
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-dark);
  display: flex;
  justify-content: flex-end;
}

.modal-enter-active,
.modal-leave-active {
  transition: all 0.2s ease;
}

.modal-enter-from,
.modal-leave-to {
  opacity: 0;

  .modal-content {
    transform: scale(0.95);
  }
}
</style>

<!-- components/panels/CombatPanel.vue -->
<!-- ä»‹ç»ï¼šæˆ˜æ–—é¢æ¿ -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

const combatManager = computed(() => {
  store.æ£€æŸ¥çŠ¶æ€æ›´æ–°()
  return store.æ¸¸æˆå®ä¾‹?.è·å–æˆ˜æ–—ç®¡ç†å™¨()
})
const selectedTarget = computed(() =>  {
  store.æ£€æŸ¥çŠ¶æ€æ›´æ–°()
  return combatManager.value?.è·å–é€‰å®šç›®æ ‡()
})
const deployedChampions = computed(() =>  {
  store.æ£€æŸ¥çŠ¶æ€æ›´æ–°()
  return combatManager.value?.è·å–å½“å‰éƒ¨ç½²åˆ—è¡¨() ?? []
})
const preview = computed(() =>  {
  store.æ£€æŸ¥çŠ¶æ€æ›´æ–°()
  return store.è·å–æˆ˜æ–—é¢„è§ˆ()
})

const availableChampions = computed(() => {
  if (!combatManager.value) return []
  return combatManager.value.è·å–å¯å‡ºæˆ˜å°†é¢†(store.æ‰€æœ‰å† å†›)
})

function selectTarget(locationId: string) {
  store.æ›´æ–°å† å†›åˆ—è¡¨()
  store.é€‰æ‹©æˆ˜æ–—ç›®æ ‡(locationId)
}

function deployChampion(championId: string) {
  store.æ·»åŠ å‡ºæˆ˜å°†é¢†(championId)
}

function removeChampion(championId: string) {
  store.ç§»é™¤å‡ºæˆ˜å°†é¢†(championId)
}

function confirmBattle() {
  store.ç¡®è®¤æˆ˜æ–—()
}
</script>

<template>
  <div class="combat-panel">
    <!-- ç›®æ ‡é€‰æ‹© -->
    <section class="panel-section">
      <h3 class="section-title">é€‰æ‹©ç›®æ ‡</h3>

      <div class="location-list">
        <div
          v-for="location in store.æ‰€æœ‰åœ°ç‚¹"
          :key="location.å®ä½“ID"
          class="location-item"
          :class="{ 'location-item--selected': selectedTarget?.å®ä½“ID === location.å®ä½“ID }"
          @click="selectTarget(location.å®ä½“ID)"
        >
          <div class="location-item__info">
            <span class="location-name">{{ location.åœ°ç‚¹åç§° }}</span>
            <span class="location-type">{{ location.åœ°ç‚¹ç±»å‹ }}</span>
          </div>
          <div class="location-item__stats">
            <span v-if="location.è·å–æˆ˜æ–—åŠ›ä¼°å€¼()" class="stat-badge">
              âš” {{ Math.round(location.è·å–æˆ˜æ–—åŠ›ä¼°å€¼()!) }}
            </span>
            <span v-else class="stat-badge stat-badge--unknown">
              âš” ???
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- å°†é¢†éƒ¨ç½² -->
    <section v-if="selectedTarget" class="panel-section">
      <h3 class="section-title">éƒ¨ç½²å°†é¢†</h3>

      <!-- å¯ç”¨å°†é¢† -->
      <div class="champion-section">
        <span class="subsection-label">å¯ç”¨å°†é¢†</span>
        <div class="champion-chips">
          <button
            v-for="champion in availableChampions"
            :key="champion.å®ä½“ID"
            class="champion-chip"
            @click="deployChampion(champion.å®ä½“ID)"
          >
            {{ champion.è·å–å±æ€§('å§“å') }}
            <span class="chip-add">+</span>
          </button>
          <span v-if="availableChampions.length === 0" class="no-data">
            æ— å¯ç”¨å°†é¢†
          </span>
        </div>
      </div>

      <!-- å·²éƒ¨ç½² -->
      <div class="champion-section">
        <span class="subsection-label">å·²éƒ¨ç½² ({{ deployedChampions.length }})</span>
        <div class="champion-chips">
          <button
            v-for="deploy in deployedChampions"
            :key="deploy.å°†é¢†ID"
            class="champion-chip champion-chip--deployed"
            @click="removeChampion(deploy.å°†é¢†ID)"
          >
            {{ deploy.å°†é¢†.è·å–å±æ€§('å§“å') }}
            <span class="chip-power">âš”{{ Math.round(deploy.æˆ˜æ–—åŠ›) }}</span>
            <span class="chip-remove">Ã—</span>
          </button>
        </div>
      </div>
    </section>

    <!-- æˆ˜æ–—é¢„è§ˆ -->
    <section v-if="preview?.å¯æ‰§è¡Œ" class="panel-section preview-section">
      <h3 class="section-title">æˆ˜æ–—é¢„è§ˆ</h3>

      <div class="preview-stats">
        <div class="preview-row">
          <span>æˆ‘æ–¹æˆ˜æ–—åŠ›</span>
          <span class="text-accent">{{ Math.round(preview.æˆ‘æ–¹!.æ€»æˆ˜æ–—åŠ›) }}</span>
        </div>
        <div class="preview-row">
          <span>æ•Œæ–¹æˆ˜æ–—åŠ›</span>
          <span>{{ Math.round(preview.ç›®æ ‡!.æˆ˜æ–—åŠ›) }}</span>
        </div>
        <div class="preview-row">
          <span>é¢„ä¼°èƒœç‡</span>
          <span :class="preview.èƒœç‡é¢„ä¼°! >= 0.5 ? 'text-success' : 'text-danger'">
            {{ Math.round(preview.èƒœç‡é¢„ä¼°! * 100) }}%
          </span>
        </div>
      </div>

      <button
        class="btn btn--primary confirm-btn"
        @click="confirmBattle"
      >
        ç¡®è®¤å‡ºæˆ˜
      </button>
    </section>
  </div>
</template>

<style lang="scss" scoped>
.combat-panel {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.panel-section {
  background: var(--bg-tertiary);
  border-radius: 3px;
  padding: 10px;
}

.section-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border-dark);
}

.location-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 120px;
  overflow-y: auto;
}

.location-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 8px;
  background: var(--bg-secondary);
  border-radius: 2px;
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.1s;

  &:hover {
    background: var(--bg-hover);
  }

  &--selected {
    border-color: var(--accent-blood);
    background: var(--bg-hover);
  }

  &__info {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }
}

.location-name {
  font-size: 16px;
  color: var(--text-primary);
}

.location-type {
  font-size: 18px;
  color: var(--text-dim);
}

.stat-badge {
  font-size: 15px;
  padding: 2px 5px;
  background: var(--bg-tertiary);
  border-radius: 2px;
  color: var(--accent-blood-light);

  &--unknown {
    color: var(--text-dim);
  }
}

.champion-section {
  margin-bottom: 10px;

  &:last-child {
    margin-bottom: 0;
  }
}

.subsection-label {
  display: block;
  font-size: 15px;
  color: var(--text-dim);
  margin-bottom: 6px;
}

.champion-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.champion-chip {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  font-size: 15px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-dark);
  border-radius: 2px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.1s;

  &:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  &--deployed {
    background: rgba(139,38,53,0.2);
    border-color: var(--accent-blood);
    color: var(--text-primary);
  }
}

.chip-add {
  color: var(--accent-poison);
}

.chip-remove {
  color: var(--accent-blood-light);
}

.chip-power {
  font-size: 18px;
  color: var(--accent-gold);
}

.no-data {
  font-size: 15px;
  color: var(--text-dim);
}

.preview-section {
  background: rgba(139,38,53,0.1);
  border: 1px solid var(--accent-blood);
}

.preview-stats {
  margin-bottom: 10px;
}

.preview-row {
  display: flex;
  justify-content: space-between;
  font-size: 16px;
  color: var(--text-secondary);
  padding: 3px 0;
}

.text-accent { color: var(--accent-gold); }
.text-success { color: var(--success); }
.text-danger { color: var(--danger); }

.confirm-btn {
  width: 100%;
}
</style>

<!-- components/panels/DashboardPanel.vue -->
<!-- ä»‹ç»ï¼šå†›å›¢ç®¡ç†é¢æ¿ -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

const entityCounts = computed(() => [
  { label: 'å† å†›', count: store.æ‰€æœ‰å† å†›.length, icon: 'â™' },
  { label: 'æ¯ç•œ', count: store.æ‰€æœ‰æ¯ç•œ.length, icon: 'â™€' },
  { label: 'å–½å•°', count: store.å–½å•°æ€»æ•°, icon: 'â˜ ' },
  { label: 'åœ°ç‚¹', count: store.æ‰€æœ‰åœ°ç‚¹.length, icon: 'âš‘' },
])

const recentTasks = computed(() =>
  store.å·²å‘å¸ƒä»»åŠ¡åˆ—è¡¨.slice(0, 3)
)

interface Tab {
  id: string
  label: string
  icon: string
}
type EntityTab = 'champions' | 'broodmothers' | 'locations'

const props = defineProps<{
  tabs: readonly Tab[]
  active: string
}>()

const emit = defineEmits<{
  'update:active': [value: string]
  'update:activeEntities': [value: EntityTab]
}>()

function clickTabs(label: string) {
  switch (label) {
    case 'å† å†›':
      emit('update:activeEntities', 'champions')
      store.æ¸…é™¤é€‰æ‹©()
      emit('update:active', 'entities')
      break
    case 'æ¯ç•œ':
      emit('update:active', 'entities')
      store.æ¸…é™¤é€‰æ‹©()
      emit('update:activeEntities', 'broodmothers')
      break
    case 'åœ°ç‚¹':
      emit('update:active', 'entities')
      store.æ¸…é™¤é€‰æ‹©()
      emit('update:activeEntities', 'locations')
      break
    case 'å–½å•°':
      emit('update:active', 'combat')
    break
    default:
      break
  }
}



</script>

<template>
  <div class="dashboard">
    <!-- å®ä½“ç»Ÿè®¡ -->
    <section class="dashboard__section">
      <h3 class="section-title">å†›å›¢æ¦‚å†µ</h3>
      <div class="stat-grid">
        <div v-for="entity in entityCounts" :key="entity.label" class="stat-card" @click="clickTabs(entity.label)">
          <span class="stat-card__icon">{{ entity.icon }}</span>
          <span class="stat-card__value">{{ entity.count }}</span>
          <span class="stat-card__label">{{ entity.label }}</span>
        </div>
      </div>
    </section>

    <!-- å¾…æ‰§è¡Œä»»åŠ¡ -->
    <section class="dashboard__section">
      <h3 class="section-title">å¾…æ‰§è¡Œä»»åŠ¡</h3>
      <div v-if="recentTasks.length === 0" class="empty-hint">
        æš‚æ— ä»»åŠ¡
      </div>
      <div v-else class="task-list">
        <div v-for="task in recentTasks" :key="task.ä»»åŠ¡ID" class="task-item">
          <span class="task-item__name">{{ task.ä»»åŠ¡å }}</span>
          <button class="btn btn--small" @click="store.å–æ¶ˆä»»åŠ¡(task.ä»»åŠ¡ID)">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </section>

    <!-- å¿«æ·æ“ä½œ -->
    <section class="dashboard__section">
      <h3 class="section-title">å¿«æ·æ“ä½œ</h3>
      <div class="quick-actions">
        <button class="btn" @click="store.åˆ‡æ¢é¢æ¿('entities')">
          ç®¡ç†å®ä½“
        </button>
        <button class="btn" @click="store.åˆ‡æ¢é¢æ¿('combat')">
          éƒ¨ç½²æˆ˜æ–—
        </button>
        <button class="btn" @click="store.åˆ‡æ¢é¢æ¿('market')">
          é»‘å¸‚äº¤æ˜“
        </button>
      </div>
    </section>
  </div>
</template>

<style lang="scss" scoped>
.dashboard {
  display: flex;
  flex-direction: column;
  gap: 12px;

  &__section {
    background: var(--bg-tertiary);
    border-radius: 3px;
    padding: 8px;
  }
}

.section-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid var(--border-dark);
}

.stat-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}

.stat-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 4px;
  background: var(--bg-secondary);
  border-radius: 2px;

  &__icon {
    font-size: 20px;
    margin-bottom: 2px;
  }

  &__value {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
  }

  &__label {
    font-size: 18px;
    color: var(--text-dim);
  }
}

.empty-hint {
  font-size: 16px;
  color: var(--text-dim);
  text-align: center;
  padding: 12px;
}

.task-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.task-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 6px;
  background: var(--bg-secondary);
  border-radius: 2px;

  &__name {
    font-size: 16px;
    color: var(--text-primary);
  }
}

.quick-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
</style>

<!-- components/panels/EntitiesPanel.vue -->
<!-- ä»‹ç»ï¼šå®ä½“é¢æ¿ -->
<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useGameStore } from '@/stores/gameStore'
import EntityList from '../entities/EntityList.vue'
import EntityDetail from '../entities/EntityDetail.vue'

const store = useGameStore()

type EntityTab = 'champions' | 'broodmothers' | 'locations'

const props = defineProps<{
  activeEntities: EntityTab
}>()

const activeEntityTab = ref<EntityTab>(props.activeEntities)


const tabs = computed(() => [
  { id: 'champions' as const, label: 'å† å†›', count: store.æ‰€æœ‰å† å†›.length },
  { id: 'broodmothers' as const, label: 'æ¯ç•œ', count: store.æ‰€æœ‰æ¯ç•œ.length },
  { id: 'locations' as const, label: 'åœ°ç‚¹', count: store.æ‰€æœ‰åœ°ç‚¹.length },
])

const showDetail = computed(() => store.é€‰ä¸­å®ä½“ID !== null)

watch(
  () => props.activeEntities,
  (newVal) => {
    activeEntityTab.value = newVal
  }
)
// å¼ºåˆ¶ç»„ä»¶åœ¨å† å†›åˆ—è¡¨å˜åŒ–æ—¶æ›´æ–°
const championsCount = computed(() => store.æ‰€æœ‰å† å†›.length)
const broodmothersCount = computed(() => store.æ‰€æœ‰æ¯ç•œ.length)
const locationsCount = computed(() => store.æ‰€æœ‰åœ°ç‚¹.length)

</script>

<template>
  <div class="entities-panel">
    <!-- å­æ ‡ç­¾ -->
    <div class="entity-tabs">
      <button
        v-for="tab in tabs"
        :key="tab.id"
        class="entity-tab"
        :class="{ 'entity-tab--active': activeEntityTab === tab.id }"
        @click="activeEntityTab = tab.id; store.æ¸…é™¤é€‰æ‹©()"
      >
        {{ tab.label }}
        <span class="entity-tab__count">{{ tab.count }}</span>
      </button>
    </div>

    <div class="entities-panel__body">
      <!-- åˆ—è¡¨ -->
      <div class="entity-list-wrapper" :class="{ 'entity-list-wrapper--narrow': showDetail } " :key="championsCount" >
        <EntityList
          :type="activeEntityTab"
        />
      </div>

      <!-- è¯¦æƒ… -->
      <Transition name="slide">
        <div v-if="showDetail" class="entity-detail-wrapper">
          <EntityDetail />
        </div>
      </Transition>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.entities-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.entity-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 8px;
}

.entity-tab {
  padding: 4px 10px;
  border: 1px solid var(--border-dark);
  border-radius: 2px;
  background: var(--bg-tertiary);
  color: var(--text-dim);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.15s;

  &:hover {
    color: var(--text-secondary);
  }

  &--active {
    background: var(--bg-hover);
    color: var(--text-primary);
    border-color: var(--border-light);
  }

  &__count {
    margin-left: 4px;
    font-size: 15px;
    color: var(--text-dim);
  }
}

.entities-panel__body {
  display: flex;
  gap: 8px;
  flex: 1;
  min-height: 0;
}

.entity-list-wrapper {
  flex: 1;
  overflow-y: auto;
  transition: flex 0.2s;

  &--narrow {
    flex: 0.4;
    min-width: 100px;
  }
}

.entity-detail-wrapper {
  flex: 0.6;
  overflow-y: auto;
  background: var(--bg-tertiary);
  border-radius: 3px;
  padding: 8px;
}

.slide-enter-active,
.slide-leave-active {
  transition: all 0.2s ease;
}

.slide-enter-from,
.slide-leave-to {
  opacity: 0;
  transform: translateX(10px);
}
</style>

<!-- components/panels/MarketPanel.vue -->
<!-- ä»‹ç»ï¼šé»‘å¸‚é¢æ¿ - æ”¹è¿›ç‰ˆï¼Œæ”¯æŒè´­ä¹°æ—¶é€‰æ‹©ç›®æ ‡ -->
<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

type MarketTab = 'goods' | 'slaves'
const activeTab = ref<MarketTab>('goods')

// ç›®æ ‡é€‰æ‹©çŠ¶æ€
const selectingTargetFor = ref<string | null>(null) // å•†å“åæˆ–å¥´éš¶ID
const selectedTarget = ref<string | null>(null)

const marketManager = computed(() => store.æ¸¸æˆå®ä¾‹?.è·å–é»‘å¸‚ç®¡ç†å™¨())

interface GoodsConfig {
  ä»·æ ¼?: number
  æè¿°?: string
  éœ€è¦ç›®æ ‡?: boolean
  ç›®æ ‡ç±»å‹?: string[]
  æ¯å›åˆé™è´­?: number
}

const allGoods = computed(() =>
  marketManager.value?.è·å–æ‰€æœ‰å•†å“å().map(name => {
    const config = marketManager.value?.è·å–å•†å“é…ç½®(name) as GoodsConfig | undefined
    return {
      name,
      config,
      remaining: marketManager.value?.è·å–å•†å“å¯è´­ä¹°æ•°é‡(name) ?? 0,
      needsTarget: config?.éœ€è¦ç›®æ ‡ ?? false
    }
  }) ?? []
)

const slaves = computed(() =>
  marketManager.value?.è·å–å¥´éš¶è´§æ¶() ?? []
)

const currentMilk = computed(() => store.èµ„æºçŠ¶æ€.å‚¬æ·«æ¯ä¹³)

// è·å–å¯é€‰ç›®æ ‡åˆ—è¡¨
const availableTargets = computed(() => {
  if (!selectingTargetFor.value) return []

  // å°è¯•è·å–å•†å“é…ç½®
  const goods = allGoods.value.find(g => g.name === selectingTargetFor.value)
  const targetTypes = goods?.config?.ç›®æ ‡ç±»å‹ ?? ['æ¯ç•œå®ä½“', 'å† å†›å®ä½“']

  const result: { id: string; name: string; type: string; info?: string }[] = []

  if (targetTypes.includes('æ¯ç•œå®ä½“')) {
    store.æ‰€æœ‰æ¯ç•œ.forEach(m => {
      result.push({
        id: m.å®ä½“ID,
        name: m.è·å–å±æ€§('å§“å'),
        type: 'æ¯ç•œ',
        info: `è‡£æœåº¦: ${m.è·å–å±æ€§('è‡£æœåº¦')}`
      })
    })
  }

  if (targetTypes.includes('å† å†›å®ä½“')) {
    store.æ‰€æœ‰å† å†›.forEach(c => {
      result.push({
        id: c.å®ä½“ID,
        name: c.è·å–å±æ€§('å§“å'),
        type: 'å† å†›'
      })
    })
  }

  if (targetTypes.includes('åœ°ç‚¹å®ä½“')) {
    store.æ‰€æœ‰åœ°ç‚¹.forEach(l => {
      result.push({
        id: l.å®ä½“ID,
        name: l.åœ°ç‚¹åç§°,
        type: 'åœ°ç‚¹'
      })
    })
  }

  return result
})

// æ£€æŸ¥å•†å“æ˜¯å¦éœ€è¦ç›®æ ‡
function checkAndBuyGoods(goodsName: string) {
  const goods = allGoods.value.find(g => g.name === goodsName)
  if (goods?.needsTarget) {
    selectingTargetFor.value = goodsName
    selectedTarget.value = null
  } else {
    store.è´­ä¹°å•†å“(goodsName, 1)
  }
}

// ç¡®è®¤è´­ä¹°ï¼ˆå¸¦ç›®æ ‡ï¼‰
function confirmPurchase() {
  if (!selectingTargetFor.value) return

  // gameStoreæ–¹æ³•ï¼šè´­ä¹°å•†å“å¹¶æŒ‡å®šç›®æ ‡
  store.è´­ä¹°å•†å“(selectingTargetFor.value, 1, selectedTarget.value ?? undefined)

  selectingTargetFor.value = null
  selectedTarget.value = null
}

// å–æ¶ˆé€‰æ‹©
function cancelSelection() {
  selectingTargetFor.value = null
  selectedTarget.value = null
}

function buySlave(slaveId: string) {
  store.è´­ä¹°å¥´éš¶(slaveId)
}
</script>

<template>
  <div class="market-panel">
    <!-- å½“å‰èµ„æº -->
    <div class="resource-display">
      <span class="resource-icon">âœ¦</span>
      <span class="resource-label">å‚¬æ·«æ¯ä¹³:</span>
      <span class="resource-value">{{ currentMilk }}</span>
    </div>

    <!-- ç›®æ ‡é€‰æ‹©å¼¹å±‚ -->
    <div v-if="selectingTargetFor" class="target-selection-overlay">
      <div class="target-selection-modal">
        <div class="modal-header">
          <h4>é€‰æ‹©ä½¿ç”¨ç›®æ ‡</h4>
          <span class="modal-subtitle">{{ selectingTargetFor }}</span>
        </div>

        <div class="target-list">
          <button
            v-for="target in availableTargets"
            :key="target.id"
            class="target-option"
            :class="{ 'target-option--selected': selectedTarget === target.id }"
            @click="selectedTarget = target.id"
          >
            <div class="target-main">
              <span class="target-type">[{{ target.type }}]</span>
              <span class="target-name">{{ target.name }}</span>
            </div>
            <span v-if="target.info" class="target-info">{{ target.info }}</span>
          </button>
          <div v-if="availableTargets.length === 0" class="no-target">
            æ— å¯ç”¨ç›®æ ‡
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" @click="cancelSelection">å–æ¶ˆ</button>
          <button
            class="btn btn--primary"
            @click="confirmPurchase"
            :disabled="!selectedTarget"
          >
            ç¡®è®¤è´­ä¹°
          </button>
        </div>
      </div>
    </div>

    <!-- å­æ ‡ç­¾ -->
    <div class="market-tabs">
      <button
        class="market-tab"
        :class="{ 'market-tab--active': activeTab === 'goods' }"
        @click="activeTab = 'goods'"
      >
        å¸¸é©»å•†å“
      </button>
      <button
        class="market-tab"
        :class="{ 'market-tab--active': activeTab === 'slaves' }"
        @click="activeTab = 'slaves'"
      >
        å¥´éš¶ ({{ slaves.length }})
      </button>
    </div>

    <!-- å•†å“åˆ—è¡¨ -->
    <div v-if="activeTab === 'goods'" class="goods-list">
      <div
        v-for="goods in allGoods"
        :key="goods.name"
        class="goods-item"
      >
        <div class="goods-item__info">
          <div class="goods-header">
            <span class="goods-name">{{ goods.name }}</span>
            <span v-if="goods.needsTarget" class="needs-target-badge">éœ€ç›®æ ‡</span>
          </div>
          <span class="goods-desc">{{ goods.config?.æè¿° }}</span>
          <span class="goods-meta">
            ä»·æ ¼: {{ goods.config?.ä»·æ ¼ }} Â· å‰©ä½™: {{ goods.remaining === Infinity ? 'âˆ' : goods.remaining }}
          </span>
        </div>
        <button
          class="btn btn--small"
          :disabled="currentMilk < (goods.config?.ä»·æ ¼ ?? 0) || goods.remaining <= 0"
          @click="checkAndBuyGoods(goods.name)"
        >
          {{ goods.needsTarget ? 'é€‰æ‹©ç›®æ ‡' : 'è´­ä¹°' }}
        </button>
      </div>
    </div>

    <!-- å¥´éš¶åˆ—è¡¨ -->
    <div v-else class="slave-list">
      <div v-if="slaves.length === 0" class="empty-hint">
        æœ¬å‘¨æ— å¥´éš¶å‡ºå”®
      </div>

      <div
        v-for="slave in slaves"
        :key="slave.å•†å“ID"
        class="slave-item"
      >
        <div class="slave-item__info">
          <span class="slave-name">{{ slave.æ¯ç•œå®ä½“.è·å–å±æ€§('å§“å') }}</span>
          <span class="slave-detail">
            {{ slave.æ¯ç•œå®ä½“.è·å–å±æ€§('ç§æ—') }} Â·
            {{ slave.æ¯ç•œå®ä½“.è·å–å±æ€§('åŸèº«ä»½') }}
          </span>
          <span class="slave-stats">
            è‚²åŠ›: {{ slave.æ¯ç•œå®ä½“.è·å–å±æ€§('æ€»ç”Ÿè‚²åŠ›') }} Â·
            é­…åŠ›: {{ slave.æ¯ç•œå®ä½“.è·å–å±æ€§('é­…åŠ›') }}
          </span>
        </div>
        <div class="slave-item__action">
          <span class="slave-price">âœ¦ {{ slave.ä»·æ ¼ }}</span>
          <button
            class="btn btn--small btn--primary"
            :disabled="currentMilk < slave.ä»·æ ¼"
            @click="buySlave(slave.å•†å“ID)"
          >
            è´­ä¹°
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.market-panel {
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: relative;
}

.resource-display {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 10px;
  background: var(--bg-tertiary);
  border-radius: 3px;

  .resource-icon {
    color: var(--accent-corrupt);
  }

  .resource-label {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .resource-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-corrupt);
  }
}

/* ç›®æ ‡é€‰æ‹©å¼¹å±‚ */
.target-selection-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  border-radius: 3px;
}

.target-selection-modal {
  width: 90%;
  max-width: 300px;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: 4px;
  overflow: hidden;
}

.modal-header {
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-dark);

  h4 {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin: 0;
  }

  .modal-subtitle {
    font-size: 12px;
    color: var(--accent-gold);
  }
}

.target-list {
  padding: 10px;
  max-height: 200px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.target-option {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 2px;
  padding: 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-dark);
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: left;
  width: 100%;

  &:hover {
    background: var(--bg-hover);
  }

  &--selected {
    background: var(--bg-hover);
    border-color: var(--accent-corrupt);
  }
}

.target-main {
  display: flex;
  align-items: center;
  gap: 6px;
}

.target-type {
  font-size: 11px;
  color: var(--text-dim);
}

.target-name {
  font-size: 13px;
  color: var(--text-primary);
}

.target-info {
  font-size: 11px;
  color: var(--text-dim);
}

.no-target {
  font-size: 13px;
  color: var(--text-dim);
  text-align: center;
  padding: 20px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-dark);
}

.market-tabs {
  display: flex;
  gap: 4px;
}

.market-tab {
  flex: 1;
  padding: 6px;
  border: 1px solid var(--border-dark);
  border-radius: 2px;
  background: var(--bg-tertiary);
  color: var(--text-dim);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;

  &:hover {
    color: var(--text-secondary);
  }

  &--active {
    background: var(--bg-hover);
    color: var(--text-primary);
    border-color: var(--border-light);
  }
}

.goods-list,
.slave-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.goods-item,
.slave-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 10px;
  background: var(--bg-tertiary);
  border-radius: 3px;

  &__info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
    min-width: 0;
  }
}

.goods-header {
  display: flex;
  align-items: center;
  gap: 6px;
}

.goods-name,
.slave-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.needs-target-badge {
  font-size: 10px;
  padding: 1px 4px;
  background: rgba(190, 149, 85, 0.3);
  color: var(--accent-gold);
  border-radius: 2px;
}

.goods-desc {
  font-size: 12px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.goods-meta {
  font-size: 11px;
  color: var(--text-dim);
}

.slave-detail {
  font-size: 12px;
  color: var(--text-secondary);
}

.slave-stats {
  font-size: 11px;
  color: var(--text-dim);
}

.slave-item__action {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
}

.slave-price {
  font-size: 13px;
  color: var(--accent-corrupt);
  font-weight: 500;
}

.empty-hint {
  font-size: 13px;
  color: var(--text-dim);
  text-align: center;
  padding: 20px;
}
</style>

<!-- components/panels/MinionPanel.vue -->
<!-- ä»‹ç»ï¼šå–½å•°ç®¡ç†é¢æ¿ï¼Œç”¨äºåˆ†é…å„å°†é¢†çš„å–½å•°æ•°é‡ -->
<script setup lang="ts">
import { computed } from 'vue'
import { useGameStore } from '@/stores/gameStore'

const store = useGameStore()

// è·å–æ‰€æœ‰å† å†›åŠå…¶å–½å•°æ± ä¿¡æ¯
const championMinionData = computed(() => {
  store.æ£€æŸ¥çŠ¶æ€æ›´æ–°()
  return store.æ‰€æœ‰å† å†›.map(champion => {
    const pool = champion.è·å–å–½å•°æ± ()
    return {
      id: champion.å®ä½“ID,
      name: champion.è·å–å±æ€§('å§“å'),
      current: pool?.è·å–æ€»æ•°é‡() ?? 0,
      max: pool?.è·å–æœ€å¤§æ•°é‡() ?? 0,
      power: pool?.è·å–æˆ˜æ–—åŠ›() ?? 0
    }
  })
})

// æ€»å–½å•°ä¿¡æ¯
const totalMinionInfo = computed(() => {
  store.æ£€æŸ¥çŠ¶æ€æ›´æ–°()
  const total = store.å–½å•°æ€»æ•°
  const allocated = championMinionData.value.reduce((sum, c) => sum + c.current, 0)
  const unallocated = total - allocated
  return { total, allocated, unallocated }
})

// è‡ªåŠ¨åˆ†é…å–½å•° - æŒ‰å„å°†é¢†æœ€å¤§å®¹é‡æ¯”ä¾‹åˆ†é…
function autoDistribute() {
  // gameStoreæ–¹æ³•ï¼šå°†æœªåˆ†é…å–½å•°æŒ‰æ¯”ä¾‹åˆ†é…ç»™æ‰€æœ‰å°†é¢†
  store.è‡ªåŠ¨åˆ†é…å–½å•°()
}

// æ¸…ç©ºæŸå°†é¢†å–½å•°
function clearMinions(championId: string) {
  // gameStoreæ–¹æ³•ï¼šå°†æŒ‡å®šå°†é¢†çš„å–½å•°å…¨éƒ¨ç§»é™¤ï¼ˆè¿”å›æœªåˆ†é…æ± ï¼‰
  store.æ¸…ç©ºå°†é¢†å–½å•°(championId)
}

// å¡«æ»¡æŸå°†é¢†å–½å•°
function fillMinions(championId: string) {
  // gameStoreæ–¹æ³•ï¼šç”¨æœªåˆ†é…å–½å•°å¡«æ»¡æŒ‡å®šå°†é¢†çš„å–½å•°æ± 
  store.å¡«æ»¡å°†é¢†å–½å•°(championId)
}

// æ¸…ç©ºæ‰€æœ‰å°†é¢†å–½å•°
function clearAll() {
  // gameStoreæ–¹æ³•ï¼šæ¸…ç©ºæ‰€æœ‰å°†é¢†çš„å–½å•°
  store.æ¸…ç©ºæ‰€æœ‰å–½å•°()
}

// è°ƒæ•´å–½å•°æ•°é‡
function adjustMinions(championId: string, delta: number) {
  // gameStoreæ–¹æ³•ï¼šå¢å‡æŒ‡å®šå°†é¢†çš„å–½å•°æ•°é‡
  store.è°ƒæ•´å°†é¢†å–½å•°(championId, delta)
}
</script>

<template>
  <div class="minion-panel">
    <!-- æ€»è§ˆä¿¡æ¯ -->
    <section class="panel-section overview-section">
      <h3 class="section-title">å–½å•°æ€»è§ˆ</h3>
      <div class="overview-stats">
        <div class="overview-stat">
          <span class="stat-icon">â˜ </span>
          <div class="stat-info">
            <span class="stat-value">{{ totalMinionInfo.total }}</span>
            <span class="stat-label">æ€»æ•°</span>
          </div>
        </div>
        <div class="overview-stat">
          <span class="stat-icon">âš”</span>
          <div class="stat-info">
            <span class="stat-value">{{ totalMinionInfo.allocated }}</span>
            <span class="stat-label">å·²åˆ†é…</span>
          </div>
        </div>
        <div class="overview-stat">
          <span class="stat-icon">â—‡</span>
          <div class="stat-info">
            <span class="stat-value highlight">{{ totalMinionInfo.unallocated }}</span>
            <span class="stat-label">å¾…åˆ†é…</span>
          </div>
        </div>
      </div>

      <div class="global-actions">
        <button
          class="btn btn--primary"
          @click="autoDistribute"
          :disabled="totalMinionInfo.unallocated <= 0"
        >
          <span class="btn-icon">âš¡</span> è‡ªåŠ¨åˆ†é…
        </button>
        <button
          class="btn"
          @click="clearAll"
          :disabled="totalMinionInfo.allocated <= 0"
        >
          <span class="btn-icon">â†º</span> å…¨éƒ¨æ¸…ç©º
        </button>
      </div>
    </section>

    <!-- å°†é¢†å–½å•°åˆ—è¡¨ -->
    <section class="panel-section">
      <h3 class="section-title">å°†é¢†åˆ†é…</h3>

      <div v-if="championMinionData.length === 0" class="empty-hint">
        æš‚æ— å°†é¢†
      </div>

      <div v-else class="champion-list">
        <div
          v-for="champion in championMinionData"
          :key="champion.id"
          class="champion-minion-card"
        >
          <div class="card-header">
            <span class="champion-name">{{ champion.name }}</span>
            <span class="champion-power">
              <span class="power-icon">âš”</span>
              {{ Math.round(champion.power) }}
            </span>
          </div>

          <div class="minion-bar-wrapper">
            <div class="minion-bar">
              <div
                class="minion-bar__fill"
                :style="{ width: (champion.current / champion.max * 100) + '%' }"
              />
            </div>
            <span class="minion-count">{{ champion.current }} / {{ champion.max }}</span>
          </div>

          <div class="card-controls">
            <div class="adjust-controls">
              <button
                class="adjust-btn"
                @click="adjustMinions(champion.id, -10)"
                :disabled="champion.current < 10"
              >-10</button>
              <button
                class="adjust-btn"
                @click="adjustMinions(champion.id, -1)"
                :disabled="champion.current <= 0"
              >-1</button>
              <button
                class="adjust-btn"
                @click="adjustMinions(champion.id, 1)"
                :disabled="champion.current >= champion.max || totalMinionInfo.unallocated <= 0"
              >+1</button>
              <button
                class="adjust-btn"
                @click="adjustMinions(champion.id, 10)"
                :disabled="champion.current >= champion.max || totalMinionInfo.unallocated < 10"
              >+10</button>
            </div>

            <div class="quick-controls">
              <button
                class="btn btn--small"
                @click="clearMinions(champion.id)"
                :disabled="champion.current <= 0"
              >æ¸…ç©º</button>
              <button
                class="btn btn--small btn--accent"
                @click="fillMinions(champion.id)"
                :disabled="champion.current >= champion.max || totalMinionInfo.unallocated <= 0"
              >å¡«æ»¡</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- å–½å•°æ¥æºæç¤º -->
    <section class="panel-section hint-section">
      <div class="hint-row">
        <span class="hint-icon">ğŸ’¡</span>
        <span class="hint-text">å–½å•°å¯é€šè¿‡è¢­å‡»æ‘åº„ã€é»‘å¸‚è´­ä¹°æˆ–æ¯ç•œç¹æ®–è·å–</span>
      </div>
    </section>
  </div>
</template>

<style lang="scss" scoped>
.minion-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.panel-section {
  background: var(--bg-tertiary);
  border-radius: 3px;
  padding: 10px;
}

.section-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border-dark);
}

.overview-section {
  background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(139,38,53,0.1) 100%);
}

.overview-stats {
  display: flex;
  justify-content: space-around;
  margin-bottom: 12px;
}

.overview-stat {
  display: flex;
  align-items: center;
  gap: 8px;
}

.stat-icon {
  font-size: 24px;
  opacity: 0.8;
}

.stat-info {
  display: flex;
  flex-direction: column;
}

.stat-value {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);

  &.highlight {
    color: var(--accent-gold);
  }
}

.stat-label {
  font-size: 12px;
  color: var(--text-dim);
}

.global-actions {
  display: flex;
  gap: 8px;
  justify-content: center;
}

.btn-icon {
  margin-right: 4px;
}

.champion-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.champion-minion-card {
  background: var(--bg-secondary);
  border-radius: 3px;
  padding: 10px;
  border: 1px solid var(--border-dark);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.champion-name {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

.champion-power {
  font-size: 13px;
  color: var(--accent-blood-light);
  display: flex;
  align-items: center;
  gap: 3px;
}

.power-icon {
  font-size: 12px;
}

.minion-bar-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}

.minion-bar {
  flex: 1;
  height: 8px;
  background: var(--bg-primary);
  border-radius: 4px;
  overflow: hidden;

  &__fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-poison) 0%, var(--accent-corrupt) 100%);
    transition: width 0.3s ease;
    border-radius: 4px;
  }
}

.minion-count {
  font-size: 13px;
  color: var(--text-secondary);
  min-width: 60px;
  text-align: right;
}

.card-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.adjust-controls {
  display: flex;
  gap: 4px;
}

.adjust-btn {
  padding: 4px 8px;
  font-size: 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-dark);
  border-radius: 2px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;

  &:hover:not(:disabled) {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  &:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
}

.quick-controls {
  display: flex;
  gap: 4px;
}

.btn--accent {
  background: rgba(107, 74, 124, 0.3);
  border-color: var(--accent-corrupt);

  &:hover:not(:disabled) {
    background: rgba(107, 74, 124, 0.5);
  }
}

.hint-section {
  background: rgba(74, 92, 138, 0.1);
  border: 1px dashed var(--accent-mana);
}

.hint-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.hint-icon {
  font-size: 16px;
}

.hint-text {
  font-size: 13px;
  color: var(--text-dim);
}

.empty-hint {
  font-size: 14px;
  color: var(--text-dim);
  text-align: center;
  padding: 20px;
}
</style>

<!-- components/panels/TasksPanel.vue -->
<!-- ä»‹ç»ï¼šä»»åŠ¡é¢æ¿ - æ”¹è¿›ç‰ˆï¼Œæ”¯æŒä»»åŠ¡ç›®æ ‡é€‰æ‹©å’Œä»»åŠ¡è¯¦æƒ…æ˜¾ç¤º -->
<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useGameStore } from '@/stores/gameStore'
import { æ¯ç•œå®ä½“ } from '@/core/entities';

const store = useGameStore()

// ä»»åŠ¡é…ç½®ç±»å‹
interface TaskConfig {
  æè¿°?: string
  è¡ŒåŠ¨åŠ›æ¶ˆè€—?: number
  éœ€è¦ç›®æ ‡?: boolean
  æ‰§è¡Œäººå®ä½“ç±»å‹?: string[]
  ç›®æ ‡å®ä½“ç±»å‹?: string[]
}

const availableTasks = computed(() => {
  const taskManager = store.æ¸¸æˆå®ä¾‹?.è·å–ä»»åŠ¡ç®¡ç†å™¨()
  if (!taskManager) return []

  return taskManager.è·å–æ‰€æœ‰ä»»åŠ¡å().map(name => ({
    name,
    config: taskManager.è·å–ä»»åŠ¡é…ç½®(name) as TaskConfig | undefined
  }))
})

const selectedTask = ref<string | null>(null)
const selectedExecutor = ref<string | null>(null)
const selectedTarget = ref<string | null>(null)

// å½“å‰é€‰ä¸­ä»»åŠ¡çš„é…ç½®
const currentTaskConfig = computed(() => {
  if (!selectedTask.value) return null
  return availableTasks.value.find(t => t.name === selectedTask.value)?.config ?? null
})

// æ˜¯å¦éœ€è¦ç›®æ ‡
const needsTarget = computed(() => {
  return currentTaskConfig.value?.éœ€è¦ç›®æ ‡ ?? false
})

// æ ¹æ®ä»»åŠ¡é…ç½®ç­›é€‰å¯ç”¨æ‰§è¡Œäºº
const executors = computed(() => {
  if (!selectedTask.value || !currentTaskConfig.value) return []

  const allowedTypes = currentTaskConfig.value.æ‰§è¡Œäººå®ä½“ç±»å‹ ?? ['å† å†›å®ä½“', 'æ¯ç•œå®ä½“']
  const result: { id: string; name: string; type: string; busy: boolean }[] = []

  if (allowedTypes.includes('å† å†›å®ä½“')) {
    store.æ‰€æœ‰å† å†›.forEach(c => {
      result.push({
        id: c.å®ä½“ID,
        name: c.è·å–å±æ€§('å§“å'),
        type: 'å† å†›',
        busy: store.æ£€æŸ¥å®ä½“æ˜¯å¦æœ‰ä»»åŠ¡(c.å®ä½“ID)
      })
    })
  }

  if (allowedTypes.includes('æ¯ç•œå®ä½“')) {
    store.æ‰€æœ‰æ¯ç•œ.forEach(m => {
      result.push({
        id: m.å®ä½“ID,
        name: m.è·å–å±æ€§('å§“å'),
        type: 'æ¯ç•œ',
        busy: store.æ£€æŸ¥å®ä½“æ˜¯å¦æœ‰ä»»åŠ¡(m.å®ä½“ID)
      })
    })
  }

  return result
})

// æ ¹æ®ä»»åŠ¡é…ç½®ç­›é€‰å¯ç”¨ç›®æ ‡
const targets = computed(() => {
  if (!selectedTask.value || !currentTaskConfig.value || !needsTarget.value) return []

  const allowedTypes = currentTaskConfig.value.ç›®æ ‡å®ä½“ç±»å‹ ?? ['æ¯ç•œå®ä½“', 'åœ°ç‚¹å®ä½“']
  const result: { id: string; name: string; type: string; info?: string }[] = []

  if (allowedTypes.includes('æ¯ç•œå®ä½“')) {
    store.æ‰€æœ‰æ¯ç•œ.forEach(m => {
      result.push({
        id: m.å®ä½“ID,
        name: m.è·å–å±æ€§('å§“å'),
        type: 'æ¯ç•œ',
        info: `è‡£æœåº¦: ${m.è·å–å±æ€§('è‡£æœåº¦')}`
      })
    })
  }

  if (allowedTypes.includes('åœ°ç‚¹å®ä½“')) {
    store.æ‰€æœ‰åœ°ç‚¹.forEach(l => {
      result.push({
        id: l.å®ä½“ID,
        name: l.åœ°ç‚¹åç§°,
        type: 'åœ°ç‚¹',
        info: l.åœ°ç‚¹ç±»å‹
      })
    })
  }

  if (allowedTypes.includes('å† å†›å®ä½“')) {
    store.æ‰€æœ‰å† å†›.forEach(c => {
      result.push({
        id: c.å®ä½“ID,
        name: c.è·å–å±æ€§('å§“å'),
        type: 'å† å†›'
      })
    })
  }

  return result
})

// é‡ç½®é€‰æ‹©
watch(selectedTask, () => {
  selectedExecutor.value = null
  selectedTarget.value = null
})

// æ˜¯å¦å¯ä»¥å‘å¸ƒ
const canPublish = computed(() => {
  if (!selectedTask.value || !selectedExecutor.value) return false
  if (needsTarget.value && !selectedTarget.value) return false
  return true
})

function publishTask() {
  if (!canPublish.value) return

  store.å‘å¸ƒä»»åŠ¡(
    selectedTask.value!,
    selectedExecutor.value!,
    selectedTarget.value ?? undefined
  )

  // é‡ç½®é€‰æ‹©
  selectedTask.value = null
  selectedExecutor.value = null
  selectedTarget.value = null
}
</script>

<template>
  <div class="tasks-panel">
    <!-- ä»»åŠ¡å‘å¸ƒ -->
    <section class="panel-section">
      <h3 class="section-title">å‘å¸ƒä»»åŠ¡</h3>

      <!-- ä»»åŠ¡é€‰æ‹© -->
      <div class="form-group">
        <label>ä»»åŠ¡ç±»å‹</label>
        <div class="task-select-grid">
          <button
            v-for="task in availableTasks"
            :key="task.name"
            class="task-option"
            :class="{ 'task-option--selected': selectedTask === task.name }"
            @click="selectedTask = task.name"
          >
            <span class="task-option__name">{{ task.name }}</span>
            <span v-if="task.config?.éœ€è¦ç›®æ ‡" class="task-option__tag">éœ€ç›®æ ‡</span>
          </button>
        </div>
      </div>

      <!-- ä»»åŠ¡è¯¦æƒ… -->
      <div v-if="currentTaskConfig" class="task-info-box">
        <div class="task-info-row">
          <span class="info-label">æè¿°:</span>
          <span class="info-value">{{ currentTaskConfig.æè¿° || 'æ— æè¿°' }}</span>
        </div>
        <div class="task-info-row">
          <span class="info-label">è¡ŒåŠ¨åŠ›:</span>
          <span class="info-value">{{ currentTaskConfig.è¡ŒåŠ¨åŠ›æ¶ˆè€— ?? 1 }}</span>
        </div>
        <div v-if="needsTarget" class="task-info-row">
          <span class="info-label warn">âš  æ­¤ä»»åŠ¡éœ€è¦æŒ‡å®šç›®æ ‡</span>
        </div>
      </div>

      <!-- æ‰§è¡Œäººé€‰æ‹© -->
      <div v-if="selectedTask" class="form-group">
        <label>æ‰§è¡Œäºº</label>
        <div class="executor-list">
          <button
            v-for="exec in executors"
            :key="exec.id"
            class="executor-option"
            :class="{
              'executor-option--selected': selectedExecutor === exec.id,
              'executor-option--busy': exec.busy
            }"
            :disabled="exec.busy"
            @click="selectedExecutor = exec.id"
          >
            <span class="executor-type">[{{ exec.type }}]</span>
            <span class="executor-name">{{ exec.name }}</span>
            <span v-if="exec.busy" class="executor-busy">å¿™ç¢Œ</span>
          </button>
        </div>
        <span v-if="executors.length === 0" class="no-data">æ— å¯ç”¨æ‰§è¡Œäºº</span>
      </div>

      <!-- ç›®æ ‡é€‰æ‹© -->
      <div v-if="selectedTask && selectedExecutor && needsTarget" class="form-group">
        <label>
          ç›®æ ‡
          <span class="required-mark">*å¿…é€‰</span>
        </label>
        <div class="target-list">
          <button
            v-for="target in targets"
            :key="target.id"
            class="target-option"
            :class="{ 'target-option--selected': selectedTarget === target.id }"
            @click="selectedTarget = target.id"
          >
            <div class="target-main">
              <span class="target-type">[{{ target.type }}]</span>
              <span class="target-name">{{ target.name }}</span>
            </div>
            <span v-if="target.info" class="target-info">{{ target.info }}</span>
          </button>
        </div>
        <span v-if="targets.length === 0" class="no-data">æ— å¯ç”¨ç›®æ ‡</span>
      </div>

      <button
        class="btn btn--primary publish-btn"
        :disabled="!canPublish"
        @click="publishTask"
      >
        <span v-if="!selectedTask">è¯·é€‰æ‹©ä»»åŠ¡</span>
        <span v-else-if="!selectedExecutor">è¯·é€‰æ‹©æ‰§è¡Œäºº</span>
        <span v-else-if="needsTarget && !selectedTarget">è¯·é€‰æ‹©ç›®æ ‡</span>
        <span v-else>å‘å¸ƒä»»åŠ¡</span>
      </button>
    </section>

    <!-- å·²å‘å¸ƒä»»åŠ¡ -->
    <section class="panel-section">
      <h3 class="section-title">å·²å‘å¸ƒä»»åŠ¡ ({{ store.å·²å‘å¸ƒä»»åŠ¡åˆ—è¡¨.length }})</h3>

      <div v-if="store.å·²å‘å¸ƒä»»åŠ¡åˆ—è¡¨.length === 0" class="empty-hint">
        æš‚æ— å¾…æ‰§è¡Œä»»åŠ¡
      </div>

      <div v-else class="task-queue">
        <div
          v-for="task in store.å·²å‘å¸ƒä»»åŠ¡åˆ—è¡¨"
          :key="task.ä»»åŠ¡ID"
          class="task-queue-item"
        >
          <div class="task-queue-item__info">
            <span class="task-name">{{ task.ä»»åŠ¡å }}</span>
            <span class="task-meta">
              æ‰§è¡Œäºº: {{ store.è·å–å§“å(task.æ‰§è¡ŒäººID) || 'æœªçŸ¥' }}
              <template v-if="task.ç›®æ ‡ID">
                â†’ ç›®æ ‡: {{ store.è·å–å§“å(task.æ‰§è¡ŒäººID) }}
              </template>
            </span>
            <span class="task-ap">è¡ŒåŠ¨åŠ›: {{ task.è¡ŒåŠ¨åŠ›å ç”¨ }}</span>
          </div>
          <button
            class="btn btn--small btn--danger"
            @click="store.å–æ¶ˆä»»åŠ¡(task.ä»»åŠ¡ID)"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </section>
  </div>
</template>

<style lang="scss" scoped>
.tasks-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.panel-section {
  background: var(--bg-tertiary);
  border-radius: 3px;
  padding: 10px;
}

.section-title {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border-dark);
}

.form-group {
  margin-bottom: 12px;

  label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
}

.required-mark {
  font-size: 11px;
  color: var(--accent-blood-light);
  background: rgba(139,38,53,0.2);
  padding: 1px 4px;
  border-radius: 2px;
}

.task-select-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.task-option {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-dark);
  border-radius: 3px;
  color: var(--text-secondary);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;

  &:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  &--selected {
    background: var(--bg-hover);
    border-color: var(--accent-blood);
    color: var(--text-primary);
  }

  &__tag {
    font-size: 10px;
    padding: 1px 4px;
    background: rgba(190, 149, 85, 0.3);
    color: var(--accent-gold);
    border-radius: 2px;
  }
}

.task-info-box {
  background: var(--bg-secondary);
  border: 1px solid var(--border-dark);
  border-radius: 3px;
  padding: 8px;
  margin-bottom: 12px;
}

.task-info-row {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 4px;

  &:last-child {
    margin-bottom: 0;
  }

  .info-label {
    color: var(--text-dim);
    margin-right: 6px;

    &.warn {
      color: var(--warning);
    }
  }
}

.executor-list,
.target-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 120px;
  overflow-y: auto;
}

.executor-option,
.target-option {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-dark);
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: left;

  &:hover:not(:disabled) {
    background: var(--bg-hover);
  }

  &--selected {
    background: var(--bg-hover);
    border-color: var(--accent-mana);
  }

  &--busy {
    opacity: 0.5;
    cursor: not-allowed;
  }
}

.executor-type,
.target-type {
  font-size: 11px;
  color: var(--text-dim);
}

.executor-name,
.target-name {
  font-size: 13px;
  color: var(--text-primary);
}

.executor-busy {
  margin-left: auto;
  font-size: 11px;
  color: var(--warning);
}

.target-option {
  flex-direction: column;
  align-items: flex-start;
}

.target-main {
  display: flex;
  align-items: center;
  gap: 6px;
}

.target-info {
  font-size: 11px;
  color: var(--text-dim);
}

.no-data {
  font-size: 12px;
  color: var(--text-dim);
  padding: 8px;
}

.publish-btn {
  width: 100%;
  padding: 8px;
}

.empty-hint {
  font-size: 13px;
  color: var(--text-dim);
  text-align: center;
  padding: 16px;
}

.task-queue {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.task-queue-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px;
  background: var(--bg-secondary);
  border-radius: 2px;

  &__info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
}

.task-name {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
}

.task-meta {
  font-size: 12px;
  color: var(--text-secondary);
}

.task-ap {
  font-size: 11px;
  color: var(--text-dim);
}

.btn--danger {
  border-color: var(--danger);
  color: var(--danger);

  &:hover {
    background: rgba(139, 38, 53, 0.2);
  }
}
</style>

