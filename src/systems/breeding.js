// ═══════════════════════════════════════════════════════════════
// systems/breeding.js
// 繁殖系统 - 管理母畜生育冠军和喽啰
// ═══════════════════════════════════════════════════════════════

/**
 * 繁殖系统
 * 管理母畜的生育功能，包括生育冠军和喽啰
 */
class 繁殖系统 {
  constructor(事件总线, 冠军工厂, 喽啰池, 属性注册表 = null) {
    this.事件总线 = 事件总线;
    this.冠军工厂 = 冠军工厂;
    this.喽啰池 = 喽啰池;
    this.属性注册表 = 属性注册表;

    // 生育配置
    this.配置 = {
      冠军消耗雌性价值: 100,
      喽啰消耗雌性价值: 100,
      喽啰产出基础: 10,
      每点价值产出喽啰: 0.1, // 不足100时，每10点产1喽啰
      生育淫乱度增加: 8,
    };

    // 生育历史
    this.生育历史 = [];
    this.历史上限 = 100;

    // 生育统计
    this.统计 = {
      总生育冠军数: 0,
      总生育喽啰数: 0,
    };
  }

  // ─── 配置方法 ───

  设置配置(新配置) {
    Object.assign(this.配置, 新配置);
  }

  设置冠军工厂(工厂) {
    this.冠军工厂 = 工厂;
  }

  设置喽啰池(池) {
    this.喽啰池 = 池;
  }

  设置属性注册表(注册表) {
    this.属性注册表 = 注册表;
  }

  // ─── 生育验证 ───

  验证可生育冠军(母畜) {
    /**
     * 验证母畜是否可以生育冠军
     */
    const 剩余价值 = 母畜.获取属性('剩余雌性价值');

    if (剩余价值 < this.配置.冠军消耗雌性价值) {
      return {
        可生育: false,
        原因: '剩余雌性价值不足',
        当前: 剩余价值,
        需要: this.配置.冠军消耗雌性价值,
      };
    }

    return { 可生育: true };
  }

  验证可生育喽啰(母畜) {
    /**
     * 验证母畜是否可以生育喽啰
     */
    const 剩余价值 = 母畜.获取属性('剩余雌性价值');

    if (剩余价值 <= 0) {
      return {
        可生育: false,
        原因: '剩余雌性价值已耗尽',
        当前: 0,
      };
    }

    return { 可生育: true };
  }

  // ─── 生育冠军 ───

  生育冠军(母畜, 选项 = {}) {
    /**
     * 母畜生育一名冠军
     * @returns { 成功, 冠军?, 原因? }
     */
    // 验证
    const 验证结果 = this.验证可生育冠军(母畜);
    if (!验证结果.可生育) {
      return { 成功: false, ...验证结果 };
    }

    // 消耗雌性价值
    const 消耗结果 = 母畜.消耗雌性价值(this.配置.冠军消耗雌性价值);
    if (!消耗结果.成功) {
      return { 成功: false, 原因: '消耗雌性价值失败' };
    }

    // 增加淫乱度
    母畜.修改属性('淫乱度', this.配置.生育淫乱度增加, this.属性注册表);

    // 生成冠军
    const 生育结果 = this.冠军工厂.从母畜生育(母畜, 选项);

    if (!生育结果.成功) {
      // 回滚雌性价值消耗（理论上不应该发生）
      母畜.修改属性('剩余雌性价值', this.配置.冠军消耗雌性价值);
      return { 成功: false, 原因: 生育结果.原因 };
    }

    const 新冠军 = 生育结果.冠军;

    // 记录母畜生育记录
    母畜.记录生育冠军?.(新冠军.实体ID, 新冠军.获取属性('姓名'));

    // 记录系统历史
    this.记录生育历史({
      类型: '生育冠军',
      母畜ID: 母畜.实体ID,
      母畜姓名: 母畜.获取属性('姓名'),
      冠军ID: 新冠军.实体ID,
      冠军姓名: 新冠军.获取属性('姓名'),
      消耗雌性价值: this.配置.冠军消耗雌性价值,
      冠军属性: {
        力量: 新冠军.获取属性('力量'),
        敏捷: 新冠军.获取属性('敏捷'),
        智力: 新冠军.获取属性('智力'),
      },
    });

    // 更新统计
    this.统计.总生育冠军数++;

    // 发布事件
    this.事件总线.发布('冠军诞生', {
      冠军: 新冠军,
      母畜ID: 母畜.实体ID,
      母畜姓名: 母畜.获取属性('姓名'),
    });

    return {
      成功: true,
      冠军: 新冠军,
      消耗雌性价值: this.配置.冠军消耗雌性价值,
      淫乱度增加: this.配置.生育淫乱度增加,
      剩余雌性价值: 母畜.获取属性('剩余雌性价值'),
    };
  }

  // ─── 生育喽啰 ───

  生育喽啰(母畜, 选项 = {}) {
    /**
     * 母畜生育喽啰
     * @returns { 成功, 产出数量?, 原因? }
     */
    // 验证
    const 验证结果 = this.验证可生育喽啰(母畜);
    if (!验证结果.可生育) {
      return { 成功: false, ...验证结果 };
    }

    const 剩余价值 = 母畜.获取属性('剩余雌性价值');
    let 实际消耗;
    let 实际产出;

    if (剩余价值 >= this.配置.喽啰消耗雌性价值) {
      // 足够消耗，产出标准数量
      实际消耗 = this.配置.喽啰消耗雌性价值;
      实际产出 = this.配置.喽啰产出基础;
    } else {
      // 不足100时按比例计算
      实际消耗 = 剩余价值;
      实际产出 = Math.floor(剩余价值 * this.配置.每点价值产出喽啰);
    }

    if (实际产出 <= 0) {
      return { 成功: false, 原因: '剩余雌性价值过低，无法产出喽啰' };
    }

    // 消耗雌性价值
    母畜.消耗雌性价值(实际消耗);

    // 增加淫乱度
    母畜.修改属性('淫乱度', this.配置.生育淫乱度增加, this.属性注册表);

    // 增加喽啰
    const 武装等级 = 选项.武装等级 ?? '未武装';
    this.喽啰池.增加喽啰(实际产出, 武装等级);

    // 记录母畜生育记录
    母畜.记录生育喽啰?.(实际产出);

    // 记录系统历史
    this.记录生育历史({
      类型: '生育喽啰',
      母畜ID: 母畜.实体ID,
      母畜姓名: 母畜.获取属性('姓名'),
      产出数量: 实际产出,
      消耗雌性价值: 实际消耗,
      武装等级,
    });

    // 更新统计
    this.统计.总生育喽啰数 += 实际产出;

    // 发布事件
    this.事件总线.发布('喽啰诞生', {
      数量: 实际产出,
      母畜ID: 母畜.实体ID,
      母畜姓名: 母畜.获取属性('姓名'),
    });

    return {
      成功: true,
      产出数量: 实际产出,
      消耗雌性价值: 实际消耗,
      淫乱度增加: this.配置.生育淫乱度增加,
      剩余雌性价值: 母畜.获取属性('剩余雌性价值'),
    };
  }

  // ─── 批量生育 ───

  批量生育喽啰(母畜列表, 选项 = {}) {
    /**
     * 多个母畜同时生育喽啰
     */
    const 结果列表 = [];
    let 总产出 = 0;

    for (const 母畜 of 母畜列表) {
      const 结果 = this.生育喽啰(母畜, 选项);
      结果列表.push({
        母畜ID: 母畜.实体ID,
        ...结果,
      });

      if (结果.成功) {
        总产出 += 结果.产出数量;
      }
    }

    return {
      结果列表,
      总产出,
      成功数: 结果列表.filter(r => r.成功).length,
    };
  }

  // ─── 生育预估 ───

  预估生育冠军(母畜) {
    /**
     * 预估生育冠军的属性范围
     */
    const 验证 = this.验证可生育冠军(母畜);
    if (!验证.可生育) {
      return { 可生育: false, 原因: 验证.原因 };
    }

    const 属性预估 = this.冠军工厂.预估生育属性(母畜);

    return {
      可生育: true,
      消耗雌性价值: this.配置.冠军消耗雌性价值,
      淫乱度增加: this.配置.生育淫乱度增加,
      属性预估,
    };
  }

  预估生育喽啰(母畜) {
    /**
     * 预估生育喽啰的数量
     */
    const 验证 = this.验证可生育喽啰(母畜);
    if (!验证.可生育) {
      return { 可生育: false, 原因: 验证.原因 };
    }

    const 剩余价值 = 母畜.获取属性('剩余雌性价值');
    let 预估消耗;
    let 预估产出;

    if (剩余价值 >= this.配置.喽啰消耗雌性价值) {
      预估消耗 = this.配置.喽啰消耗雌性价值;
      预估产出 = this.配置.喽啰产出基础;
    } else {
      预估消耗 = 剩余价值;
      预估产出 = Math.floor(剩余价值 * this.配置.每点价值产出喽啰);
    }

    return {
      可生育: 预估产出 > 0,
      消耗雌性价值: 预估消耗,
      预估产出,
      淫乱度增加: this.配置.生育淫乱度增加,
    };
  }

  // ─── 历史记录 ───

  记录生育历史(记录) {
    this.生育历史.push({
      ...记录,
      时间戳: Date.now(),
    });

    while (this.生育历史.length > this.历史上限) {
      this.生育历史.shift();
    }
  }

  获取生育历史(过滤条件 = {}) {
    let 结果 = [...this.生育历史];

    if (过滤条件.母畜ID) {
      结果 = 结果.filter(h => h.母畜ID === 过滤条件.母畜ID);
    }

    if (过滤条件.类型) {
      结果 = 结果.filter(h => h.类型 === 过滤条件.类型);
    }

    if (过滤条件.数量) {
      结果 = 结果.slice(-过滤条件.数量);
    }

    return 结果;
  }

  // ─── 统计 ───

  获取统计() {
    return { ...this.统计 };
  }

  // ─── 序列化 ───

  序列化() {
    return {
      生育历史: this.生育历史.slice(-50),
      统计: this.统计,
    };
  }

  从序列化恢复(数据) {
    this.生育历史 = 数据.生育历史 ?? [];
    this.统计 = 数据.统计 ?? {
      总生育冠军数: 0,
      总生育喽啰数: 0,
    };
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 繁殖系统 };
export default 繁殖系统;
