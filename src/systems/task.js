// ═══════════════════════════════════════════════════════════════
// systems/task.js
// 任务系统 - 管理任务的验证、执行和结果处理
// ═══════════════════════════════════════════════════════════════

/**
 * 任务系统
 * 统一管理任务的验证、执行和结果处理
 */
class 任务系统 {
  constructor(事件总线, 任务注册表, 时间系统, 公式引擎) {
    this.事件总线 = 事件总线;
    this.任务注册表 = 任务注册表;
    this.时间系统 = 时间系统;
    this.公式引擎 = 公式引擎;

    // 本周任务记录
    this.本周执行记录 = new Map();

    // 任务结果历史
    this.任务历史 = [];
    this.历史上限 = 100;

    // 任务队列（用于异步/延迟任务）
    this.待处理任务队列 = [];

    // 任务执行钩子
    this.执行前钩子 = [];
    this.执行后钩子 = [];
  }

  // ─── 钩子注册 ───

  注册执行前钩子(钩子函数) {
    /**
     * @param 钩子函数 - (上下文) => { 继续: boolean, 修改后上下文? }
     */
    this.执行前钩子.push(钩子函数);
    return () => {
      const 索引 = this.执行前钩子.indexOf(钩子函数);
      if (索引 !== -1) this.执行前钩子.splice(索引, 1);
    };
  }

  注册执行后钩子(钩子函数) {
    /**
     * @param 钩子函数 - (上下文, 结果) => 修改后结果?
     */
    this.执行后钩子.push(钩子函数);
    return () => {
      const 索引 = this.执行后钩子.indexOf(钩子函数);
      if (索引 !== -1) this.执行后钩子.splice(索引, 1);
    };
  }

  // ─── 核心执行流程 ───

  验证任务(任务名, 负责人, 游戏状态, 额外参数 = {}) {
    /**
     * 验证任务是否可执行
     */
    const 上下文 = this.任务注册表.构建执行上下文({
      任务名,
      负责人,
      游戏状态,
      时间系统: this.时间系统,
      额外参数,
    });

    return this.任务注册表.验证任务可执行性(任务名, 上下文);
  }

  执行任务(任务名, 负责人, 游戏状态, 额外参数 = {}) {
    /**
     * 执行任务
     * @returns { 成功: boolean, 结果?: any, 原因?: string }
     */

    // 构建完整上下文
    let 上下文 = this.任务注册表.构建执行上下文({
      任务名,
      负责人,
      游戏状态,
      时间系统: this.时间系统,
      公式引擎: this.公式引擎,
      事件总线: this.事件总线,
      额外参数,
    });

    // 执行前钩子
    for (const 钩子 of this.执行前钩子) {
      try {
        const 钩子结果 = 钩子(上下文);
        if (钩子结果?.继续 === false) {
          return { 成功: false, 原因: 钩子结果.原因 ?? '被钩子拦截' };
        }
        if (钩子结果?.修改后上下文) {
          上下文 = 钩子结果.修改后上下文;
        }
      } catch (错误) {
        console.error('执行前钩子错误:', 错误);
      }
    }

    // 验证
    const 验证结果 = this.任务注册表.验证任务可执行性(任务名, 上下文);
    if (!验证结果.可执行) {
      this.任务注册表.记录执行结果(任务名, false);
      return { 成功: false, 原因: 验证结果.原因 };
    }

    const 定义 = this.任务注册表.获取任务定义(任务名);

    // 消耗行动点
    const 实际消耗 = this.任务注册表.计算实际行动点(任务名, 上下文);
    if (实际消耗 > 0 && this.时间系统) {
      const 消耗结果 = this.时间系统.消耗行动点(实际消耗);
      if (!消耗结果.成功) {
        return { 成功: false, 原因: 消耗结果.原因 };
      }
    }

    // 消耗资源
    if (定义.消耗资源) {
      const 资源系统 = this.任务注册表.获取系统('资源系统');
      if (资源系统) {
        for (const [资源名, 数量] of Object.entries(定义.消耗资源)) {
          资源系统.修改资源(资源名, -数量, `任务消耗:${任务名}`);
        }
      }
    }

    // 获取并执行任务执行器
    const 执行器 = this.任务注册表.任务执行器映射.get(任务名);
    if (!执行器) {
      this.任务注册表.记录执行结果(任务名, false);
      return { 成功: false, 原因: '任务执行器未注册' };
    }

    let 执行结果;
    try {
      执行结果 = 执行器(上下文);
    } catch (错误) {
      console.error(`任务执行错误 [${任务名}]:`, 错误);
      this.任务注册表.记录执行结果(任务名, false);
      return { 成功: false, 原因: '任务执行异常', 错误: 错误.message };
    }

    // 处理副作用
    if (执行结果.成功 !== false && 定义.副作用) {
      定义.副作用.forEach(副作用处理器 => {
        try {
          副作用处理器(上下文, 执行结果);
        } catch (错误) {
          console.error(`副作用处理错误 [${任务名}]:`, 错误);
        }
      });
    }

    // 执行后钩子
    for (const 钩子 of this.执行后钩子) {
      try {
        const 修改结果 = 钩子(上下文, 执行结果);
        if (修改结果) {
          执行结果 = 修改结果;
        }
      } catch (错误) {
        console.error('执行后钩子错误:', 错误);
      }
    }

    // 记录统计
    this.任务注册表.记录执行结果(任务名, 执行结果.成功 !== false);

    // 记录本周执行
    this.记录本周执行(任务名, 负责人.实体ID);

    // 记录历史
    this.记录任务历史({
      任务名,
      负责人ID: 负责人.实体ID,
      负责人姓名: 负责人.获取属性?.('姓名') ?? '未知',
      周次: this.时间系统?.当前周次,
      行动点消耗: 实际消耗,
      结果: 执行结果,
      时间戳: Date.now(),
    });

    // 发布事件
    this.事件总线.发布('任务完成', {
      任务名,
      负责人ID: 负责人.实体ID,
      行动点消耗: 实际消耗,
      结果: 执行结果,
    });

    return { 成功: true, 结果: 执行结果, 行动点消耗: 实际消耗 };
  }

  // ─── 批量执行 ───

  批量执行任务(任务列表, 游戏状态) {
    /**
     * 批量执行任务
     * @param 任务列表 - [{ 任务名, 负责人, 额外参数?, 失败中断? }, ...]
     */
    const 结果列表 = [];

    for (const 任务配置 of 任务列表) {
      const 结果 = this.执行任务(任务配置.任务名, 任务配置.负责人, 游戏状态, 任务配置.额外参数 ?? {});

      结果列表.push({
        任务名: 任务配置.任务名,
        ...结果,
      });

      // 如果配置为失败中断
      if (!结果.成功 && 任务配置.失败中断) {
        break;
      }
    }

    return 结果列表;
  }

  // ─── 记录管理 ───

  记录本周执行(任务名, 负责人ID) {
    const 键 = `${任务名}_${负责人ID}`;
    const 当前计数 = this.本周执行记录.get(键) ?? 0;
    this.本周执行记录.set(键, 当前计数 + 1);
  }

  重置本周记录() {
    this.本周执行记录.clear();
  }

  获取本周执行次数(任务名, 负责人ID = null) {
    if (负责人ID) {
      return this.本周执行记录.get(`${任务名}_${负责人ID}`) ?? 0;
    }

    let 总次数 = 0;
    this.本周执行记录.forEach((次数, 键) => {
      if (键.startsWith(`${任务名}_`)) {
        总次数 += 次数;
      }
    });
    return 总次数;
  }

  记录任务历史(记录) {
    this.任务历史.push(记录);
    if (this.任务历史.length > this.历史上限) {
      this.任务历史.shift();
    }
  }

  获取任务历史(过滤条件 = {}) {
    let 结果 = [...this.任务历史];

    if (过滤条件.任务名) {
      结果 = 结果.filter(r => r.任务名 === 过滤条件.任务名);
    }
    if (过滤条件.负责人ID) {
      结果 = 结果.filter(r => r.负责人ID === 过滤条件.负责人ID);
    }
    if (过滤条件.周次) {
      结果 = 结果.filter(r => r.周次 === 过滤条件.周次);
    }
    if (过滤条件.数量) {
      结果 = 结果.slice(-过滤条件.数量);
    }

    return 结果;
  }

  // ─── 周结算钩子 ───

  周结算处理() {
    this.重置本周记录();
    return { 类型: '任务系统周结算' };
  }

  // ─── 查询辅助 ───

  获取可执行任务列表(负责人, 游戏状态) {
    return this.任务注册表.获取负责人可执行任务(负责人, 游戏状态);
  }

  // ─── 序列化 ───

  序列化() {
    return {
      本周执行记录: Object.fromEntries(this.本周执行记录),
      任务历史: this.任务历史.slice(-50),
    };
  }

  从序列化恢复(数据) {
    if (数据.本周执行记录) {
      this.本周执行记录 = new Map(Object.entries(数据.本周执行记录));
    }
    this.任务历史 = 数据.任务历史 ?? [];
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 任务系统 };
export default 任务系统;
