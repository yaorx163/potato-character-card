// ═══════════════════════════════════════════════════════════════
// systems/intel.js
// 情报系统 - 管理目标情报、侦察进度和战力估算
// ═══════════════════════════════════════════════════════════════

class 情报系统 {
  constructor(事件总线, 公式引擎) {
    this.事件总线 = 事件总线;
    this.公式引擎 = 公式引擎;

    this.目标情报 = new Map();
    this.侦察历史 = [];
    this.历史上限 = 200;
  }

  // ─── 配置获取 ───

  获取配置(配置名, 默认值) {
    return this.公式引擎?.获取常量(配置名, 默认值) ?? 默认值;
  }

  // ─── 情报衰减配置 ───

  获取衰减配置() {
    return {
      启用: true,
      每周衰减: this.获取配置('情报衰减值', 5),
      最低保留: this.获取配置('情报最低保留', 10),
    };
  }

  // ─── 目标管理 ───

  创建目标(目标ID, 初始数据 = {}) {
    const 情报数据 = {
      目标ID,
      名称: 初始数据.名称 ?? '未知目标',
      情报进度: 初始数据.情报进度 ?? 0,
      已锁定目标: new Set(),
      高价值目标列表: 初始数据.高价值目标列表 ?? [],
      战力估值: null,
      实际战力: 初始数据.实际战力 ?? null,
      最后侦察周次: null,
      发现时间: Date.now(),
      侦察次数: 0,
      备注: 初始数据.备注 ?? '',
    };

    this.目标情报.set(目标ID, 情报数据);
    this.更新战力估值(目标ID);

    this.事件总线.发布('目标创建', { 目标ID, 情报数据 });

    return 情报数据;
  }

  移除目标(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (情报) {
      this.目标情报.delete(目标ID);
      this.事件总线.发布('目标移除', { 目标ID, 情报 });
      return true;
    }
    return false;
  }

  获取目标情报(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return null;

    return {
      ...情报,
      已锁定目标: Array.from(情报.已锁定目标),
    };
  }

  获取所有目标() {
    return Array.from(this.目标情报.entries()).map(([目标ID, 情报]) => ({
      目标ID,
      ...情报,
      已锁定目标: Array.from(情报.已锁定目标),
    }));
  }

  // ─── 情报进度 ───

  增加情报进度(目标ID, 增量, 来源 = '侦察') {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) {
      return { 成功: false, 原因: '目标不存在' };
    }

    const 旧进度 = 情报.情报进度;
    const 情报满值 = this.获取配置('情报满值', 100);
    const 旧阶段 = this.获取情报阶段(旧进度);

    情报.情报进度 = Math.min(情报满值, 情报.情报进度 + 增量);
    情报.侦察次数++;
    情报.最后侦察周次 = this.获取当前周次();

    const 新阶段 = this.获取情报阶段(情报.情报进度);

    this.更新战力估值(目标ID);

    this.记录侦察历史({
      目标ID,
      类型: '情报增加',
      旧进度,
      新进度: 情报.情报进度,
      增量,
      来源,
    });

    this.事件总线.发布('情报更新', {
      目标ID,
      旧进度,
      新进度: 情报.情报进度,
      增量,
    });

    if (新阶段.等级 > 旧阶段.等级) {
      this.事件总线.发布('情报阶段提升', {
        目标ID,
        旧阶段,
        新阶段,
      });
    }

    return {
      成功: true,
      新进度: 情报.情报进度,
      阶段变化: 新阶段.等级 > 旧阶段.等级 ? { 旧阶段, 新阶段 } : null,
    };
  }

  设置情报进度(目标ID, 进度) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return false;

    const 情报满值 = this.获取配置('情报满值', 100);
    情报.情报进度 = Math.max(0, Math.min(情报满值, 进度));
    this.更新战力估值(目标ID);
    return true;
  }

  获取情报阶段(进度) {
    return (
      this.公式引擎?.计算('情报阶段判定', { 情报进度: 进度 }) ?? {
        名称: '模糊',
        等级: 1,
        描述: '几乎一无所知',
      }
    );
  }

  // ─── 战力估值 ───

  更新战力估值(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return;

    const 估值 = this.公式引擎?.计算('战力估值偏差', { 情报进度: 情报.情报进度 }) ?? {
      下限系数: 0.2,
      上限系数: 5.0,
    };

    情报.战力估值 = 估值;
  }

  获取战力估值(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报 || !情报.实际战力) return null;

    const 实际战力 = 情报.实际战力;
    const 估值 = 情报.战力估值;

    return {
      估计最小: Math.floor(实际战力 * 估值.下限系数),
      估计最大: Math.ceil(实际战力 * 估值.上限系数),
      准确度: 情报.情报进度,
      显示文本: this.生成战力显示文本(情报),
    };
  }

  生成战力显示文本(情报) {
    if (!情报.实际战力) return '未知';

    const 进度 = 情报.情报进度;
    const 实际 = 情报.实际战力;
    const 详尽阈值 = this.获取配置('情报阶段_详尽阈值', 80);
    const 充分阈值 = this.获取配置('情报阶段_充分阈值', 50);
    const 初步阈值 = this.获取配置('情报阶段_初步阈值', 25);

    if (进度 >= 详尽阈值) {
      const 误差 = Math.floor(实际 * 0.1);
      return `约 ${实际 - 误差} ~ ${实际 + 误差}`;
    } else if (进度 >= 充分阈值) {
      const 下限 = Math.floor(实际 * 0.6);
      const 上限 = Math.ceil(实际 * 1.5);
      return `${下限} ~ ${上限}`;
    } else if (进度 >= 初步阈值) {
      const 下限 = Math.floor(实际 * 0.3);
      const 上限 = Math.ceil(实际 * 3);
      return `${下限} ~ ${上限}`;
    } else {
      return '情报不足，无法估算';
    }
  }

  // ─── 高价值目标锁定 ───

  添加高价值目标(目标ID, 高价值目标信息) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return false;

    情报.高价值目标列表.push({
      ...高价值目标信息,
      添加时间: Date.now(),
    });

    return true;
  }

  尝试锁定目标(目标ID, 负责人系数) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return [];

    const 锁定值 =
      this.公式引擎?.计算('锁定目标值', {
        负责人系数,
        情报进度: 情报.情报进度,
      }) ?? 0;

    const 锁定解析 = this.公式引擎?.计算('锁定目标解析', { 锁定值 }) ?? {
      必定锁定数: 0,
      额外锁定概率: 0,
    };

    const 新锁定 = [];
    const 可锁定目标 = 情报.高价值目标列表.filter(t => !情报.已锁定目标.has(t.ID));

    for (let i = 0; i < Math.min(锁定解析.必定锁定数, 可锁定目标.length); i++) {
      const 目标 = 可锁定目标[i];
      情报.已锁定目标.add(目标.ID);
      新锁定.push(目标);
    }

    if (可锁定目标.length > 锁定解析.必定锁定数 && Math.random() < 锁定解析.额外锁定概率) {
      const 目标 = 可锁定目标[锁定解析.必定锁定数];
      情报.已锁定目标.add(目标.ID);
      新锁定.push(目标);
    }

    if (新锁定.length > 0) {
      this.事件总线.发布('目标锁定', {
        目标ID,
        新锁定目标: 新锁定,
      });
    }

    return 新锁定;
  }

  获取已锁定目标(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return [];

    return 情报.高价值目标列表.filter(t => 情报.已锁定目标.has(t.ID));
  }

  获取未锁定目标(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return [];

    return 情报.高价值目标列表.filter(t => !情报.已锁定目标.has(t.ID));
  }

  // ─── 周结算 ───

  周结算处理(当前周次) {
    const 衰减配置 = this.获取衰减配置();
    if (!衰减配置.启用) return [];

    const 衰减记录 = [];

    this.目标情报.forEach((情报, 目标ID) => {
      if (情报.最后侦察周次 && 情报.最后侦察周次 >= 当前周次 - 1) {
        return;
      }

      const 旧进度 = 情报.情报进度;

      const 新进度 =
        this.公式引擎?.计算('情报衰减', {
          当前进度: 情报.情报进度,
          上次侦察周次: 情报.最后侦察周次,
          当前周次,
        }) ?? Math.max(衰减配置.最低保留, 情报.情报进度 - 衰减配置.每周衰减);

      情报.情报进度 = 新进度;

      if (情报.情报进度 < 旧进度) {
        this.更新战力估值(目标ID);
        衰减记录.push({
          目标ID,
          旧进度,
          新进度: 情报.情报进度,
          衰减量: 旧进度 - 情报.情报进度,
        });
      }
    });

    return 衰减记录;
  }

  // ─── 历史记录 ───

  记录侦察历史(记录) {
    this.侦察历史.push({
      ...记录,
      时间戳: Date.now(),
    });

    while (this.侦察历史.length > this.历史上限) {
      this.侦察历史.shift();
    }
  }

  获取侦察历史(目标ID = null) {
    if (目标ID) {
      return this.侦察历史.filter(h => h.目标ID === 目标ID);
    }
    return [...this.侦察历史];
  }

  获取当前周次() {
    return this._当前周次 ?? 1;
  }

  设置当前周次(周次) {
    this._当前周次 = 周次;
  }

  序列化() {
    const 情报数据 = {};

    this.目标情报.forEach((情报, 目标ID) => {
      情报数据[目标ID] = {
        ...情报,
        已锁定目标: Array.from(情报.已锁定目标),
      };
    });

    return {
      目标情报: 情报数据,
      侦察历史: this.侦察历史.slice(-50),
    };
  }

  从序列化恢复(数据) {
    this.目标情报.clear();

    if (数据.目标情报) {
      Object.entries(数据.目标情报).forEach(([目标ID, 情报]) => {
        this.目标情报.set(目标ID, {
          ...情报,
          已锁定目标: new Set(情报.已锁定目标 ?? []),
        });
      });
    }

    this.侦察历史 = 数据.侦察历史 ?? [];
  }
}

export { 情报系统 };
export default 情报系统;
