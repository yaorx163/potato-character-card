// ═══════════════════════════════════════════════════════════════
// systems/intel.js
// 情报系统 - 管理目标情报、侦察进度和战力估算
// ═══════════════════════════════════════════════════════════════

/**
 * 情报系统
 * 管理对敌方目标的情报收集和战力估算
 */
class 情报系统 {
  constructor(事件总线, 公式引擎) {
    this.事件总线 = 事件总线;
    this.公式引擎 = 公式引擎;

    // 目标情报存储: 目标ID -> 情报数据
    this.目标情报 = new Map();

    // 情报衰减配置
    this.情报衰减配置 = {
      启用: true,
      每周衰减: 5,
      最低保留: 10,
    };

    // 侦察历史
    this.侦察历史 = [];
    this.历史上限 = 200;
  }

  // ─── 目标管理 ───

  创建目标(目标ID, 初始数据 = {}) {
    /**
     * 创建新的侦察目标
     * @param 目标ID - 目标唯一标识
     * @param 初始数据 - { 名称, 情报进度, 高价值目标列表, 实际战力 }
     */
    const 情报数据 = {
      目标ID,
      名称: 初始数据.名称 ?? '未知目标',
      情报进度: 初始数据.情报进度 ?? 0,
      已锁定目标: new Set(),
      高价值目标列表: 初始数据.高价值目标列表 ?? [],
      战力估值: null,
      实际战力: 初始数据.实际战力 ?? null, // 真实战力，用于战斗计算
      最后侦察周次: null,
      发现时间: Date.now(),
      侦察次数: 0,
      备注: 初始数据.备注 ?? '',
    };

    this.目标情报.set(目标ID, 情报数据);
    this.更新战力估值(目标ID);

    this.事件总线.发布('目标创建', { 目标ID, 情报数据 });

    return 情报数据;
  }

  移除目标(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (情报) {
      this.目标情报.delete(目标ID);
      this.事件总线.发布('目标移除', { 目标ID, 情报 });
      return true;
    }
    return false;
  }

  获取目标情报(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return null;

    return {
      ...情报,
      已锁定目标: Array.from(情报.已锁定目标),
    };
  }

  获取所有目标() {
    return Array.from(this.目标情报.entries()).map(([目标ID, 情报]) => ({
      目标ID,
      ...情报,
      已锁定目标: Array.from(情报.已锁定目标),
    }));
  }

  // ─── 情报进度 ───

  增加情报进度(目标ID, 增量, 来源 = '侦察') {
    /**
     * 增加目标的情报进度
     * @returns { 成功, 新进度, 阶段变化? }
     */
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) {
      return { 成功: false, 原因: '目标不存在' };
    }

    const 旧进度 = 情报.情报进度;
    const 旧阶段 = this.获取情报阶段(旧进度);

    情报.情报进度 = Math.min(100, 情报.情报进度 + 增量);
    情报.侦察次数++;
    情报.最后侦察周次 = this.获取当前周次();

    const 新阶段 = this.获取情报阶段(情报.情报进度);

    // 更新战力估值
    this.更新战力估值(目标ID);

    // 记录历史
    this.记录侦察历史({
      目标ID,
      类型: '情报增加',
      旧进度,
      新进度: 情报.情报进度,
      增量,
      来源,
    });

    // 发布事件
    this.事件总线.发布('情报更新', {
      目标ID,
      旧进度,
      新进度: 情报.情报进度,
      增量,
    });

    // 检查阶段变化
    if (新阶段.等级 > 旧阶段.等级) {
      this.事件总线.发布('情报阶段提升', {
        目标ID,
        旧阶段,
        新阶段,
      });
    }

    return {
      成功: true,
      新进度: 情报.情报进度,
      阶段变化: 新阶段.等级 > 旧阶段.等级 ? { 旧阶段, 新阶段 } : null,
    };
  }

  设置情报进度(目标ID, 进度) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return false;

    情报.情报进度 = Math.max(0, Math.min(100, 进度));
    this.更新战力估值(目标ID);
    return true;
  }

  获取情报阶段(进度) {
    /**
     * 根据进度获取情报阶段
     */
    if (进度 >= 80) return { 名称: '详尽', 等级: 4, 描述: '情报非常准确' };
    if (进度 >= 50) return { 名称: '充分', 等级: 3, 描述: '情报较为可靠' };
    if (进度 >= 25) return { 名称: '初步', 等级: 2, 描述: '有基本了解' };
    return { 名称: '模糊', 等级: 1, 描述: '几乎一无所知' };
  }

  // ─── 战力估值 ───

  更新战力估值(目标ID) {
    /**
     * 根据情报进度更新战力估值范围
     */
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return;

    const n = 情报.情报进度;

    // 估值偏差公式
    // 情报进度越高，偏差范围越小
    情报.战力估值 = {
      下限系数: 0.2 + (0.8 * n) / 100, // 0.2 -> 1.0
      上限系数: 5 - (4 * n) / 100, // 5.0 -> 1.0
    };
  }

  获取战力估值(目标ID) {
    /**
     * 获取目标的战力估值范围
     * @returns { 估计最小, 估计最大, 准确度 }
     */
    const 情报 = this.目标情报.get(目标ID);
    if (!情报 || !情报.实际战力) return null;

    const 实际战力 = 情报.实际战力;
    const 估值 = 情报.战力估值;

    return {
      估计最小: Math.floor(实际战力 * 估值.下限系数),
      估计最大: Math.ceil(实际战力 * 估值.上限系数),
      准确度: 情报.情报进度,
      显示文本: this.生成战力显示文本(情报),
    };
  }

  生成战力显示文本(情报) {
    if (!情报.实际战力) return '未知';

    const 进度 = 情报.情报进度;
    const 实际 = 情报.实际战力;

    if (进度 >= 80) {
      // 高精度显示
      const 误差 = Math.floor(实际 * 0.1);
      return `约 ${实际 - 误差} ~ ${实际 + 误差}`;
    } else if (进度 >= 50) {
      // 中等精度
      const 下限 = Math.floor(实际 * 0.6);
      const 上限 = Math.ceil(实际 * 1.5);
      return `${下限} ~ ${上限}`;
    } else if (进度 >= 25) {
      // 低精度
      const 下限 = Math.floor(实际 * 0.3);
      const 上限 = Math.ceil(实际 * 3);
      return `${下限} ~ ${上限}`;
    } else {
      // 极低精度
      return '情报不足，无法估算';
    }
  }

  // ─── 高价值目标锁定 ───

  添加高价值目标(目标ID, 高价值目标信息) {
    /**
     * 向目标添加可锁定的高价值目标
     * @param 高价值目标信息 - { ID, 名称, 类型, 价值估计 }
     */
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return false;

    情报.高价值目标列表.push({
      ...高价值目标信息,
      添加时间: Date.now(),
    });

    return true;
  }

  尝试锁定目标(目标ID, 负责人系数) {
    /**
     * 尝试锁定高价值目标
     * @param 负责人系数 - 影响锁定概率的系数
     * @returns 新锁定的目标列表
     */
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return [];

    // 计算锁定值
    const 锁定值 =
      this.公式引擎?.计算('锁定目标值', {
        负责人系数,
        情报进度: 情报.情报进度,
      }) ?? (负责人系数 * (情报.情报进度 + 25)) / 100;

    const 必定锁定数 = Math.floor(锁定值 / 100);
    const 额外锁定概率 = (锁定值 % 100) / 100;

    const 新锁定 = [];
    const 可锁定目标 = 情报.高价值目标列表.filter(t => !情报.已锁定目标.has(t.ID));

    // 必定锁定
    for (let i = 0; i < Math.min(必定锁定数, 可锁定目标.length); i++) {
      const 目标 = 可锁定目标[i];
      情报.已锁定目标.add(目标.ID);
      新锁定.push(目标);
    }

    // 概率锁定
    if (可锁定目标.length > 必定锁定数 && Math.random() < 额外锁定概率) {
      const 目标 = 可锁定目标[必定锁定数];
      情报.已锁定目标.add(目标.ID);
      新锁定.push(目标);
    }

    // 发布事件
    if (新锁定.length > 0) {
      this.事件总线.发布('目标锁定', {
        目标ID,
        新锁定目标: 新锁定,
      });
    }

    return 新锁定;
  }

  获取已锁定目标(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return [];

    return 情报.高价值目标列表.filter(t => 情报.已锁定目标.has(t.ID));
  }

  获取未锁定目标(目标ID) {
    const 情报 = this.目标情报.get(目标ID);
    if (!情报) return [];

    return 情报.高价值目标列表.filter(t => !情报.已锁定目标.has(t.ID));
  }

  // ─── 周结算 ───

  周结算处理(当前周次) {
    /**
     * 周结算：情报衰减
     */
    if (!this.情报衰减配置.启用) return [];

    const 衰减记录 = [];

    this.目标情报.forEach((情报, 目标ID) => {
      // 只有一周未侦察才衰减
      if (情报.最后侦察周次 && 情报.最后侦察周次 >= 当前周次 - 1) {
        return;
      }

      const 旧进度 = 情报.情报进度;
      const 衰减量 = this.情报衰减配置.每周衰减;
      情报.情报进度 = Math.max(this.情报衰减配置.最低保留, 情报.情报进度 - 衰减量);

      if (情报.情报进度 < 旧进度) {
        this.更新战力估值(目标ID);
        衰减记录.push({
          目标ID,
          旧进度,
          新进度: 情报.情报进度,
          衰减量: 旧进度 - 情报.情报进度,
        });
      }
    });

    return 衰减记录;
  }

  设置情报衰减配置(配置) {
    Object.assign(this.情报衰减配置, 配置);
  }

  // ─── 历史记录 ───

  记录侦察历史(记录) {
    this.侦察历史.push({
      ...记录,
      时间戳: Date.now(),
    });

    while (this.侦察历史.length > this.历史上限) {
      this.侦察历史.shift();
    }
  }

  获取侦察历史(目标ID = null) {
    if (目标ID) {
      return this.侦察历史.filter(h => h.目标ID === 目标ID);
    }
    return [...this.侦察历史];
  }

  // ─── 辅助方法 ───

  获取当前周次() {
    // 如果有时间系统引用，从中获取
    return this._当前周次 ?? 1;
  }

  设置当前周次(周次) {
    this._当前周次 = 周次;
  }

  // ─── 序列化 ───

  序列化() {
    const 情报数据 = {};

    this.目标情报.forEach((情报, 目标ID) => {
      情报数据[目标ID] = {
        ...情报,
        已锁定目标: Array.from(情报.已锁定目标),
      };
    });

    return {
      目标情报: 情报数据,
      侦察历史: this.侦察历史.slice(-50),
    };
  }

  从序列化恢复(数据) {
    this.目标情报.clear();

    if (数据.目标情报) {
      Object.entries(数据.目标情报).forEach(([目标ID, 情报]) => {
        this.目标情报.set(目标ID, {
          ...情报,
          已锁定目标: new Set(情报.已锁定目标 ?? []),
        });
      });
    }

    this.侦察历史 = 数据.侦察历史 ?? [];
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 情报系统 };
export default 情报系统;
