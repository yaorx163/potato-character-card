// ═══════════════════════════════════════════════════════════════
// systems/spell.js
// 法术系统 - 管理领主法术的施放和效果
// ═══════════════════════════════════════════════════════════════

/**
 * 法术系统
 * 管理领主的魔力和法术施放
 */
class 法术系统 {
  constructor(事件总线, 法术注册表, 领主) {
    this.事件总线 = 事件总线;
    this.法术注册表 = 法术注册表;
    this.领主 = 领主;

    // 法术冷却记录
    this.法术冷却 = new Map();

    // 当前周次（用于冷却计算）
    this._当前周次 = 1;

    // 施放历史
    this.施放历史 = [];
    this.历史上限 = 100;

    // 法术修正器（临时增强等）
    this.效果修正器 = new Map();
  }

  // ─── 领主管理 ───

  设置领主(领主) {
    this.领主 = 领主;
  }

  获取领主() {
    return this.领主;
  }

  设置当前周次(周次) {
    this._当前周次 = 周次;
  }

  // ─── 法术验证 ───

  验证施法(法术名, 目标 = null) {
    /**
     * 验证法术是否可以施放
     */
    if (!this.领主) {
      return { 可施放: false, 原因: '领主未设置' };
    }

    const 定义 = this.法术注册表.获取法术定义(法术名);
    if (!定义) {
      return { 可施放: false, 原因: '未知法术' };
    }

    // 检查魔力
    const 当前魔力 = this.领主.获取属性('魔力');
    if (当前魔力 < 定义.魔力消耗) {
      return {
        可施放: false,
        原因: '魔力不足',
        当前魔力,
        需要魔力: 定义.魔力消耗,
      };
    }

    // 检查冷却
    if (定义.冷却周期 > 0) {
      const 上次施放周次 = this.法术冷却.get(法术名);
      if (上次施放周次) {
        const 剩余冷却 = 定义.冷却周期 - (this._当前周次 - 上次施放周次);
        if (剩余冷却 > 0) {
          return {
            可施放: false,
            原因: '法术冷却中',
            剩余冷却周次: 剩余冷却,
          };
        }
      }
    }

    // 检查目标类型
    if (定义.目标类型 !== '无') {
      if (!目标) {
        return { 可施放: false, 原因: '需要指定目标' };
      }
      if (定义.目标类型 !== 目标.实体类型) {
        return {
          可施放: false,
          原因: '目标类型不匹配',
          需要类型: 定义.目标类型,
          实际类型: 目标.实体类型,
        };
      }
    }

    // 检查施放条件
    if (!定义.施放条件({ 领主: this.领主, 目标 })) {
      return { 可施放: false, 原因: '施放条件不满足' };
    }

    return { 可施放: true, 魔力消耗: 定义.魔力消耗 };
  }

  // ─── 法术施放 ───

  施放法术(法术名, 目标 = null, 选项 = {}) {
    /**
     * 施放法术
     * @returns { 成功, 效果结果?, 原因? }
     */
    // 验证
    const 验证结果 = this.验证施法(法术名, 目标);
    if (!验证结果.可施放) {
      return { 成功: false, ...验证结果 };
    }

    const 定义 = this.法术注册表.获取法术定义(法术名);

    // 消耗魔力
    const 消耗结果 = this.领主.消耗魔力(定义.魔力消耗);
    if (!消耗结果.成功) {
      return { 成功: false, 原因: '魔力消耗失败' };
    }

    // 记录冷却
    if (定义.冷却周期 > 0) {
      this.法术冷却.set(法术名, this._当前周次);
    }

    // 构建效果上下文
    const 上下文 = {
      领主: this.领主,
      效果参数: { ...定义.效果参数 },
      选项,
    };

    // 应用效果修正器
    const 修正器 = this.效果修正器.get(法术名);
    if (修正器) {
      上下文.效果参数 = 修正器(上下文.效果参数);
    }

    // 执行效果
    let 效果结果;
    try {
      效果结果 = this.法术注册表.执行法术效果(法术名, 目标, 上下文);
    } catch (错误) {
      console.error(`法术效果执行错误 [${法术名}]:`, 错误);
      效果结果 = { 成功: false, 错误: 错误.message };
    }

    // 记录历史
    this.记录施放历史({
      法术名,
      目标ID: 目标?.实体ID,
      目标类型: 目标?.实体类型,
      魔力消耗: 定义.魔力消耗,
      效果结果,
      周次: this._当前周次,
    });

    // 发布事件
    this.事件总线.发布('法术施放', {
      法术名,
      目标ID: 目标?.实体ID,
      魔力消耗: 定义.魔力消耗,
      效果结果,
    });

    return {
      成功: true,
      法术名,
      魔力消耗: 定义.魔力消耗,
      剩余魔力: this.领主.获取属性('魔力'),
      效果结果,
    };
  }

  // ─── 特殊法术：献祭母畜 ───

  献祭母畜(母畜) {
    /**
     * 将完全淫堕的母畜献祭给领主，获得魔力
     * @returns { 成功, 魔力获得?, 需移除母畜? }
     */
    if (!this.领主) {
      return { 成功: false, 原因: '领主未设置' };
    }

    const 淫乱度 = 母畜.获取属性('淫乱度');
    if (淫乱度 < 100) {
      return {
        成功: false,
        原因: '未达到完全淫堕状态',
        当前淫乱度: 淫乱度,
        需要淫乱度: 100,
      };
    }

    const 总雌性价值 = 母畜.获取属性('总雌性价值');
    const 魔力获得 = Math.floor(总雌性价值 / 100);

    this.领主.获得魔力(魔力获得);

    // 记录历史
    this.记录施放历史({
      法术名: '献祭母畜',
      目标ID: 母畜.实体ID,
      目标姓名: 母畜.获取属性('姓名'),
      目标类型: '母畜',
      魔力获得,
      周次: this._当前周次,
    });

    // 发布事件
    this.事件总线.发布('母畜献祭', {
      母畜ID: 母畜.实体ID,
      母畜姓名: 母畜.获取属性('姓名'),
      魔力获得,
    });

    return {
      成功: true,
      魔力获得,
      当前魔力: this.领主.获取属性('魔力'),
      需移除母畜: true, // 告知调用者需要移除该母畜
    };
  }

  // ─── 法术查询 ───

  获取可用法术列表(目标类型 = null) {
    /**
     * 获取当前可施放的法术列表
     */
    const 所有法术 = this.法术注册表.获取所有法术列表();
    const 当前魔力 = this.领主?.获取属性('魔力') ?? 0;

    return 所有法术
      .map(法术 => {
        const 验证 = this.验证施法(法术.名称, { 实体类型: 法术.目标类型 });

        return {
          ...法术,
          可施放: 验证.可施放,
          不可施放原因: 验证.原因,
          冷却剩余: this.获取冷却剩余(法术.名称),
        };
      })
      .filter(法术 => {
        if (目标类型 === null) return true;
        return 法术.目标类型 === 目标类型 || 法术.目标类型 === '无';
      });
  }

  获取冷却剩余(法术名) {
    const 定义 = this.法术注册表.获取法术定义(法术名);
    if (!定义?.冷却周期) return 0;

    const 上次施放 = this.法术冷却.get(法术名);
    if (!上次施放) return 0;

    const 剩余 = 定义.冷却周期 - (this._当前周次 - 上次施放);
    return Math.max(0, 剩余);
  }

  // ─── 效果修正器 ───

  添加效果修正器(法术名, 修正函数) {
    /**
     * 添加法术效果修正器
     * @param 修正函数 - (原效果参数) => 修正后效果参数
     * @returns 移除函数
     */
    this.效果修正器.set(法术名, 修正函数);

    return () => {
      this.效果修正器.delete(法术名);
    };
  }

  // ─── 周结算 ───

  周结算处理(新周次) {
    this._当前周次 = 新周次;
    // 冷却自动减少（通过周次差计算）
  }

  // ─── 历史记录 ───

  记录施放历史(记录) {
    this.施放历史.push({
      ...记录,
      时间戳: Date.now(),
    });

    while (this.施放历史.length > this.历史上限) {
      this.施放历史.shift();
    }
  }

  获取施放历史(过滤条件 = {}) {
    let 结果 = [...this.施放历史];

    if (过滤条件.法术名) {
      结果 = 结果.filter(h => h.法术名 === 过滤条件.法术名);
    }

    if (过滤条件.周次) {
      结果 = 结果.filter(h => h.周次 === 过滤条件.周次);
    }

    if (过滤条件.数量) {
      结果 = 结果.slice(-过滤条件.数量);
    }

    return 结果;
  }

  // ─── 魔力状态 ───

  获取魔力状态() {
    if (!this.领主) return null;

    return {
      当前: this.领主.获取属性('魔力'),
      最大: this.领主.获取属性('最大魔力'),
      百分比: this.领主.获取魔力百分比?.() ?? 0,
    };
  }

  // ─── 序列化 ───

  序列化() {
    return {
      法术冷却: Object.fromEntries(this.法术冷却),
      当前周次: this._当前周次,
      施放历史: this.施放历史.slice(-30),
    };
  }

  从序列化恢复(数据) {
    if (数据.法术冷却) {
      this.法术冷却 = new Map(Object.entries(数据.法术冷却));
    }
    this._当前周次 = 数据.当前周次 ?? 1;
    this.施放历史 = 数据.施放历史 ?? [];
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 法术系统 };
export default 法术系统;
