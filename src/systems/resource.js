// ═══════════════════════════════════════════════════════════════
// systems/resource.js
// 资源系统 - 管理游戏资源的产出、消耗和存储
// ═══════════════════════════════════════════════════════════════

/**
 * 资源系统
 * 管理游戏中的各类资源
 */
class 资源系统 {
  constructor(事件总线) {
    this.事件总线 = 事件总线;

    // 资源存储
    this.资源映射 = new Map();

    // 资源配置
    this.资源配置 = new Map();

    // 产出规则: 资源名 -> [规则函数]
    this.产出规则 = new Map();

    // 消耗规则: 资源名 -> [规则函数]
    this.消耗规则 = new Map();

    // 资源变更历史
    this.变更历史 = [];
    this.历史上限 = 500;
  }

  // ─── 资源类型注册 ───

  注册资源类型(资源名, 配置 = {}) {
    /**
     * 注册资源类型
     * @param 配置 - { 初始值, 最小值, 最大值, 描述, 图标 }
     */
    this.资源配置.set(资源名, {
      最小值: 配置.最小值 ?? 0,
      最大值: 配置.最大值 ?? Infinity,
      描述: 配置.描述 ?? '',
      图标: 配置.图标 ?? null,
      可负数: 配置.可负数 ?? false,
    });

    this.资源映射.set(资源名, 配置.初始值 ?? 0);
  }

  批量注册资源类型(配置对象) {
    Object.entries(配置对象).forEach(([资源名, 配置]) => {
      this.注册资源类型(资源名, 配置);
    });
  }

  // ─── 资源操作 ───

  获取资源(资源名) {
    return this.资源映射.get(资源名) ?? 0;
  }

  设置资源(资源名, 数值) {
    const 配置 = this.资源配置.get(资源名);
    let 最终值 = 数值;

    if (配置) {
      最终值 = Math.min(配置.最大值, Math.max(配置.最小值, 数值));
    }

    const 旧值 = this.获取资源(资源名);
    this.资源映射.set(资源名, 最终值);

    this.记录变更(资源名, 旧值, 最终值, '设置');

    return 最终值;
  }

  修改资源(资源名, 增量, 来源 = '未知') {
    /**
     * 修改资源数量
     * @returns { 成功: boolean, 新值?: number, 实际变化?: number }
     */
    const 当前值 = this.获取资源(资源名);
    const 配置 = this.资源配置.get(资源名);

    let 新值 = 当前值 + 增量;

    // 应用范围限制
    if (配置) {
      if (!配置.可负数 && 新值 < 配置.最小值) {
        // 不允许负数时，检查是否足够消耗
        if (增量 < 0) {
          return {
            成功: false,
            原因: '资源不足',
            当前: 当前值,
            需要: Math.abs(增量),
          };
        }
      }
      新值 = Math.min(配置.最大值, Math.max(配置.最小值, 新值));
    }

    const 实际变化 = 新值 - 当前值;
    this.资源映射.set(资源名, 新值);

    // 记录变更
    this.记录变更(资源名, 当前值, 新值, 来源);

    // 发布事件
    this.事件总线.发布('资源变更', {
      资源名,
      旧值: 当前值,
      新值,
      增量: 实际变化,
      来源,
    });

    return {
      成功: true,
      新值,
      实际变化,
    };
  }

  消耗资源(资源名, 数量, 来源 = '消耗') {
    /**
     * 消耗资源（更语义化的方法）
     */
    return this.修改资源(资源名, -数量, 来源);
  }

  增加资源(资源名, 数量, 来源 = '获得') {
    /**
     * 增加资源（更语义化的方法）
     */
    return this.修改资源(资源名, 数量, 来源);
  }

  // ─── 批量操作 ───

  批量修改(修改列表) {
    /**
     * 批量修改资源
     * @param 修改列表 - [{ 资源名, 增量, 来源? }, ...]
     * @returns 结果列表
     */
    return 修改列表.map(({ 资源名, 增量, 来源 }) => this.修改资源(资源名, 增量, 来源));
  }

  检查资源充足(需求列表) {
    /**
     * 检查资源是否充足
     * @param 需求列表 - { 资源名: 需要数量 } 或 [{ 资源名, 数量 }]
     * @returns { 充足: boolean, 缺少?: { 资源名, 缺少数量 }[] }
     */
    const 缺少列表 = [];

    if (Array.isArray(需求列表)) {
      需求列表.forEach(({ 资源名, 数量 }) => {
        const 当前 = this.获取资源(资源名);
        if (当前 < 数量) {
          缺少列表.push({ 资源名, 缺少数量: 数量 - 当前 });
        }
      });
    } else {
      Object.entries(需求列表).forEach(([资源名, 数量]) => {
        const 当前 = this.获取资源(资源名);
        if (当前 < 数量) {
          缺少列表.push({ 资源名, 缺少数量: 数量 - 当前 });
        }
      });
    }

    return {
      充足: 缺少列表.length === 0,
      缺少: 缺少列表.length > 0 ? 缺少列表 : undefined,
    };
  }

  // ─── 产出消耗规则 ───

  注册产出规则(资源名, 规则函数, 描述 = '') {
    /**
     * 注册周结算产出规则
     * @param 规则函数 - (游戏状态) => 产出数量
     */
    if (!this.产出规则.has(资源名)) {
      this.产出规则.set(资源名, []);
    }
    this.产出规则.get(资源名).push({ 规则函数, 描述 });
  }

  注册消耗规则(资源名, 规则函数, 描述 = '') {
    /**
     * 注册周结算消耗规则
     * @param 规则函数 - (游戏状态) => 消耗数量
     */
    if (!this.消耗规则.has(资源名)) {
      this.消耗规则.set(资源名, []);
    }
    this.消耗规则.get(资源名).push({ 规则函数, 描述 });
  }

  // ─── 周结算 ───

  周结算处理(游戏状态) {
    /**
     * 执行周结算资源变化
     * @returns 结算明细
     */
    const 结算明细 = {
      产出: [],
      消耗: [],
      净变化: {},
    };

    // 处理产出
    this.产出规则.forEach((规则列表, 资源名) => {
      let 总产出 = 0;

      规则列表.forEach(({ 规则函数, 描述 }) => {
        try {
          const 产出量 = 规则函数(游戏状态);
          if (产出量 > 0) {
            总产出 += 产出量;
            结算明细.产出.push({
              资源名,
              数量: 产出量,
              来源: 描述,
            });
          }
        } catch (错误) {
          console.error(`产出规则错误 [${资源名}]:`, 错误);
        }
      });

      if (总产出 > 0) {
        this.修改资源(资源名, 总产出, '周结算产出');
        结算明细.净变化[资源名] = (结算明细.净变化[资源名] ?? 0) + 总产出;
      }
    });

    // 处理消耗
    this.消耗规则.forEach((规则列表, 资源名) => {
      let 总消耗 = 0;

      规则列表.forEach(({ 规则函数, 描述 }) => {
        try {
          const 消耗量 = 规则函数(游戏状态);
          if (消耗量 > 0) {
            总消耗 += 消耗量;
            结算明细.消耗.push({
              资源名,
              数量: 消耗量,
              来源: 描述,
            });
          }
        } catch (错误) {
          console.error(`消耗规则错误 [${资源名}]:`, 错误);
        }
      });

      if (总消耗 > 0) {
        this.修改资源(资源名, -总消耗, '周结算消耗');
        结算明细.净变化[资源名] = (结算明细.净变化[资源名] ?? 0) - 总消耗;
      }
    });

    return 结算明细;
  }

  // ─── 历史记录 ───

  记录变更(资源名, 旧值, 新值, 来源) {
    this.变更历史.push({
      资源名,
      旧值,
      新值,
      变化量: 新值 - 旧值,
      来源,
      时间戳: Date.now(),
    });

    while (this.变更历史.length > this.历史上限) {
      this.变更历史.shift();
    }
  }

  获取变更历史(过滤条件 = {}) {
    let 结果 = [...this.变更历史];

    if (过滤条件.资源名) {
      结果 = 结果.filter(h => h.资源名 === 过滤条件.资源名);
    }

    if (过滤条件.数量) {
      结果 = 结果.slice(-过滤条件.数量);
    }

    return 结果;
  }

  // ─── 查询方法 ───

  获取所有资源() {
    const 结果 = {};
    this.资源映射.forEach((数量, 资源名) => {
      结果[资源名] = {
        数量,
        ...this.资源配置.get(资源名),
      };
    });
    return 结果;
  }

  获取资源列表() {
    return Array.from(this.资源映射.keys());
  }

  // ─── 序列化 ───

  序列化() {
    return {
      资源: Object.fromEntries(this.资源映射),
      变更历史: this.变更历史.slice(-100), // 只保留最近100条
    };
  }

  从序列化恢复(数据) {
    if (数据.资源) {
      Object.entries(数据.资源).forEach(([资源名, 数量]) => {
        this.资源映射.set(资源名, 数量);
      });
    }
    this.变更历史 = 数据.变更历史 ?? [];
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 资源系统 };
export default 资源系统;
