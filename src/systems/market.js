// ═══════════════════════════════════════════════════════════════
// systems/market.js
// 黑市系统 - 管理商品交易和刷新
// ═══════════════════════════════════════════════════════════════

/**
 * 黑市系统
 * 管理黑市商品的展示、购买和刷新
 */
class 黑市系统 {
  constructor(事件总线, 商品注册表, 资源系统) {
    this.事件总线 = 事件总线;
    this.商品注册表 = 商品注册表;
    this.资源系统 = 资源系统;

    // 当前商品库存
    this.当前商品库存 = new Map();

    // 本周购买记录
    this.本周购买记录 = new Map();

    // 交易历史
    this.交易历史 = [];
    this.历史上限 = 100;

    // 当前周次
    this._当前周次 = 1;

    // 交易货币
    this.交易货币 = '母乳';

    // 折扣修正器
    this.折扣修正器 = [];

    // 购买条件检查器
    this.购买条件检查器 = [];
  }

  // ─── 配置方法 ───

  设置交易货币(货币名) {
    this.交易货币 = 货币名;
  }

  设置资源系统(系统) {
    this.资源系统 = 系统;
  }

  // ─── 商品刷新 ───

  刷新商品(周次, 上下文 = {}) {
    /**
     * 刷新黑市商品
     * @param 周次 - 当前周次
     * @param 上下文 - 额外上下文（如游戏状态）
     */
    this._当前周次 = 周次;
    this.本周购买记录.clear();
    this.当前商品库存.clear();

    const 刷新结果 = {
      固定商品: [],
      随机商品: [],
    };

    // 获取所有分类
    const 分类列表 = this.商品注册表.获取所有分类();

    for (const 分类 of 分类列表) {
      const 分类配置 = this.商品注册表.获取分类配置(分类.名称);

      if (分类配置?.随机刷新) {
        // 随机刷新商品
        const 随机商品 = this.商品注册表.执行分类刷新(
          分类.名称,
          周次,
          上下文
        );

        随机商品.forEach(商品 => {
          this.添加商品到库存(商品);
          刷新结果.随机商品.push(商品.名称);
        });
      } else {
        // 固定商品
        const 固定商品 = this.商品注册表.获取分类商品列表(分类.名称);

        固定商品.forEach(商品 => {
          this.添加商品到库存(商品);
          刷新结果.固定商品.push(商品.名称);
        });
      }
    }

    // 发布刷新事件
    this.事件总线.发布('黑市刷新', {
      周次,
      可用商品数: this.当前商品库存.size,
      刷新结果,
    });

    return 刷新结果;
  }

  添加商品到库存(商品) {
    this.当前商品库存.set(商品.名称, {
      ...商品,
      剩余限购: 商品.每周限购 ?? Infinity,
      原价: 商品.价格,
      现价: this.计算商品现价(商品),
    });
  }

  计算商品现价(商品) {
    let 价格 = 商品.价格;

    // 应用折扣修正器
    for (const 修正器 of this.折扣修正器) {
      价格 = 修正器(价格, 商品);
    }

    return Math.max(1, Math.floor(价格));
  }

  // ─── 商品查询 ───

  获取可用商品列表() {
    /**
     * 获取当前可购买的商品列表
     */
    return Array.from(this.当前商品库存.entries())
      .filter(([_, 数据]) => 数据.剩余限购 > 0)
      .map(([名称, 数据]) => ({
        名称,
        ...数据,
        本周已购: this.本周购买记录.get(名称) ?? 0,
      }));
  }

  获取商品详情(商品名) {
    const 商品 = this.当前商品库存.get(商品名);
    if (!商品) return null;

    return {
      ...商品,
      本周已购: this.本周购买记录.get(商品名) ?? 0,
      可购买: 商品.剩余限购 > 0,
    };
  }

  获取分类商品(分类名) {
    return this.获取可用商品列表().filter(商品 => 商品.分类 === 分类名);
  }

  // ─── 购买验证 ───

  验证购买(商品名, 数量 = 1) {
    /**
     * 验证是否可以购买
     */
    const 商品 = this.当前商品库存.get(商品名);

    if (!商品) {
      return { 可购买: false, 原因: '商品不存在或已下架' };
    }

    if (商品.剩余限购 < 数量) {
      return {
        可购买: false,
        原因: '超出限购数量',
        剩余限购: 商品.剩余限购,
        请求数量: 数量,
      };
    }

    const 总价 = 商品.现价 * 数量;
    const 当前货币 = this.资源系统?.获取资源(this.交易货币) ?? 0;

    if (当前货币 < 总价) {
      return {
        可购买: false,
        原因: `${this.交易货币}不足`,
        当前: 当前货币,
        需要: 总价,
      };
    }

    // 执行自定义购买条件检查
    for (const 检查器 of this.购买条件检查器) {
      const 结果 = 检查器(商品, 数量);
      if (!结果.通过) {
        return { 可购买: false, 原因: 结果.原因 };
      }
    }

    // 检查商品自身的购买条件
    if (商品.购买条件 && !商品.购买条件({ 商品, 数量 })) {
      return { 可购买: false, 原因: '不满足购买条件' };
    }

    return {
      可购买: true,
      总价,
      单价: 商品.现价,
    };
  }

  // ─── 购买执行 ───

  购买商品(商品名, 数量 = 1, 选项 = {}) {
    /**
     * 购买商品
     * @returns { 成功, 效果?, 原因? }
     */
    // 验证
    const 验证结果 = this.验证购买(商品名, 数量);
    if (!验证结果.可购买) {
      return { 成功: false, ...验证结果 };
    }

    const 商品 = this.当前商品库存.get(商品名);
    const 总价 = 验证结果.总价;

    // 扣除货币
    const 扣除结果 = this.资源系统?.消耗资源(
      this.交易货币,
      总价,
      `黑市购买:${商品名}`
    );

    if (!扣除结果?.成功) {
      return { 成功: false, 原因: '货币扣除失败' };
    }

    // 减少库存
    商品.剩余限购 -= 数量;

    // 记录购买
    const 已购数量 = this.本周购买记录.get(商品名) ?? 0;
    this.本周购买记录.set(商品名, 已购数量 + 数量);

    // 记录交易历史
    this.记录交易历史({
      类型: '购买',
      商品名,
      数量,
      单价: 商品.现价,
      总价,
      效果: 商品.效果,
      周次: this._当前周次,
    });

    // 发布购买事件
    this.事件总线.发布('商品购买', {
      商品名,
      数量,
      总价,
      效果: 商品.效果,
      剩余限购: 商品.剩余限购,
    });

    return {
      成功: true,
      商品名,
      数量,
      总价,
      效果: 商品.效果,
      剩余货币: this.资源系统?.获取资源(this.交易货币),
    };
  }

  批量购买(购买列表) {
    /**
     * 批量购买商品
     * @param 购买列表 - [{ 商品名, 数量 }, ...]
     */
    const 结果列表 = [];
    let 总花费 = 0;

    for (const { 商品名, 数量 } of 购买列表) {
      const 结果 = this.购买商品(商品名, 数量 ?? 1);
      结果列表.push({ 商品名, ...结果 });

      if (结果.成功) {
        总花费 += 结果.总价;
      }
    }

    return {
      结果列表,
      总花费,
      成功数: 结果列表.filter(r => r.成功).length,
    };
  }

  // ─── 效果应用 ───

  应用商品效果(效果, 目标上下文 = {}) {
    /**
     * 应用商品效果（由外部调用者根据效果类型处理）
     * 这里只返回效果信息，实际处理由游戏控制器完成
     */
    return {
      效果类型: 效果.类型,
      效果参数: 效果,
      目标上下文,
    };
  }

  // ─── 折扣管理 ───

  添加折扣修正器(修正函数, 描述 = '') {
    /**
     * 添加价格折扣修正器
     * @param 修正函数 - (原价, 商品) => 修正后价格
     * @returns 移除函数
     */
    const 修正器 = { 函数: 修正函数, 描述 };
    this.折扣修正器.push(修正器.函数);

    // 重新计算所有商品价格
    this.重新计算价格();

    return () => {
      const 索引 = this.折扣修正器.indexOf(修正器.函数);
      if (索引 !== -1) {
        this.折扣修正器.splice(索引, 1);
        this.重新计算价格();
      }
    };
  }

  重新计算价格() {
    this.当前商品库存.forEach((商品, 名称) => {
      商品.现价 = this.计算商品现价(商品);
    });
  }

  // ─── 购买条件检查器 ───

  添加购买条件检查器(检查函数) {
    /**
     * 添加自定义购买条件检查器
     * @param 检查函数 - (商品, 数量) => { 通过: boolean, 原因?: string }
     */
    this.购买条件检查器.push(检查函数);

    return () => {
      const 索引 = this.购买条件检查器.indexOf(检查函数);
      if (索引 !== -1) {
        this.购买条件检查器.splice(索引, 1);
      }
    };
  }

  // ─── 特殊商品操作 ───

  添加临时商品(商品配置) {
    /**
     * 添加临时商品（如事件奖励商品）
     */
    this.添加商品到库存({
      临时: true,
      ...商品配置,
    });

    this.事件总线.发布('临时商品添加', { 商品名: 商品配置.名称 });
  }

  移除商品(商品名) {
    const 商品 = this.当前商品库存.get(商品名);
    if (商品) {
      this.当前商品库存.delete(商品名);
      return true;
    }
    return false;
  }

  // ─── 历史记录 ───

  记录交易历史(记录) {
    this.交易历史.push({
      ...记录,
      时间戳: Date.now(),
    });

    while (this.交易历史.length > this.历史上限) {
      this.交易历史.shift();
    }
  }

  获取交易历史(过滤条件 = {}) {
    let 结果 = [...this.交易历史];

    if (过滤条件.商品名) {
      结果 = 结果.filter(h => h.商品名 === 过滤条件.商品名);
    }

    if (过滤条件.周次) {
      结果 = 结果.filter(h => h.周次 === 过滤条件.周次);
    }

    if (过滤条件.数量) {
      结果 = 结果.slice(-过滤条件.数量);
    }

    return 结果;
  }

  获取本周交易统计() {
    const 本周记录 = this.交易历史.filter(h => h.周次 === this._当前周次);

    return {
      交易次数: 本周记录.length,
      总花费: 本周记录.reduce((sum, h) => sum + h.总价, 0),
      购买商品: Object.fromEntries(this.本周购买记录),
    };
  }

  // ─── 状态查询 ───

  获取货币状态() {
    return {
      货币类型: this.交易货币,
      当前数量: this.资源系统?.获取资源(this.交易货币) ?? 0,
    };
  }

  获取黑市状态() {
    return {
      当前周次: this._当前周次,
      商品数量: this.当前商品库存.size,
      可购买商品数: this.获取可用商品列表().length,
      本周交易: this.获取本周交易统计(),
    };
  }

  // ─── 周结算 ───

  周结算处理(新周次) {
    // 周结算时自动刷新（如果需要的话）
    // 通常由游戏控制器在新周开始时调用刷新商品
  }

  // ─── 序列化 ───

  序列化() {
    // 将商品库存转换为可序列化格式
    const 商品库存数据 = {};
    this.当前商品库存.forEach((商品, 名称) => {
      商品库存数据[名称] = {
        ...商品,
        // 移除不可序列化的函数
        购买条件: undefined,
      };
    });

    return {
      当前商品库存: 商品库存数据,
      本周购买记录: Object.fromEntries(this.本周购买记录),
      当前周次: this._当前周次,
      交易历史: this.交易历史.slice(-30),
    };
  }

  从序列化恢复(数据) {
    this._当前周次 = 数据.当前周次 ?? 1;

    if (数据.本周购买记录) {
      this.本周购买记录 = new Map(Object.entries(数据.本周购买记录));
    }

    if (数据.当前商品库存) {
      this.当前商品库存.clear();
      Object.entries(数据.当前商品库存).forEach(([名称, 商品]) => {
        const 注册定义 = this.商品注册表.获取商品定义(名称);
        this.当前商品库存.set(名称, {
          ...商品,
          购买条件: 注册定义?.购买条件,
        });
      });
    }
    this.交易历史 = 数据.交易历史 ?? [];
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 黑市系统 };
export default 黑市系统;
