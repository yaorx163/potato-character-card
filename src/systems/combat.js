// ═══════════════════════════════════════════════════════════════
// systems/combat.js
// 战斗系统 - 管理军队战斗、战力计算和战斗结算
// ═══════════════════════════════════════════════════════════════

/**
 * 战斗系统
 * 管理军队编成、战力计算、战斗执行和结果处理
 */
class 战斗系统 {
  constructor(事件总线, 公式引擎, 情报系统 = null) {
    this.事件总线 = 事件总线;
    this.公式引擎 = 公式引擎;
    this.情报系统 = 情报系统;

    // 战斗结果处理器
    this.战斗结果处理器 = new Map();

    // 战斗历史
    this.战斗历史 = [];
    this.历史上限 = 50;

    // 战斗结果定义表
    this.战斗结果表 = this.初始化战斗结果表();

    // 战斗修正器（用于临时buff等）
    this.战力修正器 = [];
  }

  // ─── 战斗结果表 ───

  初始化战斗结果表() {
    return [
      {
        类型: '溃败',
        战力比范围: [0, 0.5],
        存活率: 0.2,
        士气变化: -50,
        俘获规则: null,
        描述: '我军遭遇惨烈失败，大量人员溃散',
      },
      {
        类型: '惨败',
        战力比范围: [0.5, 0.8],
        存活率: 0.4,
        士气变化: -30,
        俘获规则: null,
        描述: '我军战败，损失惨重',
      },
      {
        类型: '惜败',
        战力比范围: [0.8, 1.0],
        存活率: 0.6,
        士气变化: -10,
        俘获规则: null,
        描述: '我军略处下风，有序撤退',
      },
      {
        类型: '险胜',
        战力比范围: [1.0, 1.2],
        存活率: 0.7,
        士气变化: 5,
        俘获规则: { 保底: 1 },
        描述: '我军险胜，付出一定代价',
      },
      {
        类型: '小胜',
        战力比范围: [1.2, 1.5],
        存活率: 0.85,
        士气变化: 10,
        俘获规则: { 保底: 2 },
        描述: '我军获胜，战果可观',
      },
      {
        类型: '大胜',
        战力比范围: [1.5, 2.0],
        存活率: 0.95,
        士气变化: 15,
        俘获规则: { 保底: 3 },
        描述: '我军大获全胜',
      },
      {
        类型: '碾压',
        战力比范围: [2.0, Infinity],
        存活率: 1.0,
        士气变化: 20,
        俘获规则: { 全部俘获: true },
        描述: '我军以压倒性优势获胜',
      },
    ];
  }

  // ─── 战力计算 ───

  计算部曲战力(冠军, 喽啰配置, 士气) {
    /**
     * 计算单个部曲（冠军+喽啰）的战力
     * @param 冠军 - 冠军实体
     * @param 喽啰配置 - [{ 数量, 武装等级, 战斗力 }, ...]
     * @param 士气 - 当前士气值
     */
    const 力量 = 冠军.获取属性('力量');
    const 可统帅上限 = 冠军.计算可统帅喽啰数?.() ?? 力量;

    let 总战力 = 0;
    let 已分配喽啰 = 0;

    // 按战斗力从高到低排序喽啰配置
    const 排序后配置 = [...喽啰配置].sort((a, b) => b.战斗力 - a.战斗力);

    for (const 配置 of 排序后配置) {
      const 可分配数量 = Math.min(配置.数量, 可统帅上限 - 已分配喽啰);
      if (可分配数量 <= 0) continue;

      // 部曲战力公式
      const 部曲战力 =
        this.公式引擎?.计算('部曲战力', {
          有效喽啰数: 可分配数量,
          冠军力量: 力量,
          武装战斗力: 配置.战斗力,
          士气,
        }) ?? (可分配数量 + Math.floor(力量 / 20)) * (配置.战斗力 / 100);

      总战力 += 部曲战力;
      已分配喽啰 += 可分配数量;
    }

    // 士气系数
    const 士气系数 = this.公式引擎?.计算('士气系数', { 士气 }) ?? Math.pow(1.1, (士气 + 20) / 10 - 10);

    return {
      战力: 总战力 * 士气系数,
      已分配喽啰,
      溢出喽啰: 喽啰配置.reduce((sum, c) => sum + c.数量, 0) - 已分配喽啰,
    };
  }

  计算军队总战力(出击配置) {
    /**
     * 计算整个军队的总战力
     * @param 出击配置 - { 部曲列表: [{ 冠军, 喽啰配置 }], 士气 }
     */
    const { 部曲列表, 士气 } = 出击配置;

    let 总战力 = 0;
    const 部曲详情 = [];

    for (const 部曲 of 部曲列表) {
      const 结果 = this.计算部曲战力(部曲.冠军, 部曲.喽啰配置, 士气);
      总战力 += 结果.战力;
      部曲详情.push({
        冠军ID: 部曲.冠军.实体ID,
        冠军姓名: 部曲.冠军.获取属性('姓名'),
        ...结果,
      });
    }

    // 应用战力修正器
    let 修正后战力 = 总战力;
    for (const 修正器 of this.战力修正器) {
      修正后战力 = 修正器(修正后战力, 出击配置);
    }

    return {
      基础战力: 总战力,
      修正后战力,
      部曲详情,
      士气,
    };
  }

  // ─── 战斗执行 ───

  执行战斗(我方配置, 敌方战力, 战斗参数 = {}) {
    /**
     * 执行战斗
     * @param 我方配置 - { 部曲列表, 士气 }
     * @param 敌方战力 - 敌方战力值
     * @param 战斗参数 - { 目标ID?, 战斗类型? }
     * @returns 战斗结果报告
     */
    const 目标ID = 战斗参数.目标ID;

    // 发布战斗开始事件
    this.事件总线.发布('战斗开始', {
      我方配置,
      敌方战力,
      目标ID,
    });

    // 计算我方战力
    const 我方战力计算 = this.计算军队总战力(我方配置);
    const 我方战力 = 我方战力计算.修正后战力;

    // 计算战力比
    const 战力比 = 敌方战力 > 0 ? 我方战力 / 敌方战力 : Infinity;

    // 确定战斗结果
    const 结果模板 = this.判定战斗结果(战力比);

    // 计算损失
    const 喽啰损失 = this.计算喽啰损失(我方配置, 结果模板.存活率);

    // 计算冠军损失（可选）
    const 冠军损失 = this.计算冠军损失(我方配置, 结果模板);

    // 处理战利品
    const 战利品 = this.处理战利品(目标ID, 结果模板);

    // 士气变化
    const 士气变化 = 结果模板.士气变化;

    // 构建战斗报告
    const 战斗报告 = {
      时间戳: Date.now(),
      目标ID,
      我方战力,
      敌方战力,
      战力比: Math.round(战力比 * 100) / 100,
      结果类型: 结果模板.类型,
      是否胜利: 战力比 >= 1.0,
      描述: 结果模板.描述,
      喽啰损失,
      冠军损失,
      战利品,
      士气变化,
      我方战力详情: 我方战力计算,
    };

    // 记录历史
    this.记录战斗历史(战斗报告);

    // 发布战斗结束事件
    this.事件总线.发布('战斗结束', 战斗报告);

    return 战斗报告;
  }

  判定战斗结果(战力比) {
    /**
     * 根据战力比判定战斗结果
     */
    for (const 结果 of this.战斗结果表) {
      const [下限, 上限] = 结果.战力比范围;
      if (战力比 >= 下限 && 战力比 < 上限) {
        return { ...结果 };
      }
    }

    // 默认返回碾压
    return { ...this.战斗结果表[this.战斗结果表.length - 1] };
  }

  // ─── 损失计算 ───

  计算喽啰损失(配置, 存活率) {
    /**
     * 计算各武装等级的喽啰损失
     */
    const 损失明细 = [];
    let 总损失 = 0;

    配置.部曲列表.forEach(部曲 => {
      部曲.喽啰配置.forEach(喽啰组 => {
        const 损失数 = Math.floor(喽啰组.数量 * (1 - 存活率));
        if (损失数 > 0) {
          损失明细.push({
            武装等级: 喽啰组.武装等级 ?? '未武装',
            损失数量: 损失数,
            剩余数量: 喽啰组.数量 - 损失数,
          });
          总损失 += 损失数;
        }
      });
    });

    return {
      明细: 损失明细,
      总损失,
    };
  }

  计算冠军损失(配置, 结果模板) {
    /**
     * 计算冠军损失（负伤或阵亡）
     */
    const 损失情况 = [];

    // 只有惨败及以下才可能有冠军损失
    if (结果模板.存活率 >= 0.6) {
      return { 损失情况, 有损失: false };
    }

    配置.部曲列表.forEach(部曲 => {
      const 冠军 = 部曲.冠军;

      // 根据存活率计算负伤概率
      const 负伤概率 = (1 - 结果模板.存活率) * 0.5;
      const 阵亡概率 = 结果模板.存活率 < 0.3 ? 0.1 : 0;

      if (Math.random() < 阵亡概率) {
        损失情况.push({
          冠军ID: 冠军.实体ID,
          冠军姓名: 冠军.获取属性('姓名'),
          状态: '阵亡',
        });
      } else if (Math.random() < 负伤概率) {
        损失情况.push({
          冠军ID: 冠军.实体ID,
          冠军姓名: 冠军.获取属性('姓名'),
          状态: '负伤',
        });
      }
    });

    return {
      损失情况,
      有损失: 损失情况.length > 0,
    };
  }

  // ─── 战利品处理 ───

  处理战利品(目标ID, 战斗结果) {
    /**
     * 处理战斗胜利后的战利品（主要是俘获目标）
     */
    const 战利品 = {
      俘获目标: [],
      其他资源: {},
    };

    if (!目标ID || !this.情报系统) {
      return 战利品;
    }

    const 情报 = this.情报系统.获取目标情报(目标ID);
    if (!情报) return 战利品;

    // 已锁定目标全部俘获
    const 已锁定 = this.情报系统.获取已锁定目标(目标ID);
    已锁定.forEach(目标 => {
      战利品.俘获目标.push(目标);
    });

    // 处理俘获规则
    if (战斗结果.俘获规则) {
      if (战斗结果.俘获规则.全部俘获) {
        // 俘获所有高价值目标
        const 未锁定 = this.情报系统.获取未锁定目标(目标ID);
        未锁定.forEach(目标 => {
          if (!战利品.俘获目标.find(t => t.ID === 目标.ID)) {
            战利品.俘获目标.push(目标);
          }
        });
      } else if (战斗结果.俘获规则.保底) {
        // 保底俘获数量
        const 未锁定 = this.情报系统.获取未锁定目标(目标ID);
        const 可俘获数 = Math.min(战斗结果.俘获规则.保底, 未锁定.length);

        for (let i = 0; i < 可俘获数; i++) {
          if (!战利品.俘获目标.find(t => t.ID === 未锁定[i].ID)) {
            战利品.俘获目标.push(未锁定[i]);
          }
        }
      }
    }

    return 战利品;
  }

  // ─── 战力修正器 ───

  添加战力修正器(修正函数, 标识 = '', 优先级 = 0) {
    /**
     * 添加临时战力修正器
     * @param 修正函数 - (当前战力, 配置) => 修正后战力
     * @returns 移除修正器函数
     */
    const 修正器 = { 函数: 修正函数, 标识, 优先级 };
    this.战力修正器.push(修正器);
    this.战力修正器.sort((a, b) => b.优先级 - a.优先级);

    return () => {
      const 索引 = this.战力修正器.indexOf(修正器);
      if (索引 !== -1) this.战力修正器.splice(索引, 1);
    };
  }

  清空战力修正器() {
    this.战力修正器 = [];
  }

  // ─── 结果处理器 ───

  注册战斗结果处理器(结果类型, 处理函数) {
    /**
     * 注册特定战斗结果的后处理器
     */
    this.战斗结果处理器.set(结果类型, 处理函数);
  }

  // ─── 历史记录 ───

  记录战斗历史(报告) {
    this.战斗历史.push(报告);

    while (this.战斗历史.length > this.历史上限) {
      this.战斗历史.shift();
    }
  }

  获取战斗历史(过滤条件 = {}) {
    let 结果 = [...this.战斗历史];

    if (过滤条件.目标ID) {
      结果 = 结果.filter(h => h.目标ID === 过滤条件.目标ID);
    }

    if (过滤条件.只看胜利) {
      结果 = 结果.filter(h => h.是否胜利);
    }

    if (过滤条件.数量) {
      结果 = 结果.slice(-过滤条件.数量);
    }

    return 结果;
  }

  // ─── 战力预估 ───

  预估战斗结果(我方配置, 敌方战力估计) {
    /**
     * 预估战斗结果（用于UI显示）
     * @param 敌方战力估计 - { 最小, 最大 }
     */
    const 我方战力 = this.计算军队总战力(我方配置).修正后战力;

    const 最优战力比 = 敌方战力估计.最小 > 0 ? 我方战力 / 敌方战力估计.最小 : Infinity;

    const 最劣战力比 = 敌方战力估计.最大 > 0 ? 我方战力 / 敌方战力估计.最大 : 0;

    const 最优结果 = this.判定战斗结果(最优战力比);
    const 最劣结果 = this.判定战斗结果(最劣战力比);

    return {
      我方战力,
      敌方战力估计,
      最优情况: {
        战力比: 最优战力比,
        结果类型: 最优结果.类型,
        存活率: 最优结果.存活率,
      },
      最劣情况: {
        战力比: 最劣战力比,
        结果类型: 最劣结果.类型,
        存活率: 最劣结果.存活率,
      },
      建议: this.生成战斗建议(最劣战力比),
    };
  }

  生成战斗建议(最劣战力比) {
    if (最劣战力比 >= 2.0) return '胜券在握，可放心出击';
    if (最劣战力比 >= 1.5) return '胜算较大，建议出击';
    if (最劣战力比 >= 1.0) return '胜负难料，谨慎考虑';
    if (最劣战力比 >= 0.7) return '风险较大，不建议出击';
    return '敌我悬殊，强烈不建议出击';
  }

  // ─── 序列化 ───

  序列化() {
    return {
      战斗历史: this.战斗历史,
    };
  }

  从序列化恢复(数据) {
    this.战斗历史 = 数据.战斗历史 ?? [];
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 战斗系统 };
export default 战斗系统;
