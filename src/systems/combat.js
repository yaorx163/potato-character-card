// ═══════════════════════════════════════════════════════════════
// systems/combat.js
// 战斗系统 - 管理军队战斗、战力计算和战斗结算
// ═══════════════════════════════════════════════════════════════

/**
 * 战斗系统
 * 管理军队编成、战力计算、战斗执行和结果处理
 */
class 战斗系统 {
  constructor(事件总线, 公式引擎) {
    this.事件总线 = 事件总线;
    this.公式引擎 = 公式引擎;

    // 战斗结果处理器
    this.战斗结果处理器 = new Map();

    // 战斗历史
    this.战斗历史 = [];
    this.历史上限 = 50;

    // 战力修正器
    this.战力修正器 = [];
  }

  // ─── 配置获取 ───

  获取配置(配置名, 默认值) {
    return this.公式引擎?.获取常量(配置名, 默认值) ?? 默认值;
  }

  // ─── 战斗结果表（动态生成）───

  生成战斗结果表() {
    return [
      {
        类型: '溃败',
        战力比范围: [0, this.获取配置('战力比_溃败上限', 0.5)],
        存活率: this.获取配置('存活率_溃败', 0.2),
        士气变化: this.获取配置('士气变化_溃败', -50),
        俘获规则: null,
        描述: '我军遭遇惨烈失败，大量人员溃散',
      },
      {
        类型: '惨败',
        战力比范围: [this.获取配置('战力比_溃败上限', 0.5), this.获取配置('战力比_惨败上限', 0.8)],
        存活率: this.获取配置('存活率_惨败', 0.4),
        士气变化: this.获取配置('士气变化_惨败', -30),
        俘获规则: null,
        描述: '我军战败，损失惨重',
      },
      {
        类型: '惜败',
        战力比范围: [this.获取配置('战力比_惨败上限', 0.8), this.获取配置('战力比_惜败上限', 1.0)],
        存活率: this.获取配置('存活率_惜败', 0.6),
        士气变化: this.获取配置('士气变化_惜败', -10),
        俘获规则: null,
        描述: '我军略处下风，有序撤退',
      },
      {
        类型: '险胜',
        战力比范围: [this.获取配置('战力比_惜败上限', 1.0), this.获取配置('战力比_险胜上限', 1.2)],
        存活率: this.获取配置('存活率_险胜', 0.7),
        士气变化: this.获取配置('士气变化_险胜', 5),
        俘获规则: { 保底: this.获取配置('俘获保底_险胜', 1) },
        描述: '我军险胜，付出一定代价',
      },
      {
        类型: '小胜',
        战力比范围: [this.获取配置('战力比_险胜上限', 1.2), this.获取配置('战力比_小胜上限', 1.5)],
        存活率: this.获取配置('存活率_小胜', 0.85),
        士气变化: this.获取配置('士气变化_小胜', 10),
        俘获规则: { 保底: this.获取配置('俘获保底_小胜', 2) },
        描述: '我军获胜，战果可观',
      },
      {
        类型: '大胜',
        战力比范围: [this.获取配置('战力比_小胜上限', 1.5), this.获取配置('战力比_大胜上限', 2.0)],
        存活率: this.获取配置('存活率_大胜', 0.95),
        士气变化: this.获取配置('士气变化_大胜', 15),
        俘获规则: { 保底: this.获取配置('俘获保底_大胜', 3) },
        描述: '我军大获全胜',
      },
      {
        类型: '碾压',
        战力比范围: [this.获取配置('战力比_大胜上限', 2.0), Infinity],
        存活率: this.获取配置('存活率_碾压', 1.0),
        士气变化: this.获取配置('士气变化_碾压', 20),
        俘获规则: { 全部俘获: true },
        描述: '我军以压倒性优势获胜',
      },
    ];
  }

  // ─── 战力计算 ───

  计算部曲战力(冠军, 喽啰配置, 士气) {
    const 力量 = 冠军.获取属性('力量');
    const 可统帅上限 = 冠军.计算可统帅喽啰数?.() ?? 力量;

    let 总战力 = 0;
    let 已分配喽啰 = 0;

    const 排序后配置 = [...喽啰配置].sort((a, b) => b.战斗力 - a.战斗力);

    for (const 配置 of 排序后配置) {
      const 可分配数量 = Math.min(配置.数量, 可统帅上限 - 已分配喽啰);
      if (可分配数量 <= 0) continue;

      const 部曲战力 =
        this.公式引擎?.计算('部曲战力', {
          有效喽啰数: 可分配数量,
          冠军力量: 力量,
          武装战斗力: 配置.战斗力,
          士气,
        }) ?? 可分配数量 * (配置.战斗力 / 100);

      总战力 += 部曲战力;
      已分配喽啰 += 可分配数量;
    }

    const 士气系数 = this.公式引擎?.计算('士气系数', { 士气 }) ?? 1.0;

    return {
      战力: 总战力 * 士气系数,
      已分配喽啰,
      溢出喽啰: 喽啰配置.reduce((sum, c) => sum + c.数量, 0) - 已分配喽啰,
    };
  }

  计算军队总战力(出击配置) {
    const { 部曲列表, 士气 } = 出击配置;

    let 总战力 = 0;
    const 部曲详情 = [];

    for (const 部曲 of 部曲列表) {
      const 结果 = this.计算部曲战力(部曲.冠军, 部曲.喽啰配置, 士气);
      总战力 += 结果.战力;
      部曲详情.push({
        冠军ID: 部曲.冠军.实体ID,
        冠军姓名: 部曲.冠军.获取属性('姓名'),
        ...结果,
      });
    }

    let 修正后战力 = 总战力;
    for (const 修正器 of this.战力修正器) {
      修正后战力 = 修正器(修正后战力, 出击配置);
    }

    return {
      基础战力: 总战力,
      修正后战力,
      部曲详情,
      士气,
    };
  }

  // ─── 战斗执行 ───

  执行战斗(我方配置, 敌方战力, 战斗参数 = {}) {
    const 目标ID = 战斗参数.目标ID;

    this.事件总线.发布('战斗开始', {
      我方配置,
      敌方战力,
      目标ID,
    });

    const 我方战力计算 = this.计算军队总战力(我方配置);
    const 我方战力 = 我方战力计算.修正后战力;

    const 战力比 = 敌方战力 > 0 ? 我方战力 / 敌方战力 : Infinity;

    const 结果模板 = this.判定战斗结果(战力比);

    const 喽啰损失 = this.计算喽啰损失(我方配置, 结果模板.存活率);
    const 冠军损失 = this.计算冠军损失(我方配置, 结果模板, 战力比);
    const 战利品 = this.处理战利品(目标ID, 结果模板);

    const 战斗报告 = {
      时间戳: Date.now(),
      目标ID,
      我方战力,
      敌方战力,
      战力比: Math.round(战力比 * 100) / 100,
      结果类型: 结果模板.类型,
      是否胜利: 战力比 >= 1.0,
      描述: 结果模板.描述,
      喽啰损失,
      冠军损失,
      战利品,
      士气变化: 结果模板.士气变化,
      我方战力详情: 我方战力计算,
    };

    this.记录战斗历史(战斗报告);

    this.事件总线.发布('战斗结束', 战斗报告);

    return 战斗报告;
  }

  判定战斗结果(战力比) {
    const 结果表 = this.生成战斗结果表();
    for (const 结果 of 结果表) {
      const [下限, 上限] = 结果.战力比范围;
      if (战力比 >= 下限 && 战力比 < 上限) {
        return { ...结果 };
      }
    }
    return { ...结果表[结果表.length - 1] };
  }

  // ─── 损失计算 ───

  计算喽啰损失(配置, 存活率) {
    const 损失明细 = [];
    let 总损失 = 0;

    配置.部曲列表.forEach(部曲 => {
      部曲.喽啰配置.forEach(喽啰组 => {
        const 损失数 = Math.floor(喽啰组.数量 * (1 - 存活率));
        if (损失数 > 0) {
          损失明细.push({
            武装等级: 喽啰组.武装等级 ?? '未武装',
            损失数量: 损失数,
            剩余数量: 喽啰组.数量 - 损失数,
          });
          总损失 += 损失数;
        }
      });
    });

    return {
      明细: 损失明细,
      总损失,
    };
  }

  计算冠军损失(配置, 结果模板, 战力比) {
    const 损失情况 = [];

    const 惜败存活率 = this.获取配置('存活率_惜败', 0.6);
    if (结果模板.存活率 >= 惜败存活率) {
      return { 损失情况, 有损失: false };
    }

    配置.部曲列表.forEach(部曲 => {
      const 冠军 = 部曲.冠军;
      const 已负伤 = 冠军.拥有标签?.('负伤') ?? false;

      const 阵亡概率 = this.公式引擎?.计算('冠军阵亡概率', { 战力比, 已负伤 }) ?? 0;
      const 负伤概率 = this.公式引擎?.计算('冠军负伤概率', { 战力比, 已负伤 }) ?? 0;

      if (Math.random() < 阵亡概率) {
        损失情况.push({
          冠军ID: 冠军.实体ID,
          冠军姓名: 冠军.获取属性('姓名'),
          状态: '阵亡',
        });
      } else if (Math.random() < 负伤概率) {
        损失情况.push({
          冠军ID: 冠军.实体ID,
          冠军姓名: 冠军.获取属性('姓名'),
          状态: '负伤',
        });
      }
    });

    return {
      损失情况,
      有损失: 损失情况.length > 0,
    };
  }


  // ─── 战力修正器 ───

  添加战力修正器(修正函数, 标识 = '', 优先级 = 0) {
    const 修正器 = { 函数: 修正函数, 标识, 优先级 };
    this.战力修正器.push(修正器);
    this.战力修正器.sort((a, b) => b.优先级 - a.优先级);

    return () => {
      const 索引 = this.战力修正器.indexOf(修正器);
      if (索引 !== -1) this.战力修正器.splice(索引, 1);
    };
  }

  清空战力修正器() {
    this.战力修正器 = [];
  }

  // ─── 历史记录 ───

  记录战斗历史(报告) {
    this.战斗历史.push(报告);

    while (this.战斗历史.length > this.历史上限) {
      this.战斗历史.shift();
    }
  }

  获取战斗历史(过滤条件 = {}) {
    let 结果 = [...this.战斗历史];

    if (过滤条件.目标ID) {
      结果 = 结果.filter(h => h.目标ID === 过滤条件.目标ID);
    }

    if (过滤条件.只看胜利) {
      结果 = 结果.filter(h => h.是否胜利);
    }

    if (过滤条件.数量) {
      结果 = 结果.slice(-过滤条件.数量);
    }

    return 结果;
  }

  // ─── 战力预估 ───

  预估战斗结果(我方配置, 敌方战力估计) {
    const 我方战力 = this.计算军队总战力(我方配置).修正后战力;

    const 最优战力比 = 敌方战力估计.最小 > 0 ? 我方战力 / 敌方战力估计.最小 : Infinity;
    const 最劣战力比 = 敌方战力估计.最大 > 0 ? 我方战力 / 敌方战力估计.最大 : 0;

    const 最优结果 = this.判定战斗结果(最优战力比);
    const 最劣结果 = this.判定战斗结果(最劣战力比);

    return {
      我方战力,
      敌方战力估计,
      最优情况: {
        战力比: 最优战力比,
        结果类型: 最优结果.类型,
        存活率: 最优结果.存活率,
      },
      最劣情况: {
        战力比: 最劣战力比,
        结果类型: 最劣结果.类型,
        存活率: 最劣结果.存活率,
      },
      建议: this.生成战斗建议(最劣战力比),
    };
  }

  生成战斗建议(最劣战力比) {
    const 大胜阈值 = this.获取配置('战力比_大胜上限', 2.0);
    const 小胜阈值 = this.获取配置('战力比_小胜上限', 1.5);
    const 惜败阈值 = this.获取配置('战力比_惜败上限', 1.0);
    const 惨败阈值 = this.获取配置('战力比_惨败上限', 0.8);

    if (最劣战力比 >= 大胜阈值) return '胜券在握，可放心出击';
    if (最劣战力比 >= 小胜阈值) return '胜算较大，建议出击';
    if (最劣战力比 >= 惜败阈值) return '胜负难料，谨慎考虑';
    if (最劣战力比 >= 惨败阈值) return '风险较大，不建议出击';
    return '敌我悬殊，强烈不建议出击';
  }

  序列化() {
    return {
      战斗历史: this.战斗历史,
    };
  }

  从序列化恢复(数据) {
    this.战斗历史 = 数据.战斗历史 ?? [];
  }
}

export { 战斗系统 };
export default 战斗系统;
