// ═══════════════════════════════════════════════════════════════
// systems/time.js
// 时间系统 - 管理游戏回合、行动点和周结算
// ═══════════════════════════════════════════════════════════════

class 时间系统 {
  constructor(事件总线, 配置 = {}, 公式引擎 = null) {
    this.事件总线 = 事件总线;
    this.公式引擎 = 公式引擎;

    // 从公式引擎获取配置或使用传入配置
    const 获取配置值 = (名称, 默认值) => {
      return 配置[名称] ?? 公式引擎?.获取常量(名称, 默认值) ?? 默认值;
    };

    this.当前周次 = 配置.初始周次 ?? 1;
    this.周行动点上限 = 获取配置值('周行动点上限', 3);
    this.剩余行动点 = 配置.初始行动点 ?? this.周行动点上限;

    this.周结算处理器 = [];
    this.新周处理器 = [];
    this.本周事件记录 = [];
    this.周历史 = [];
    this.历史上限 = 获取配置值('历史记录上限', 100);

    this.已暂停 = false;
  }

  设置公式引擎(引擎) {
    this.公式引擎 = 引擎;
  }

  // ─── 行动点管理 ───

  消耗行动点(数量 = 1) {
    if (this.已暂停) {
      return { 成功: false, 原因: '时间已暂停' };
    }

    if (this.剩余行动点 < 数量) {
      return {
        成功: false,
        原因: '行动点不足',
        剩余: this.剩余行动点,
        需要: 数量,
      };
    }

    this.剩余行动点 -= 数量;

    this.事件总线.发布('行动点消耗', {
      消耗数量: 数量,
      剩余: this.剩余行动点,
      周次: this.当前周次,
    });

    return {
      成功: true,
      剩余: this.剩余行动点,
    };
  }

  恢复行动点(数量 = 1) {
    const 旧值 = this.剩余行动点;
    this.剩余行动点 = Math.min(this.周行动点上限, this.剩余行动点 + 数量);
    const 实际恢复 = this.剩余行动点 - 旧值;

    if (实际恢复 > 0) {
      this.事件总线.发布('行动点恢复', {
        恢复数量: 实际恢复,
        剩余: this.剩余行动点,
      });
    }

    return { 实际恢复, 剩余: this.剩余行动点 };
  }

  设置行动点上限(新上限) {
    this.周行动点上限 = 新上限;
  }

  获取行动点状态() {
    return {
      剩余: this.剩余行动点,
      上限: this.周行动点上限,
      已消耗: this.周行动点上限 - this.剩余行动点,
    };
  }

  // ─── 周结算处理器 ───

  注册周结算处理器(处理函数, 优先级 = 0) {
    const 处理器信息 = { 处理函数, 优先级 };
    this.周结算处理器.push(处理器信息);
    this.周结算处理器.sort((a, b) => b.优先级 - a.优先级);

    return () => {
      const 索引 = this.周结算处理器.indexOf(处理器信息);
      if (索引 !== -1) {
        this.周结算处理器.splice(索引, 1);
      }
    };
  }

  注册新周处理器(处理函数, 优先级 = 0) {
    const 处理器信息 = { 处理函数, 优先级 };
    this.新周处理器.push(处理器信息);
    this.新周处理器.sort((a, b) => b.优先级 - a.优先级);

    return () => {
      const 索引 = this.新周处理器.indexOf(处理器信息);
      if (索引 !== -1) {
        this.新周处理器.splice(索引, 1);
      }
    };
  }

  // ─── 周流转 ───

  结束当前周(游戏状态) {
    if (this.已暂停) {
      return { 成功: false, 原因: '时间已暂停' };
    }

    this.事件总线.发布('周结算开始', {
      周次: this.当前周次,
    });

    const 结算结果列表 = [];

    for (const { 处理函数 } of this.周结算处理器) {
      try {
        const 结果 = 处理函数(游戏状态, this.当前周次);
        if (结果) {
          结算结果列表.push(结果);
        }
      } catch (错误) {
        console.error('周结算处理器错误:', 错误);
        结算结果列表.push({
          类型: '错误',
          错误信息: 错误.message,
        });
      }
    }

    this.记录周历史({
      周次: this.当前周次,
      行动点使用: this.周行动点上限 - this.剩余行动点,
      结算结果: 结算结果列表,
      事件记录: [...this.本周事件记录],
    });

    this.事件总线.发布('周结算完成', {
      周次: this.当前周次,
      结算结果: 结算结果列表,
    });

    this.当前周次++;
    this.剩余行动点 = this.周行动点上限;
    this.本周事件记录 = [];

    for (const { 处理函数 } of this.新周处理器) {
      try {
        处理函数(游戏状态, this.当前周次);
      } catch (错误) {
        console.error('新周处理器错误:', 错误);
      }
    }

    this.事件总线.发布('新周开始', {
      周次: this.当前周次,
      行动点: this.剩余行动点,
    });

    return {
      成功: true,
      旧周次: this.当前周次 - 1,
      新周次: this.当前周次,
      结算结果: 结算结果列表,
    };
  }

  // ─── 事件记录 ───

  记录本周事件(事件) {
    this.本周事件记录.push({
      ...事件,
      时间戳: Date.now(),
    });
  }

  获取本周事件记录() {
    return [...this.本周事件记录];
  }

  // ─── 周历史 ───

  记录周历史(周数据) {
    this.周历史.push({
      ...周数据,
      记录时间: Date.now(),
    });

    while (this.周历史.length > this.历史上限) {
      this.周历史.shift();
    }
  }

  获取周历史(周次 = null) {
    if (周次 !== null) {
      return this.周历史.find(h => h.周次 === 周次);
    }
    return [...this.周历史];
  }

  // ─── 暂停控制 ───

  暂停() {
    this.已暂停 = true;
    this.事件总线.发布('时间暂停', { 周次: this.当前周次 });
  }

  恢复() {
    this.已暂停 = false;
    this.事件总线.发布('时间恢复', { 周次: this.当前周次 });
  }

  是否暂停() {
    return this.已暂停;
  }

  获取时间状态() {
    return {
      当前周次: this.当前周次,
      剩余行动点: this.剩余行动点,
      周行动点上限: this.周行动点上限,
      已暂停: this.已暂停,
      本周事件数: this.本周事件记录.length,
    };
  }

  序列化() {
    return {
      当前周次: this.当前周次,
      剩余行动点: this.剩余行动点,
      周行动点上限: this.周行动点上限,
      本周事件记录: this.本周事件记录,
      周历史: this.周历史,
    };
  }

  从序列化恢复(数据) {
    this.当前周次 = 数据.当前周次 ?? 1;
    this.剩余行动点 = 数据.剩余行动点 ?? this.周行动点上限;
    this.周行动点上限 = 数据.周行动点上限 ?? 3;
    this.本周事件记录 = 数据.本周事件记录 ?? [];
    this.周历史 = 数据.周历史 ?? [];
  }
}

export { 时间系统 };
export default 时间系统;
