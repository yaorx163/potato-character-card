// ═══════════════════════════════════════════════════════════════
// data/rules.ts
// 游戏规则配置实现
// ═══════════════════════════════════════════════════════════════

import {
    冠军实体,
    母畜实体,
    可袭击地点实体,
    领主实体,
    喽啰池
  } from '../core/entities';
  
  import { 工厂管理器 } from '../core/factories';
  
  // ═══════════════════════════════════════════════════════════════
  // 类型定义
  // ═══════════════════════════════════════════════════════════════
  
  type 实体类型 = 冠军实体 | 母畜实体 | 可袭击地点实体 | 领主实体 | 喽啰池;
  
  interface 游戏总控接口 {
    地点管理: {
      获取地点: (地点ID: string) => 可袭击地点实体 | null;
    };
    母畜管理: {
      从劝诱获取母畜: (母畜: 母畜实体) => void;
      移除母畜: (母畜ID: string) => void;
    };
    冠军管理: {
      从生育获取冠军: (冠军: 冠军实体) => void;
    };
    喽啰池管理: {
      获取喽啰总数: () => number;
      获取无将领喽啰池: () => 喽啰池;
    };
    资源管理: {
      获取士气: () => number;
      修改士气: (增量: number) => number;
      获取催淫母乳数量: () => number;
      修改催淫母乳数量: (增量: number) => number;
    };
    获取领主: () => 领主实体;
  }
  
  interface 属性变化记录 {
    [属性名: string]: [number | string, number | string];
  }
  
  interface 任务执行结果 {
    成功: boolean;
    类型: string;
    执行人: 实体类型;
    目标: 实体类型 | null;
    变化?: 属性变化记录;
    已侦察母畜?: 母畜实体[];
    已获取母畜?: 母畜实体[];
    已获取冠军?: 冠军实体[];
    原因?: string;
  }
  
  interface 商品执行结果 {
    成功: boolean;
    类型: string;
    目标: 实体类型 | null;
    信息?: string;
    变化?: 属性变化记录;
  }
  
  interface 法术执行结果 {
    成功: boolean;
    类型: string;
    目标: 实体类型 | null;
    变化?: 属性变化记录;
  }
  
  type 任务前置条件 = (执行人: 实体类型) => boolean;
  type 行动力占用计算 = (执行人: 实体类型) => number;
  type 任务执行效果 = (
    执行人: 实体类型,
    目标: 实体类型 | null,
    游戏总控?: 游戏总控接口
  ) => 任务执行结果;
  
  interface 任务配置 {
    名称: string;
    描述: string;
    前置条件?: 任务前置条件[];
    行动力占用?: 行动力占用计算;
    执行效果: 任务执行效果;
  }
  
  type 商品执行效果 = (
    购买数量: number,
    目标: 实体类型 | null,
    游戏总控: 游戏总控接口
  ) => 商品执行结果;
  
  interface 商品配置 {
    名称: string;
    价格: number;
    描述?: string;
    每周限购: number;
    执行效果: 商品执行效果;
  }
  
  type 法术执行效果 = (
    法术倍率: number,
    目标: 实体类型 | null,
    游戏总控: 游戏总控接口
  ) => 法术执行结果;
  
  interface 法术配置 {
    名称: string;
    价格: number;
    法术倍率上限: number;
    执行效果: 法术执行效果;
  }
  
  interface 任务系统接口 {
    注册任务: (任务名: string, 配置: 任务配置) => void;
  }
  
  interface 黑市系统接口 {
    注册商品: (商品名: string, 配置: 商品配置) => void;
  }
  
  interface 法术系统接口 {
    注册法术: (法术名: string, 配置: 法术配置) => void;
  }
  
  // ═══════════════════════════════════════════════════════════════
  // 规则初始化函数
  // ═══════════════════════════════════════════════════════════════
  
  export function 初始化规则(
    工厂管理器实例: 工厂管理器,
    任务系统: 任务系统接口,
    黑市系统: 黑市系统接口,
    法术系统: 法术系统接口
  ): void {
    // ─── 辅助函数 ───
    const min = Math.min;
    const floor = Math.floor;
  
    // ─── 数组洗牌工具 ───
    const shuffleArray = <T>(array: T[]): T[] => {
      const result = [...array];
      for (let i = result.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [result[i], result[j]] = [result[j], result[i]];
      }
      return result;
    };
  
    // ═══════════════════════════════════════════════════════════════
    // 任务配置
    // ═══════════════════════════════════════════════════════════════
  
    任务系统.注册任务('调教', {
      名称: '调教',
      描述: '冠军对母畜进行调教，提升其臣服度',
      前置条件: [(执行人) => 执行人.实体类型 === '冠军'],
      行动力占用: (_执行人) => 1,
      执行效果: (执行人, 目标母畜, _游戏总控) => {
        const 冠军 = 执行人 as 冠军实体;
        const 母畜 = 目标母畜 as 母畜实体;
  
        const 初始值 = 母畜.获取属性<number>('臣服度');
        const 智力 = 冠军.获取属性<number>('智力');
        const 增量 = floor(智力 / 10) + 5;
        const 新值 = 母畜.修改属性('臣服度', 增量);
  
        return {
          成功: true,
          类型: '调教',
          执行人: 冠军,
          目标: 母畜,
          变化: { 臣服度: [初始值, 新值] },
        };
      },
    });
  
    任务系统.注册任务('劝慰', {
      名称: '劝慰',
      描述: '母畜对其他母畜进行劝慰，提升其臣服度',
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('臣服度') >= 50,
      ],
      行动力占用: (_执行人) => 1,
      执行效果: (执行人, 目标母畜, _游戏总控) => {
        const 执行母畜 = 执行人 as 母畜实体;
        const 目标 = 目标母畜 as 母畜实体;
  
        const 初始值 = 目标.获取属性<number>('臣服度');
        const 基础值 = 10;
        const 种族A = 执行母畜.获取属性<string>('种族');
        const 种族B = 目标.获取属性<string>('种族');
        const 系数 = 种族A === 种族B ? 1.5 : 1;
        const 增量 = floor(基础值 * 系数);
        const 新值 = 目标.修改属性('臣服度', 增量);
  
        return {
          成功: true,
          类型: '劝慰',
          执行人: 执行母畜,
          目标: 目标,
          变化: { 臣服度: [初始值, 新值] },
        };
      },
    });
  
    任务系统.注册任务('侦察', {
      名称: '侦察',
      描述: '侦察地点，获取地点内可被侦察的母畜信息',
      前置条件: [(执行人) => 执行人.实体类型 === '冠军'],
      执行效果: (执行人, 目标地点, _游戏总控) => {
        const 冠军 = 执行人 as 冠军实体;
        const 地点 = 目标地点 as 可袭击地点实体;
  
        const 敏捷 = 冠军.获取属性<number>('敏捷');
        const 成功率 = (敏捷 + 50) / 100;
  
        if (Math.random() > 成功率) {
          return {
            成功: false,
            类型: '侦察',
            执行人: 冠军,
            目标: 地点,
          };
        }
  
        const 初始进度 = 地点.获取侦察进度();
  
        // 进度增加
        const 进度增量 = (敏捷 + 50) / 10;
        const 当前进度 = 地点.增加侦察进度(进度增量);
  
        // 侦察逻辑
        const 因子 = (敏捷 + 50) * (当前进度 + 25);
        const 必定侦察数 = floor(因子 / 7500);
        const 额外概率 = (因子 % 7500) / 7500;
  
        let 侦察母畜总数 = 必定侦察数 + (Math.random() < 额外概率 ? 1 : 0);
        const 可侦察母畜列表 = 地点.获取潜在母畜列表();
        const 随机索引数组 = shuffleArray([...Array(可侦察母畜列表.length).keys()]);
  
        // 执行地点实体内部的侦察逻辑
        const 被侦察母畜列表: 母畜实体[] = [];
        for (let i = 0; i < 侦察母畜总数 && i < 可侦察母畜列表.length; i++) {
          const 被侦察母畜 = 可侦察母畜列表[随机索引数组[i]];
          地点.标记母畜已侦察(被侦察母畜);
          被侦察母畜列表.push(被侦察母畜);
        }
  
        return {
          成功: true,
          类型: '侦察',
          执行人: 冠军,
          目标: 地点,
          变化: { 侦察进度: [初始进度, 当前进度]},
          已侦察母畜: 被侦察母畜列表,
        };
      },
    });
  
    任务系统.注册任务('潜入侦察', {
      名称: '潜入侦察',
      描述: '母畜潜入地点，获取地点内可被侦察的母畜信息',
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('臣服度') >= 75,
      ],
      行动力占用: (_执行人) => 1,
      执行效果: (执行人, 目标地点, _游戏总控) => {
        const 母畜 = 执行人 as 母畜实体;
        const 地点 = 目标地点 as 可袭击地点实体;
  
        const 淫乱度 = 母畜.获取属性<number>('淫乱度');
        const 成功率 = (125 - 淫乱度) / 100;
  
        if (Math.random() > 成功率) {
          return {
            成功: false,
            类型: '潜入侦察',
            执行人: 母畜,
            目标: 地点,
          };
        }
  
        const 初始进度 = 地点.获取侦察进度();
  
        // 进度增加
        const 进度增量 = (125 - 淫乱度) / 10;
        const 当前进度 = 地点.增加侦察进度(进度增量);
  
        // 侦察逻辑
        const 因子 = (125 - 淫乱度) * (当前进度 + 25);
        const 必定侦察数 = floor(因子 / 7500);
        const 额外概率 = (因子 % 7500) / 7500;
  
        let 侦察母畜总数 = 必定侦察数 + (Math.random() < 额外概率 ? 1 : 0);
        const 可侦察母畜列表 = 地点.获取潜在母畜列表();
        const 随机索引数组 = shuffleArray([...Array(可侦察母畜列表.length).keys()]);
  
        // 执行地点实体内部的侦察逻辑
        const 被侦察母畜列表: 母畜实体[] = [];
        for (let i = 0; i < 侦察母畜总数 && i < 可侦察母畜列表.length; i++) {
          const 被侦察母畜 = 可侦察母畜列表[随机索引数组[i]];
          地点.标记母畜已侦察(被侦察母畜);
          被侦察母畜列表.push(被侦察母畜);
        }
  
        return {
          成功: true,
          类型: '潜入侦察',
          执行人: 母畜,
          目标: 地点,
          变化: { 侦察进度: [初始进度, 当前进度]},
          已侦察母畜: 被侦察母畜列表,
        };
      },
    });
  
    任务系统.注册任务('潜入劝诱', {
      名称: '潜入劝诱',
      描述: '母畜潜入地点，尝试与目标母畜进行劝诱',
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('臣服度') >= 90,
      ],
      行动力占用: (_执行人) => 1,
      执行效果: (执行人, 目标母畜, 游戏总控) => {
        const 执行母畜 = 执行人 as 母畜实体;
        const 目标 = 目标母畜 as 母畜实体;
  
        const 淫乱度 = 执行母畜.获取属性<number>('淫乱度');
        const 自身总雌性价值 = 执行母畜.获取属性<number>('总雌性价值');
        const 目标总雌性价值 = 目标.获取属性<number>('总雌性价值');
        const 目标地点 = 游戏总控!.地点管理.获取地点(目标.来源地点ID!);
        const 成功率 = ((目标总雌性价值 - 自身总雌性价值 + 50) * (125 - 淫乱度)) / 1000;
  
        if (Math.random() > 成功率) {
          return {
            成功: false,
            类型: '潜入劝诱',
            执行人: 执行母畜,
            目标: 目标,
          };
        }
  
        目标地点!.移除已捕获母畜(目标);
        游戏总控!.母畜管理.从劝诱获取母畜(目标);
  
        return {
          成功: true,
          类型: '潜入劝诱',
          执行人: 执行母畜,
          目标: 目标,
          已获取母畜: [目标],
        };
      },
    });
  
    任务系统.注册任务('生育哥布林冠军', {
      名称: '生育哥布林冠军',
      描述: '母畜生育哥布林冠军',
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('剩余雌性价值') >= 100,
      ],
      行动力占用: (执行人) =>
        (执行人 as 母畜实体).获取属性<number>('臣服度') >= 25 ? 1 : 2,
      执行效果: (执行人, _无, 游戏总控) => {
        const 母畜 = 执行人 as 母畜实体;
  
        // 调用 工厂管理器.从母畜生育哥布林冠军
        const 结果 = 工厂管理器实例.从母畜生育哥布林冠军(母畜, {});
        const 初始淫乱度 = 母畜.获取属性<number>('淫乱度');
  
        // 消耗扣除由工厂处理，这里处理副作用
        if (结果.成功 && 结果.冠军) {
          母畜.修改属性('淫乱度', 6);
          // 冠军加入玩家阵营逻辑
          游戏总控!.冠军管理.从生育获取冠军(结果.冠军);
  
          return {
            成功: true,
            类型: '生育哥布林冠军',
            执行人: 母畜,
            目标: null,
            变化: {
              淫乱度: [初始淫乱度, 母畜.获取属性<number>('淫乱度')],
            },
            已获取冠军: [结果.冠军]
          };
        }
  
        return {
          成功: false,
          类型: '生育哥布林冠军',
          执行人: 母畜,
          目标: null,
        };
      },
    });
  
    任务系统.注册任务('生育喽啰', {
      名称: '生育喽啰',
      描述: '母畜生育喽啰',
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('剩余雌性价值') >= 10,
      ],
      行动力占用: (执行人) =>
        (执行人 as 母畜实体).获取属性<number>('臣服度') >= 25 ? 0 : 1,
      执行效果: (执行人, _无, 游戏总控) => {
        const 母畜 = 执行人 as 母畜实体;
  
        const 初始喽啰数量 = 游戏总控!.喽啰池管理.获取喽啰总数();
        const 初始淫乱度 = 母畜.获取属性<number>('淫乱度');
        const 价值 = 母畜.获取属性<number>('剩余雌性价值');
        const 数量 = min(10, floor(价值 / 10));
  
        母畜.消耗雌性价值(数量 * 10);
        母畜.修改属性('淫乱度', 6);
  
        // 增加喽啰池
        const 目标喽啰池 = 游戏总控!.喽啰池管理.获取无将领喽啰池();
        目标喽啰池.增加喽啰(数量, '未武装');
  
        return {
          成功: true,
          类型: '生育喽啰',
          执行人: 母畜,
          目标: null,
          变化: {
            喽啰数量: [初始喽啰数量, 游戏总控!.喽啰池管理.获取喽啰总数()],
            淫乱度: [初始淫乱度, 母畜.获取属性<number>('淫乱度')],
          },
        };
      },
    });
  
    任务系统.注册任务('提振士气', {
      名称: '提振士气',
      描述: '母畜提振全军士气',
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('臣服度') >= 75,
      ],
      行动力占用: (_执行人) => 1,
      执行效果: (执行人, _无, 游戏总控) => {
        const 母畜 = 执行人 as 母畜实体;
  
        const 初始士气 = 游戏总控!.资源管理.获取士气();
        const 初始淫乱度 = 母畜.获取属性<number>('淫乱度');
        const 价值 = 母畜.获取属性<number>('总雌性价值');
        const 增量 = (价值 + 50) / 25;
        const 当前士气 = 游戏总控!.资源管理.修改士气(增量);
        母畜.修改属性('淫乱度', 10);
  
        return {
          成功: true,
          类型: '提振士气',
          执行人: 母畜,
          目标: null,
          变化: {
            士气: [初始士气, 当前士气],
            淫乱度: [初始淫乱度, 母畜.获取属性<number>('淫乱度')],
          },
        };
      },
    });
  
    任务系统.注册任务('泌乳', {
      名称: '泌乳',
      描述: '母畜泌乳',
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('淫乱度') >= 25,
      ],
      行动力占用: (执行人) =>
        (执行人 as 母畜实体).获取属性<number>('臣服度') >= 50 ? 0 : 1,
      执行效果: (执行人, _无, 游戏总控) => {
        const 母畜 = 执行人 as 母畜实体;
  
        const 初始淫乱度 = 母畜.获取属性<number>('淫乱度');
        const 初始催淫母乳数量 = 游戏总控!.资源管理.获取催淫母乳数量();
        const 淫乱 = 母畜.获取属性<number>('淫乱度');
        const 产出 = floor((淫乱 + 20) / 10);
        const 当前催淫母乳数量 = 游戏总控!.资源管理.修改催淫母乳数量(产出);
        母畜.修改属性('淫乱度', 3);
  
        return {
          成功: true,
          类型: '泌乳',
          执行人: 母畜,
          目标: null,
          变化: {
            催淫母乳数量: [初始催淫母乳数量, 当前催淫母乳数量],
            淫乱度: [初始淫乱度, 母畜.获取属性<number>('淫乱度')],
          },
        };
      },
    });
  
    任务系统.注册任务('献祭', {
      名称: '献祭',
      描述: '献祭母畜以获取魔力',
      行动力占用: (_执行人) => 0,
      前置条件: [
        (执行人) => 执行人.实体类型 === '母畜',
        (执行人) => (执行人 as 母畜实体).获取属性<number>('淫乱度') >= 100,
      ],
      执行效果: (执行人, _无, 游戏总控) => {
        const 母畜 = 执行人 as 母畜实体;
  
        const 价值 = 母畜.获取属性<number>('总雌性价值');
        const 魔力增量 = floor((价值 + 50) / 50);
  
        const 领主 = 游戏总控!.获取领主();
        const 初始魔力 = 领主.获取属性<number>('魔力');
        领主.获得魔力(魔力增量);
  
        游戏总控!.母畜管理.移除母畜(母畜.实体ID);
        母畜.销毁();
  
        return {
          成功: true,
          类型: '献祭',
          执行人: 母畜,
          目标: null,
          变化: { 魔力: [初始魔力, 领主.获取属性<number>('魔力')] },
        };
      },
    });
  
    // ═══════════════════════════════════════════════════════════════
    // 黑市商品配置
    // ═══════════════════════════════════════════════════════════════
  
    const 武装升级效果 = (
      数量: number,
      等级: string,
      游戏总控: 游戏总控接口
    ) => (目标喽啰池: 喽啰池): 商品执行结果 => {
      // 优先列表定义
      const 优先 = ['未武装', '低级武装', '中级武装', '高级武装', '精英武装'];
      const 溢出数量 = 目标喽啰池.武装升级(数量, 等级, 优先).溢出数量;
      const 将领 = 目标喽啰池.获取将领();
      const 初始战斗力 = 目标喽啰池.获取战斗力();
  
      if (将领 && 溢出数量 > 0) {
        const 无将领喽啰池 = 游戏总控.喽啰池管理.获取无将领喽啰池();
        const 再次溢出数量 = 无将领喽啰池.武装升级(溢出数量, 等级, 优先).溢出数量;
  
        return {
          成功: true,
          类型: '武装升级',
          目标: 目标喽啰池,
          信息: `${数量 - 再次溢出数量} 名喽啰已升级到 ${等级} 等级，${再次溢出数量} 份武装因无喽啰可升级舍弃`,
          变化: { 战斗力: [初始战斗力, 目标喽啰池.获取战斗力()] },
        };
      }
  
      if (溢出数量 > 0) {
        return {
          成功: true,
          类型: '武装升级',
          目标: 目标喽啰池,
          信息: `${数量 - 溢出数量} 名喽啰已升级到 ${等级} 等级，${溢出数量} 份武装因无喽啰可升级舍弃`,
          变化: { 战斗力: [初始战斗力, 目标喽啰池.获取战斗力()] },
        };
      }
  
      return {
        成功: true,
        类型: '武装升级',
        目标: 目标喽啰池,
        信息: `${数量} 名喽啰已升级到 ${等级} 等级`,
        变化: { 战斗力: [初始战斗力, 目标喽啰池.获取战斗力()] },
      };
    };
  
    黑市系统.注册商品('破旧兵刃', {
      名称: '破旧兵刃',
      价格: 1,
      描述: '勉强能用的武器和护甲，聊胜于无，可以武装10名喽啰',
      每周限购: Infinity,
      执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
        武装升级效果(10 * 购买数量, '低级武装', 游戏总控)(目标喽啰池 as 喽啰池),
    });
  
    黑市系统.注册商品('标准铁剑', {
      名称: '标准铁剑',
      价格: 1,
      描述: '正规军队的标准装备，可靠耐用，可以武装4名喽啰',
      每周限购: Infinity,
      执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
        武装升级效果(4 * 购买数量, '中级武装', 游戏总控)(目标喽啰池 as 喽啰池),
    });
  
    黑市系统.注册商品('骑士武装', {
      名称: '骑士武装',
      价格: 1,
      描述: '通过特殊渠道走私的骑士装备，品质上乘，可以武装1名喽啰',
      每周限购: Infinity,
      执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
        武装升级效果(1 * 购买数量, '高级武装', 游戏总控)(目标喽啰池 as 喽啰池),
    });
  
    黑市系统.注册商品('附魔装备', {
      名称: '附魔装备',
      价格: 4,
      描述: '非常罕见的附魔装备，极大提升喽啰战斗力，可以武装1名喽啰',
      每周限购: Infinity,
      执行效果: (购买数量, 目标喽啰池, 游戏总控) =>
        武装升级效果(1 * 购买数量, '精英武装', 游戏总控)(目标喽啰池 as 喽啰池),
    });
  
    黑市系统.注册商品('祝福水晶', {
      名称: '祝福水晶',
      价格: 50,
      每周限购: 1,
      执行效果: (购买数量, 目标母畜, _游戏总控) => {
        const 母畜 = 目标母畜 as 母畜实体;
  
        const 淫乱 = 母畜.获取属性<number>('淫乱度');
        const 增量 = (购买数量 * 2000) / (淫乱 + 20);
        const 初始总雌性价值 = 母畜.获取属性<number>('总雌性价值');
        const 初始剩余雌性价值 = 母畜.获取属性<number>('剩余雌性价值');
        母畜.修改属性('总雌性价值', 增量);
        母畜.修改属性('剩余雌性价值', 增量);
  
        return {
          成功: true,
          类型: '祝福水晶',
          目标: 母畜,
          变化: {
            总雌性价值: [初始总雌性价值, 母畜.获取属性<number>('总雌性价值')],
            剩余雌性价值: [初始剩余雌性价值, 母畜.获取属性<number>('剩余雌性价值')],
          },
        };
      },
    });
  
    黑市系统.注册商品('净化水晶', {
      名称: '净化水晶',
      价格: 25,
      每周限购: 5,
      执行效果: (购买数量, 目标母畜, _游戏总控) => {
        const 母畜 = 目标母畜 as 母畜实体;
  
        const 初始淫乱 = 母畜.获取属性<number>('淫乱度');
        const 新值 = 母畜.修改属性('淫乱度', -10 * 购买数量);
  
        return {
          成功: true,
          类型: '净化水晶',
          目标: 母畜,
          变化: { 淫乱度: [初始淫乱, 新值] },
        };
      },
    });
  
    黑市系统.注册商品('魔力水晶', {
      名称: '魔力水晶',
      价格: 15,
      每周限购: 1,
      执行效果: (购买数量, _无, 游戏总控) => {
        const 领主 = 游戏总控.获取领主();
        const 初始魔力 = 领主.获取属性<number>('魔力');
        const 结果 = 领主.获得魔力(3 * 购买数量);
  
        return {
          成功: true,
          类型: '魔力水晶',
          目标: null,
          变化: { 领主魔力: [初始魔力, 结果.当前] },
        };
      },
    });
  
    // ═══════════════════════════════════════════════════════════════
    // 法术配置
    // ═══════════════════════════════════════════════════════════════
  
    法术系统.注册法术('魔眼侦察', {
      名称: '魔眼侦察',
      价格: 1,
      法术倍率上限: 3,
      执行效果: (法术倍率, 目标地点, _游戏总控) => {
        const 地点 = 目标地点 as 可袭击地点实体;
  
        const 初始侦察进度 = 地点.获取侦察进度();
        const 新值 = 地点.增加侦察进度(20 * 法术倍率);
  
        return {
          成功: true,
          类型: '魔眼侦察',
          目标: 地点,
          变化: { 侦察进度: [初始侦察进度, 新值] },
        };
      },
    });
  
    法术系统.注册法术('意志粉碎', {
      名称: '意志粉碎',
      价格: 1,
      法术倍率上限: 3,
      执行效果: (法术倍率, 目标母畜, _游戏总控) => {
        const 母畜 = 目标母畜 as 母畜实体;
  
        const 初始臣服 = 母畜.获取属性<number>('臣服度');
        const 新值 = 母畜.修改属性('臣服度', 10 * 法术倍率);
  
        return {
          成功: true,
          类型: '意志粉碎',
          目标: 母畜,
          变化: { 臣服度: [初始臣服, 新值] },
        };
      },
    });
  
    法术系统.注册法术('孕力回复', {
      名称: '孕力回复',
      价格: 10,
      法术倍率上限: 3,
      执行效果: (法术倍率, 目标母畜, _游戏总控) => {
        const 母畜 = 目标母畜 as 母畜实体;
  
        const 初始剩余雌性价值 = 母畜.获取属性<number>('剩余雌性价值');
        const 新值 = 母畜.修改属性('剩余雌性价值', 50 * 法术倍率);
  
        return {
          成功: true,
          类型: '孕力回复',
          目标: 母畜,
          变化: { 剩余雌性价值: [初始剩余雌性价值, 新值] },
        };
      },
    });
  
    法术系统.注册法术('士气鼓舞', {
      名称: '士气鼓舞',
      价格: 5,
      法术倍率上限: 3,
      执行效果: (法术倍率, _无, 游戏总控) => {
        const 初始士气 = 游戏总控.资源管理.获取士气();
        const 新值 = 游戏总控.资源管理.修改士气(30 * 法术倍率);
  
        return {
          成功: true,
          类型: '士气鼓舞',
          目标: null,
          变化: { 士气: [初始士气, 新值] },
        };
      },
    });
  }
  