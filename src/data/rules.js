// ═══════════════════════════════════════════════════════════════
// core/data/rules.js
// 游戏规则配置实现
// ═══════════════════════════════════════════════════════════════
// 建议的返回格式

export function 初始化规则(工厂管理器, 任务系统, 黑市系统, 法术系统) {
  // ─── 辅助函数 ───
  const min = Math.min;
  const floor = Math.floor;

  // ─── 任务配置 ───

  任务系统.注册任务('调教', {
    名称: '调教',
    描述: '冠军对母畜进行调教，提升其臣服度',
    前置条件: [执行人 => 执行人.实体类型 === '冠军'],
    行动力占用: 执行人 => 1,
    执行效果: (执行人, 目标母畜) => {
      const 初始值 = 目标母畜.获取属性('臣服度');
      const 智力 = 执行人.获取属性('智力');
      const 增量 = floor(智力 / 10) + 5;
      const 新值 = 目标母畜.修改属性('臣服度', 增量);
      return {
        成功: true,
        类型: '调教',
        目标: 目标母畜,
        变化: { 臣服度: [初始值, 新值] },
      };
    },
  });

  任务系统.注册任务('劝慰', {
    名称: '劝慰',
    描述: '母畜对其他母畜进行劝慰，提升其臣服度',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => 执行人.获取属性('臣服度') >= 50],
    行动力占用: 执行人 => 1,
    执行效果: (执行人, 目标母畜) => {
      const 初始值 = 目标母畜.获取属性('臣服度');
      const 基础值 = 10;
      const 种族A = 执行人.获取属性('种族');
      const 种族B = 目标母畜.获取属性('种族');
      const 系数 = 种族A === 种族B ? 1.5 : 1;
      const 增量 = floor(基础值 * 系数);
      const 新值 = 目标母畜.修改属性('臣服度', 增量);

      return {
        成功: true,
        类型: '劝慰',
        目标: 目标母畜,
        变化: { 臣服度: [初始值, 新值] },
      };
    },
  });

  任务系统.注册任务('侦察', {
    名称: '侦察',
    描述: '侦察地点，获取地点内可被侦察的母畜信息',
    前置条件: [执行人 => 执行人.实体类型 === '冠军'],
    执行效果: (执行人, 目标地点) => {
      const 敏捷 = 执行人.获取属性('敏捷');
      const 成功率 = (敏捷 + 50) / 100;

      if (Math.random() > 成功率)
        return {
          成功: false,
          类型: '侦察',
          目标: 目标地点,
        };

      const 初始进度 = 目标地点.获取侦察进度();

      // 进度增加
      const 进度增量 = (敏捷 + 50) / 10;
      const 进度新值 = 目标地点.增加侦察进度(进度增量);

      // 侦察逻辑
      const 当前进度 = 目标地点.侦察进度;
      const 因子 = (敏捷 + 50) * (当前进度 + 25);
      const 必定侦察数 = floor(因子 / 7500);
      const 额外概率 = (因子 % 7500) / 7500;

      let 侦察总数 = 必定侦察数 + (Math.random() < 额外概率 ? 1 : 0);
      const 可侦察列表 = 目标地点.获取潜在母畜();
      const shuffleArray = array => {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      };
      const 随机索引数组 = shuffleArray([...Array(可侦察列表.length).keys()]);

      // 执行地点实体内部的侦察逻辑
      let 被侦察母畜列表 = [];
      for (let i = 0; i < 侦察总数 && i < 可侦察列表.length; i++) {
        const 被侦察母畜ID = 可侦察列表[随机索引数组[i]];
        目标地点.标记母畜已侦察(被侦察母畜ID);
        被侦察母畜列表.push(地点.获取母畜(被侦察母畜ID));
      }
      return {
        成功: true,
        类型: '侦察',
        目标: 目标地点,
        变化: { 侦察进度: [初始进度, 进度新值], 已侦察母畜: 被侦察母畜列表 },
      };
    },
  });

  任务系统.注册任务('潜入侦察', {
    名称: '潜入侦察',
    描述: '母畜潜入地点，获取地点内可被侦察的母畜信息',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => 执行人.获取属性('臣服度') >= 75],
    行动力占用: 执行人 => 1,
    执行效果: (执行人, 目标地点) => {
      const 淫乱度 = 执行人.获取属性('淫乱度');
      const 成功率 = (125 - 淫乱度) / 100;

      if (Math.random() > 成功率) return '侦察失败';

      // 进度增加
      const 进度增量 = (125 - 淫乱度) / 10;
      目标地点.增加侦察进度(进度增量);

      // 侦察逻辑
      const 当前进度 = 目标地点.侦察进度;
      const 因子 = (125 - 淫乱度) * (当前进度 + 25);
      const 必定侦察数 = floor(因子 / 7500);
      const 额外概率 = (因子 % 7500) / 7500;

      let 侦察母畜总数 = 必定侦察数 + (Math.random() < 额外概率 ? 1 : 0);
      const 可侦察母畜列表 = 目标地点.获取潜在母畜();
      const shuffleArray = array => {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      };
      const 随机索引数组 = shuffleArray([...Array(可侦察母畜列表.length).keys()]);

      // 执行地点实体内部的侦察逻辑
      let 实际侦察 = 0;
      for (let i = 0; i < 侦察母畜总数 && i < 可侦察母畜列表.length; i++) {
        目标地点.标记母畜已侦察(可侦察母畜列表[随机索引数组[i]]);
        实际侦察++;
      }

      return `侦察成功，进度+${进度增量}，侦察了 ${实际侦察} 名目标`;
    },
  });

  任务系统.注册任务('潜入劝诱', {
    名称: '潜入劝诱',
    描述: '母畜潜入地点，尝试与目标母畜进行劝诱',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => 执行人.获取属性('臣服度') >= 90],
    行动力占用: 执行人 => 1,
    执行效果: (执行人, 目标地点, 目标母畜ID, 游戏总控) => {
      const 目标母畜 = 目标地点.获取母畜(目标母畜ID);
      const 淫乱度 = 执行人.获取属性('淫乱度');
      const 自身总雌性价值 = 执行人.获取属性('总雌性价值');
      const 目标总雌性价值 = 目标母畜.获取属性('总雌性价值');
      const 成功率 = ((目标总雌性价值 - 自身总雌性价值 + 50) * (125 - 淫乱度)) / 1000;

      if (Math.random() > 成功率) return '劝诱失败';

      目标地点.移除已捕获母畜(目标母畜ID);
      游戏总控.母畜管理.从劝诱获取母畜(目标母畜);

      return `劝诱成功，${目标母畜.获取属性('姓名')} 已加入你的阵营！`;
    },
  });

  任务系统.注册任务('生育冠军', {
    名称: '生育冠军',
    描述: '母畜生育冠军',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => 执行人.获取属性('剩余雌性价值') >= 100],
    行动力占用: 执行人 => (执行人.获取属性('臣服度') >= 25 ? 1 : 2),
    执行效果: (执行人, 无, 游戏总控) => {
      // 调用 工厂管理器.从母畜生育冠军
      const 结果 = 工厂管理器.从母畜生育冠军(执行人, {});
      // 消耗扣除由工厂处理，这里处理副作用
      if (结果.成功) {
        执行人.修改属性('淫乱度', 6);
        // 冠军加入玩家阵营逻辑
        游戏总控.冠军管理.从生育获取冠军(结果.冠军);
        return `生育成功: ${结果.冠军.获取属性('姓名')}`;
      }
      return `生育失败: ${结果.原因}`;
    },
  });

  任务系统.注册任务('生育喽啰', {
    名称: '生育喽啰',
    描述: '母畜生育喽啰',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => 执行人.获取属性('剩余雌性价值') >= 10],
    行动力占用: 执行人 => (执行人.获取属性('臣服度') >= 25 ? 0 : 1),
    执行效果: (执行人, 无, 游戏总控) => {
      const 价值 = 执行人.获取属性('剩余雌性价值');
      const 数量 = min(10, floor(价值 / 10));

      执行人.消耗雌性价值(数量 * 10);
      执行人.修改属性('淫乱度', 6);

      // 增加喽啰池
      const 目标喽啰池 = 游戏总控.喽啰池管理.获取无将领喽啰池();
      目标喽啰池.增加喽啰(数量, '未武装');
      return `产出了 ${数量} 名喽啰`;
    },
  });

  任务系统.注册任务('提振士气', {
    名称: '提振士气',
    描述: '母畜提振全军士气',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => 执行人.获取属性('臣服度') >= 75],
    行动力占用: 执行人 => 1,
    执行效果: (母畜, 无, 游戏总控) => {
      const 价值 = 母畜.获取属性('总雌性价值');
      const 增量 = (价值 + 50) / 25;
      游戏总控.资源管理.修改全军士气(增量);
      母畜.修改属性('淫乱度', 10);
      return `士气提升了 ${增量}`;
    },
  });

  任务系统.注册任务('泌乳', {
    名称: '泌乳',
    描述: '母畜泌乳',
    前置条件: [执行人 => 执行人.实体类型 === '母畜', 执行人 => 执行人.获取属性('淫乱度') >= 25],
    行动力占用: 执行人 => {
      执行人.获取属性('臣服度') >= 50 ? 0 : 1;
    },
    执行效果: (母畜, 无, 游戏总控) => {
      const 淫乱 = 母畜.获取属性('淫乱度');
      const 产出 = floor((淫乱 + 20) / 10);
      游戏总控.资源管理.修改催淫母乳数量(产出);
      母畜.修改属性('淫乱度', 3);
      return `产出母乳: ${产出}`;
    },
  });

  任务系统.注册任务('献祭', {
    名称: '献祭',
    描述: '献祭母畜以获取魔力',
    行动力占用: 执行人 => 0,
    前置条件: 母畜 => 母畜.获取属性('淫乱度') >= 100,
    执行效果: (母畜, 无, 游戏总控) => {
      const 价值 = 母畜.获取属性('总雌性价值');
      const 魔力增量 = floor((价值 + 50) / 50);

      const 领主 = 游戏总控.获取领主();
      领主.获得魔力(魔力增量);

      游戏总控.母畜管理.移除母畜(母畜.实体ID);
      母畜.销毁();

      return `献祭完成，获得魔力 ${魔力增量}`;
    },
  });

  // ─── 黑市商品配置 ───

  const 武器升级效果 = (数量, 等级, 游戏总控) => 目标喽啰池 => {
    // 优先列表定义
    const 优先 = ['未武装', '低级武装', '中级武装', '高级武装', '精英武装'];
    const 溢出数量 = 目标喽啰池.武装升级(数量, 等级, 优先).溢出数量;
    const 将领 = 目标喽啰池.获取喽啰将领();
    if (将领 && 溢出数量 > 0) {
      const 无将领喽啰池 = 游戏总控.喽啰池管理.获取无将领喽啰池();
      const 再次溢出数量 = 无将领喽啰池.武装升级(溢出数量, 等级, 优先).溢出数量;
      return `${数量 - 再次溢出数量} 名喽啰已升级到 ${等级} 等级，${再次溢出数量} 份武装因无喽啰可升级舍弃`;
    }
    if (溢出数量 > 0) {
      return `${数量 - 溢出数量} 名喽啰已升级到 ${等级} 等级，${溢出数量} 份武装因无喽啰可升级舍弃`;
    }
    return `${数量} 名喽啰已升级到 ${等级} 等级`;
  };

  黑市系统.注册商品('破旧兵刃', {
    名称: '破旧兵刃',
    价格: 1,
    描述: '勉强能用的武器和护甲，聊胜于无，可以武装10名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) => 武器升级效果(10 * 购买数量, '低级武装', 游戏总控)(目标喽啰池),
  });

  黑市系统.注册商品('标准铁剑', {
    名称: '标准铁剑',
    价格: 1,
    描述: '正规军队的标准装备，可靠耐用，可以武装4名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) => 武器升级效果(4 * 购买数量, '中级武装', 游戏总控)(目标喽啰池),
  });

  // ... 骑士武装 (数量1, 高级)
  黑市系统.注册商品('骑士武装', {
    名称: '骑士武装',
    价格: 1,
    描述: '通过特殊渠道走私的骑士装备，品质上乘，可以武装1名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) => 武器升级效果(1 * 购买数量, '高级武装', 游戏总控)(目标喽啰池),
  });
  // ... 附魔装备 (数量1, 精英, 价格4)
  黑市系统.注册商品('附魔装备', {
    名称: '附魔装备',
    价格: 4,
    描述: '非常罕见的附魔装备，极大提升喽啰战斗力，可以武装1名喽啰',
    每周限购: Infinity,
    执行效果: (购买数量, 目标喽啰池, 游戏总控) => 武器升级效果(1 * 购买数量, '精英武装', 游戏总控)(目标喽啰池),
  });

  黑市系统.注册商品('祝福水晶', {
    名称: '祝福水晶',
    价格: 50,
    每周限购: 1,
    执行效果: (购买数量, 目标母畜, 游戏总控) => {
      const 淫乱 = 目标母畜.获取属性('淫乱度');
      const 增量 = (购买数量 * 2000) / (淫乱 + 20);
      目标母畜.修改属性('总雌性价值', 增量);
      目标母畜.修改属性('剩余雌性价值', 增量);
      return `${目标母畜.获取属性('姓名')} 价值提升: ${增量.toFixed(1)}`;
    },
  });

  黑市系统.注册商品('净化水晶', {
    名称: '净化水晶',
    价格: 25,
    每周限购: 5,
    执行效果: (购买数量, 目标母畜, 游戏总控) => {
      目标母畜.修改属性('淫乱度', -10 * 购买数量);
      return `${目标母畜.获取属性('姓名')} 淫乱度降低 ${10 * 购买数量}`;
    },
  });

  黑市系统.注册商品('魔力水晶', {
    名称: '魔力水晶',
    价格: 15,
    每周限购: 1,
    执行效果: (购买数量, 无, 游戏总控) => {
      游戏总控.获取玩家领主().获得魔力(3 * 购买数量);
      return `魔力获取 ${3 * 购买数量}`;
    },
  });

  // ─── 法术配置 ───

  法术系统.注册法术('魔眼侦察', {
    名称: '魔眼侦察',
    价格: 1,
    法术倍率上限: 3,
    执行效果: (法术倍率, 目标地点, 游戏总控) => {
      目标地点.增加侦察进度(20 * 法术倍率);
      return `侦察进度 +${20 * 法术倍率}`;
    },
  });

  法术系统.注册法术('意志粉碎', {
    名称: '意志粉碎',
    价格: 1,
    法术倍率上限: 3,
    执行效果: (法术倍率, 目标母畜, 游戏总控) => {
      目标母畜.修改属性('臣服度', 10 * 法术倍率);
      return `${目标母畜.获取属性('姓名')} 臣服度 +${10 * 法术倍率}`;
    },
  });

  法术系统.注册法术('孕力回复', {
    名称: '孕力回复',
    价格: 10,
    法术倍率上限: 3,
    执行效果: (法术倍率, 目标母畜, 游戏总控) => {
      目标母畜.修改属性('剩余雌性价值', 50 * 法术倍率);
      return `${目标母畜.获取属性('姓名')} 剩余价值 +${50 * 法术倍率}`;
    },
  });

  法术系统.注册法术('士气鼓舞', {
    名称: '士气鼓舞',
    价格: 5,
    法术倍率上限: 3,
    执行效果: (法术倍率, 无, 游戏总控) => {
      游戏总控.资源管理.修改全军士气(30 * 法术倍率);
      return `全军士气 +${30 * 法术倍率}`;
    },
  });
}
