// ═══════════════════════════════════════════════════════════════
// core/factories.js
// 工厂类 - 负责创建游戏实体
// ═══════════════════════════════════════════════════════════════

import { 冠军实体, 母畜实体, 领主实体 } from './entities.js';

// ═══════════════════════════════════════════════════════════════
// 冠军工厂
// ═══════════════════════════════════════════════════════════════

/**
 * 冠军工厂
 * 负责创建冠军实体，支持从母畜生育和直接创建
 */
class 冠军工厂 {
  constructor(属性注册表 = null) {
    this.属性注册表 = 属性注册表;

    // 效率系数表：身份类型 -> 属性系数
    this.效率系数表 = new Map();

    // 种族系数表：种族 -> 属性系数
    this.种族系数表 = new Map();

    // 姓名生成器
    this.姓名生成器 = null;
    this.姓名池 = {
      前缀: [],
      主名: [],
      后缀: [],
    };

    // 外貌生成器
    this.外貌生成器 = null;

    // 默认属性范围
    this.默认属性范围 = {
      力量: { 最小: 5, 最大: 20 },
      敏捷: { 最小: 5, 最大: 20 },
      智力: { 最小: 5, 最大: 20 },
    };

    // 生育消耗配置
    this.生育消耗 = 100;

    // 随机浮动范围
    this.随机浮动范围 = 5;
  }

  // ─── 配置方法 ───

  设置属性注册表(注册表) {
    this.属性注册表 = 注册表;
  }

  设置生育消耗(数值) {
    this.生育消耗 = 数值;
  }

  设置随机浮动范围(范围) {
    this.随机浮动范围 = 范围;
  }

  // ─── 效率系数管理 ───

  注册效率系数(身份类型, 系数配置) {
    /**
     * 系数配置示例: { 力量: 1.3, 敏捷: 1.0, 智力: 0.8 }
     * 用于根据母畜身份调整生育冠军的属性分布
     */
    this.效率系数表.set(身份类型, {
      力量: 系数配置.力量 ?? 1.0,
      敏捷: 系数配置.敏捷 ?? 1.0,
      智力: 系数配置.智力 ?? 1.0,
    });
  }

  批量注册效率系数(配置对象) {
    /**
     * 配置对象示例:
     * {
     *   '女骑士': { 力量: 1.3, 敏捷: 1.0, 智力: 0.8 },
     *   '法师': { 力量: 0.7, 敏捷: 0.9, 智力: 1.4 },
     * }
     */
    Object.entries(配置对象).forEach(([身份, 系数]) => {
      this.注册效率系数(身份, 系数);
    });
  }

  获取效率系数(身份类型) {
    return (
      this.效率系数表.get(身份类型) ?? {
        力量: 1.0,
        敏捷: 1.0,
        智力: 1.0,
      }
    );
  }

  获取所有效率系数() {
    return Object.fromEntries(this.效率系数表);
  }

  // ─── 种族系数管理 ───

  注册种族系数(种族, 系数配置) {
    this.种族系数表.set(种族, {
      力量: 系数配置.力量 ?? 1.0,
      敏捷: 系数配置.敏捷 ?? 1.0,
      智力: 系数配置.智力 ?? 1.0,
    });
  }

  批量注册种族系数(配置对象) {
    Object.entries(配置对象).forEach(([种族, 系数]) => {
      this.注册种族系数(种族, 系数);
    });
  }

  获取种族系数(种族) {
    return (
      this.种族系数表.get(种族) ?? {
        力量: 1.0,
        敏捷: 1.0,
        智力: 1.0,
      }
    );
  }

  // ─── 姓名生成器 ───

  设置姓名生成器(生成函数) {
    /**
     * 生成函数签名: (上下文?) => 姓名字符串
     * 上下文包含: 母畜(如果是生育)、种族、性别等
     */
    this.姓名生成器 = 生成函数;
  }

  设置姓名池(池配置) {
    /**
     * 池配置示例:
     * {
     *   前缀: ['勇敢的', '狡猾的', '强壮的'],
     *   主名: ['格里芬', '亚瑟', '莱昂'],
     *   后缀: ['·影刃', '·铁拳', ''],
     * }
     */
    if (池配置.前缀) this.姓名池.前缀 = 池配置.前缀;
    if (池配置.主名) this.姓名池.主名 = 池配置.主名;
    if (池配置.后缀) this.姓名池.后缀 = 池配置.后缀;
  }

  生成随机姓名(上下文 = {}) {
    // 优先使用自定义生成器
    if (this.姓名生成器) {
      return this.姓名生成器(上下文);
    }

    // 使用姓名池生成
    if (this.姓名池.主名.length > 0) {
      const 随机选择 = 数组 => {
        if (!数组 || 数组.length === 0) return '';
        return 数组[Math.floor(Math.random() * 数组.length)];
      };

      const 前缀 = Math.random() < 0.3 ? 随机选择(this.姓名池.前缀) : '';
      const 主名 = 随机选择(this.姓名池.主名);
      const 后缀 = Math.random() < 0.2 ? 随机选择(this.姓名池.后缀) : '';

      return `${前缀}${主名}${后缀}`.trim();
    }

    // 默认姓名
    return `冠军_${Date.now().toString(36).slice(-4)}`;
  }

  // ─── 外貌生成器 ───

  设置外貌生成器(生成函数) {
    /**
     * 生成函数签名: (上下文?) => 外貌描述字符串
     */
    this.外貌生成器 = 生成函数;
  }

  生成随机外貌(上下文 = {}) {
    if (this.外貌生成器) {
      return this.外貌生成器(上下文);
    }
    return '';
  }

  // ─── 属性计算辅助 ───

  计算随机浮动() {
    const 范围 = this.随机浮动范围;
    return Math.floor(Math.random() * (范围 * 2 + 1)) - 范围;
  }

  计算属性值(基础值, 效率系数, 种族系数 = 1.0) {
    const 浮动 = this.计算随机浮动();
    const 原始值 = (基础值 + 浮动) * 效率系数 * 种族系数;
    return Math.max(1, Math.round(原始值));
  }

  // ─── 创建方法 ───

  从母畜生育(母畜, 选项 = {}) {
    /**
     * 从母畜生育冠军
     * 冠军属性基于:
     * - 母畜的总雌性价值 (决定基础值)
     * - 母畜的原身份 (决定属性分布)
     * - 母畜的种族 (额外系数)
     * - 随机浮动
     *
     * 返回: { 成功: boolean, 冠军?: 冠军实体, 原因?: string }
     */

    // 检查剩余雌性价值
    const 剩余价值 = 母畜.获取属性('剩余雌性价值');
    if (剩余价值 < this.生育消耗) {
      return {
        成功: false,
        原因: '剩余雌性价值不足',
        当前: 剩余价值,
        需要: this.生育消耗,
      };
    }

    // 获取母畜信息
    const 母畜身份 = 母畜.获取属性('原身份');
    const 母畜种族 = 母畜.获取属性('种族');
    const 总雌性价值 = 母畜.获取属性('总雌性价值');

    // 获取系数
    const 效率系数 = this.获取效率系数(母畜身份);
    const 种族系数 = this.获取种族系数(母畜种族);

    // 计算基础值 (总雌性价值 / 10)
    const 基础值 = 总雌性价值 / 10;

    // 计算各属性
    const 力量 = this.计算属性值(基础值, 效率系数.力量, 种族系数.力量);
    const 敏捷 = this.计算属性值(基础值, 效率系数.敏捷, 种族系数.敏捷);
    const 智力 = this.计算属性值(基础值, 效率系数.智力, 种族系数.智力);

    // 生成上下文
    const 生成上下文 = {
      母畜,
      母畜身份,
      母畜种族,
      性别: 选项.性别 ?? '男',
      ...选项,
    };

    // 生成姓名和外貌
    const 姓名 = 选项.姓名 ?? this.生成随机姓名(生成上下文);
    const 外貌描述 = 选项.外貌描述 ?? this.生成随机外貌(生成上下文);

    // 创建冠军数据
    const 冠军数据 = {
      姓名,
      外貌描述,
      性别: 生成上下文.性别,
      力量,
      敏捷,
      智力,
      来源信息: {
        类型: '生育',
        母畜ID: 母畜.实体ID,
        母畜姓名: 母畜.获取属性('姓名'),
        母畜身份,
        母畜种族,
        母畜总雌性价值: 总雌性价值,
        出生时间: Date.now(),
      },
    };

    // 创建冠军实体
    const 新冠军 = new 冠军实体(冠军数据);

    // 记录成长事件
    新冠军.记录成长事件(`由${母畜.获取属性('姓名')}(${母畜身份})所生`, { 力量, 敏捷, 智力 });

    // 应用额外标签
    if (选项.标签) {
      选项.标签.forEach(标签 => 新冠军.添加标签(标签));
    }

    // 继承母畜的特殊标签（如果配置了）
    if (选项.继承标签) {
      选项.继承标签.forEach(标签 => {
        if (母畜.拥有标签(标签)) {
          新冠军.添加标签(标签);
        }
      });
    }

    return {
      成功: true,
      冠军: 新冠军,
      消耗雌性价值: this.生育消耗,
      属性: { 力量, 敏捷, 智力 },
    };
  }

  直接创建(配置) {
    /**
     * 直接创建冠军（非生育方式）
     * 用于初始冠军、招募、事件奖励等
     *
     * 配置示例:
     * {
     *   姓名: '艾伦',
     *   力量: 15,
     *   敏捷: 12,
     *   智力: 10,
     *   // 或使用属性等级自动计算
     *   属性等级: '普通', // '弱小' | '普通' | '精英' | '传奇'
     * }
     */

    let 力量, 敏捷, 智力;

    if (配置.属性等级) {
      // 根据属性等级生成
      const 属性 = this.根据等级生成属性(配置.属性等级);
      力量 = 配置.力量 ?? 属性.力量;
      敏捷 = 配置.敏捷 ?? 属性.敏捷;
      智力 = 配置.智力 ?? 属性.智力;
    } else {
      // 使用指定值或默认范围随机
      力量 = 配置.力量 ?? this.随机属性值('力量');
      敏捷 = 配置.敏捷 ?? this.随机属性值('敏捷');
      智力 = 配置.智力 ?? this.随机属性值('智力');
    }

    const 生成上下文 = {
      性别: 配置.性别 ?? '男',
      来源: 配置.来源 ?? '未知',
      ...配置,
    };

    const 冠军数据 = {
      姓名: 配置.姓名 ?? this.生成随机姓名(生成上下文),
      外貌描述: 配置.外貌描述 ?? this.生成随机外貌(生成上下文),
      性别: 生成上下文.性别,
      力量,
      敏捷,
      智力,
      经验: 配置.经验 ?? 0,
      等级: 配置.等级 ?? 1,
      来源信息: {
        类型: 配置.来源类型 ?? '创建',
        来源: 配置.来源 ?? '未知',
        创建时间: Date.now(),
        备注: 配置.备注 ?? null,
      },
    };

    const 新冠军 = new 冠军实体(冠军数据);

    // 应用标签
    if (配置.标签) {
      配置.标签.forEach(标签 => 新冠军.添加标签(标签));
    }

    // 记录来源
    新冠军.记录成长事件(`来源: ${配置.来源 ?? '未知'}`);

    return 新冠军;
  }

  // ─── 辅助方法 ───

  随机属性值(属性名) {
    const 范围 = this.默认属性范围[属性名] ?? { 最小: 5, 最大: 20 };
    return Math.floor(Math.random() * (范围.最大 - 范围.最小 + 1)) + 范围.最小;
  }

  根据等级生成属性(等级) {
    const 等级配置 = {
      弱小: { 基础: 5, 浮动: 3 },
      普通: { 基础: 10, 浮动: 5 },
      精英: { 基础: 20, 浮动: 5 },
      传奇: { 基础: 35, 浮动: 10 },
    };

    const 配置 = 等级配置[等级] ?? 等级配置.普通;
    const 生成 = () => 配置.基础 + Math.floor(Math.random() * (配置.浮动 * 2 + 1)) - 配置.浮动;

    return {
      力量: Math.max(1, 生成()),
      敏捷: Math.max(1, 生成()),
      智力: Math.max(1, 生成()),
    };
  }

  批量创建(数量, 配置模板 = {}) {
    /**
     * 批量创建冠军
     * 返回冠军实体数组
     */
    const 冠军列表 = [];

    for (let i = 0; i < 数量; i++) {
      const 个体配置 = {
        ...配置模板,
        // 每个个体重新生成姓名
        姓名: 配置模板.固定姓名 ? 配置模板.姓名 : null,
      };
      冠军列表.push(this.直接创建(个体配置));
    }

    return 冠军列表;
  }

  // ─── 预估方法 ───

  预估生育属性(母畜) {
    /**
     * 预估从指定母畜生育的冠军属性范围
     * 用于UI展示
     */
    const 母畜身份 = 母畜.获取属性('原身份');
    const 母畜种族 = 母畜.获取属性('种族');
    const 总雌性价值 = 母畜.获取属性('总雌性价值');

    const 效率系数 = this.获取效率系数(母畜身份);
    const 种族系数 = this.获取种族系数(母畜种族);

    const 基础值 = 总雌性价值 / 10;
    const 范围 = this.随机浮动范围;

    return {
      力量: {
        最小: Math.max(1, Math.round((基础值 - 范围) * 效率系数.力量 * 种族系数.力量)),
        最大: Math.round((基础值 + 范围) * 效率系数.力量 * 种族系数.力量),
        期望: Math.round(基础值 * 效率系数.力量 * 种族系数.力量),
      },
      敏捷: {
        最小: Math.max(1, Math.round((基础值 - 范围) * 效率系数.敏捷 * 种族系数.敏捷)),
        最大: Math.round((基础值 + 范围) * 效率系数.敏捷 * 种族系数.敏捷),
        期望: Math.round(基础值 * 效率系数.敏捷 * 种族系数.敏捷),
      },
      智力: {
        最小: Math.max(1, Math.round((基础值 - 范围) * 效率系数.智力 * 种族系数.智力)),
        最大: Math.round((基础值 + 范围) * 效率系数.智力 * 种族系数.智力),
        期望: Math.round(基础值 * 效率系数.智力 * 种族系数.智力),
      },
    };
  }
}

// ═══════════════════════════════════════════════════════════════
// 母畜工厂
// ═══════════════════════════════════════════════════════════════

/**
 * 母畜工厂
 * 负责创建母畜实体，支持多种来源
 */
class 母畜工厂 {
  constructor(属性注册表 = null) {
    this.属性注册表 = 属性注册表;

    // 身份价值表：身份类型 -> 价值范围
    this.身份价值表 = new Map();

    // 种族价值修正表
    this.种族价值修正表 = new Map();

    // 姓名生成器
    this.姓名生成器 = null;
    this.姓名池 = {
      人类: [],
      精灵: [],
      兽人: [],
      通用: [],
    };

    // 外貌生成器
    this.外貌生成器 = null;

    // 默认价值范围
    this.默认价值范围 = { 最小: 80, 最大: 120 };
  }

  // ─── 配置方法 ───

  设置属性注册表(注册表) {
    this.属性注册表 = 注册表;
  }

  // ─── 身份价值管理 ───

  注册身份价值(身份类型, 价值范围) {
    /**
     * 价值范围示例: { 最小: 100, 最大: 150 }
     * 或直接提供固定值: { 固定: 200 }
     */
    this.身份价值表.set(身份类型, {
      最小: 价值范围.最小 ?? 价值范围.固定 ?? 100,
      最大: 价值范围.最大 ?? 价值范围.固定 ?? 100,
      固定: 价值范围.固定 ?? null,
    });
  }

  批量注册身份价值(配置对象) {
    /**
     * 配置对象示例:
     * {
     *   '圣女': { 最小: 450, 最大: 550 },
     *   '普通人': { 最小: 80, 最大: 120 },
     * }
     */
    Object.entries(配置对象).forEach(([身份, 范围]) => {
      this.注册身份价值(身份, 范围);
    });
  }

  获取身份价值范围(身份类型) {
    return this.身份价值表.get(身份类型) ?? { ...this.默认价值范围 };
  }

  获取所有身份价值() {
    return Object.fromEntries(this.身份价值表);
  }

  // ─── 种族修正管理 ───

  注册种族价值修正(种族, 修正配置) {
    /**
     * 修正配置示例:
     * { 乘数: 1.2, 加成: 50 }
     * 最终价值 = 基础价值 * 乘数 + 加成
     */
    this.种族价值修正表.set(种族, {
      乘数: 修正配置.乘数 ?? 1.0,
      加成: 修正配置.加成 ?? 0,
    });
  }

  获取种族价值修正(种族) {
    return this.种族价值修正表.get(种族) ?? { 乘数: 1.0, 加成: 0 };
  }

  // ─── 姓名生成器 ───

  设置姓名生成器(生成函数) {
    /**
     * 生成函数签名: (上下文?) => 姓名字符串
     * 上下文包含: 种族、身份等
     */
    this.姓名生成器 = 生成函数;
  }

  设置姓名池(种族, 姓名列表) {
    this.姓名池[种族] = 姓名列表;
  }

  批量设置姓名池(配置) {
    Object.entries(配置).forEach(([种族, 列表]) => {
      this.姓名池[种族] = 列表;
    });
  }

  生成随机姓名(上下文 = {}) {
    // 优先使用自定义生成器
    if (this.姓名生成器) {
      return this.姓名生成器(上下文);
    }

    // 根据种族选择姓名池
    const 种族 = 上下文.种族 ?? '人类';
    let 候选池 = this.姓名池[种族];

    if (!候选池 || 候选池.length === 0) {
      候选池 = this.姓名池.通用;
    }

    if (候选池 && 候选池.length > 0) {
      return 候选池[Math.floor(Math.random() * 候选池.length)];
    }

    // 默认姓名
    return `女子_${Date.now().toString(36).slice(-4)}`;
  }

  // ─── 外貌生成器 ───

  设置外貌生成器(生成函数) {
    this.外貌生成器 = 生成函数;
  }

  生成随机外貌(上下文 = {}) {
    if (this.外貌生成器) {
      return this.外貌生成器(上下文);
    }
    return '';
  }

  // ─── 价值计算 ───

  计算总雌性价值(身份, 种族 = '人类', 选项 = {}) {
    // 获取基础范围
    const 范围 = this.获取身份价值范围(身份);

    // 计算基础价值
    let 基础价值;
    if (范围.固定 !== null) {
      基础价值 = 范围.固定;
    } else {
      基础价值 = Math.floor(Math.random() * (范围.最大 - 范围.最小 + 1)) + 范围.最小;
    }

    // 应用种族修正
    const 修正 = this.获取种族价值修正(种族);
    let 最终价值 = Math.round(基础价值 * 修正.乘数 + 修正.加成);

    // 应用额外修正（如果有）
    if (选项.价值修正) {
      最终价值 = Math.round(最终价值 * (选项.价值修正.乘数 ?? 1.0) + (选项.价值修正.加成 ?? 0));
    }

    return Math.max(10, 最终价值); // 最低保证10点价值
  }

  // ─── 创建方法 ───

  创建母畜(配置) {
    /**
     * 配置示例:
     * {
     *   姓名: '艾丽丝',
     *   原身份: '骑士',
     *   种族: '人类',
     *   年龄: 22,
     *   外貌描述: '金发碧眼...',
     *   总雌性价值: 200, // 可选，不提供则根据身份和种族计算
     *   臣服度: 0,
     *   淫乱度: 0,
     *   特殊标签: ['贵族血脉'],
     *   来源: '战斗俘获',
     * }
     */

    const 身份 = 配置.原身份 ?? '普通人';
    const 种族 = 配置.种族 ?? '人类';
    const 年龄 = 配置.年龄 ?? 20 + Math.floor(Math.random() * 10);

    // 计算总雌性价值
    const 总雌性价值 = 配置.总雌性价值 ?? this.计算总雌性价值(身份, 种族, 配置);

    // 生成上下文
    const 生成上下文 = {
      原身份: 身份,
      种族,
      年龄,
      ...配置,
    };

    // 创建母畜数据
    const 母畜数据 = {
      姓名: 配置.姓名 ?? this.生成随机姓名(生成上下文),
      原身份: 身份,
      种族,
      年龄,
      外貌描述: 配置.外貌描述 ?? this.生成随机外貌(生成上下文),
      总雌性价值,
      剩余雌性价值: 配置.剩余雌性价值 ?? 总雌性价值,
      臣服度: 配置.臣服度 ?? 0,
      淫乱度: 配置.淫乱度 ?? 0,
      特殊标签: 配置.特殊标签 ?? [],
    };

    // 创建实体
    const 新母畜 = new 母畜实体(母畜数据);

    // 设置来源元数据
    新母畜.元数据.来源 = 配置.来源 ?? '未知';
    新母畜.元数据.来源类型 = 配置.来源类型 ?? '创建';
    新母畜.元数据.俘获时间 = 配置.俘获时间 ?? Date.now();

    // 应用额外标签
    if (配置.额外标签) {
      配置.额外标签.forEach(标签 => 新母畜.添加标签(标签));
    }

    return 新母畜;
  }

  从战斗俘获创建(战利品配置) {
    /**
     * 战利品配置示例:
     * {
     *   目标信息: { 姓名: '敌方女骑士', 原身份: '骑士', ... },
     *   俘获来源: '血月村袭击',
     *   初始臣服度: 0,
     * }
     */
    return this.创建母畜({
      ...战利品配置.目标信息,
      臣服度: 战利品配置.初始臣服度 ?? 0,
      淫乱度: 0,
      来源: 战利品配置.俘获来源 ?? '战斗俘获',
      来源类型: '战斗俘获',
    });
  }

  从黑市购买创建(商品配置) {
    /**
     * 商品配置示例:
     * {
     *   总雌性价值范围: [80, 120],
     *   初始臣服度: 10,
     *   原身份: '普通人',
     *   商品名称: '债务抵押的农家女',
     * }
     */
    let 总雌性价值;
    if (商品配置.总雌性价值) {
      总雌性价值 = 商品配置.总雌性价值;
    } else if (商品配置.总雌性价值范围) {
      const [最小, 最大] = 商品配置.总雌性价值范围;
      总雌性价值 = Math.floor(Math.random() * (最大 - 最小 + 1)) + 最小;
    }

    return this.创建母畜({
      原身份: 商品配置.原身份 ?? '普通人',
      种族: 商品配置.种族 ?? '人类',
      总雌性价值,
      臣服度: 商品配置.初始臣服度 ?? 10,
      特殊标签: 商品配置.特殊标签 ?? [],
      来源: `黑市购买: ${商品配置.商品名称 ?? '奴隶'}`,
      来源类型: '黑市购买',
    });
  }

  从劝诱创建(劝诱配置) {
    /**
     * 潜入劝诱成功时创建母畜
     */
    return this.创建母畜({
      ...劝诱配置.目标配置,
      臣服度: 劝诱配置.初始臣服度 ?? 20,
      淫乱度: 0,
      来源: `劝诱加入`,
      来源类型: '劝诱',
    });
  }

  // ─── 批量创建 ───

  批量创建(数量, 配置模板 = {}) {
    /**
     * 批量创建母畜
     * 返回母畜实体数组
     */
    const 母畜列表 = [];

    for (let i = 0; i < 数量; i++) {
      const 个体配置 = {
        ...配置模板,
        // 每个个体重新生成姓名和价值
        姓名: 配置模板.固定姓名 ? 配置模板.姓名 : null,
        总雌性价值: 配置模板.固定价值 ? 配置模板.总雌性价值 : null,
      };
      母畜列表.push(this.创建母畜(个体配置));
    }

    return 母畜列表;
  }

  // ─── 预估方法 ───

  预估身份价值(身份, 种族 = '人类') {
    /**
     * 预估指定身份和种族的价值范围
     * 用于UI展示
     */
    const 范围 = this.获取身份价值范围(身份);
    const 修正 = this.获取种族价值修正(种族);

    return {
      最小: Math.round(范围.最小 * 修正.乘数 + 修正.加成),
      最大: Math.round(范围.最大 * 修正.乘数 + 修正.加成),
      期望: Math.round(((范围.最小 + 范围.最大) / 2) * 修正.乘数 + 修正.加成),
    };
  }
}

// ═══════════════════════════════════════════════════════════════
// 领主工厂
// ═══════════════════════════════════════════════════════════════

/**
 * 领主工厂
 * 负责创建领主实体
 */
class 领主工厂 {
  constructor() {
    this.默认配置 = {
      魔力: 0,
      最大魔力: 100,
      姓名: '无名领主',
    };
  }

  设置默认配置(配置) {
    this.默认配置 = { ...this.默认配置, ...配置 };
  }

  创建领主(配置 = {}) {
    return new 领主实体({
      ...this.默认配置,
      ...配置,
    });
  }
}

// ═══════════════════════════════════════════════════════════════
// 工厂管理器
// ═══════════════════════════════════════════════════════════════

/**
 * 工厂管理器
 * 统一管理所有工厂实例
 */
class 工厂管理器 {
  constructor(属性注册表 = null) {
    this.冠军工厂 = new 冠军工厂(属性注册表);
    this.母畜工厂 = new 母畜工厂(属性注册表);
    this.领主工厂 = new 领主工厂();
    this.属性注册表 = 属性注册表;

    // 自定义工厂扩展
    this.扩展工厂 = new Map();
  }

  设置属性注册表(注册表) {
    this.属性注册表 = 注册表;
    this.冠军工厂.设置属性注册表(注册表);
    this.母畜工厂.设置属性注册表(注册表);
  }

  // ─── 工厂访问 ───

  获取冠军工厂() {
    return this.冠军工厂;
  }

  获取母畜工厂() {
    return this.母畜工厂;
  }

  获取领主工厂() {
    return this.领主工厂;
  }

  // ─── 扩展工厂 ───

  注册扩展工厂(名称, 工厂实例) {
    this.扩展工厂.set(名称, 工厂实例);
  }

  获取扩展工厂(名称) {
    return this.扩展工厂.get(名称);
  }

  // ─── 快捷创建方法 ───

  创建冠军(配置) {
    return this.冠军工厂.直接创建(配置);
  }

  创建母畜(配置) {
    return this.母畜工厂.创建母畜(配置);
  }

  创建领主(配置) {
    return this.领主工厂.创建领主(配置);
  }

  从母畜生育冠军(母畜, 选项) {
    return this.冠军工厂.从母畜生育(母畜, 选项);
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 冠军工厂, 工厂管理器, 母畜工厂, 领主工厂 };
