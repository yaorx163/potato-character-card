// ═══════════════════════════════════════════════════════════════
// core/factories.js
// 工厂类 - 负责创建游戏实体
// ═══════════════════════════════════════════════════════════════

import { 冠军实体, 母畜实体, 袭击目标实体, 领主实体 } from './entities.js';

// ═══════════════════════════════════════════════════════════════
// 冠军工厂
// ═══════════════════════════════════════════════════════════════

/**
 * 冠军工厂
 * 负责创建冠军实体，支持从母畜生育和直接创建
 */
class 冠军工厂 {
  constructor(属性注册表 = null) {
    this.属性注册表 = 属性注册表;

    // 效率系数表：身份类型 -> 属性系数
    this.效率系数表 = new Map();

    // 种族系数表：种族 -> 属性系数
    this.种族系数表 = new Map();

    // 姓名生成器
    this.姓名生成器 = null;
    this.姓名池 = {
      前缀: [],
      主名: [],
      后缀: [],
    };

    // 外貌生成器
    this.外貌生成器 = null;

    // 默认属性范围
    this.默认属性范围 = {
      力量: { 最小: 5, 最大: 20 },
      敏捷: { 最小: 5, 最大: 20 },
      智力: { 最小: 5, 最大: 20 },
    };

    // 生育消耗配置
    this.生育消耗 = 100;

    // 随机浮动范围
    this.随机浮动范围 = 5;
  }

  // ─── 配置方法 ───

  设置属性注册表(注册表) {
    this.属性注册表 = 注册表;
  }

  设置生育消耗(数值) {
    this.生育消耗 = 数值;
  }

  设置随机浮动范围(范围) {
    this.随机浮动范围 = 范围;
  }

  // ─── 效率系数管理 ───

  注册效率系数(身份类型, 系数配置) {
    this.效率系数表.set(身份类型, {
      力量: 系数配置.力量 ?? 1.0,
      敏捷: 系数配置.敏捷 ?? 1.0,
      智力: 系数配置.智力 ?? 1.0,
    });
  }

  批量注册效率系数(配置对象) {
    Object.entries(配置对象).forEach(([身份, 系数]) => {
      this.注册效率系数(身份, 系数);
    });
  }

  获取效率系数(身份类型) {
    return (
      this.效率系数表.get(身份类型) ?? {
        力量: 1.0,
        敏捷: 1.0,
        智力: 1.0,
      }
    );
  }

  获取所有效率系数() {
    return Object.fromEntries(this.效率系数表);
  }

  // ─── 种族系数管理 ───

  注册种族系数(种族, 系数配置) {
    this.种族系数表.set(种族, {
      力量: 系数配置.力量 ?? 1.0,
      敏捷: 系数配置.敏捷 ?? 1.0,
      智力: 系数配置.智力 ?? 1.0,
    });
  }

  批量注册种族系数(配置对象) {
    Object.entries(配置对象).forEach(([种族, 系数]) => {
      this.注册种族系数(种族, 系数);
    });
  }

  获取种族系数(种族) {
    return (
      this.种族系数表.get(种族) ?? {
        力量: 1.0,
        敏捷: 1.0,
        智力: 1.0,
      }
    );
  }

  // ─── 姓名生成器 ───

  设置姓名生成器(生成函数) {
    this.姓名生成器 = 生成函数;
  }

  设置姓名池(池配置) {
    if (池配置.前缀) this.姓名池.前缀 = 池配置.前缀;
    if (池配置.主名) this.姓名池.主名 = 池配置.主名;
    if (池配置.后缀) this.姓名池.后缀 = 池配置.后缀;
  }

  生成随机姓名(上下文 = {}) {
    if (this.姓名生成器) {
      return this.姓名生成器(上下文);
    }

    if (this.姓名池.主名.length > 0) {
      const 随机选择 = 数组 => {
        if (!数组 || 数组.length === 0) return '';
        return 数组[Math.floor(Math.random() * 数组.length)];
      };

      const 前缀 = Math.random() < 0.3 ? 随机选择(this.姓名池.前缀) : '';
      const 主名 = 随机选择(this.姓名池.主名);
      const 后缀 = Math.random() < 0.2 ? 随机选择(this.姓名池.后缀) : '';

      return `${前缀}${主名}${后缀}`.trim();
    }

    return `冠军_${Date.now().toString(36).slice(-4)}`;
  }

  // ─── 外貌生成器 ───

  设置外貌生成器(生成函数) {
    this.外貌生成器 = 生成函数;
  }

  生成随机外貌(上下文 = {}) {
    if (this.外貌生成器) {
      return this.外貌生成器(上下文);
    }
    return '';
  }

  // ─── 属性计算辅助 ───

  计算随机浮动() {
    const 范围 = this.随机浮动范围;
    return Math.floor(Math.random() * (范围 * 2 + 1)) - 范围;
  }

  计算属性值(基础值, 效率系数, 种族系数 = 1.0) {
    const 浮动 = this.计算随机浮动();
    const 原始值 = (基础值 + 浮动) * 效率系数 * 种族系数;
    return Math.max(1, Math.round(原始值));
  }

  // ─── 创建方法 ───

  从母畜生育(母畜, 选项 = {}) {
    const 剩余价值 = 母畜.获取属性('剩余雌性价值');
    if (剩余价值 < this.生育消耗) {
      return {
        成功: false,
        原因: '剩余雌性价值不足',
        当前: 剩余价值,
        需要: this.生育消耗,
      };
    }

    const 母畜身份 = 母畜.获取属性('原身份');
    const 母畜种族 = 母畜.获取属性('种族');
    const 总雌性价值 = 母畜.获取属性('总雌性价值');

    const 效率系数 = this.获取效率系数(母畜身份);
    const 种族系数 = this.获取种族系数(母畜种族);

    const 基础值 = 总雌性价值 / 10;

    const 力量 = this.计算属性值(基础值, 效率系数.力量, 种族系数.力量);
    const 敏捷 = this.计算属性值(基础值, 效率系数.敏捷, 种族系数.敏捷);
    const 智力 = this.计算属性值(基础值, 效率系数.智力, 种族系数.智力);

    const 生成上下文 = {
      母畜,
      母畜身份,
      母畜种族,
      性别: 选项.性别 ?? '男',
      ...选项,
    };

    const 姓名 = 选项.姓名 ?? this.生成随机姓名(生成上下文);
    const 外貌描述 = 选项.外貌描述 ?? this.生成随机外貌(生成上下文);

    const 冠军数据 = {
      姓名,
      外貌描述,
      性别: 生成上下文.性别,
      力量,
      敏捷,
      智力,
      来源信息: {
        类型: '生育',
        母畜ID: 母畜.实体ID,
        母畜姓名: 母畜.获取属性('姓名'),
        母畜身份,
        母畜种族,
        母畜总雌性价值: 总雌性价值,
        出生时间: Date.now(),
      },
    };

    const 新冠军 = new 冠军实体(冠军数据);

    新冠军.记录成长事件(`由${母畜.获取属性('姓名')}(${母畜身份})所生`, { 力量, 敏捷, 智力 });

    if (选项.标签) {
      选项.标签.forEach(标签 => 新冠军.添加标签(标签));
    }

    if (选项.继承标签) {
      选项.继承标签.forEach(标签 => {
        if (母畜.拥有标签(标签)) {
          新冠军.添加标签(标签);
        }
      });
    }

    return {
      成功: true,
      冠军: 新冠军,
      消耗雌性价值: this.生育消耗,
      属性: { 力量, 敏捷, 智力 },
    };
  }

  直接创建(配置) {
    let 力量, 敏捷, 智力;

    if (配置.属性等级) {
      const 属性 = this.根据等级生成属性(配置.属性等级);
      力量 = 配置.力量 ?? 属性.力量;
      敏捷 = 配置.敏捷 ?? 属性.敏捷;
      智力 = 配置.智力 ?? 属性.智力;
    } else {
      力量 = 配置.力量 ?? this.随机属性值('力量');
      敏捷 = 配置.敏捷 ?? this.随机属性值('敏捷');
      智力 = 配置.智力 ?? this.随机属性值('智力');
    }

    const 生成上下文 = {
      性别: 配置.性别 ?? '男',
      来源: 配置.来源 ?? '未知',
      ...配置,
    };

    const 冠军数据 = {
      姓名: 配置.姓名 ?? this.生成随机姓名(生成上下文),
      外貌描述: 配置.外貌描述 ?? this.生成随机外貌(生成上下文),
      性别: 生成上下文.性别,
      力量,
      敏捷,
      智力,
      经验: 配置.经验 ?? 0,
      等级: 配置.等级 ?? 1,
      来源信息: {
        类型: 配置.来源类型 ?? '创建',
        来源: 配置.来源 ?? '未知',
        创建时间: Date.now(),
        备注: 配置.备注 ?? null,
      },
    };

    const 新冠军 = new 冠军实体(冠军数据);

    if (配置.标签) {
      配置.标签.forEach(标签 => 新冠军.添加标签(标签));
    }

    新冠军.记录成长事件(`来源: ${配置.来源 ?? '未知'}`);

    return 新冠军;
  }

  // ─── 辅助方法 ───

  随机属性值(属性名) {
    const 范围 = this.默认属性范围[属性名] ?? { 最小: 5, 最大: 20 };
    return Math.floor(Math.random() * (范围.最大 - 范围.最小 + 1)) + 范围.最小;
  }

  根据等级生成属性(等级) {
    const 等级配置 = {
      弱小: { 基础: 5, 浮动: 3 },
      普通: { 基础: 10, 浮动: 5 },
      精英: { 基础: 20, 浮动: 5 },
      传奇: { 基础: 35, 浮动: 10 },
    };

    const 配置 = 等级配置[等级] ?? 等级配置.普通;
    const 生成 = () => 配置.基础 + Math.floor(Math.random() * (配置.浮动 * 2 + 1)) - 配置.浮动;

    return {
      力量: Math.max(1, 生成()),
      敏捷: Math.max(1, 生成()),
      智力: Math.max(1, 生成()),
    };
  }

  批量创建(数量, 配置模板 = {}) {
    const 冠军列表 = [];

    for (let i = 0; i < 数量; i++) {
      const 个体配置 = {
        ...配置模板,
        姓名: 配置模板.固定姓名 ? 配置模板.姓名 : null,
      };
      冠军列表.push(this.直接创建(个体配置));
    }

    return 冠军列表;
  }

  // ─── 预估方法 ───

  预估生育属性(母畜) {
    const 母畜身份 = 母畜.获取属性('原身份');
    const 母畜种族 = 母畜.获取属性('种族');
    const 总雌性价值 = 母畜.获取属性('总雌性价值');

    const 效率系数 = this.获取效率系数(母畜身份);
    const 种族系数 = this.获取种族系数(母畜种族);

    const 基础值 = 总雌性价值 / 10;
    const 范围 = this.随机浮动范围;

    return {
      力量: {
        最小: Math.max(1, Math.round((基础值 - 范围) * 效率系数.力量 * 种族系数.力量)),
        最大: Math.round((基础值 + 范围) * 效率系数.力量 * 种族系数.力量),
        期望: Math.round(基础值 * 效率系数.力量 * 种族系数.力量),
      },
      敏捷: {
        最小: Math.max(1, Math.round((基础值 - 范围) * 效率系数.敏捷 * 种族系数.敏捷)),
        最大: Math.round((基础值 + 范围) * 效率系数.敏捷 * 种族系数.敏捷),
        期望: Math.round(基础值 * 效率系数.敏捷 * 种族系数.敏捷),
      },
      智力: {
        最小: Math.max(1, Math.round((基础值 - 范围) * 效率系数.智力 * 种族系数.智力)),
        最大: Math.round((基础值 + 范围) * 效率系数.智力 * 种族系数.智力),
        期望: Math.round(基础值 * 效率系数.智力 * 种族系数.智力),
      },
    };
  }
}

// ═══════════════════════════════════════════════════════════════
// 母畜工厂
// ═══════════════════════════════════════════════════════════════

/**
 * 母畜工厂
 * 负责创建母畜实体，支持多种来源
 */
class 母畜工厂 {
  constructor(属性注册表 = null) {
    this.属性注册表 = 属性注册表;

    // 女性随机配置（可选注入）
    this.女性随机配置 = null;

    // 身份价值表：身份类型 -> 价值范围
    this.身份价值表 = new Map();

    // 种族价值修正表
    this.种族价值修正表 = new Map();

    // 姓名生成器
    this.姓名生成器 = null;
    this.姓名池 = {
      人类: [],
      精灵: [],
      兽人: [],
      通用: [],
    };

    // 外貌生成器
    this.外貌生成器 = null;

    // 默认价值范围
    this.默认价值范围 = { 最小: 80, 最大: 120 };
  }

  // ─── 配置方法 ───

  设置属性注册表(注册表) {
    this.属性注册表 = 注册表;
  }

  设置女性随机配置(配置实例) {
    this.女性随机配置 = 配置实例;
  }

  // ─── 身份价值管理 ───

  注册身份价值(身份类型, 价值范围) {
    this.身份价值表.set(身份类型, {
      最小: 价值范围.最小 ?? 价值范围.固定 ?? 100,
      最大: 价值范围.最大 ?? 价值范围.固定 ?? 100,
      固定: 价值范围.固定 ?? null,
    });
  }

  批量注册身份价值(配置对象) {
    Object.entries(配置对象).forEach(([身份, 范围]) => {
      this.注册身份价值(身份, 范围);
    });
  }

  获取身份价值范围(身份类型) {
    return this.身份价值表.get(身份类型) ?? { ...this.默认价值范围 };
  }

  获取所有身份价值() {
    return Object.fromEntries(this.身份价值表);
  }

  // ─── 种族修正管理 ───

  注册种族价值修正(种族, 修正配置) {
    this.种族价值修正表.set(种族, {
      乘数: 修正配置.乘数 ?? 1.0,
      加成: 修正配置.加成 ?? 0,
    });
  }

  获取种族价值修正(种族) {
    return this.种族价值修正表.get(种族) ?? { 乘数: 1.0, 加成: 0 };
  }

  // ─── 姓名生成器 ───

  设置姓名生成器(生成函数) {
    this.姓名生成器 = 生成函数;
  }

  设置姓名池(种族, 姓名列表) {
    this.姓名池[种族] = 姓名列表;
  }

  批量设置姓名池(配置) {
    Object.entries(配置).forEach(([种族, 列表]) => {
      this.姓名池[种族] = 列表;
    });
  }

  生成随机姓名(上下文 = {}) {
    if (this.姓名生成器) {
      return this.姓名生成器(上下文);
    }

    const 种族 = 上下文.种族 ?? '人类';
    let 候选池 = this.姓名池[种族];

    if (!候选池 || 候选池.length === 0) {
      候选池 = this.姓名池.通用;
    }

    if (候选池 && 候选池.length > 0) {
      return 候选池[Math.floor(Math.random() * 候选池.length)];
    }

    return `女子_${Date.now().toString(36).slice(-4)}`;
  }

  // ─── 外貌生成器 ───

  设置外貌生成器(生成函数) {
    this.外貌生成器 = 生成函数;
  }

  生成随机外貌(上下文 = {}) {
    if (this.外貌生成器) {
      return this.外貌生成器(上下文);
    }
    return '';
  }

  // ─── 价值计算 ───

  计算总雌性价值(身份, 种族 = '人类', 选项 = {}) {
    const 范围 = this.获取身份价值范围(身份);

    let 基础价值;
    if (范围.固定 !== null) {
      基础价值 = 范围.固定;
    } else {
      基础价值 = Math.floor(Math.random() * (范围.最大 - 范围.最小 + 1)) + 范围.最小;
    }

    const 修正 = this.获取种族价值修正(种族);
    let 最终价值 = Math.round(基础价值 * 修正.乘数 + 修正.加成);

    if (选项.价值修正) {
      最终价值 = Math.round(最终价值 * (选项.价值修正.乘数 ?? 1.0) + (选项.价值修正.加成 ?? 0));
    }

    return Math.max(10, 最终价值);
  }

  // ─── 创建方法 ───

  创建母畜(配置) {
    const 身份 = 配置.原身份 ?? '普通人';
    const 种族 = 配置.种族 ?? '人类';
    const 年龄 = 配置.年龄 ?? 20 + Math.floor(Math.random() * 10);

    const 总雌性价值 = 配置.总雌性价值 ?? this.计算总雌性价值(身份, 种族, 配置);

    const 生成上下文 = {
      原身份: 身份,
      种族,
      年龄,
      ...配置,
    };

    const 母畜数据 = {
      姓名: 配置.姓名 ?? this.生成随机姓名(生成上下文),
      原身份: 身份,
      种族,
      年龄,
      外貌描述: 配置.外貌描述 ?? this.生成随机外貌(生成上下文),
      总雌性价值,
      剩余雌性价值: 配置.剩余雌性价值 ?? 总雌性价值,
      臣服度: 配置.臣服度 ?? 0,
      淫乱度: 配置.淫乱度 ?? 0,
      特殊标签: 配置.特殊标签 ?? [],
      已捕获: 配置.已捕获 ?? true,
      已锁定: 配置.已锁定 ?? false,
      来源类型: 配置.来源类型 ?? '创建',
    };

    const 新母畜 = new 母畜实体(母畜数据);

    新母畜.元数据.来源 = 配置.来源 ?? '未知';
    新母畜.元数据.来源类型 = 配置.来源类型 ?? '创建';
    新母畜.元数据.俘获时间 = 配置.俘获时间 ?? Date.now();

    if (配置.额外标签) {
      配置.额外标签.forEach(标签 => 新母畜.添加标签(标签));
    }

    return 新母畜;
  }

  // ─── 从高价值目标创建（俘获） ───

  从高价值目标创建(母畜实体实例) {
    /**
     * 从已存在的高价值目标（母畜实体）转化为正式母畜
     * 不进行随机，直接继承所有属性
     */
    if (母畜实体实例.是否已捕获()) {
      return 母畜实体实例;
    }

    母畜实体实例.标记捕获('袭击');

    return 母畜实体实例;
  }

  // ─── 从劝诱创建 ───

  从劝诱创建(母畜实体实例) {
    /**
     * 从潜入劝诱成功的目标创建母畜
     * 不进行随机，直接继承属性，但来源类型不同
     */
    if (母畜实体实例.是否已捕获()) {
      return 母畜实体实例;
    }

    母畜实体实例.标记捕获('劝诱');
    母畜实体实例.设置属性('臣服度', 20);

    return 母畜实体实例;
  }

  // ─── 从黑市购买创建 ───

  从黑市购买创建(商品配置) {
    /**
     * 从黑市购买创建母畜
     * 需要进行随机生成
     */
    if (this.女性随机配置) {
      const 随机属性 = this.女性随机配置.为黑市商品生成(商品配置);

      return this.创建母畜({
        ...随机属性,
        臣服度: 商品配置.初始臣服度 ?? 10,
        来源: `黑市购买: ${商品配置.商品名称 ?? '奴隶'}`,
        来源类型: '黑市',
        已捕获: true,
      });
    }

    return false;
  }

  // ─── 旧方法兼容 ───

  从战斗俘获创建(战利品配置) {
    /**
     * @deprecated 使用 从高价值目标创建 代替
     */
    return this.创建母畜({
      ...战利品配置.目标信息,
      臣服度: 战利品配置.初始臣服度 ?? 0,
      淫乱度: 0,
      来源: 战利品配置.俘获来源 ?? '战斗俘获',
      来源类型: '袭击',
      已捕获: true,
    });
  }

  // ─── 批量创建 ───

  批量创建(数量, 配置模板 = {}) {
    const 母畜列表 = [];

    for (let i = 0; i < 数量; i++) {
      const 个体配置 = {
        ...配置模板,
        姓名: 配置模板.固定姓名 ? 配置模板.姓名 : null,
        总雌性价值: 配置模板.固定价值 ? 配置模板.总雌性价值 : null,
      };
      母畜列表.push(this.创建母畜(个体配置));
    }

    return 母畜列表;
  }

  // ─── 预估方法 ───

  预估身份价值(身份, 种族 = '人类') {
    const 范围 = this.获取身份价值范围(身份);
    const 修正 = this.获取种族价值修正(种族);

    return {
      最小: Math.round(范围.最小 * 修正.乘数 + 修正.加成),
      最大: Math.round(范围.最大 * 修正.乘数 + 修正.加成),
      期望: Math.round(((范围.最小 + 范围.最大) / 2) * 修正.乘数 + 修正.加成),
    };
  }
}

// ═══════════════════════════════════════════════════════════════
// 领主工厂
// ═══════════════════════════════════════════════════════════════

/**
 * 领主工厂
 * 负责创建领主实体
 */
class 领主工厂 {
  constructor() {
    this.默认配置 = {
      魔力: 0,
      最大魔力: 100,
      姓名: '无名领主',
    };
  }

  设置默认配置(配置) {
    this.默认配置 = { ...this.默认配置, ...配置 };
  }

  创建领主(配置 = {}) {
    return new 领主实体({
      ...this.默认配置,
      ...配置,
    });
  }
}

// ═══════════════════════════════════════════════════════════════
// 袭击目标工厂
// ═══════════════════════════════════════════════════════════════

/**
 * 袭击目标工厂
 * 负责生成随机的袭击目标及其高价值目标
 */
class 袭击目标工厂 {
  constructor(女性随机配置实例 = null, 公式引擎 = null) {
    this.女性随机配置 = 女性随机配置实例;
    this.公式引擎 = 公式引擎;

    // 类型配置
    this.类型配置 = new Map();

    // 难度系数
    this.难度系数 = {
      简单: 0.7,
      普通: 1.0,
      困难: 1.3,
      噩梦: 1.6,
    };

    // 当前难度
    this.当前难度 = '普通';
  }

  // ─── 配置方法 ───

  设置女性随机配置(配置实例) {
    this.女性随机配置 = 配置实例;
  }

  设置公式引擎(引擎) {
    this.公式引擎 = 引擎;
  }

  注册目标类型(类型名, 配置) {
    /**
     * 配置示例:
     * {
     *   战力范围: { 最小: 20, 最大: 80 },
     *   高价值目标数量: { 最小: 1, 最大: 3 },
     *   描述模板: ['偏远的小村庄', '宁静的农业村落'],
     *   位置类型: ['平原', '山区', '河谷'],
     *   高价值目标身份池: ['农家女', '村长之女'],
     *   稀有身份概率: 0.1,
     *   稀有身份池: ['商人之女', '低阶冒险者'],
     *   种族权重覆盖: { 人类: 80, 精灵: 20 },  // 可选
     *   特殊标签: ['神圣'],  // 可选
     * }
     */
    this.类型配置.set(类型名, 配置);
  }

  批量注册目标类型(配置对象) {
    Object.entries(配置对象).forEach(([类型, 配置]) => {
      this.注册目标类型(类型, 配置);
    });
  }

  设置难度(难度) {
    if (this.难度系数[难度]) {
      this.当前难度 = 难度;
    }
  }

  获取难度系数() {
    return this.难度系数[this.当前难度] ?? 1.0;
  }

  // ─── 工具方法 ───

  随机选择(数组) {
    if (!数组 || 数组.length === 0) return null;
    return 数组[Math.floor(Math.random() * 数组.length)];
  }

  随机范围(最小, 最大) {
    return Math.floor(Math.random() * (最大 - 最小 + 1)) + 最小;
  }

  // ─── 高价值目标生成 ───

  // 袭击目标工厂中的方法
  生成高价值目标(类型配置, 选项 = {}) {
    if (!this.女性随机配置) {
      throw new Error('女性随机配置未设置');
    }

    // 构建约束条件
    const 约束条件 = {
      身份池: 类型配置.高价值目标身份池,
    };

    // 处理稀有身份
    if (类型配置.稀有身份池 && Math.random() < (类型配置.稀有身份概率 ?? 0)) {
      约束条件.身份池 = 类型配置.稀有身份池;
    }

    // 处理种族权重覆盖
    if (类型配置.种族权重覆盖) {
      约束条件.种族权重覆盖 = 类型配置.种族权重覆盖;
    }

    // 处理特殊标签
    if (类型配置.特殊标签) {
      约束条件.额外标签 = 类型配置.特殊标签;
    }

    // 使用女性随机配置生成基础属性
    const 随机属性 = this.女性随机配置.随机生成(约束条件);

    // 创建母畜实体（未捕获状态）
    const 目标 = new 母畜实体({
      ...随机属性,
      已捕获: false,
      已锁定: false,
      来源类型: '袭击',
    });

    return 目标;
  }

  // ─── 袭击目标生成 ───

  生成袭击目标(类型, 选项 = {}) {
    const 类型配置 = this.类型配置.get(类型);
    if (!类型配置) {
      throw new Error(`未知的袭击目标类型: ${类型}`);
    }

    // 计算战斗力
    const 基础战力 = this.随机范围(类型配置.战力范围.最小, 类型配置.战力范围.最大);
    const 难度系数 = this.难度系数[选项.难度] ?? this.获取难度系数();
    const 实际战力 = Math.floor(基础战力 * 难度系数);

    // 确定高价值目标数量
    const 数量配置 = 类型配置.高价值目标数量;
    const 目标数量 = 选项.高价值目标数量 ?? this.随机范围(数量配置.最小, 数量配置.最大);

    // 生成高价值目标列表
    const 高价值目标列表 = [];
    for (let i = 0; i < 目标数量; i++) {
      高价值目标列表.push(this.生成高价值目标(类型配置, 选项));
    }

    // 生成描述和位置
    const 描述 = 选项.描述 ?? this.随机选择(类型配置.描述模板 ?? []);
    const 位置 = 选项.位置 ?? this.随机选择(类型配置.位置类型 ?? []);

    // 生成名称
    const 名称 = 选项.名称 ?? this.生成目标名称(类型, 位置);

    // 生成护卫描述
    const 护卫描述 = this.生成护卫描述(类型, 实际战力);

    // 创建实体
    const 目标 = new 袭击目标实体({
      名称,
      类型,
      描述,
      位置,
      战斗力: 实际战力,
      护卫描述,
      高价值目标列表,
      发现周次: 选项.发现周次 ?? null,
      额外数据: {
        难度: 选项.难度 ?? this.当前难度,
        生成时间: Date.now(),
      },
    });

    return 目标;
  }

  生成目标名称(类型, 位置) {
    const 名称模板 = {
      村庄: ['${位置}村', '${随机}村', '${位置}的小村'],
      商队: ['${位置}商队', '过路商队', '远方的商队'],
      城镇: ['${位置}镇', '${随机}城镇', '边境城镇'],
      城市: ['${随机}城', '${位置}城', '${随机}都'],
      要塞: ['${位置}要塞', '${随机}堡', '边境堡垒'],
      修道院: ['${位置}修道院', '圣${随机}院', '隐修院'],
      冒险者营地: ['${位置}营地', '探险者营地', '临时营地'],
      贵族庄园: ['${随机}庄园', '${位置}领主府', '贵族宅邸'],
    };

    const 随机字 = ['安', '宁', '和', '平', '丰', '盛', '明', '清', '瑞', '祥'];

    const 模板列表 = 名称模板[类型] ?? ['未知地点'];
    let 名称 = this.随机选择(模板列表);

    名称 = 名称.replace('${位置}', 位置 ?? '');
    名称 = 名称.replace('${随机}', this.随机选择(随机字));

    return 名称.trim() || '未知地点';
  }

  生成护卫描述(类型, 战力) {
    if (战力 < 50) return '几乎没有防御力量';
    if (战力 < 100) return '少量民兵守卫';
    if (战力 < 200) return '有一定数量的卫兵';
    if (战力 < 400) return '驻扎着士兵和少量骑士';
    if (战力 < 600) return '有精锐骑士团驻守';
    return '重兵把守，防御森严';
  }

  // ─── 批量生成 ───

  批量生成(配置列表) {
    /**
     * @param 配置列表 - [{ 类型, 选项? }, ...]
     */
    return 配置列表.map(({ 类型, 选项 }) => this.生成袭击目标(类型, 选项 ?? {}));
  }

  随机生成多个(数量, 允许类型 = null) {
    const 可用类型 = 允许类型 ?? Array.from(this.类型配置.keys());
    const 结果 = [];

    for (let i = 0; i < 数量; i++) {
      const 类型 = this.随机选择(可用类型);
      if (类型) {
        结果.push(this.生成袭击目标(类型));
      }
    }

    return 结果;
  }

  按难度递进生成(周次) {
    const 所有类型 = Array.from(this.类型配置.keys());
    if (所有类型.length === 0) {
      throw new Error('未注册任何目标类型');
    }

    // 早期只生成简单目标
    if (周次 <= 4) {
      const 早期类型 = 所有类型.filter(t => ['村庄', '商队'].includes(t));
      const 类型 = this.随机选择(早期类型.length > 0 ? 早期类型 : 所有类型);
      return this.生成袭击目标(类型, { 难度: '简单' });
    }

    // 中期
    if (周次 <= 12) {
      const 中期类型 = 所有类型.filter(t => ['村庄', '商队', '城镇', '冒险者营地', '修道院'].includes(t));
      const 类型 = this.随机选择(中期类型.length > 0 ? 中期类型 : 所有类型);
      return this.生成袭击目标(类型, { 难度: '普通' });
    }

    // 后期
    if (周次 <= 24) {
      const 后期类型 = 所有类型.filter(t => ['城镇', '城市', '要塞', '贵族庄园', '修道院'].includes(t));
      const 类型 = this.随机选择(后期类型.length > 0 ? 后期类型 : 所有类型);
      const 难度 = Math.random() < 0.3 ? '困难' : '普通';
      return this.生成袭击目标(类型, { 难度 });
    }

    // 末期全面开放
    const 难度选项 = ['普通', '困难', '噩梦'];
    const 难度 = this.随机选择(难度选项);
    return this.生成袭击目标(this.随机选择(所有类型), { 难度 });
  }
}

// ═══════════════════════════════════════════════════════════════
// 工厂管理器
// ═══════════════════════════════════════════════════════════════

/**
 * 工厂管理器
 * 统一管理所有工厂实例
 */
class 工厂管理器 {
  constructor(属性注册表 = null) {
    this.冠军工厂 = new 冠军工厂(属性注册表);
    this.母畜工厂 = new 母畜工厂(属性注册表);
    this.领主工厂 = new 领主工厂();
    this.袭击目标工厂 = new 袭击目标工厂();
    this.属性注册表 = 属性注册表;

    // 女性随机配置
    this.女性随机配置 = null;

    // 自定义工厂扩展
    this.扩展工厂 = new Map();
  }

  设置属性注册表(注册表) {
    this.属性注册表 = 注册表;
    this.冠军工厂.设置属性注册表(注册表);
    this.母畜工厂.设置属性注册表(注册表);
  }

  设置女性随机配置(配置实例) {
    this.女性随机配置 = 配置实例;
    this.母畜工厂.设置女性随机配置(配置实例);
    this.袭击目标工厂.设置女性随机配置(配置实例);
  }

  设置公式引擎(引擎) {
    this.袭击目标工厂.设置公式引擎(引擎);
  }

  // ─── 工厂访问 ───

  获取冠军工厂() {
    return this.冠军工厂;
  }

  获取母畜工厂() {
    return this.母畜工厂;
  }

  获取领主工厂() {
    return this.领主工厂;
  }

  获取袭击目标工厂() {
    return this.袭击目标工厂;
  }

  // ─── 扩展工厂 ───

  注册扩展工厂(名称, 工厂实例) {
    this.扩展工厂.set(名称, 工厂实例);
  }

  获取扩展工厂(名称) {
    return this.扩展工厂.get(名称);
  }

  // ─── 快捷创建方法 ───

  创建冠军(配置) {
    return this.冠军工厂.直接创建(配置);
  }

  创建母畜(配置) {
    return this.母畜工厂.创建母畜(配置);
  }

  创建领主(配置) {
    return this.领主工厂.创建领主(配置);
  }

  从母畜生育冠军(母畜, 选项) {
    return this.冠军工厂.从母畜生育(母畜, 选项);
  }

  // ─── 袭击目标相关快捷方法 ───

  创建袭击目标(类型, 选项) {
    return this.袭击目标工厂.生成袭击目标(类型, 选项);
  }

  俘获高价值目标(母畜实体实例) {
    return this.母畜工厂.从高价值目标创建(母畜实体实例);
  }

  劝诱高价值目标(母畜实体实例) {
    return this.母畜工厂.从劝诱创建(母畜实体实例);
  }

  从黑市购买母畜(商品配置) {
    return this.母畜工厂.从黑市购买创建(商品配置);
  }

  // ─── 批量俘获 ───

  批量俘获目标(母畜实体列表) {
    return 母畜实体列表.map(实体 => this.俘获高价值目标(实体));
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 冠军工厂, 工厂管理器, 母畜工厂, 袭击目标工厂, 领主工厂 };
