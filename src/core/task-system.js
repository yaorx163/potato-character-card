// ═══════════════════════════════════════════════════════════════
// core/task-system.js
// 任务系统框架 - 基类、注册表、执行器
// ═══════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════
// 任务基类
// ═══════════════════════════════════════════════════════════════

class 任务基类 {
    static 行动者类型 = {
      冠军: 'champion',
      母畜: 'breeder',
      领主: 'lord',
      无: 'none'
    };
  
    static 目标类型 = {
      母畜: 'breeder',
      冠军: 'champion',
      地点: 'location',
      喽啰池: 'minion_pool',
      无: 'none'
    };
  
    constructor(配置 = {}) {
      this.任务ID = 配置.任务ID || this.constructor.name;
      this.任务名称 = 配置.任务名称 || '未命名任务';
      this.描述 = 配置.描述 || '';
      this.行动点消耗 = 配置.行动点消耗 ?? 1;
      this.需要行动者类型 = 配置.需要行动者类型 || 任务基类.行动者类型.无;
      this.需要目标类型 = 配置.需要目标类型 || 任务基类.目标类型.无;
      this.冷却回合 = 配置.冷却回合 ?? 0;
      this.标签 = new Set(配置.标签 || []);
    }
  
    // ─── 验证方法 ───
  
    验证行动者(行动者) {
      if (this.需要行动者类型 === 任务基类.行动者类型.无) {
        return { 有效: true };
      }
  
      if (!行动者) {
        return { 有效: false, 原因: '需要指定行动者' };
      }
  
      const 类型映射 = {
        [任务基类.行动者类型.冠军]: '冠军',
        [任务基类.行动者类型.母畜]: '母畜',
        [任务基类.行动者类型.领主]: '领主'
      };
  
      const 期望类型 = 类型映射[this.需要行动者类型];
      if (行动者.实体类型 !== 期望类型) {
        return { 有效: false, 原因: `行动者类型不匹配，需要${期望类型}` };
      }
  
      return { 有效: true };
    }
  
    验证目标(目标) {
      if (this.需要目标类型 === 任务基类.目标类型.无) {
        return { 有效: true };
      }
  
      if (!目标) {
        return { 有效: false, 原因: '需要指定目标' };
      }
  
      const 类型映射 = {
        [任务基类.目标类型.母畜]: '母畜',
        [任务基类.目标类型.冠军]: '冠军',
        [任务基类.目标类型.地点]: '可袭击地点',
        [任务基类.目标类型.喽啰池]: '喽啰池'
      };
  
      const 期望类型 = 类型映射[this.需要目标类型];
      if (目标.实体类型 !== 期望类型) {
        return { 有效: false, 原因: `目标类型不匹配，需要${期望类型}` };
      }
  
      return { 有效: true };
    }
  
    验证前置条件(上下文) {
      return { 有效: true };
    }
  
    验证执行条件(上下文) {
      const { 行动者, 目标, 当前行动点 } = 上下文;
  
      if (当前行动点 < this.行动点消耗) {
        return {
          可执行: false,
          原因: `行动点不足，需要${this.行动点消耗}，当前${当前行动点}`
        };
      }
  
      const 行动者验证 = this.验证行动者(行动者);
      if (!行动者验证.有效) {
        return { 可执行: false, 原因: 行动者验证.原因 };
      }
  
      const 目标验证 = this.验证目标(目标);
      if (!目标验证.有效) {
        return { 可执行: false, 原因: 目标验证.原因 };
      }
  
      const 前置验证 = this.验证前置条件(上下文);
      if (!前置验证.有效) {
        return { 可执行: false, 原因: 前置验证.原因 };
      }
  
      return { 可执行: true };
    }
  
    // ─── 执行方法（子类实现） ───
  
    执行(上下文) {
      throw new Error('子类必须实现执行方法');
    }
  
    // ─── 效果预览（子类可选实现） ───
  
    预览效果(上下文) {
      return { 描述: this.描述 };
    }
  
    // ─── 辅助方法 ───
  
    创建成功结果(效果, 描述, 额外数据 = {}) {
      return {
        成功: true,
        行动点消耗: this.行动点消耗,
        效果,
        描述,
        ...额外数据
      };
    }
  
    创建失败结果(原因) {
      return { 成功: false, 原因 };
    }
  }
  
  // ═══════════════════════════════════════════════════════════════
  // 任务注册表
  // ═══════════════════════════════════════════════════════════════
  
  class 任务注册表 {
    constructor() {
      this.任务库 = new Map();
      this.行动者索引 = new Map();
      this.目标索引 = new Map();
      this.标签索引 = new Map();
    }
  
    注册任务(任务实例) {
      const ID = 任务实例.任务ID;
      this.任务库.set(ID, 任务实例);
  
      // 按行动者类型索引
      const 行动者类型 = 任务实例.需要行动者类型;
      if (!this.行动者索引.has(行动者类型)) {
        this.行动者索引.set(行动者类型, new Set());
      }
      this.行动者索引.get(行动者类型).add(ID);
  
      // 按目标类型索引
      const 目标类型 = 任务实例.需要目标类型;
      if (!this.目标索引.has(目标类型)) {
        this.目标索引.set(目标类型, new Set());
      }
      this.目标索引.get(目标类型).add(ID);
  
      // 按标签索引
      任务实例.标签.forEach(标签 => {
        if (!this.标签索引.has(标签)) {
          this.标签索引.set(标签, new Set());
        }
        this.标签索引.get(标签).add(ID);
      });
  
      return this;
    }
  
    批量注册(任务列表) {
      任务列表.forEach(任务 => this.注册任务(任务));
      return this;
    }
  
    获取任务(任务ID) {
      return this.任务库.get(任务ID);
    }
  
    获取所有任务() {
      return Array.from(this.任务库.values());
    }
  
    按行动者查询(行动者类型) {
      const ID集合 = this.行动者索引.get(行动者类型) || new Set();
      return Array.from(ID集合).map(id => this.任务库.get(id));
    }
  
    按目标查询(目标类型) {
      const ID集合 = this.目标索引.get(目标类型) || new Set();
      return Array.from(ID集合).map(id => this.任务库.get(id));
    }
  
    按标签查询(标签) {
      const ID集合 = this.标签索引.get(标签) || new Set();
      return Array.from(ID集合).map(id => this.任务库.get(id));
    }
  
    复合查询(条件 = {}) {
      let 结果集 = new Set(this.任务库.keys());
  
      if (条件.行动者类型) {
        const 匹配 = this.行动者索引.get(条件.行动者类型) || new Set();
        结果集 = new Set([...结果集].filter(id => 匹配.has(id)));
      }
  
      if (条件.目标类型) {
        const 匹配 = this.目标索引.get(条件.目标类型) || new Set();
        结果集 = new Set([...结果集].filter(id => 匹配.has(id)));
      }
  
      if (条件.标签) {
        const 匹配 = this.标签索引.get(条件.标签) || new Set();
        结果集 = new Set([...结果集].filter(id => 匹配.has(id)));
      }
  
      return Array.from(结果集).map(id => this.任务库.get(id));
    }
  }
  
  // ═══════════════════════════════════════════════════════════════
  // 任务执行器
  // ═══════════════════════════════════════════════════════════════
  
  class 任务执行器 {
    constructor(配置 = {}) {
      this.注册表 = 配置.注册表 || new 任务注册表();
      this.工厂管理器 = 配置.工厂管理器 || null;
      this.行动点管理器 = 配置.行动点管理器 || null;
      this.执行历史 = [];
      this.事件回调 = new Map();
    }
  
    // ─── 依赖注入 ───
  
    设置工厂管理器(管理器) {
      this.工厂管理器 = 管理器;
      return this;
    }
  
    设置行动点管理器(管理器) {
      this.行动点管理器 = 管理器;
      return this;
    }
  
    设置注册表(注册表) {
      this.注册表 = 注册表;
      return this;
    }
  
    // ─── 事件系统 ───
  
    监听(事件名, 回调) {
      if (!this.事件回调.has(事件名)) {
        this.事件回调.set(事件名, []);
      }
      this.事件回调.get(事件名).push(回调);
      return this;
    }
  
    触发事件(事件名, 数据) {
      const 回调列表 = this.事件回调.get(事件名) || [];
      回调列表.forEach(回调 => {
        try {
          回调(数据);
        } catch (e) {
          console.error(`任务事件处理错误 [${事件名}]:`, e);
        }
      });
    }
  
    // ─── 核心执行 ───
  
    执行任务(任务ID, 参数 = {}) {
      const 任务 = this.注册表.获取任务(任务ID);
      if (!任务) {
        return { 成功: false, 原因: `未知任务: ${任务ID}` };
      }
  
      const 当前行动点 = this.行动点管理器?.获取当前行动点() ?? Infinity;
  
      const 上下文 = {
        ...参数,
        当前行动点,
        工厂管理器: this.工厂管理器
      };
  
      // 验证
      const 验证结果 = 任务.验证执行条件(上下文);
      if (!验证结果.可执行) {
        this.触发事件('任务验证失败', { 任务ID, 原因: 验证结果.原因 });
        return { 成功: false, 原因: 验证结果.原因 };
      }
  
      // 执行
      this.触发事件('任务执行前', { 任务ID, 上下文 });
      const 执行结果 = 任务.执行(上下文);
  
      // 扣除行动点
      if (执行结果.成功 && 执行结果.行动点消耗 > 0) {
        this.行动点管理器?.消耗行动点(执行结果.行动点消耗);
      }
  
      // 记录历史
      const 历史记录 = {
        任务ID,
        回合: 参数.当前回合,
        结果: 执行结果,
        时间戳: Date.now()
      };
      this.执行历史.push(历史记录);
  
      this.触发事件('任务执行后', { 任务ID, 结果: 执行结果, 历史: 历史记录 });
  
      return 执行结果;
    }
  
    // ─── 查询方法 ───
  
    获取可用任务(条件 = {}) {
      if (Object.keys(条件).length === 0) {
        return this.注册表.获取所有任务();
      }
      return this.注册表.复合查询(条件);
    }
  
    预览任务(任务ID, 参数 = {}) {
      const 任务 = this.注册表.获取任务(任务ID);
      if (!任务) return null;
  
      const 上下文 = {
        ...参数,
        工厂管理器: this.工厂管理器
      };
  
      return {
        任务信息: {
          ID: 任务.任务ID,
          名称: 任务.任务名称,
          描述: 任务.描述,
          行动点消耗: 任务.行动点消耗,
          行动者类型: 任务.需要行动者类型,
          目标类型: 任务.需要目标类型
        },
        ...任务.预览效果(上下文)
      };
    }
  
    获取执行历史(过滤条件 = {}) {
      let 结果 = this.执行历史;
  
      if (过滤条件.回合 !== undefined) {
        结果 = 结果.filter(记录 => 记录.回合 === 过滤条件.回合);
      }
  
      if (过滤条件.任务ID) {
        结果 = 结果.filter(记录 => 记录.任务ID === 过滤条件.任务ID);
      }
  
      if (过滤条件.成功 !== undefined) {
        结果 = 结果.filter(记录 => 记录.结果.成功 === 过滤条件.成功);
      }
  
      return 结果;
    }
  
    清空历史() {
      this.执行历史 = [];
    }
  }
  
  // ═══════════════════════════════════════════════════════════════
  // 行动点管理器
  // ═══════════════════════════════════════════════════════════════
  
  class 行动点管理器 {
    constructor(配置 = {}) {
      this.当前行动点 = 配置.初始行动点 ?? 3;
      this.每回合行动点 = 配置.每回合行动点 ?? 3;
      this.最大行动点 = 配置.最大行动点 ?? 10;
    }
  
    获取当前行动点() {
      return this.当前行动点;
    }
  
    获取最大行动点() {
      return this.最大行动点;
    }
  
    消耗行动点(数量) {
      if (this.当前行动点 < 数量) {
        return { 成功: false, 原因: '行动点不足', 当前: this.当前行动点, 需要: 数量 };
      }
      this.当前行动点 -= 数量;
      return { 成功: true, 剩余: this.当前行动点 };
    }
  
    增加行动点(数量) {
      const 原值 = this.当前行动点;
      this.当前行动点 = Math.min(this.当前行动点 + 数量, this.最大行动点);
      return { 增加: this.当前行动点 - 原值, 当前: this.当前行动点 };
    }
  
    回合结束重置() {
      const 原值 = this.当前行动点;
      this.当前行动点 = Math.min(
        this.当前行动点 + this.每回合行动点,
        this.最大行动点
      );
      return { 恢复: this.当前行动点 - 原值, 当前: this.当前行动点 };
    }
  
    设置行动点(数量) {
      this.当前行动点 = Math.max(0, Math.min(数量, this.最大行动点));
      return this.当前行动点;
    }
  }
  
  // ═══════════════════════════════════════════════════════════════
  // 导出
  // ═══════════════════════════════════════════════════════════════
  
  export {
    任务基类,
    任务注册表,
    任务执行器,
    行动点管理器
  };
  