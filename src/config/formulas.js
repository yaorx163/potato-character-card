// ═══════════════════════════════════════════════════════════════
// config/formulas.js
// 公式配置 - 定义所有游戏计算公式
// ═══════════════════════════════════════════════════════════════

/**
 * 初始化默认公式配置
 * @param 公式引擎 - 公式引擎实例
 */
function 初始化公式配置(公式引擎) {
  // ═══════════════════════════════════════════════════════════════
  // 常量设置
  // ═══════════════════════════════════════════════════════════════

  公式引擎.批量设置常量({
    // ─── 基础常量 ───
    基础臣服度增加: 5,
    基础淫乱度增加: 5,
    调教基础效率: 5,

    // ─── 繁殖系统常量 ───
    冠军生育消耗: 100,
    喽啰生育消耗: 100,
    喽啰生育基础产出: 10,
    每点价值产出喽啰: 0.1, // 每10点产1喽啰
    生育淫乱度增加: 8,
    冠军属性随机浮动范围: 5,

    // ─── 战斗系统常量 ───
    基础存活率: 0.8,
    士气基础值: 50,
    士气每周衰减: 5,
    冠军力量战力系数: 20, // 力量/20 转化为战力
    士气系数基数: 1.1,
    士气系数偏移: 20,
    士气系数除数: 10,
    士气系数幂偏移: 10,

    // ─── 战斗结果阈值 ───
    战力比_溃败上限: 0.5,
    战力比_惨败上限: 0.8,
    战力比_惜败上限: 1.0,
    战力比_险胜上限: 1.2,
    战力比_小胜上限: 1.5,
    战力比_大胜上限: 2.0,

    // ─── 战斗存活率 ───
    存活率_溃败: 0.2,
    存活率_惨败: 0.4,
    存活率_惜败: 0.6,
    存活率_险胜: 0.7,
    存活率_小胜: 0.85,
    存活率_大胜: 0.95,
    存活率_碾压: 1.0,

    // ─── 战斗士气变化 ───
    士气变化_溃败: -50,
    士气变化_惨败: -30,
    士气变化_惜败: -10,
    士气变化_险胜: 5,
    士气变化_小胜: 10,
    士气变化_大胜: 15,
    士气变化_碾压: 20,

    // ─── 战斗俘获保底 ───
    俘获保底_险胜: 1,
    俘获保底_小胜: 2,
    俘获保底_大胜: 3,

    // ─── 冠军损失概率 ───
    冠军负伤概率_惜败: 0.15,
    冠军负伤概率_惨败: 0.3,
    冠军负伤概率_溃败: 0.5,
    冠军负伤系数: 0.5, // (1 - 存活率) * 此系数
    冠军阵亡概率_严重溃败: 0.05,
    冠军阵亡概率_完全溃败: 0.1,
    冠军阵亡战力比阈值: 0.3,

    // ─── 情报系统常量 ───
    情报满值: 100,
    情报衰减值: 5,
    情报最低保留: 10,
    情报阶段_详尽阈值: 80,
    情报阶段_充分阈值: 50,
    情报阶段_初步阈值: 25,

    // ─── 情报战力估值系数 ───
    战力估值_下限起始: 0.2,
    战力估值_下限终点: 1.0,
    战力估值_上限起始: 5.0,
    战力估值_上限终点: 1.0,

    // ─── 侦察常量 ───
    潜入侦察基础情报: 20,
    直接侦察基础情报: 15,
    遭遇战概率: 0.1,
    潜入暴露基数: 200, // 暴露概率 = 淫乱度 / 此值
    潜入淫乱度增加: 2,
    潜入劝诱暴露概率: 0.3,
    潜入劝诱成功率除数: 2.5,

    // ─── 锁定目标常量 ───
    锁定系数_情报偏移: 25,
    锁定系数_除数: 100,

    // ─── 泌乳常量 ───
    泌乳阈值: 25,
    泌乳淫乱度增加: 3,
    泌乳产量偏移: 45,
    泌乳产量除数: 20,

    // ─── 调教任务常量 ───
    调教智力系数: 25,
    调教基础增加: 5,
    惩戒基础臣服度: 8,
    惩戒力量系数_臣服度: 10,
    惩戒基础淫乱度: 12,
    惩戒力量系数_淫乱度: 15,

    // ─── 劝慰任务常量 ───
    劝慰基础臣服度: 10,
    劝慰同种族加成: 1.5,
    劝慰同身份加成: 1.3,

    // ─── 提振士气常量 ───
    提振士气基础值: 15,
    提振士气淫乱度系数: 50,
    提振士气价值系数: 200,
    提振士气淫乱度增加: 5,

    // ─── 训练常量 ───
    训练基础战力: 2,
    训练力量系数: 20,

    // ─── 任务臣服度阈值 ───
    臣服度_归心阈值: 75,
    臣服度_忠诚阈值: 90,
    臣服度_动摇阈值: 25,
    臣服度_顺从阈值: 50,

    // ─── 时间系统常量 ───
    周行动点上限: 3,
    历史记录上限: 100,

    // ─── 法术系统常量 ───
    献祭魔力系数: 100, // 总雌性价值 / 此值 = 魔力获得
    献祭淫乱度阈值: 100,
    强制献祭淫乱度阈值: 80,

    // ─── 法术效果常量 ───
    催化调教倍率: 2,
    战嚎祝福战力加成: 0.3,
    铁壁守护存活率加成: 0.2,
    急行军令行动点: 1,
    魔眼侦察情报增量: 30,
    真视之眼情报增量: 100,
    心灵探知锁定数量: 1,
    意志粉碎臣服度: 50,
    淫堕催化淫乱度: 50,
    双重催化臣服度: 30,
    双重催化淫乱度: 30,
    净化之光淫乱度减少: 30,
    孕力回复雌性价值: 100,
    士气鼓舞增加量: 20,
    狂战祝福战力倍率: 2,
    丰饶祝福产量倍率: 2,
    繁殖祝福产出倍率: 2,
    命运改写价值提升比例: 0.5,

    // ─── 商品效果常量 ───
    祝福水晶基数: 2000,
    祝福水晶淫乱度偏移: 20,

    // ─── 休整常量 ───
    休整淫乱度降低: 5,

    // ─── 属性阶段阈值 ───
    淫乱度_完全淫堕: 100,
    淫乱度_淫堕期: 75,
    淫乱度_渴求期: 50,
    淫乱度_泌乳期: 25,

    // ─── 士气阶段阈值 ───
    士气_狂热阈值: 80,
    士气_高涨阈值: 60,
    士气_正常阈值: 40,
    士气_低迷阈值: 20,

    // ─── 士气战力系数 ───
    士气系数_狂热: 1.5,
    士气系数_高涨: 1.25,
    士气系数_正常: 1.0,
    士气系数_低迷: 0.75,
    士气系数_崩溃: 0.5,

    // ─── 经验与等级常量 ───
    升级经验系数: 100, // 升级所需 = 当前等级 * 此值

    // ─── 冠军属性等级配置 ───
    属性等级_弱小_基础: 5,
    属性等级_弱小_浮动: 3,
    属性等级_普通_基础: 10,
    属性等级_普通_浮动: 5,
    属性等级_精英_基础: 20,
    属性等级_精英_浮动: 5,
    属性等级_传奇_基础: 35,
    属性等级_传奇_浮动: 10,

    // ─── 默认属性范围 ───
    默认属性_最小: 5,
    默认属性_最大: 20,

    // ─── 喽啰维护常量 ───
    喽啰维护除数: 50, // 每50喽啰消耗1单位资源
  });

  // ═══════════════════════════════════════════════════════════════
  // 战斗相关公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 士气系数 ───
  公式引擎.注册公式(
    '士气系数',
    ({ 士气 }, 常量) => {
      const 基数 = 常量.士气系数基数 ?? 1.1;
      const 偏移 = 常量.士气系数偏移 ?? 20;
      const 除数 = 常量.士气系数除数 ?? 10;
      const 幂偏移 = 常量.士气系数幂偏移 ?? 10;
      return Math.pow(基数, (士气 + 偏移) / 除数 - 幂偏移);
    },
    {
      描述: '根据士气计算战斗力系数',
      参数说明: { 士气: '当前士气值 (0-100)' },
      分类: '战斗',
      公式文本: '1.1^((士气+20)/10-10)',
    },
  );

  // ─── 部曲战力 ───
  公式引擎.注册公式(
    '部曲战力',
    ({ 有效喽啰数, 冠军力量, 武装战斗力, 士气 }, 常量) => {
      const 士气系数 = 公式引擎.计算('士气系数', { 士气 });
      const 力量系数 = 常量.冠军力量战力系数 ?? 20;
      const 基础战力 = (有效喽啰数 + Math.floor(冠军力量 / 力量系数)) * (武装战斗力 / 100);
      return 基础战力 * 士气系数;
    },
    {
      描述: '计算单个部曲的战斗力',
      参数说明: {
        有效喽啰数: '分配给该冠军的有效喽啰数量（不超过统帅上限）',
        冠军力量: '冠军的力量属性',
        武装战斗力: '喽啰的武装战斗力百分比',
        士气: '当前士气值',
      },
      分类: '战斗',
      公式文本: '(有效喽啰数 + 力量/20) × 武装战斗力% × 士气系数',
    },
  );

  // ─── 战力估值偏差 ───
  公式引擎.注册公式(
    '战力估值偏差',
    ({ 情报进度 }, 常量) => {
      const n = 情报进度;
      const 下限起始 = 常量.战力估值_下限起始 ?? 0.2;
      const 下限终点 = 常量.战力估值_下限终点 ?? 1.0;
      const 上限起始 = 常量.战力估值_上限起始 ?? 5.0;
      const 上限终点 = 常量.战力估值_上限终点 ?? 1.0;

      return {
        下限系数: 下限起始 + ((下限终点 - 下限起始) * n) / 100,
        上限系数: 上限起始 - ((上限起始 - 上限终点) * n) / 100,
      };
    },
    {
      描述: '根据情报进度计算敌方战力估值的误差范围',
      参数说明: { 情报进度: '对目标的情报进度 (0-100)' },
      分类: '战斗',
      公式文本: '下限=0.2+0.8n/100, 上限=5-4n/100',
    },
  );

  // ─── 战斗损失率 ───
  公式引擎.注册公式(
    '战斗损失率',
    ({ 战力比 }, 常量) => {
      const 溃败 = 常量.战力比_溃败上限 ?? 0.5;
      const 惨败 = 常量.战力比_惨败上限 ?? 0.8;
      const 惜败 = 常量.战力比_惜败上限 ?? 1.0;
      const 险胜 = 常量.战力比_险胜上限 ?? 1.2;
      const 小胜 = 常量.战力比_小胜上限 ?? 1.5;
      const 大胜 = 常量.战力比_大胜上限 ?? 2.0;

      if (战力比 >= 大胜) return 0;
      if (战力比 >= 小胜) return 1 - (常量.存活率_大胜 ?? 0.95);
      if (战力比 >= 险胜) return 1 - (常量.存活率_小胜 ?? 0.85);
      if (战力比 >= 惜败) return 1 - (常量.存活率_险胜 ?? 0.7);
      if (战力比 >= 惨败) return 1 - (常量.存活率_惜败 ?? 0.6);
      if (战力比 >= 溃败) return 1 - (常量.存活率_惨败 ?? 0.4);
      return 1 - (常量.存活率_溃败 ?? 0.2);
    },
    {
      描述: '根据战力比计算己方损失率',
      参数说明: { 战力比: '我方战力/敌方战力' },
      分类: '战斗',
    },
  );

  // ─── 战斗士气变化 ───
  公式引擎.注册公式(
    '战斗士气变化',
    ({ 战力比 }, 常量) => {
      const 大胜 = 常量.战力比_大胜上限 ?? 2.0;
      const 小胜 = 常量.战力比_小胜上限 ?? 1.5;
      const 险胜 = 常量.战力比_险胜上限 ?? 1.2;
      const 惜败 = 常量.战力比_惜败上限 ?? 1.0;
      const 惨败 = 常量.战力比_惨败上限 ?? 0.8;
      const 溃败 = 常量.战力比_溃败上限 ?? 0.5;

      if (战力比 >= 大胜) return 常量.士气变化_碾压 ?? 20;
      if (战力比 >= 小胜) return 常量.士气变化_大胜 ?? 15;
      if (战力比 >= 险胜) return 常量.士气变化_小胜 ?? 10;
      if (战力比 >= 惜败) return 常量.士气变化_险胜 ?? 5;
      if (战力比 >= 惨败) return 常量.士气变化_惜败 ?? -10;
      if (战力比 >= 溃败) return 常量.士气变化_惨败 ?? -30;
      return 常量.士气变化_溃败 ?? -50;
    },
    {
      描述: '根据战斗结果计算士气变化',
      参数说明: {
        战力比: '我方战力/敌方战力',
      },
      分类: '战斗',
    },
  );

  // ─── 冠军负伤概率 ───
  公式引擎.注册公式(
    '冠军负伤概率',
    ({ 战力比, 已负伤 }, 常量) => {
      if (已负伤) return 0;

      const 小胜 = 常量.战力比_小胜上限 ?? 1.5;
      const 惜败 = 常量.战力比_惜败上限 ?? 1.0;
      const 惨败 = 常量.战力比_惨败上限 ?? 0.8;
      const 溃败 = 常量.战力比_溃败上限 ?? 0.5;

      if (战力比 >= 小胜) return 0;
      if (战力比 >= 惜败) return 0.05;
      if (战力比 >= 惨败) return 常量.冠军负伤概率_惜败 ?? 0.15;
      if (战力比 >= 溃败) return 常量.冠军负伤概率_惨败 ?? 0.3;
      return 常量.冠军负伤概率_溃败 ?? 0.5;
    },
    {
      描述: '计算冠军在战斗中负伤的概率',
      参数说明: {
        战力比: '我方战力/敌方战力',
        已负伤: '冠军是否已经处于负伤状态',
      },
      分类: '战斗',
    },
  );

  // ─── 冠军阵亡概率 ───
  公式引擎.注册公式(
    '冠军阵亡概率',
    ({ 战力比, 已负伤 }, 常量) => {
      const 溃败 = 常量.战力比_溃败上限 ?? 0.5;
      const 阵亡阈值 = 常量.冠军阵亡战力比阈值 ?? 0.3;

      let 基础概率 = 0;

      if (战力比 >= 溃败) {
        基础概率 = 0;
      } else if (战力比 >= 阵亡阈值) {
        基础概率 = 常量.冠军阵亡概率_严重溃败 ?? 0.05;
      } else {
        基础概率 = 常量.冠军阵亡概率_完全溃败 ?? 0.1;
      }

      return 已负伤 ? 基础概率 * 2 : 基础概率;
    },
    {
      描述: '计算冠军在战斗中阵亡的概率',
      参数说明: {
        战力比: '我方战力/敌方战力',
        已负伤: '冠军是否处于负伤状态',
      },
      分类: '战斗',
    },
  );

  // ═══════════════════════════════════════════════════════════════
  // 任务效率公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 调教效率 ───
  公式引擎.注册公式(
    '调教效率',
    ({ 智力 }, 常量) => {
      const 系数 = 常量.调教智力系数 ?? 25;
      const 基础 = 常量.调教基础增加 ?? 5;
      return 基础 * (智力 / 系数) + 基础;
    },
    {
      描述: '计算调教任务的臣服度增加量',
      参数说明: { 智力: '冠军的智力属性' },
      分类: '任务',
      公式文本: '5 × (智力/25) + 5',
    },
  );

  // ─── 惩戒效率 ───
  公式引擎.注册公式(
    '惩戒效率',
    ({ 力量 }, 常量) => {
      const 基础臣服度 = 常量.惩戒基础臣服度 ?? 8;
      const 臣服度系数 = 常量.惩戒力量系数_臣服度 ?? 10;
      const 基础淫乱度 = 常量.惩戒基础淫乱度 ?? 12;
      const 淫乱度系数 = 常量.惩戒力量系数_淫乱度 ?? 15;

      return {
        臣服度增加: 基础臣服度 + Math.floor(力量 / 臣服度系数),
        淫乱度增加: 基础淫乱度 + Math.floor(力量 / 淫乱度系数),
      };
    },
    {
      描述: '计算惩戒任务的臣服度和淫乱度增加量',
      参数说明: { 力量: '冠军的力量属性' },
      分类: '任务',
      公式文本: '臣服度=8+力量/10, 淫乱度=12+力量/15',
    },
  );

  // ─── 劝慰效率 ───
  公式引擎.注册公式(
    '劝慰效率',
    ({ 同种族, 同身份 }, 常量) => {
      let 基础值 = 常量.劝慰基础臣服度 ?? 10;
      const 种族加成 = 常量.劝慰同种族加成 ?? 1.5;
      const 身份加成 = 常量.劝慰同身份加成 ?? 1.3;

      if (同种族) {
        基础值 *= 种族加成;
      }
      if (同身份) {
        基础值 *= 身份加成;
      }

      return Math.floor(基础值);
    },
    {
      描述: '计算劝慰任务的臣服度增加量',
      参数说明: {
        同种族: '负责人与目标是否同种族',
        同身份: '负责人与目标是否同身份',
      },
      分类: '任务',
      公式文本: '基础10 × 同种族1.5 × 同身份1.3',
    },
  );

  // ─── 潜入侦察效率 ───
  公式引擎.注册公式(
    '潜入侦察效率',
    ({ 臣服度, 淫乱度 }, 常量) => {
      const 臣服度系数 = 常量.臣服度_顺从阈值 ?? 50;
      const 暴露基数 = 常量.潜入暴露基数 ?? 200;
      return 1 * (臣服度 / 臣服度系数) * (1 - 淫乱度 / 暴露基数);
    },
    {
      描述: '计算潜入侦察的效率系数',
      参数说明: {
        臣服度: '母畜的臣服度',
        淫乱度: '母畜的淫乱度',
      },
      分类: '任务',
      公式文本: '1 × (臣服度/50) × (1 - 淫乱度/200)',
    },
  );

  // ─── 潜入暴露概率 ───
  公式引擎.注册公式(
    '潜入暴露概率',
    ({ 淫乱度 }, 常量) => {
      const 基数 = 常量.潜入暴露基数 ?? 200;
      return 淫乱度 / 基数;
    },
    {
      描述: '计算潜入任务的身份暴露概率',
      参数说明: { 淫乱度: '母畜的淫乱度' },
      分类: '任务',
      公式文本: '淫乱度/200',
    },
  );

  // ─── 直接侦察效率 ───
  公式引擎.注册公式(
    '直接侦察效率',
    ({ 敏捷 }, 常量) => {
      const 系数 = 常量.调教智力系数 ?? 25;
      return 1 * (敏捷 / 系数);
    },
    {
      描述: '计算直接侦察的效率系数',
      参数说明: { 敏捷: '冠军的敏捷属性' },
      分类: '任务',
      公式文本: '1 × (敏捷/25)',
    },
  );

  // ─── 提振士气效率 ───
  公式引擎.注册公式(
    '提振士气效率',
    ({ 淫乱度, 总雌性价值 }, 常量) => {
      const 基础值 = 常量.提振士气基础值 ?? 15;
      const 淫乱度系数 = 常量.提振士气淫乱度系数 ?? 50;
      const 价值系数 = 常量.提振士气价值系数 ?? 200;
      return 基础值 * (淫乱度 / 淫乱度系数) * (总雌性价值 / 价值系数);
    },
    {
      描述: '计算提振士气任务的士气增加量',
      参数说明: {
        淫乱度: '母畜的淫乱度',
        总雌性价值: '母畜的总雌性价值',
      },
      分类: '任务',
      公式文本: '15 × (淫乱度/50) × (总雌性价值/200)',
    },
  );

  // ─── 潜入劝诱成功率 ───
  公式引擎.注册公式(
    '潜入劝诱成功率',
    ({ 负责人价值, 目标价值 }, 常量) => {
      const 除数 = 常量.潜入劝诱成功率除数 ?? 2.5;
      return Math.min(1, 负责人价值 / 目标价值 / 除数);
    },
    {
      描述: '计算潜入劝诱的成功概率',
      参数说明: {
        负责人价值: '执行任务母畜的总雌性价值',
        目标价值: '目标的雌性价值',
      },
      分类: '任务',
      公式文本: 'min(1, 负责人价值/目标价值/2.5)',
    },
  );

  // ─── 训练效率 ───
  公式引擎.注册公式(
    '训练效率',
    ({ 力量 }, 常量) => {
      const 基础 = 常量.训练基础战力 ?? 2;
      const 系数 = 常量.训练力量系数 ?? 20;
      return 基础 + Math.floor(力量 / 系数);
    },
    {
      描述: '计算训练喽啰任务的战力提升',
      参数说明: { 力量: '冠军的力量属性' },
      分类: '任务',
      公式文本: '2 + 力量/20',
    },
  );

  // ═══════════════════════════════════════════════════════════════
  // 资源产出公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 泌乳产量 ───
  公式引擎.注册公式(
    '泌乳产量',
    ({ 淫乱度 }, 常量) => {
      const 阈值 = 常量.泌乳阈值 ?? 25;
      const 偏移 = 常量.泌乳产量偏移 ?? 45;
      const 除数 = 常量.泌乳产量除数 ?? 20;

      if (淫乱度 < 阈值) return 0;
      return Math.floor((淫乱度 + 偏移) / 除数);
    },
    {
      描述: '计算母畜的每周母乳产量',
      参数说明: { 淫乱度: '母畜的淫乱度 (需≥25才能泌乳)' },
      分类: '资源',
      公式文本: 'floor((淫乱度+45)/20), 淫乱度<25时为0',
    },
  );

  // ─── 总泌乳产量 ───
  公式引擎.注册公式(
    '总泌乳产量',
    ({ 母畜列表 }) => {
      let 总产量 = 0;
      for (const 母畜 of 母畜列表) {
        const 淫乱度 = 母畜.获取属性?.('淫乱度') ?? 母畜.淫乱度 ?? 0;
        总产量 += 公式引擎.计算('泌乳产量', { 淫乱度 });
      }
      return 总产量;
    },
    {
      描述: '计算所有母畜的总泌乳产量',
      参数说明: { 母畜列表: '母畜实体数组' },
      分类: '资源',
    },
  );

  // ─── 祝福水晶效果 ───
  公式引擎.注册公式(
    '祝福水晶效果',
    ({ 淫乱度 }, 常量) => {
      const 基数 = 常量.祝福水晶基数 ?? 2000;
      const 偏移 = 常量.祝福水晶淫乱度偏移 ?? 20;
      return Math.floor(基数 / (淫乱度 + 偏移));
    },
    {
      描述: '计算祝福水晶恢复的雌性价值',
      参数说明: { 淫乱度: '目标母畜的淫乱度' },
      分类: '资源',
      公式文本: 'floor(2000/(淫乱度+20))',
    },
  );

  // ─── 献祭魔力获得 ───
  公式引擎.注册公式(
    '献祭魔力获得',
    ({ 总雌性价值, 淫乱度 }, 常量) => {
      const 系数 = 常量.献祭魔力系数 ?? 100;
      const 完全淫堕 = 常量.淫乱度_完全淫堕 ?? 100;
      const 效率 = 淫乱度 >= 完全淫堕 ? 1.0 : 淫乱度 / 完全淫堕;
      return Math.floor((总雌性价值 / 系数) * 效率);
    },
    {
      描述: '计算献祭母畜获得的魔力',
      参数说明: {
        总雌性价值: '母畜的总雌性价值',
        淫乱度: '母畜的淫乱度',
      },
      分类: '资源',
      公式文本: 'floor(总雌性价值/100 × 效率), 完全淫堕效率=1',
    },
  );

  // ─── 喽啰维护消耗 ───
  公式引擎.注册公式(
    '喽啰维护消耗',
    ({ 喽啰总数 }, 常量) => {
      const 除数 = 常量.喽啰维护除数 ?? 50;
      return Math.floor(喽啰总数 / 除数);
    },
    {
      描述: '计算喽啰的每周维护消耗',
      参数说明: { 喽啰总数: '喽啰总数量' },
      分类: '资源',
      公式文本: 'floor(喽啰总数/50)',
    },
  );

  // ═══════════════════════════════════════════════════════════════
  // 繁殖相关公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 冠军属性生成 ───
  公式引擎.注册公式(
    '冠军属性生成',
    ({ 总雌性价值, 效率系数, 随机浮动 }) => {
      const 基础值 = 总雌性价值 / 10;
      return Math.max(1, Math.round((基础值 + 随机浮动) * 效率系数));
    },
    {
      描述: '计算生育冠军的单项属性值',
      参数说明: {
        总雌性价值: '母畜的总雌性价值',
        效率系数: '身份对应的属性效率系数',
        随机浮动: '随机浮动值 (通常±5)',
      },
      分类: '繁殖',
      公式文本: 'max(1, round((总雌性价值/10 + 随机浮动) × 效率系数))',
    },
  );

  // ─── 冠军属性预估范围 ───
  公式引擎.注册公式(
    '冠军属性预估范围',
    ({ 总雌性价值, 效率系数, 随机浮动范围 }, 常量) => {
      const 基础值 = 总雌性价值 / 10;
      const 范围 = 随机浮动范围 ?? 常量.冠军属性随机浮动范围 ?? 5;

      return {
        最小: Math.max(1, Math.round((基础值 - 范围) * 效率系数)),
        最大: Math.round((基础值 + 范围) * 效率系数),
        期望: Math.round(基础值 * 效率系数),
      };
    },
    {
      描述: '预估生育冠军的属性范围',
      参数说明: {
        总雌性价值: '母畜的总雌性价值',
        效率系数: '身份对应的属性效率系数',
        随机浮动范围: '随机浮动范围（默认5）',
      },
      分类: '繁殖',
    },
  );

  // ─── 喽啰产出计算 ───
  公式引擎.注册公式(
    '喽啰产出计算',
    ({ 剩余雌性价值, 标准消耗, 标准产出 }, 常量) => {
      const 消耗 = 标准消耗 ?? 常量.喽啰生育消耗 ?? 100;
      const 产出 = 标准产出 ?? 常量.喽啰生育基础产出 ?? 10;
      const 每点产出 = 常量.每点价值产出喽啰 ?? 0.1;

      if (剩余雌性价值 >= 消耗) {
        return {
          实际消耗: 消耗,
          实际产出: 产出,
        };
      } else {
        return {
          实际消耗: 剩余雌性价值,
          实际产出: Math.floor(剩余雌性价值 * 每点产出),
        };
      }
    },
    {
      描述: '计算生育喽啰的实际消耗和产出',
      参数说明: {
        剩余雌性价值: '母畜的剩余雌性价值',
        标准消耗: '标准消耗量（默认100）',
        标准产出: '标准产出量（默认10）',
      },
      分类: '繁殖',
    },
  );

  // ─── 生育行动点计算 ───
  公式引擎.注册公式(
    '生育行动点计算',
    ({ 臣服度, 任务类型 }, 常量) => {
      const 动摇阈值 = 常量.臣服度_动摇阈值 ?? 25;
      if (任务类型 === '冠军') {
        return 臣服度 >= 动摇阈值 ? 1 : 2;
      } else if (任务类型 === '喽啰') {
        return 臣服度 >= 动摇阈值 ? 0 : 1;
      }
      return 1;
    },
    {
      描述: '根据臣服度计算生育任务的行动点消耗',
      参数说明: {
        臣服度: '母畜的臣服度',
        任务类型: '生育任务类型（冠军/喽啰）',
      },
      分类: '繁殖',
    },
  );

  // ═══════════════════════════════════════════════════════════════
  // 情报相关公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 锁定目标值 ───
  公式引擎.注册公式(
    '锁定目标值',
    ({ 负责人系数, 情报进度 }, 常量) => {
      const 偏移 = 常量.锁定系数_情报偏移 ?? 25;
      const 除数 = 常量.锁定系数_除数 ?? 100;
      return (负责人系数 * (情报进度 + 偏移)) / 除数;
    },
    {
      描述: '计算侦察任务锁定高价值目标的数值',
      参数说明: {
        负责人系数: '负责人的相关系数（如总雌性价值/100或敏捷/10）',
        情报进度: '对目标的情报进度',
      },
      分类: '情报',
      公式文本: '负责人系数 × (情报进度+25) / 100',
    },
  );

  // ─── 锁定目标解析 ───
  公式引擎.注册公式(
    '锁定目标解析',
    ({ 锁定值 }) => {
      return {
        必定锁定数: Math.floor(锁定值 / 100),
        额外锁定概率: (锁定值 % 100) / 100,
      };
    },
    {
      描述: '解析锁定值为必定锁定数和额外锁定概率',
      参数说明: { 锁定值: '由锁定目标值公式计算得出' },
      分类: '情报',
    },
  );

  // ─── 情报衰减 ───
  公式引擎.注册公式(
    '情报衰减',
    ({ 当前进度, 上次侦察周次, 当前周次, 衰减值, 最低保留 }, 常量) => {
      const 间隔周次 = 当前周次 - (上次侦察周次 ?? 0);

      if (间隔周次 <= 1) {
        return 当前进度;
      }

      const 实际衰减 = (衰减值 ?? 常量.情报衰减值 ?? 5) * (间隔周次 - 1);
      return Math.max(最低保留 ?? 常量.情报最低保留 ?? 10, 当前进度 - 实际衰减);
    },
    {
      描述: '计算情报的自然衰减',
      参数说明: {
        当前进度: '当前情报进度',
        上次侦察周次: '上次进行侦察的周次',
        当前周次: '当前周次',
        衰减值: '每周衰减值（默认5）',
        最低保留: '最低保留值（默认10）',
      },
      分类: '情报',
    },
  );

  // ─── 情报阶段判定 ───
  公式引擎.注册公式(
    '情报阶段判定',
    ({ 情报进度 }, 常量) => {
      const 详尽 = 常量.情报阶段_详尽阈值 ?? 80;
      const 充分 = 常量.情报阶段_充分阈值 ?? 50;
      const 初步 = 常量.情报阶段_初步阈值 ?? 25;

      if (情报进度 >= 详尽) {
        return { 名称: '详尽', 等级: 4, 描述: '情报非常准确，误差极小' };
      }
      if (情报进度 >= 充分) {
        return { 名称: '充分', 等级: 3, 描述: '情报较为可靠，有一定误差' };
      }
      if (情报进度 >= 初步) {
        return { 名称: '初步', 等级: 2, 描述: '有基本了解，误差较大' };
      }
      return { 名称: '模糊', 等级: 1, 描述: '几乎一无所知，估计极不准确' };
    },
    {
      描述: '根据情报进度判定情报阶段',
      参数说明: { 情报进度: '对目标的情报进度 (0-100)' },
      分类: '情报',
    },
  );

  // ═══════════════════════════════════════════════════════════════
  // 属性阶段公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 臣服度阶段判定 ───
  公式引擎.注册公式(
    '臣服度阶段判定',
    ({ 臣服度 }, 常量) => {
      const 忠诚 = 常量.臣服度_忠诚阈值 ?? 90;
      const 归心 = 常量.臣服度_归心阈值 ?? 75;
      const 顺从 = 常量.臣服度_顺从阈值 ?? 50;
      const 动摇 = 常量.臣服度_动摇阈值 ?? 25;

      if (臣服度 >= 忠诚) {
        return { 名称: '忠诚期', 等级: 5, 解锁: ['潜入侦察', '潜入劝诱'] };
      }
      if (臣服度 >= 归心) {
        return { 名称: '归心期', 等级: 4, 解锁: ['劝慰', '提振士气'] };
      }
      if (臣服度 >= 顺从) {
        return { 名称: '顺从期', 等级: 3, 解锁: ['生育冠军'] };
      }
      if (臣服度 >= 动摇) {
        return { 名称: '动摇期', 等级: 2, 解锁: ['生育喽啰'] };
      }
      return { 名称: '抗拒期', 等级: 1, 解锁: [] };
    },
    {
      描述: '根据臣服度判定阶段及解锁任务',
      参数说明: { 臣服度: '母畜的臣服度' },
      分类: '属性',
    },
  );

  // ─── 淫乱度阶段判定 ───
  公式引擎.注册公式(
    '淫乱度阶段判定',
    ({ 淫乱度 }, 常量) => {
      const 完全淫堕 = 常量.淫乱度_完全淫堕 ?? 100;
      const 淫堕期 = 常量.淫乱度_淫堕期 ?? 75;
      const 渴求期 = 常量.淫乱度_渴求期 ?? 50;
      const 泌乳期 = 常量.淫乱度_泌乳期 ?? 25;

      if (淫乱度 >= 完全淫堕) {
        return { 名称: '完全淫堕', 等级: 5, 解锁: ['献祭'] };
      }
      if (淫乱度 >= 淫堕期) {
        return { 名称: '淫堕期', 等级: 4, 解锁: ['极限泌乳'] };
      }
      if (淫乱度 >= 渴求期) {
        return { 名称: '渴求期', 等级: 3, 解锁: ['增强泌乳'] };
      }
      if (淫乱度 >= 泌乳期) {
        return { 名称: '泌乳期', 等级: 2, 解锁: ['泌乳'] };
      }
      return { 名称: '常态期', 等级: 1, 解锁: [] };
    },
    {
      描述: '根据淫乱度判定阶段及解锁能力',
      参数说明: { 淫乱度: '母畜的淫乱度' },
      分类: '属性',
    },
  );

  // ─── 士气阶段判定 ───
  公式引擎.注册公式(
    '士气阶段判定',
    ({ 士气 }, 常量) => {
      const 狂热 = 常量.士气_狂热阈值 ?? 80;
      const 高涨 = 常量.士气_高涨阈值 ?? 60;
      const 正常 = 常量.士气_正常阈值 ?? 40;
      const 低迷 = 常量.士气_低迷阈值 ?? 20;

      if (士气 >= 狂热) {
        return { 名称: '狂热', 等级: 5, 战力系数: 常量.士气系数_狂热 ?? 1.5 };
      }
      if (士气 >= 高涨) {
        return { 名称: '高涨', 等级: 4, 战力系数: 常量.士气系数_高涨 ?? 1.25 };
      }
      if (士气 >= 正常) {
        return { 名称: '正常', 等级: 3, 战力系数: 常量.士气系数_正常 ?? 1.0 };
      }
      if (士气 >= 低迷) {
        return { 名称: '低迷', 等级: 2, 战力系数: 常量.士气系数_低迷 ?? 0.75 };
      }
      return { 名称: '崩溃', 等级: 1, 战力系数: 常量.士气系数_崩溃 ?? 0.5 };
    },
    {
      描述: '根据士气判定阶段和战力系数',
      参数说明: { 士气: '军队士气值' },
      分类: '属性',
    },
  );

  // ═══════════════════════════════════════════════════════════════
  // 经济相关公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 武装成本计算 ───
  公式引擎.注册公式(
    '武装成本计算',
    ({ 武装等级, 数量 }) => {
      const 单位成本映射 = {
        低级武装: { 单价: 0.1, 战斗力: 110 },
        中级武装: { 单价: 0.25, 战斗力: 130 },
        高级武装: { 单价: 1, 战斗力: 180 },
        精英武装: { 单价: 10, 战斗力: 250 },
      };

      const 配置 = 单位成本映射[武装等级] ?? { 单价: 0.1, 战斗力: 110 };

      return {
        总成本: Math.ceil(配置.单价 * 数量),
        单位成本: 配置.单价,
        战斗力提升: 配置.战斗力,
      };
    },
    {
      描述: '计算武装喽啰的成本',
      参数说明: {
        武装等级: '目标武装等级',
        数量: '武装数量',
      },
      分类: '经济',
    },
  );

  // ─── 商品性价比 ───
  公式引擎.注册公式(
    '商品性价比',
    ({ 效果值, 价格 }) => {
      return 价格 > 0 ? 效果值 / 价格 : Infinity;
    },
    {
      描述: '计算商品的性价比',
      参数说明: {
        效果值: '商品效果的数值化评估',
        价格: '商品价格',
      },
      分类: '经济',
    },
  );

  // ═══════════════════════════════════════════════════════════════
  // 通用工具公式
  // ═══════════════════════════════════════════════════════════════

  // ─── 百分比计算 ───
  公式引擎.注册公式(
    '百分比计算',
    ({ 当前值, 最大值 }) => {
      return 最大值 > 0 ? (当前值 / 最大值) * 100 : 0;
    },
    {
      描述: '计算当前值占最大值的百分比',
      参数说明: {
        当前值: '当前数值',
        最大值: '最大数值',
      },
      分类: '通用',
    },
  );

  // ─── 范围限制 ───
  公式引擎.注册公式(
    '范围限制',
    ({ 值, 最小, 最大 }) => {
      return Math.max(最小 ?? 0, Math.min(最大 ?? Infinity, 值));
    },
    {
      描述: '将值限制在指定范围内',
      参数说明: {
        值: '输入值',
        最小: '最小值（默认0）',
        最大: '最大值（默认无限）',
      },
      分类: '通用',
    },
  );

  // ─── 随机范围 ───
  公式引擎.注册公式(
    '随机范围',
    ({ 最小, 最大 }) => {
      return Math.floor(Math.random() * (最大 - 最小 + 1)) + 最小;
    },
    {
      描述: '生成指定范围的随机整数',
      参数说明: {
        最小: '最小值',
        最大: '最大值',
      },
      分类: '通用',
    },
  );

  // ─── 概率判定 ───
  公式引擎.注册公式(
    '概率判定',
    ({ 概率 }) => {
      return Math.random() < 概率;
    },
    {
      描述: '进行概率判定',
      参数说明: { 概率: '判定概率 (0-1)' },
      分类: '通用',
    },
  );

  // ─── 加权随机选择 ───
  公式引擎.注册公式(
    '加权随机选择',
    ({ 选项列表 }) => {
      const 总权重 = 选项列表.reduce((sum, item) => sum + (item.权重 ?? 1), 0);
      let 随机值 = Math.random() * 总权重;

      for (const 选项 of 选项列表) {
        随机值 -= 选项.权重 ?? 1;
        if (随机值 <= 0) {
          return 选项.值;
        }
      }

      return 选项列表[选项列表.length - 1]?.值;
    },
    {
      描述: '从加权选项中随机选择',
      参数说明: { 选项列表: '加权选项数组 [{ 值, 权重 }, ...]' },
      分类: '通用',
    },
  );

  // ─── 经验升级阈值 ───
  公式引擎.注册公式(
    '经验升级阈值',
    ({ 当前等级 }, 常量) => {
      const 系数 = 常量.升级经验系数 ?? 100;
      return 当前等级 * 系数;
    },
    {
      描述: '计算升级所需经验',
      参数说明: { 当前等级: '当前等级' },
      分类: '通用',
      公式文本: '当前等级 × 100',
    },
  );

  // ─── 升级检查 ───
  公式引擎.注册公式(
    '升级检查',
    ({ 当前经验, 当前等级 }) => {
      const 阈值 = 公式引擎.计算('经验升级阈值', { 当前等级 });
      if (当前经验 >= 阈值) {
        return {
          可升级: true,
          剩余经验: 当前经验 - 阈值,
          新等级: 当前等级 + 1,
        };
      }
      return {
        可升级: false,
        距离升级: 阈值 - 当前经验,
      };
    },
    {
      描述: '检查是否可以升级并返回相关信息',
      参数说明: {
        当前经验: '当前经验值',
        当前等级: '当前等级',
      },
      分类: '通用',
    },
  );
}

// ═══════════════════════════════════════════════════════════════
// 公式分类文档
// ═══════════════════════════════════════════════════════════════

const 公式分类文档 = {
  战斗: {
    描述: '与战斗计算相关的公式',
    包含: ['士气系数', '部曲战力', '战力估值偏差', '战斗损失率', '战斗士气变化', '冠军负伤概率', '冠军阵亡概率'],
  },
  任务: {
    描述: '与任务执行效率相关的公式',
    包含: [
      '调教效率',
      '惩戒效率',
      '劝慰效率',
      '潜入侦察效率',
      '潜入暴露概率',
      '直接侦察效率',
      '提振士气效率',
      '潜入劝诱成功率',
      '训练效率',
    ],
  },
  资源: {
    描述: '与资源产出相关的公式',
    包含: ['泌乳产量', '总泌乳产量', '祝福水晶效果', '献祭魔力获得', '喽啰维护消耗'],
  },
  繁殖: {
    描述: '与生育系统相关的公式',
    包含: ['冠军属性生成', '冠军属性预估范围', '喽啰产出计算', '生育行动点计算'],
  },
  情报: {
    描述: '与情报系统相关的公式',
    包含: ['锁定目标值', '锁定目标解析', '情报衰减', '情报阶段判定'],
  },
  属性: {
    描述: '与属性阶段判定相关的公式',
    包含: ['臣服度阶段判定', '淫乱度阶段判定', '士气阶段判定'],
  },
  经济: {
    描述: '与经济计算相关的公式',
    包含: ['武装成本计算', '商品性价比'],
  },
  通用: {
    描述: '通用工具类公式',
    包含: ['百分比计算', '范围限制', '随机范围', '概率判定', '加权随机选择', '经验升级阈值', '升级检查'],
  },
};

// ═══════════════════════════════════════════════════════════════
// 公式快速参考表
// ═══════════════════════════════════════════════════════════════

const 公式快速参考 = {
  // 战斗
  士气50战力系数: '1.0',
  部曲战力公式: '(喽啰数+力量/20) × 武装% × 士气系数',

  // 任务
  调教臣服度增加: '5×(智力/25)+5',
  潜入效率: '(臣服度/50)×(1-淫乱度/200)',
  暴露概率: '淫乱度/200',
  直接侦察效率: '敏捷/25',
  提振士气: '15×(淫乱度/50)×(总价值/200)',
  劝诱成功率: '负责人价值/目标价值/2.5',

  // 资源
  泌乳产量: '(淫乱度+45)/20, 需淫乱度≥25',
  祝福水晶恢复: '2000/(淫乱度+20)',
  献祭魔力: '总价值/100×效率',

  // 繁殖
  冠军属性: '(总价值/10+随机±5)×效率系数',
  喽啰产出: '100消耗→10产出, 不足100时10点/个',

  // 情报
  锁定值: '系数×(情报+25)/100',
};

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 初始化公式配置, 公式分类文档, 公式快速参考 };

export default 初始化公式配置;
