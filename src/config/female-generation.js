// ═══════════════════════════════════════════════════════════════
// config/female-generation.js
// 女性角色随机生成配置 - 统一管理母畜/高价值目标的随机规则
// ═══════════════════════════════════════════════════════════════

/**
 * 女性随机配置类
 * 管理所有女性角色的随机生成规则
 */
class 女性随机配置 {
  constructor() {
    // ─── 身份配置 ───
    this.身份价值表 = new Map();
    this.身份权重表 = new Map();

    // ─── 种族配置 ───
    this.种族权重表 = new Map();
    this.种族价值修正表 = new Map();

    // ─── 年龄配置 ───
    this.年龄范围表 = new Map();
    this.默认年龄范围 = { 最小: 16, 最大: 35 };

    // ─── 生成器 ───
    this.姓名生成器 = null;
    this.外貌生成器 = null;

    // ─── 姓名池 ───
    this.姓名池 = {
      人类: [],
      精灵: [],
      半精灵: [],
      兽人: [],
      矮人: [],
      通用: [],
    };

    // ─── 外貌模板 ───
    this.外貌模板 = {
      人类: [],
      精灵: [],
      兽人: [],
      通用: [],
    };

    // ─── 特殊标签规则 ───
    this.特殊标签规则 = [];
  }

  // ═══════════════════════════════════════════════════════════════
  // 身份配置
  // ═══════════════════════════════════════════════════════════════

  注册身份(身份名, 配置) {
    /**
     * 配置示例:
     * {
     *   价值范围: { 最小: 100, 最大: 150 },
     *   权重: 100,           // 随机权重
     *   稀有度: 1,           // 1-5
     *   年龄范围: { 最小: 18, 最大: 30 },  // 可选，覆盖默认
     *   特殊标签: ['贵族'],  // 可选
     * }
     */
    this.身份价值表.set(身份名, {
      最小: 配置.价值范围?.最小 ?? 80,
      最大: 配置.价值范围?.最大 ?? 120,
    });

    this.身份权重表.set(身份名, 配置.权重 ?? 100);

    if (配置.年龄范围) {
      this.年龄范围表.set(身份名, 配置.年龄范围);
    }
  }

  批量注册身份(配置对象) {
    Object.entries(配置对象).forEach(([身份, 配置]) => {
      this.注册身份(身份, 配置);
    });
  }

  获取身份价值范围(身份) {
    return this.身份价值表.get(身份) ?? { 最小: 80, 最大: 120 };
  }

  获取所有身份() {
    return Array.from(this.身份价值表.keys());
  }

  // ═══════════════════════════════════════════════════════════════
  // 种族配置
  // ═══════════════════════════════════════════════════════════════

  注册种族(种族名, 配置) {
    /**
     * 配置示例:
     * {
     *   权重: 70,
     *   价值修正: { 乘数: 1.3, 加成: 50 },
     * }
     */
    this.种族权重表.set(种族名, 配置.权重 ?? 100);
    this.种族价值修正表.set(种族名, {
      乘数: 配置.价值修正?.乘数 ?? 1.0,
      加成: 配置.价值修正?.加成 ?? 0,
    });
  }

  批量注册种族(配置对象) {
    Object.entries(配置对象).forEach(([种族, 配置]) => {
      this.注册种族(种族, 配置);
    });
  }

  获取种族价值修正(种族) {
    return this.种族价值修正表.get(种族) ?? { 乘数: 1.0, 加成: 0 };
  }

  // ═══════════════════════════════════════════════════════════════
  // 姓名生成
  // ═══════════════════════════════════════════════════════════════

  设置姓名生成器(生成函数) {
    /**
     * 生成函数签名: (上下文) => 姓名字符串
     * 上下文: { 种族, 身份, 年龄 }
     */
    this.姓名生成器 = 生成函数;
  }

  设置姓名池(种族, 姓名列表) {
    if (this.姓名池[种族]) {
      this.姓名池[种族] = 姓名列表;
    } else {
      this.姓名池[种族] = 姓名列表;
    }
  }

  批量设置姓名池(配置) {
    Object.entries(配置).forEach(([种族, 列表]) => {
      this.设置姓名池(种族, 列表);
    });
  }

  生成姓名(上下文 = {}) {
    // 优先使用自定义生成器
    if (this.姓名生成器) {
      return this.姓名生成器(上下文);
    }

    // 根据种族选择姓名池
    const 种族 = 上下文.种族 ?? '人类';
    let 候选池 = this.姓名池[种族];

    if (!候选池 || 候选池.length === 0) {
      候选池 = this.姓名池.通用;
    }

    if (候选池 && 候选池.length > 0) {
      return this.随机选择(候选池);
    }

    // 默认姓名
    return `女子_${Math.random().toString(36).slice(2, 6)}`;
  }

  // ═══════════════════════════════════════════════════════════════
  // 外貌生成
  // ═══════════════════════════════════════════════════════════════

  设置外貌生成器(生成函数) {
    /**
     * 生成函数签名: (上下文) => 外貌描述字符串
     */
    this.外貌生成器 = 生成函数;
  }

  设置外貌模板(种族, 模板列表) {
    this.外貌模板[种族] = 模板列表;
  }

  生成外貌(上下文 = {}) {
    if (this.外貌生成器) {
      return this.外貌生成器(上下文);
    }

    const 种族 = 上下文.种族 ?? '人类';
    const 模板池 = this.外貌模板[种族] ?? this.外貌模板.通用 ?? [];

    if (模板池.length > 0) {
      return this.随机选择(模板池);
    }

    return '';
  }

  // ═══════════════════════════════════════════════════════════════
  // 特殊标签规则
  // ═══════════════════════════════════════════════════════════════

  注册特殊标签规则(规则函数) {
    /**
     * 规则函数签名: (上下文) => 标签数组
     * 上下文: { 身份, 种族, 年龄, 总雌性价值 }
     */
    this.特殊标签规则.push(规则函数);
  }

  生成特殊标签(上下文) {
    const 标签集合 = new Set();

    for (const 规则 of this.特殊标签规则) {
      try {
        const 标签列表 = 规则(上下文);
        if (Array.isArray(标签列表)) {
          标签列表.forEach(标签 => 标签集合.add(标签));
        }
      } catch (错误) {
        console.error('特殊标签规则执行错误:', 错误);
      }
    }

    return Array.from(标签集合);
  }

  // ═══════════════════════════════════════════════════════════════
  // 核心随机生成方法
  // ═══════════════════════════════════════════════════════════════

  随机生成(约束条件 = {}) {
    /**
     * 核心随机生成方法
     *
     * 约束条件示例:
     * {
     *   身份池: ['农家女', '商人之女'],     // 限定身份范围
     *   种族池: ['人类', '精灵'],           // 限定种族范围
     *   种族权重覆盖: { 人类: 50, 精灵: 50 }, // 覆盖默认权重
     *   价值范围: { 最小: 100, 最大: 200 }, // 覆盖身份默认价值
     *   年龄范围: { 最小: 18, 最大: 25 },   // 覆盖默认年龄
     *   固定属性: { 姓名: '艾丽丝' },       // 固定某些属性不随机
     *   额外标签: ['处女'],                 // 额外添加的标签
     * }
     *
     * @returns {
     *   姓名, 原身份, 种族, 年龄, 外貌描述,
     *   总雌性价值, 特殊标签
     * }
     */

    // ─── 确定身份 ───
    let 身份;
    if (约束条件.固定属性?.原身份) {
      身份 = 约束条件.固定属性.原身份;
    } else if (约束条件.身份池?.length > 0) {
      身份 = this.按权重随机选择身份(约束条件.身份池);
    } else {
      身份 = this.按权重随机选择身份();
    }

    // ─── 确定种族 ───
    let 种族;
    if (约束条件.固定属性?.种族) {
      种族 = 约束条件.固定属性.种族;
    } else if (约束条件.种族权重覆盖) {
      种族 = this.按权重随机选择(约束条件.种族权重覆盖);
    } else if (约束条件.种族池?.length > 0) {
      种族 = this.按权重随机选择种族(约束条件.种族池);
    } else {
      种族 = this.按权重随机选择种族();
    }

    // ─── 确定年龄 ───
    let 年龄;
    if (约束条件.固定属性?.年龄) {
      年龄 = 约束条件.固定属性.年龄;
    } else {
      const 年龄范围 = 约束条件.年龄范围 ?? this.年龄范围表.get(身份) ?? this.默认年龄范围;
      年龄 = this.随机范围(年龄范围.最小, 年龄范围.最大);
    }

    // ─── 计算雌性价值 ───
    let 总雌性价值;
    if (约束条件.固定属性?.总雌性价值) {
      总雌性价值 = 约束条件.固定属性.总雌性价值;
    } else {
      const 价值范围 = 约束条件.价值范围 ?? this.获取身份价值范围(身份);
      const 基础价值 = this.随机范围(价值范围.最小, 价值范围.最大);

      const 修正 = this.获取种族价值修正(种族);
      总雌性价值 = Math.round(基础价值 * 修正.乘数 + 修正.加成);
      总雌性价值 = Math.max(10, 总雌性价值);
    }

    // ─── 生成上下文 ───
    const 生成上下文 = {
      原身份: 身份,
      种族,
      年龄,
      总雌性价值,
    };

    // ─── 生成姓名 ───
    const 姓名 = 约束条件.固定属性?.姓名 ?? this.生成姓名(生成上下文);

    // ─── 生成外貌 ───
    const 外貌描述 = 约束条件.固定属性?.外貌描述 ?? this.生成外貌(生成上下文);

    // ─── 生成特殊标签 ───
    const 自动标签 = this.生成特殊标签(生成上下文);
    const 额外标签 = 约束条件.额外标签 ?? [];
    const 特殊标签 = [...new Set([...自动标签, ...额外标签])];

    return {
      姓名,
      原身份: 身份,
      种族,
      年龄,
      外貌描述,
      总雌性价值,
      特殊标签,
    };
  }

  // ═══════════════════════════════════════════════════════════════
  // 便捷生成方法
  // ═══════════════════════════════════════════════════════════════

  为袭击目标生成(目标类型配置) {
    /**
     * 为袭击目标生成高价值目标
     * @param 目标类型配置 - 来自 raid-targets.js 的配置
     */
    const 约束条件 = {
      身份池: 目标类型配置.高价值目标身份池,
    };

    // 处理稀有身份
    if (目标类型配置.稀有身份池 && Math.random() < (目标类型配置.稀有身份概率 ?? 0)) {
      约束条件.身份池 = 目标类型配置.稀有身份池;
    }

    // 处理特殊种族权重（如精灵商队）
    if (目标类型配置.种族权重覆盖) {
      约束条件.种族权重覆盖 = 目标类型配置.种族权重覆盖;
    }

    // 处理特殊标签
    if (目标类型配置.特殊标签) {
      约束条件.额外标签 = 目标类型配置.特殊标签;
    }

    return this.随机生成(约束条件);
  }

  为黑市商品生成(商品配置) {
    /**
     * 为黑市商品生成母畜属性
     * @param 商品配置 - 来自商品效果的配置
     */
    const 约束条件 = {};

    // 处理身份
    if (商品配置.原身份) {
      约束条件.固定属性 = { 原身份: 商品配置.原身份 };
    }

    // 处理种族
    if (商品配置.种族) {
      约束条件.固定属性 = {
        ...约束条件.固定属性,
        种族: 商品配置.种族,
      };
    }

    // 处理价值范围
    if (商品配置.总雌性价值范围) {
      约束条件.价值范围 = {
        最小: 商品配置.总雌性价值范围[0],
        最大: 商品配置.总雌性价值范围[1],
      };
    } else if (商品配置.总雌性价值) {
      约束条件.固定属性 = {
        ...约束条件.固定属性,
        总雌性价值: 商品配置.总雌性价值,
      };
    }

    // 处理特殊标签
    if (商品配置.特殊标签) {
      约束条件.额外标签 = 商品配置.特殊标签;
    }

    return this.随机生成(约束条件);
  }

  // ═══════════════════════════════════════════════════════════════
  // 工具方法
  // ═══════════════════════════════════════════════════════════════

  随机选择(数组) {
    if (!数组 || 数组.length === 0) return null;
    return 数组[Math.floor(Math.random() * 数组.length)];
  }

  随机范围(最小, 最大) {
    return Math.floor(Math.random() * (最大 - 最小 + 1)) + 最小;
  }

  按权重随机选择(权重对象) {
    const 总权重 = Object.values(权重对象).reduce((sum, w) => sum + w, 0);
    let 随机值 = Math.random() * 总权重;

    for (const [选项, 权重] of Object.entries(权重对象)) {
      随机值 -= 权重;
      if (随机值 <= 0) {
        return 选项;
      }
    }

    return Object.keys(权重对象)[0];
  }

  按权重随机选择身份(限定池 = null) {
    const 候选 = {};

    if (限定池) {
      限定池.forEach(身份 => {
        候选[身份] = this.身份权重表.get(身份) ?? 100;
      });
    } else {
      this.身份权重表.forEach((权重, 身份) => {
        候选[身份] = 权重;
      });
    }

    if (Object.keys(候选).length === 0) {
      return '普通人';
    }

    return this.按权重随机选择(候选);
  }

  按权重随机选择种族(限定池 = null) {
    const 候选 = {};

    if (限定池) {
      限定池.forEach(种族 => {
        候选[种族] = this.种族权重表.get(种族) ?? 100;
      });
    } else {
      this.种族权重表.forEach((权重, 种族) => {
        候选[种族] = 权重;
      });
    }

    if (Object.keys(候选).length === 0) {
      return '人类';
    }

    return this.按权重随机选择(候选);
  }
}

// ═══════════════════════════════════════════════════════════════
// 默认配置初始化函数
// ═══════════════════════════════════════════════════════════════

function 初始化女性随机配置(配置实例) {
  // ─── 注册身份 ───
  配置实例.批量注册身份({
    // 顶级身份
    圣女: { 价值范围: { 最小: 450, 最大: 550 }, 权重: 5, 稀有度: 5 },
    公主: { 价值范围: { 最小: 450, 最大: 550 }, 权重: 3, 稀有度: 5 },
    女王: { 价值范围: { 最小: 500, 最大: 600 }, 权重: 1, 稀有度: 5 },

    // 高级身份
    女骑士: { 价值范围: { 最小: 350, 最大: 450 }, 权重: 15, 稀有度: 4 },
    高阶法师: { 价值范围: { 最小: 350, 最大: 450 }, 权重: 10, 稀有度: 4 },
    大贵族: { 价值范围: { 最小: 350, 最大: 450 }, 权重: 10, 稀有度: 4 },
    女将军: { 价值范围: { 最小: 350, 最大: 450 }, 权重: 5, 稀有度: 4 },

    // 中级身份
    城主之女: { 价值范围: { 最小: 200, 最大: 300 }, 权重: 30, 稀有度: 3 },
    低阶冒险者: { 价值范围: { 最小: 200, 最大: 300 }, 权重: 40, 稀有度: 3 },
    见习法师: { 价值范围: { 最小: 200, 最大: 300 }, 权重: 25, 稀有度: 3 },
    女侍卫: { 价值范围: { 最小: 180, 最大: 280 }, 权重: 35, 稀有度: 3 },
    贵族: { 价值范围: { 最小: 150, 最大: 200 }, 权重: 40, 稀有度: 3 },

    // 普通身份
    商人之女: { 价值范围: { 最小: 150, 最大: 200 }, 权重: 60, 稀有度: 2 },
    村长之女: { 价值范围: { 最小: 120, 最大: 180 }, 权重: 70, 稀有度: 2 },
    工匠之女: { 价值范围: { 最小: 100, 最大: 160 }, 权重: 80, 稀有度: 2 },

    // 低级身份
    普通人: { 价值范围: { 最小: 80, 最大: 120 }, 权重: 100, 稀有度: 1 },
    农家女: { 价值范围: { 最小: 70, 最大: 110 }, 权重: 120, 稀有度: 1 },
    佣人: { 价值范围: { 最小: 60, 最大: 100 }, 权重: 90, 稀有度: 1 },

    // 特殊身份
    盗贼: { 价值范围: { 最小: 120, 最大: 180 }, 权重: 20, 稀有度: 2 },
    游侠: { 价值范围: { 最小: 150, 最大: 220 }, 权重: 15, 稀有度: 3 },
    刺客: { 价值范围: { 最小: 180, 最大: 260 }, 权重: 10, 稀有度: 3 },
    战士: { 价值范围: { 最小: 160, 最大: 240 }, 权重: 25, 稀有度: 2 },
  });

  // ─── 注册种族 ───
  配置实例.批量注册种族({
    人类: { 权重: 70, 价值修正: { 乘数: 1.0, 加成: 0 } },
    精灵: { 权重: 10, 价值修正: { 乘数: 1.3, 加成: 50 } },
    半精灵: { 权重: 10, 价值修正: { 乘数: 1.15, 加成: 25 } },
    兽人: { 权重: 5, 价值修正: { 乘数: 0.8, 加成: 0 } },
    矮人: { 权重: 5, 价值修正: { 乘数: 0.9, 加成: 20 } },
  });

  // ─── 注册年龄范围（按身份类型）───
  配置实例.年龄范围表.set('圣女', { 最小: 16, 最大: 24 });
  配置实例.年龄范围表.set('公主', { 最小: 14, 最大: 22 });
  配置实例.年龄范围表.set('女骑士', { 最小: 18, 最大: 32 });
  配置实例.年龄范围表.set('低阶冒险者', { 最小: 16, 最大: 28 });
  配置实例.年龄范围表.set('见习法师', { 最小: 14, 最大: 22 });
  配置实例.年龄范围表.set('农家女', { 最小: 14, 最大: 30 });
  配置实例.年龄范围表.set('贵族', { 最小: 16, 最大: 28 });

  // ─── 注册特殊标签规则 ───

  // 精灵血脉
  配置实例.注册特殊标签规则(上下文 => {
    if (上下文.种族 === '精灵') return ['精灵血脉'];
    if (上下文.种族 === '半精灵') return ['半精灵血脉'];
    return [];
  });

  // 高贵血统
  配置实例.注册特殊标签规则(上下文 => {
    const 贵族身份 = ['公主', '女王', '大贵族', '贵族', '城主之女'];
    if (贵族身份.includes(上下文.原身份)) return ['高贵血统'];
    return [];
  });

  // 神圣属性
  配置实例.注册特殊标签规则(上下文 => {
    if (上下文.原身份 === '圣女') return ['神圣'];
    return [];
  });

  // 战斗训练
  配置实例.注册特殊标签规则(上下文 => {
    const 战斗身份 = ['女骑士', '女将军', '女侍卫', '低阶冒险者', '战士', '刺客'];
    if (战斗身份.includes(上下文.原身份)) return ['战斗训练'];
    return [];
  });

  // 魔法天赋
  配置实例.注册特殊标签规则(上下文 => {
    const 魔法身份 = ['高阶法师', '见习法师', '圣女'];
    if (魔法身份.includes(上下文.原身份)) return ['魔法天赋'];
    return [];
  });

  // 高价值标记
  配置实例.注册特殊标签规则(上下文 => {
    if (上下文.总雌性价值 >= 400) return ['极品'];
    if (上下文.总雌性价值 >= 300) return ['优质'];
    return [];
  });
}

// ═══════════════════════════════════════════════════════════════
// 预设种族权重配置（用于特殊场景）
// ═══════════════════════════════════════════════════════════════

const 预设种族权重 = {
  默认: { 人类: 70, 精灵: 10, 半精灵: 10, 兽人: 5, 矮人: 5 },
  精灵聚居地: { 人类: 10, 精灵: 60, 半精灵: 25, 兽人: 0, 矮人: 5 },
  边境地区: { 人类: 50, 精灵: 5, 半精灵: 15, 兽人: 20, 矮人: 10 },
  贵族领地: { 人类: 80, 精灵: 10, 半精灵: 8, 兽人: 0, 矮人: 2 },
  修道院: { 人类: 85, 精灵: 10, 半精灵: 5, 兽人: 0, 矮人: 0 },
};

// ═══════════════════════════════════════════════════════════════
// 预设身份池（用于特定场景）
// ═══════════════════════════════════════════════════════════════

const 预设身份池 = {
  村庄: ['农家女', '村长之女', '工匠之女', '普通人'],
  商队: ['商人之女', '佣人', '普通人', '低阶冒险者'],
  城镇: ['商人之女', '城主之女', '工匠之女', '低阶冒险者', '见习法师'],
  城市: ['贵族', '城主之女', '女骑士', '低阶冒险者', '见习法师', '商人之女'],
  要塞: ['女骑士', '女侍卫', '女将军'],
  修道院: ['普通人', '见习法师', '圣女'],
  冒险者营地: ['低阶冒险者', '见习法师', '盗贼', '游侠'],
  贵族庄园: ['贵族', '大贵族', '佣人', '女侍卫'],

  // 稀有身份池
  稀有_战斗: ['女骑士', '女将军', '刺客'],
  稀有_魔法: ['高阶法师', '圣女'],
  稀有_贵族: ['公主', '大贵族', '女王'],
};

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 女性随机配置, 初始化女性随机配置, 预设种族权重, 预设身份池 };

export default 女性随机配置;