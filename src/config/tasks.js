// ═══════════════════════════════════════════════════════════════
// config/tasks.js
// 任务配置 - 定义所有任务类型及其执行器
// ═══════════════════════════════════════════════════════════════

/**
 * 初始化默认任务配置
 * @param 任务注册表 - 任务定义注册表实例
 */
function 初始化任务配置(任务注册表) {
  // ═══════════════════════════════════════════════════════════════
  // 调教类任务
  // ═══════════════════════════════════════════════════════════════

  // ─── 调教（冠军 → 母畜）───
  任务注册表.注册任务类型('调教', {
    分类: '调教',
    行动点消耗: 1,
    负责人类型: ['冠军'],
    效率属性: ['智力'],
    产出类型: ['臣服度'],
    需要目标: true,
    目标类型: '母畜',
    描述: '冠军对母畜进行调教，提升其臣服度',
    图标: '🎓',
  });

  任务注册表.注册任务执行器('调教', 上下文 => {
    const { 负责人, 游戏状态, 属性注册表, 公式引擎, 额外参数 } = 上下文;
    const 目标ID = 额外参数?.目标ID;

    const 目标母畜 = 游戏状态.获取母畜(目标ID);
    if (!目标母畜) {
      return { 成功: false, 原因: '目标不存在' };
    }

    const 智力 = 负责人.获取属性('智力');
    const 臣服度增加 = 公式引擎?.计算('调教效率', { 智力 }) ?? 5 * (智力 / 25) + 5;

    const 旧臣服度 = 目标母畜.获取属性('臣服度');
    目标母畜.修改属性('臣服度', 臣服度增加, 属性注册表);
    const 新臣服度 = 目标母畜.获取属性('臣服度');

    return {
      成功: true,
      效果: {
        臣服度增加: Math.floor(臣服度增加),
        当前臣服度: 新臣服度,
        原臣服度: 旧臣服度,
      },
      目标ID: 目标母畜.实体ID,
      目标姓名: 目标母畜.获取属性('姓名'),
    };
  });

  // ─── 惩戒（冠军 → 母畜）───
  任务注册表.注册任务类型('惩戒', {
    分类: '调教',
    行动点消耗: 1,
    负责人类型: ['冠军'],
    效率属性: ['力量'],
    产出类型: ['臣服度', '淫乱度'],
    需要目标: true,
    目标类型: '母畜',
    描述: '通过惩戒快速提升臣服度，但会大幅增加淫乱度',
    图标: '⚔️',
  });

  任务注册表.注册任务执行器('惩戒', 上下文 => {
    const { 负责人, 游戏状态, 属性注册表, 额外参数 } = 上下文;

    const 目标母畜 = 游戏状态.获取母畜(额外参数?.目标ID);
    if (!目标母畜) {
      return { 成功: false, 原因: '目标不存在' };
    }

    const 力量 = 负责人.获取属性('力量');
    const 臣服度增加 = 8 + Math.floor(力量 / 10);
    const 淫乱度增加 = 12 + Math.floor(力量 / 15);

    目标母畜.修改属性('臣服度', 臣服度增加, 属性注册表);
    目标母畜.修改属性('淫乱度', 淫乱度增加, 属性注册表);

    return {
      成功: true,
      效果: {
        臣服度增加,
        淫乱度增加,
        当前臣服度: 目标母畜.获取属性('臣服度'),
        当前淫乱度: 目标母畜.获取属性('淫乱度'),
      },
      目标ID: 目标母畜.实体ID,
    };
  });

  // ─── 劝慰（母畜 → 母畜）───
  任务注册表.注册任务类型('劝慰', {
    分类: '调教',
    行动点消耗: 1,
    负责人类型: ['母畜'],
    负责人条件: 上下文 => 上下文.负责人.获取属性('臣服度') >= 75,
    产出类型: ['臣服度'],
    需要目标: true,
    目标类型: '母畜',
    描述: '已归心的母畜劝慰新来者，同种族/身份有加成',
    图标: '💬',
  });

  任务注册表.注册任务执行器('劝慰', 上下文 => {
    const { 负责人, 游戏状态, 属性注册表, 额外参数 } = 上下文;

    const 目标母畜 = 游戏状态.获取母畜(额外参数?.目标ID);
    if (!目标母畜) {
      return { 成功: false, 原因: '目标不存在' };
    }

    if (负责人.实体ID === 目标母畜.实体ID) {
      return { 成功: false, 原因: '不能对自己执行此任务' };
    }

    let 臣服度增加 = 10;

    // 同种族加成 ×1.5
    if (负责人.获取属性('种族') === 目标母畜.获取属性('种族')) {
      臣服度增加 *= 1.5;
    }

    // 同身份加成 ×1.3
    if (负责人.获取属性('原身份') === 目标母畜.获取属性('原身份')) {
      臣服度增加 *= 1.3;
    }

    目标母畜.修改属性('臣服度', Math.floor(臣服度增加), 属性注册表);

    return {
      成功: true,
      效果: {
        臣服度增加: Math.floor(臣服度增加),
        当前臣服度: 目标母畜.获取属性('臣服度'),
      },
      目标ID: 目标母畜.实体ID,
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 侦察类任务
  // ═══════════════════════════════════════════════════════════════

  // ─── 潜入侦察（母畜 → 目标）───
  任务注册表.注册任务类型('潜入侦察', {
    分类: '侦察',
    行动点消耗: 1,
    负责人类型: ['母畜'],
    负责人条件: 上下文 => 上下文.负责人.获取属性('臣服度') >= 90,
    产出类型: ['情报'],
    需要目标: true,
    描述: '派遣忠诚母畜潜入目标进行侦察，有暴露风险',
    图标: '🕵️',
  });

  任务注册表.注册任务执行器('潜入侦察', 上下文 => {
    // todo
  });

  // ─── 直接侦察（冠军 → 目标）───
  任务注册表.注册任务类型('直接侦察', {
    分类: '侦察',
    行动点消耗: 1,
    负责人类型: ['冠军'],
    效率属性: ['敏捷'],
    产出类型: ['情报'],
    需要目标: true,
    描述: '派遣冠军直接侦察，效率较高但可能遭遇战斗',
    图标: '🔭',
  });

  任务注册表.注册任务执行器('直接侦察', 上下文 => {
    // todo
  });

  // ═══════════════════════════════════════════════════════════════
  // 繁殖类任务
  // ═══════════════════════════════════════════════════════════════

  // ─── 生育冠军 ───
  任务注册表.注册任务类型('生育冠军', {
    分类: '繁殖',
    行动点消耗: 1,
    负责人类型: ['母畜'],
    负责人条件: 上下文 => {
      const 剩余价值 = 上下文.负责人.获取属性('剩余雌性价值');
      return 剩余价值 >= 100;
    },
    产出类型: ['冠军'],
    动态行动点计算: 上下文 => {
      const 臣服度 = 上下文.负责人.获取属性('臣服度');
      return 臣服度 >= 25 ? 1 : 2;
    },
    描述: '母畜生育一名冠军，消耗100雌性价值',
    图标: '👶',
  });

  任务注册表.注册任务执行器('生育冠军', 上下文 => {
    const { 负责人, 繁殖系统, 游戏状态, 事件总线 } = 上下文;

    if (!繁殖系统) {
      return { 成功: false, 原因: '繁殖系统未初始化' };
    }

    const 结果 = 繁殖系统.生育冠军(负责人);

    if (结果.成功) {
      // 将新冠军添加到游戏状态
      游戏状态?.添加冠军(结果.冠军);

      // 检查是否是首个冠军
      if (游戏状态?.冠军列表?.length === 1) {
        事件总线?.发布('首个冠军诞生', { 冠军: 结果.冠军 });
      }
    }

    return 结果;
  });

  // ─── 生育喽啰 ───
  任务注册表.注册任务类型('生育喽啰', {
    分类: '繁殖',
    行动点消耗: 0,
    负责人类型: ['母畜'],
    负责人条件: 上下文 => {
      const 剩余价值 = 上下文.负责人.获取属性('剩余雌性价值');
      return 剩余价值 > 0;
    },
    产出类型: ['喽啰'],
    动态行动点计算: 上下文 => {
      const 臣服度 = 上下文.负责人.获取属性('臣服度');
      return 臣服度 >= 25 ? 0 : 1;
    },
    描述: '母畜生育喽啰，消耗100雌性价值产出10喽啰',
    图标: '👥',
  });

  任务注册表.注册任务执行器('生育喽啰', 上下文 => {
    const { 负责人, 繁殖系统 } = 上下文;

    if (!繁殖系统) {
      return { 成功: false, 原因: '繁殖系统未初始化' };
    }

    return 繁殖系统.生育喽啰(负责人);
  });

  // ═══════════════════════════════════════════════════════════════
  // 军事类任务
  // ═══════════════════════════════════════════════════════════════

  // ─── 提振士气 ───
  任务注册表.注册任务类型('提振士气', {
    分类: '军事',
    行动点消耗: 1,
    负责人类型: ['母畜'],
    负责人条件: 上下文 => 上下文.负责人.获取属性('臣服度') >= 75,
    产出类型: ['士气'],
    描述: '母畜在喽啰面前表演以提振士气',
    图标: '🎭',
    副作用: [
      上下文 => {
        const { 负责人, 属性注册表 } = 上下文;
        负责人.修改属性('淫乱度', 5, 属性注册表);
      },
    ],
  });

  任务注册表.注册任务执行器('提振士气', 上下文 => {
    const { 负责人, 游戏状态, 公式引擎 } = 上下文;

    const 淫乱度 = 负责人.获取属性('淫乱度');
    const 总雌性价值 = 负责人.获取属性('总雌性价值');

    const 士气提升 = 公式引擎?.计算('提振士气效率', { 淫乱度, 总雌性价值 }) ?? 15 * (淫乱度 / 50) * (总雌性价值 / 200);

    游戏状态?.修改士气(Math.floor(士气提升));

    return {
      成功: true,
      效果: {
        士气提升: Math.floor(士气提升),
        淫乱度增加: 5, // 由副作用处理
        当前士气: 游戏状态?.军队状态?.士气,
      },
    };
  });

  // ─── 训练喽啰 ───
  任务注册表.注册任务类型('训练喽啰', {
    分类: '军事',
    行动点消耗: 1,
    负责人类型: ['冠军'],
    效率属性: ['力量'],
    产出类型: ['战力'],
    描述: '冠军训练喽啰，提升基础战斗力',
    图标: '⚔️',
  });

  任务注册表.注册任务执行器('训练喽啰', 上下文 => {
    const { 负责人, 游戏状态 } = 上下文;

    const 力量 = 负责人.获取属性('力量');
    const 战力提升 = 2 + Math.floor(力量 / 20);

    if (游戏状态?.军队状态) {
      游戏状态.军队状态.战斗力基础值 = (游戏状态.军队状态.战斗力基础值 ?? 100) + 战力提升;
    }

    return {
      成功: true,
      效果: {
        战力提升,
        当前基础战力: 游戏状态?.军队状态?.战斗力基础值,
      },
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 资源类任务
  // ═══════════════════════════════════════════════════════════════

  // ─── 泌乳 ───
  任务注册表.注册任务类型('泌乳', {
    分类: '资源',
    行动点消耗: 0,
    负责人类型: ['母畜'],
    负责人条件: 上下文 => 上下文.负责人.获取属性('淫乱度') >= 25,
    产出类型: ['母乳'],
    描述: '淫乱度达到25以上的母畜会产出母乳',
    图标: '🥛',
    副作用: [
      上下文 => {
        const { 负责人, 属性注册表 } = 上下文;
        负责人.修改属性('淫乱度', 3, 属性注册表);
      },
    ],
  });

  任务注册表.注册任务执行器('泌乳', 上下文 => {
    const { 负责人, 资源系统, 公式引擎 } = 上下文;

    const 淫乱度 = 负责人.获取属性('淫乱度');
    const 产量 = 公式引擎?.计算('泌乳产量', { 淫乱度 }) ?? Math.floor((淫乱度 + 45) / 20);

    if (资源系统) {
      资源系统.增加资源('母乳', 产量, '泌乳');
    }

    return {
      成功: true,
      效果: {
        母乳产量: 产量,
        淫乱度增加: 3, // 由副作用处理
      },
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 特殊任务
  // ═══════════════════════════════════════════════════════════════

  // ─── 潜入劝诱 ───
  任务注册表.注册任务类型('潜入劝诱', {
    分类: '特殊',
    行动点消耗: 1,
    负责人类型: ['母畜'],
    负责人条件: 上下文 => 上下文.负责人.获取属性('臣服度') >= 90,
    产出类型: ['母畜'],
    需要目标: true,
    描述: '派遣母畜劝诱目标地点的女性加入部落',
    图标: '💋',
  });

  任务注册表.注册任务执行器('潜入劝诱', 上下文 => {
    const { 负责人, 母畜工厂, 游戏状态, 额外参数, 公式引擎, 事件总线 } = 上下文;

    const 负责人价值 = 负责人.获取属性('总雌性价值');
    const 目标价值 = 额外参数?.目标价值 ?? 100;

    const 成功率 = 公式引擎?.计算('潜入劝诱成功率', { 负责人价值, 目标价值 }) ?? 负责人价值 / 目标价值 / 2.5;
    const 是否成功 = Math.random() < 成功率;

    if (!是否成功) {
      const 暴露概率 = 0.3;
      const 是否暴露 = Math.random() < 暴露概率;

      if (是否暴露) {
        事件总线?.发布('负责人暴露', {
          负责人ID: 负责人.实体ID,
          任务: '潜入劝诱',
        });
      }

      return {
        成功: false,
        暴露: 是否暴露,
        负责人ID: 负责人.实体ID,
        原因: '劝诱失败',
      };
    }

    // 创建新母畜
    if (母畜工厂) {
      // todo
    }

    return {
      成功: true,
      需创建母畜: true,
      初始臣服度: 20,
      目标配置: 额外参数?.目标配置,
    };
  });

  // ─── 休整 ───
  任务注册表.注册任务类型('休整', {
    分类: '通用',
    行动点消耗: 1,
    负责人类型: ['冠军', '母畜'],
    描述: '休息恢复，冠军恢复负伤状态，母畜略微降低淫乱度',
    图标: '💤',
  });

  任务注册表.注册任务执行器('休整', 上下文 => {
    const { 负责人, 属性注册表 } = 上下文;

    const 效果 = {};

    if (负责人.实体类型 === '冠军') {
      if (负责人.拥有标签('负伤')) {
        负责人.移除标签('负伤');
        效果.状态恢复 = '负伤痊愈';
      } else {
        效果.状态恢复 = '无需恢复';
      }
    } else if (负责人.实体类型 === '母畜') {
      const 旧淫乱度 = 负责人.获取属性('淫乱度');
      if (旧淫乱度 > 0) {
        负责人.修改属性('淫乱度', -5, 属性注册表);
        效果.淫乱度降低 = Math.min(5, 旧淫乱度);
        效果.当前淫乱度 = 负责人.获取属性('淫乱度');
      } else {
        效果.状态恢复 = '无需恢复';
      }
    }

    return {
      成功: true,
      效果,
    };
  });
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 初始化任务配置 };
export default 初始化任务配置;
