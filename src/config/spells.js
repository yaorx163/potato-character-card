// ═══════════════════════════════════════════════════════════════
// config/spells.js
// 法术配置 - 定义所有法术及其效果
// ═══════════════════════════════════════════════════════════════

/**
 * 初始化默认法术配置
 * @param 法术注册表 - 法术定义注册表实例
 */
function 初始化法术配置(法术注册表) {
  // ═══════════════════════════════════════════════════════════════
  // 增益类法术
  // ═══════════════════════════════════════════════════════════════

  // ─── 催化调教 ───
  法术注册表.注册法术('催化调教', {
    魔力消耗: 1,
    目标类型: '无',
    分类: '增益',
    效果描述: '下一次调教任务效率翻倍',
    效果参数: {
      调教倍率: 2,
      持续: '单次',
    },
    图标: '✨',
  });

  法术注册表.注册效果处理器('催化调教', (目标, 上下文) => {
    // 此法术效果由任务系统在下次调教时应用
    return {
      成功: true,
      效果类型: '调教增幅',
      倍率: 上下文.效果参数.调教倍率,
      描述: '下一次调教效率翻倍',
      需要标记: true,
      标记名称: 'buff_调教增幅',
    };
  });

  // ─── 战嚎祝福 ───
  法术注册表.注册法术('战嚎祝福', {
    魔力消耗: 3,
    目标类型: '无',
    分类: '增益',
    效果描述: '本次战斗军队战力+30%',
    效果参数: {
      战力加成: 0.3,
      持续: '单次战斗',
    },
    冷却周期: 2,
    图标: '🔥',
  });

  法术注册表.注册效果处理器('战嚎祝福', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '战力增幅',
      加成比例: 上下文.效果参数.战力加成,
      描述: '本次战斗战力+30%',
      需要标记: true,
      标记名称: 'buff_战力增幅',
    };
  });

  // ─── 铁壁守护 ───
  法术注册表.注册法术('铁壁守护', {
    魔力消耗: 2,
    目标类型: '无',
    分类: '增益',
    效果描述: '本次战斗存活率提升20%',
    效果参数: {
      存活率加成: 0.2,
      持续: '单次战斗',
    },
    冷却周期: 2,
    图标: '🛡️',
  });

  法术注册表.注册效果处理器('铁壁守护', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '存活率增幅',
      加成比例: 上下文.效果参数.存活率加成,
      描述: '本次战斗存活率提升20%',
      需要标记: true,
      标记名称: 'buff_铁壁',
    };
  });

  // ─── 急行军令 ───
  法术注册表.注册法术('急行军令', {
    魔力消耗: 2,
    目标类型: '无',
    分类: '增益',
    效果描述: '本周额外获得1点行动点',
    效果参数: {
      行动点增加: 1,
    },
    冷却周期: 4,
    图标: '⚡',
  });

  法术注册表.注册效果处理器('急行军令', (目标, 上下文) => {
    // 需要时间系统配合
    return {
      成功: true,
      效果类型: '行动点增加',
      增量: 上下文.效果参数.行动点增加,
      描述: '本周行动点+1',
      需要应用到: '时间系统',
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 情报类法术
  // ═══════════════════════════════════════════════════════════════

  // ─── 魔眼侦察 ───
  法术注册表.注册法术('魔眼侦察', {
    魔力消耗: 1,
    目标类型: '无',
    分类: '情报',
    效果描述: '立刻提高目标情报进度30点',
    效果参数: {
      情报增量: 30,
    },
    图标: '👁️',
  });

  法术注册表.注册效果处理器('魔眼侦察', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '情报增加',
      增量: 上下文.效果参数.情报增量,
      描述: '情报进度+30',
      需要应用到: '情报系统',
    };
  });

  // ─── 真视之眼 ───
  法术注册表.注册法术('真视之眼', {
    魔力消耗: 3,
    目标类型: '无',
    分类: '情报',
    效果描述: '完全揭示目标的真实战力',
    效果参数: {
      情报增量: 100,
    },
    冷却周期: 5,
    图标: '🔮',
  });

  法术注册表.注册效果处理器('真视之眼', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '情报完全揭示',
      增量: 上下文.效果参数.情报增量,
      描述: '完全揭示目标战力',
      需要应用到: '情报系统',
    };
  });

  // ─── 心灵探知 ───
  法术注册表.注册法术('心灵探知', {
    魔力消耗: 2,
    目标类型: '无',
    分类: '情报',
    效果描述: '锁定一个高价值目标',
    效果参数: {
      锁定数量: 1,
    },
    冷却周期: 2,
    图标: '🧠',
  });

  法术注册表.注册效果处理器('心灵探知', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '目标锁定',
      锁定数量: 上下文.效果参数.锁定数量,
      描述: '强制锁定一个高价值目标',
      需要应用到: '情报系统',
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 操控类法术（针对母畜）
  // ═══════════════════════════════════════════════════════════════

  // ─── 意志粉碎 ───
  法术注册表.注册法术('意志粉碎', {
    魔力消耗: 3,
    目标类型: '母畜',
    分类: '操控',
    效果描述: '目标母畜臣服度直接+50',
    效果参数: {
      臣服度增加: 50,
    },
    冷却周期: 3,
    图标: '💔',
  });

  法术注册表.注册效果处理器('意志粉碎', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 旧臣服度 = 目标.获取属性('臣服度');
    目标.修改属性('臣服度', 上下文.效果参数.臣服度增加);
    const 新臣服度 = 目标.获取属性('臣服度');

    return {
      成功: true,
      效果类型: '臣服度增加',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      旧值: 旧臣服度,
      新值: 新臣服度,
      增量: 新臣服度 - 旧臣服度,
    };
  });

  // ─── 淫堕催化 ───
  法术注册表.注册法术('淫堕催化', {
    魔力消耗: 3,
    目标类型: '母畜',
    分类: '操控',
    效果描述: '目标母畜淫乱度直接+50',
    效果参数: {
      淫乱度增加: 50,
    },
    冷却周期: 3,
    图标: '💜',
  });

  法术注册表.注册效果处理器('淫堕催化', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 旧淫乱度 = 目标.获取属性('淫乱度');
    目标.修改属性('淫乱度', 上下文.效果参数.淫乱度增加);
    const 新淫乱度 = 目标.获取属性('淫乱度');

    return {
      成功: true,
      效果类型: '淫乱度增加',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      旧值: 旧淫乱度,
      新值: 新淫乱度,
      增量: 新淫乱度 - 旧淫乱度,
    };
  });

  // ─── 双重催化 ───
  法术注册表.注册法术('双重催化', {
    魔力消耗: 5,
    目标类型: '母畜',
    分类: '操控',
    效果描述: '目标母畜臣服度和淫乱度各+30',
    效果参数: {
      臣服度增加: 30,
      淫乱度增加: 30,
    },
    冷却周期: 4,
    图标: '💫',
  });

  法术注册表.注册效果处理器('双重催化', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 旧臣服度 = 目标.获取属性('臣服度');
    const 旧淫乱度 = 目标.获取属性('淫乱度');

    目标.修改属性('臣服度', 上下文.效果参数.臣服度增加);
    目标.修改属性('淫乱度', 上下文.效果参数.淫乱度增加);

    const 新臣服度 = 目标.获取属性('臣服度');
    const 新淫乱度 = 目标.获取属性('淫乱度');

    return {
      成功: true,
      效果类型: '双重增加',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      臣服度: { 旧值: 旧臣服度, 新值: 新臣服度 },
      淫乱度: { 旧值: 旧淫乱度, 新值: 新淫乱度 },
    };
  });

  // ─── 净化之光 ───
  法术注册表.注册法术('净化之光', {
    魔力消耗: 2,
    目标类型: '母畜',
    分类: '操控',
    效果描述: '目标母畜淫乱度-30（最低为0）',
    效果参数: {
      淫乱度减少: 30,
    },
    冷却周期: 2,
    图标: '✝️',
  });

  法术注册表.注册效果处理器('净化之光', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 旧淫乱度 = 目标.获取属性('淫乱度');
    目标.修改属性('淫乱度', -上下文.效果参数.淫乱度减少);
    const 新淫乱度 = 目标.获取属性('淫乱度');

    return {
      成功: true,
      效果类型: '淫乱度减少',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      旧值: 旧淫乱度,
      新值: 新淫乱度,
      减少量: 旧淫乱度 - 新淫乱度,
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 恢复类法术
  // ═══════════════════════════════════════════════════════════════

  // ─── 孕力回复 ───
  法术注册表.注册法术('孕力回复', {
    魔力消耗: 5,
    目标类型: '母畜',
    分类: '恢复',
    效果描述: '目标母畜剩余雌性价值+100',
    效果参数: {
      雌性价值恢复: 100,
    },
    冷却周期: 5,
    图标: '💖',
  });

  法术注册表.注册效果处理器('孕力回复', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 当前剩余 = 目标.获取属性('剩余雌性价值');
    const 总价值 = 目标.获取属性('总雌性价值');
    const 恢复量 = 上下文.效果参数.雌性价值恢复;

    const 新值 = Math.min(当前剩余 + 恢复量, 总价值);
    const 实际恢复 = 新值 - 当前剩余;

    目标.设置属性('剩余雌性价值', 新值);

    return {
      成功: true,
      效果类型: '雌性价值恢复',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      请求恢复: 恢复量,
      实际恢复: 实际恢复,
      当前剩余: 新值,
      总价值,
    };
  });

  // ─── 完全回复 ───
  法术注册表.注册法术('完全回复', {
    魔力消耗: 10,
    目标类型: '母畜',
    分类: '恢复',
    效果描述: '完全恢复目标母畜的剩余雌性价值',
    效果参数: {},
    冷却周期: 10,
    施放条件: 上下文 => {
      // 需要目标剩余价值低于50%才能施放
      if (!上下文.目标) return true;
      const 剩余 = 上下文.目标.获取属性('剩余雌性价值');
      const 总量 = 上下文.目标.获取属性('总雌性价值');
      return 剩余 < 总量 * 0.5;
    },
    图标: '💗',
  });

  法术注册表.注册效果处理器('完全回复', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 当前剩余 = 目标.获取属性('剩余雌性价值');
    const 总价值 = 目标.获取属性('总雌性价值');

    目标.设置属性('剩余雌性价值', 总价值);

    return {
      成功: true,
      效果类型: '完全恢复',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      恢复量: 总价值 - 当前剩余,
      当前剩余: 总价值,
    };
  });

  // ─── 治愈之手 ───
  法术注册表.注册法术('治愈之手', {
    魔力消耗: 2,
    目标类型: '冠军',
    分类: '恢复',
    效果描述: '立刻治愈目标冠军的负伤状态',
    效果参数: {},
    图标: '🩹',
  });

  法术注册表.注册效果处理器('治愈之手', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    if (!目标.拥有标签('负伤')) {
      return {
        成功: true,
        效果类型: '无需治疗',
        描述: '目标未负伤',
      };
    }

    目标.移除标签('负伤');

    return {
      成功: true,
      效果类型: '治愈负伤',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      描述: '负伤已治愈',
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 军事类法术
  // ═══════════════════════════════════════════════════════════════

  // ─── 士气鼓舞 ───
  法术注册表.注册法术('士气鼓舞', {
    魔力消耗: 2,
    目标类型: '无',
    分类: '军事',
    效果描述: '立刻提升军队士气20点',
    效果参数: {
      士气增加: 20,
    },
    冷却周期: 2,
    图标: '📣',
  });

  法术注册表.注册效果处理器('士气鼓舞', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '士气增加',
      增量: 上下文.效果参数.士气增加,
      描述: '士气+20',
      需要应用到: '军队状态',
    };
  });

  // ─── 狂战祝福 ───
  法术注册表.注册法术('狂战祝福', {
    魔力消耗: 4,
    目标类型: '冠军',
    分类: '军事',
    效果描述: '目标冠军本次战斗所率部曲战力翻倍',
    效果参数: {
      战力倍率: 2,
      持续: '单次战斗',
    },
    冷却周期: 5,
    图标: '⚔️',
  });

  法术注册表.注册效果处理器('狂战祝福', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    目标.添加标签('buff_狂战');

    return {
      成功: true,
      效果类型: '部曲战力增幅',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      倍率: 上下文.效果参数.战力倍率,
      描述: '本次战斗部曲战力翻倍',
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 资源类法术
  // ═══════════════════════════════════════════════════════════════

  // ─── 丰饶祝福 ───
  法术注册表.注册法术('丰饶祝福', {
    魔力消耗: 3,
    目标类型: '无',
    分类: '资源',
    效果描述: '本周所有母畜泌乳产量翻倍',
    效果参数: {
      产量倍率: 2,
      持续: '本周',
    },
    冷却周期: 4,
    图标: '🌾',
  });

  法术注册表.注册效果处理器('丰饶祝福', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '泌乳增幅',
      倍率: 上下文.效果参数.产量倍率,
      描述: '本周泌乳产量翻倍',
      需要标记: true,
      标记名称: 'buff_丰饶',
    };
  });

  // ─── 繁殖祝福 ───
  法术注册表.注册法术('繁殖祝福', {
    魔力消耗: 4,
    目标类型: '母畜',
    分类: '资源',
    效果描述: '目标母畜下次生育产出翻倍',
    效果参数: {
      产出倍率: 2,
    },
    冷却周期: 5,
    图标: '🐣',
  });

  法术注册表.注册效果处理器('繁殖祝福', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    目标.添加标签('buff_繁殖祝福');

    return {
      成功: true,
      效果类型: '繁殖增幅',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      倍率: 上下文.效果参数.产出倍率,
      描述: '下次生育产出翻倍',
    };
  });

  // ═══════════════════════════════════════════════════════════════
  // 特殊法术
  // ═══════════════════════════════════════════════════════════════

  // ─── 强制献祭 ───
  法术注册表.注册法术('强制献祭', {
    魔力消耗: 0, // 不消耗魔力，反而获得魔力
    目标类型: '母畜',
    分类: '特殊',
    效果描述: '强制将淫乱度≥80的母畜献祭，获得魔力',
    效果参数: {},
    施放条件: 上下文 => {
      if (!上下文.目标) return false;
      return 上下文.目标.获取属性('淫乱度') >= 80;
    },
    图标: '🔥',
  });

  法术注册表.注册效果处理器('强制献祭', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 淫乱度 = 目标.获取属性('淫乱度');
    if (淫乱度 < 80) {
      return { 成功: false, 原因: '淫乱度不足80' };
    }

    const 总雌性价值 = 目标.获取属性('总雌性价值');
    // 强制献祭效率略低于完全淫堕献祭
    const 效率 = 淫乱度 / 100; // 80%~100%
    const 魔力获得 = Math.floor((总雌性价值 / 100) * 效率);

    return {
      成功: true,
      效果类型: '强制献祭',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      魔力获得,
      需移除母畜: true,
      描述: `献祭获得${魔力获得}点魔力`,
    };
  });

  // ─── 时间加速 ───
  法术注册表.注册法术('时间加速', {
    魔力消耗: 8,
    目标类型: '无',
    分类: '特殊',
    效果描述: '立刻进入下一周（跳过本周剩余行动点）',
    效果参数: {},
    冷却周期: 10,
    施放条件: 上下文 => true,
    图标: '⏰',
  });

  法术注册表.注册效果处理器('时间加速', (目标, 上下文) => {
    return {
      成功: true,
      效果类型: '时间加速',
      描述: '立刻进入下一周',
      需要应用到: '时间系统',
      特殊操作: '强制周结算',
    };
  });

  // ─── 命运改写 ───
  法术注册表.注册法术('命运改写', {
    魔力消耗: 10,
    目标类型: '母畜',
    分类: '特殊',
    效果描述: '将目标母畜的总雌性价值提升50%',
    效果参数: {
      价值提升比例: 0.5,
    },
    冷却周期: 20,
    图标: '⭐',
  });

  法术注册表.注册效果处理器('命运改写', (目标, 上下文) => {
    if (!目标) {
      return { 成功: false, 原因: '无目标' };
    }

    const 原总价值 = 目标.获取属性('总雌性价值');
    const 原剩余价值 = 目标.获取属性('剩余雌性价值');
    const 提升量 = Math.floor(原总价值 * 上下文.效果参数.价值提升比例);

    const 新总价值 = 原总价值 + 提升量;
    const 新剩余价值 = 原剩余价值 + 提升量;

    目标.设置属性('总雌性价值', 新总价值);
    目标.设置属性('剩余雌性价值', 新剩余价值);

    return {
      成功: true,
      效果类型: '价值提升',
      目标ID: 目标.实体ID,
      目标姓名: 目标.获取属性('姓名'),
      原总价值,
      新总价值,
      提升量,
      描述: `总雌性价值提升${提升量}`,
    };
  });
}

// ═══════════════════════════════════════════════════════════════
// 法术分类说明
// ═══════════════════════════════════════════════════════════════

const 法术分类说明 = {
  增益: {
    描述: '临时增强效果，通常持续单次行动或战斗',
    图标: '✨',
  },
  情报: {
    描述: '与情报收集相关的法术',
    图标: '👁️',
  },
  操控: {
    描述: '直接影响母畜属性的法术',
    图标: '💜',
  },
  恢复: {
    描述: '恢复类法术，用于治疗或恢复资源',
    图标: '💖',
  },
  军事: {
    描述: '影响军队战斗力或士气的法术',
    图标: '⚔️',
  },
  资源: {
    描述: '影响资源产出的法术',
    图标: '🌾',
  },
  特殊: {
    描述: '特殊效果法术',
    图标: '⭐',
  },
};

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 初始化法术配置, 法术分类说明 };
export default 初始化法术配置;
