// ═══════════════════════════════════════════════════════════════
// game/controller.js
// 游戏控制器 - 统一管理所有系统，提供高层API
// ═══════════════════════════════════════════════════════════════

import { 游戏状态 } from './state.js';
import { 事件总线 } from '../systems/event-bus.js';
import { 公式引擎 } from '../systems/formula.js';
import { 时间系统 } from '../systems/time.js';
import { 资源系统 } from '../systems/resource.js';
import { 任务系统 } from '../systems/task.js';
import { 情报系统 } from '../systems/intel.js';
import { 战斗系统 } from '../systems/combat.js';
import { 繁殖系统 } from '../systems/breeding.js';
import { 法术系统 } from '../systems/spell.js';
import { 黑市系统 } from '../systems/market.js';

import { 属性定义注册表, 任务定义注册表, 法术定义注册表, 商品定义注册表 } from '../core/registries.js';
import { 工厂管理器 } from '../core/factories.js';

import { 初始化属性配置 } from '../config/attributes.js';
import { 初始化任务配置 } from '../config/tasks.js';
import { 初始化法术配置 } from '../config/spells.js';
import { 初始化商品配置 } from '../config/items.js';
import { 初始化公式配置 } from '../config/formulas.js';

/**
 * 游戏控制器
 * 作为游戏的中央协调器，负责初始化、管理所有系统并提供统一API
 */
class 游戏控制器 {
  constructor(配置 = {}) {
    // ─── 控制器状态 ───
    this.已初始化 = false;
    this.配置 = {
      游戏版本: '1.0.0',
      调试模式: false,
      自动保存: true,
      自动保存间隔: 5, // 每5周自动保存
      ...配置,
    };

    // ─── 核心组件占位 ───
    this.事件总线 = null;
    this.游戏状态 = null;

    // ─── 注册表 ───
    this.属性注册表 = null;
    this.任务注册表 = null;
    this.法术注册表 = null;
    this.商品注册表 = null;

    // ─── 工厂 ───
    this.工厂管理器 = null;

    // ─── 引擎与系统 ───
    this.公式引擎 = null;
    this.时间系统 = null;
    this.资源系统 = null;
    this.任务系统 = null;
    this.情报系统 = null;
    this.战斗系统 = null;
    this.繁殖系统 = null;
    this.法术系统 = null;
    this.黑市系统 = null;

    // ─── 插件系统 ───
    this.插件列表 = [];
    this.插件钩子 = new Map();

    // ─── 存档管理 ───
    this.存档适配器 = 配置.存档适配器 ?? null;
    this.当前存档名 = null;

    // ─── 游戏循环状态 ───
    this.游戏运行中 = false;
  }

  // ═══════════════════════════════════════════════════════════════
  // 初始化
  // ═══════════════════════════════════════════════════════════════

  初始化() {
    /**
     * 初始化游戏控制器及所有子系统
     * 必须在开始游戏前调用
     */
    if (this.已初始化) {
      console.warn('游戏控制器已初始化，跳过重复初始化');
      return this;
    }

    // 1. 创建事件总线
    this.事件总线 = new 事件总线({
      调试模式: this.配置.调试模式,
      启用历史记录: true,
    });

    // 2. 创建注册表
    this.属性注册表 = new 属性定义注册表();
    this.任务注册表 = new 任务定义注册表();
    this.法术注册表 = new 法术定义注册表();
    this.商品注册表 = new 商品定义注册表();

    // 3. 创建公式引擎
    this.公式引擎 = new 公式引擎();

    // 4. 加载默认配置
    this.加载默认配置();

    // 5. 创建工厂管理器
    this.工厂管理器 = new 工厂管理器(this.属性注册表);
    this.配置工厂();

    // 6. 创建各系统（暂时不传入游戏状态依赖）
    this.创建系统();

    // 7. 注入系统间依赖
    this.注入系统依赖();

    // 8. 注册周结算处理器
    this.注册周结算处理器();

    // 9. 初始化插件
    this.初始化插件();

    this.已初始化 = true;

    this.事件总线.发布('控制器初始化完成', { 版本: this.配置.游戏版本 });

    return this;
  }

  加载默认配置() {
    // 加载属性配置
    初始化属性配置(this.属性注册表);

    // 加载公式配置
    初始化公式配置(this.公式引擎);

    // 加载任务配置
    初始化任务配置(this.任务注册表);

    // 加载法术配置
    初始化法术配置(this.法术注册表);

    // 加载商品配置
    初始化商品配置(this.商品注册表);
  }

  配置工厂() {
    const 冠军工厂 = this.工厂管理器.获取冠军工厂();
    const 母畜工厂 = this.工厂管理器.获取母畜工厂();
    const 袭击目标工厂 = this.工厂管理器.获取袭击目标工厂();

    // 初始化女性随机配置
    const { 女性随机配置, 初始化女性随机配置 } = require('../config/female-generation.js');
    const 女性配置实例 = new 女性随机配置();
    初始化女性随机配置(女性配置实例);
    this.工厂管理器.设置女性随机配置(女性配置实例);

    // 初始化袭击目标类型配置
    const { 袭击目标类型配置 } = require('../config/raid-targets.js');
    if (袭击目标类型配置) {
      袭击目标工厂.批量注册目标类型(袭击目标类型配置);
    }

    // 从配置导入效率系数（原有逻辑）
    try {
      const { 冠军效率系数配置, 身份价值配置, 种族价值修正配置 } = require('../config/attributes.js');

      if (冠军效率系数配置) {
        冠军工厂.批量注册效率系数(冠军效率系数配置);
      }
      if (身份价值配置) {
        母畜工厂.批量注册身份价值(身份价值配置);
      }
      if (种族价值修正配置) {
        Object.entries(种族价值修正配置).forEach(([种族, 修正]) => {
          母畜工厂.注册种族价值修正(种族, 修正);
        });
      }
    } catch (e) {
      // 配置可能未导出，使用默认值
    }
  }

  创建系统() {
    // 时间系统
    this.时间系统 = new 时间系统(this.事件总线, {
      周行动点上限: 3,
    });

    // 资源系统
    this.资源系统 = new 资源系统(this.事件总线);
    this.资源系统.注册资源类型('母乳', {
      初始值: 0,
      最小值: 0,
      描述: '母畜产出的母乳，用于黑市交易',
    });

    // 情报系统
    this.情报系统 = new 情报系统(this.事件总线, this.公式引擎);

    // 战斗系统
    this.战斗系统 = new 战斗系统(this.事件总线, this.公式引擎, this.情报系统);

    // 任务系统（需要任务注册表）
    this.任务系统 = new 任务系统(this.事件总线, this.任务注册表, this.时间系统, this.公式引擎);

    // 繁殖系统（需要冠军工厂和喽啰池，稍后绑定）
    this.繁殖系统 = new 繁殖系统(this.事件总线, this.工厂管理器.获取冠军工厂(), null, this.属性注册表);

    // 法术系统
    this.法术系统 = new 法术系统(this.事件总线, this.法术注册表, null);

    // 黑市系统
    this.黑市系统 = new 黑市系统(this.事件总线, this.商品注册表, this.资源系统);
  }

  注入系统依赖() {
    // 任务注册表注入系统依赖
    this.任务注册表.注入系统依赖({
      事件总线: this.事件总线,
      公式引擎: this.公式引擎,
      属性注册表: this.属性注册表,
      情报系统: this.情报系统,
      繁殖系统: this.繁殖系统,
      资源系统: this.资源系统,
      母畜工厂: this.工厂管理器.获取母畜工厂(),
    });
  }

  注册周结算处理器() {
    // 资源产出（泌乳）
    this.时间系统.注册周结算处理器(游戏状态 => {
      if (!游戏状态) return null;

      // 泌乳产出
      let 总泌乳量 = 0;
      const 泌乳母畜 = 游戏状态.获取泌乳状态母畜();

      泌乳母畜.forEach(母畜 => {
        const 产量 = this.公式引擎.计算('泌乳产量', {
          淫乱度: 母畜.获取属性('淫乱度'),
        });
        总泌乳量 += 产量;

        // 泌乳增加淫乱度
        母畜.修改属性('淫乱度', 3, this.属性注册表);
      });

      if (总泌乳量 > 0) {
        this.资源系统.增加资源('母乳', 总泌乳量, '周结算泌乳');
      }

      return {
        类型: '泌乳产出',
        泌乳母畜数: 泌乳母畜.length,
        总产量: 总泌乳量,
      };
    }, 100);

    // 士气衰减
    this.时间系统.注册周结算处理器(游戏状态 => {
      if (!游戏状态) return null;

      const 旧士气 = 游戏状态.获取士气();
      游戏状态.修改士气(-5);

      return {
        类型: '士气衰减',
        旧士气,
        新士气: 游戏状态.获取士气(),
        衰减量: 5,
      };
    }, 50);

    // 情报衰减
    this.时间系统.注册周结算处理器(游戏状态 => {
      const 衰减记录 = this.情报系统.周结算处理(this.时间系统.当前周次);
      return {
        类型: '情报衰减',
        衰减目标数: 衰减记录.length,
        详情: 衰减记录,
      };
    }, 40);

    // 任务系统周重置
    this.时间系统.注册周结算处理器(() => {
      return this.任务系统.周结算处理();
    }, 30);

    // 自动保存
    this.时间系统.注册周结算处理器(游戏状态 => {
      if (!this.配置.自动保存) return null;

      if (this.时间系统.当前周次 % this.配置.自动保存间隔 === 0) {
        this.自动保存();
        return { 类型: '自动保存' };
      }
      return null;
    }, 10);

    // 新周处理：刷新黑市
    this.时间系统.注册新周处理器(游戏状态 => {
      const 刷新结果 = this.黑市系统.刷新商品(this.时间系统.当前周次, { 游戏状态 });

      this.法术系统.设置当前周次(this.时间系统.当前周次);
      this.情报系统.设置当前周次(this.时间系统.当前周次);
    }, 100);
  }

  初始化插件() {
    this.插件列表.forEach(插件 => {
      try {
        if (typeof 插件.初始化 === 'function') {
          插件.初始化(this);
        }
      } catch (错误) {
        console.error(`插件初始化失败 [${插件.名称 ?? '未知'}]:`, 错误);
      }
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // 游戏生命周期
  // ═══════════════════════════════════════════════════════════════

  创建新游戏(配置 = {}) {
    /**
     * 创建新游戏
     */
    if (!this.已初始化) {
      this.初始化();
    }

    // 创建游戏状态
    this.游戏状态 = 游戏状态.创建新游戏({
      游戏版本: this.配置.游戏版本,
      存档名称: 配置.存档名称 ?? '新游戏',
      领主姓名: 配置.领主姓名,
      初始魔力: 配置.初始魔力 ?? 0,
      初始喽啰数量: 配置.初始喽啰数量 ?? 50,
      ...配置,
    });

    // 绑定游戏状态到各系统
    this.绑定游戏状态();

    // 发布新游戏事件
    this.事件总线.发布('新游戏开始', {
      存档名称: this.游戏状态.元数据.存档名称,
    });

    // 刷新首周黑市
    this.黑市系统.刷新商品(1, { 游戏状态: this.游戏状态 });

    this.游戏运行中 = true;

    // 执行插件钩子
    this.执行插件钩子('新游戏开始', { 游戏状态: this.游戏状态 });

    return this.游戏状态;
  }

  绑定游戏状态() {
    // 繁殖系统绑定喽啰池
    this.繁殖系统.设置喽啰池(this.游戏状态.获取喽啰池());

    // 法术系统绑定领主
    this.法术系统.设置领主(this.游戏状态.获取领主());

    // 任务注册表更新游戏状态引用
    this.任务注册表.注入系统依赖({
      游戏状态: this.游戏状态,
    });
  }

  加载游戏(存档数据) {
    /**
     * 从存档数据加载游戏
     */
    if (!this.已初始化) {
      this.初始化();
    }

    try {
      // 恢复游戏状态
      this.游戏状态 = 游戏状态.从存档加载(存档数据, {
        游戏版本: this.配置.游戏版本,
      });

      // 恢复各系统状态
      if (存档数据.系统状态) {
        this.恢复系统状态(存档数据.系统状态);
      }

      // 绑定游戏状态
      this.绑定游戏状态();

      this.事件总线.发布('游戏加载完成', {
        存档名称: this.游戏状态.元数据.存档名称,
        周次: this.时间系统.当前周次,
      });

      this.游戏运行中 = true;

      // 执行插件钩子
      this.执行插件钩子('游戏加载', { 游戏状态: this.游戏状态 });

      return { 成功: true, 游戏状态: this.游戏状态 };
    } catch (错误) {
      console.error('加载游戏失败:', 错误);
      return { 成功: false, 原因: 错误.message };
    }
  }

  恢复系统状态(系统状态) {
    if (系统状态.时间系统) {
      this.时间系统.从序列化恢复(系统状态.时间系统);
    }
    if (系统状态.资源系统) {
      this.资源系统.从序列化恢复(系统状态.资源系统);
    }
    if (系统状态.情报系统) {
      this.情报系统.从序列化恢复(系统状态.情报系统);
    }
    if (系统状态.任务系统) {
      this.任务系统.从序列化恢复(系统状态.任务系统);
    }
    if (系统状态.法术系统) {
      this.法术系统.从序列化恢复(系统状态.法术系统);
    }
    if (系统状态.黑市系统) {
      this.黑市系统.从序列化恢复(系统状态.黑市系统);
    }
    if (系统状态.战斗系统) {
      this.战斗系统.从序列化恢复(系统状态.战斗系统);
    }
    if (系统状态.繁殖系统) {
      this.繁殖系统.从序列化恢复(系统状态.繁殖系统);
    }
  }

  保存游戏() {
    /**
     * 保存当前游戏状态
     */
    if (!this.游戏状态) {
      return { 成功: false, 原因: '无游戏状态可保存' };
    }

    const 存档数据 = {
      版本: this.配置.游戏版本,
      保存时间: Date.now(),
      游戏状态: this.游戏状态.序列化(),
      系统状态: {
        时间系统: this.时间系统.序列化(),
        资源系统: this.资源系统.序列化(),
        情报系统: this.情报系统.序列化(),
        任务系统: this.任务系统.序列化(),
        法术系统: this.法术系统.序列化(),
        黑市系统: this.黑市系统.序列化(),
        战斗系统: this.战斗系统.序列化(),
        繁殖系统: this.繁殖系统.序列化(),
      },
    };

    // 执行插件钩子
    this.执行插件钩子('保存前', { 存档数据 });

    // 如果有存档适配器，使用它保存
    if (this.存档适配器) {
      try {
        this.存档适配器.保存(this.当前存档名 ?? 'autosave', 存档数据);
      } catch (错误) {
        console.error('存档适配器保存失败:', 错误);
      }
    }

    this.事件总线.发布('游戏保存', {
      存档名称: this.游戏状态.元数据.存档名称,
    });

    return { 成功: true, 存档数据 };
  }

  自动保存() {
    const 结果 = this.保存游戏();
    if (结果.成功) {
      this.事件总线.发布('自动保存完成', {
        周次: this.时间系统.当前周次,
      });
    }
    return 结果;
  }

  // ═══════════════════════════════════════════════════════════════
  // 游戏流程控制
  // ═══════════════════════════════════════════════════════════════

  结束当前周() {
    /**
     * 结束当前周，触发周结算
     */
    if (!this.游戏运行中) {
      return { 成功: false, 原因: '游戏未运行' };
    }

    // 执行插件钩子
    this.执行插件钩子('周结算前', {
      周次: this.时间系统.当前周次,
    });

    const 结果 = this.时间系统.结束当前周(this.游戏状态);

    // 执行插件钩子
    this.执行插件钩子('周结算后', {
      周次: this.时间系统.当前周次,
      结果,
    });

    return 结果;
  }

  暂停游戏() {
    this.时间系统.暂停();
    this.游戏运行中 = false;
  }

  恢复游戏() {
    this.时间系统.恢复();
    this.游戏运行中 = true;
  }

  // ═══════════════════════════════════════════════════════════════
  // 高层API - 任务
  // ═══════════════════════════════════════════════════════════════

  执行任务(任务名, 负责人ID, 额外参数 = {}) {
    /**
     * 执行任务的统一入口
     */
    if (!this.游戏运行中) {
      return { 成功: false, 原因: '游戏未运行' };
    }

    // 获取负责人实体
    let 负责人 = this.游戏状态.获取冠军(负责人ID);
    if (!负责人) {
      负责人 = this.游戏状态.获取母畜(负责人ID);
    }

    if (!负责人) {
      return { 成功: false, 原因: '负责人不存在' };
    }

    return this.任务系统.执行任务(任务名, 负责人, this.游戏状态, 额外参数);
  }

  获取可执行任务(负责人ID) {
    /**
     * 获取指定负责人可执行的任务列表
     */
    let 负责人 = this.游戏状态.获取冠军(负责人ID);
    if (!负责人) {
      负责人 = this.游戏状态.获取母畜(负责人ID);
    }

    if (!负责人) return [];

    return this.任务系统.获取可执行任务列表(负责人, this.游戏状态);
  }

  // ═══════════════════════════════════════════════════════════════
  // 高层API - 战斗
  // ═══════════════════════════════════════════════════════════════

  发起战斗(出击配置, 目标ID) {
    /**
     * 发起战斗
     * @param 出击配置 - { 部曲列表: [{ 冠军ID, 喽啰配置 }] }
     */
    if (!this.游戏运行中) {
      return { 成功: false, 原因: '游戏未运行' };
    }

    // 消耗行动点
    const 消耗结果 = this.时间系统.消耗行动点(1);
    if (!消耗结果.成功) {
      return { 成功: false, 原因: 消耗结果.原因 };
    }

    // 构建完整出击配置
    const 完整配置 = {
      部曲列表: 出击配置.部曲列表.map(部曲 => ({
        冠军: this.游戏状态.获取冠军(部曲.冠军ID),
        喽啰配置: 部曲.喽啰配置,
      })),
      士气: this.游戏状态.获取士气(),
    };

    // 获取目标情报
    const 目标情报 = this.情报系统.获取目标情报(目标ID);
    if (!目标情报) {
      return { 成功: false, 原因: '目标不存在' };
    }

    // 执行战斗
    const 战斗结果 = this.战斗系统.执行战斗(完整配置, 目标情报.实际战力, { 目标ID });

    // 应用战斗结果
    this.应用战斗结果(战斗结果);

    return { 成功: true, 战斗结果 };
  }

  应用战斗结果(战斗结果) {
    // 处理喽啰损失
    if (战斗结果.喽啰损失?.明细) {
      战斗结果.喽啰损失.明细.forEach(损失 => {
        this.游戏状态.减少喽啰(损失.损失数量, 损失.武装等级);
      });
    }

    // 处理冠军损失
    if (战斗结果.冠军损失?.损失情况) {
      战斗结果.冠军损失.损失情况.forEach(损失 => {
        const 冠军 = this.游戏状态.获取冠军(损失.冠军ID);
        if (冠军) {
          if (损失.状态 === '阵亡') {
            this.游戏状态.移除冠军(损失.冠军ID);
          } else if (损失.状态 === '负伤') {
            冠军.添加标签('负伤');
          }
        }
      });
    }

    // 士气变化
    if (战斗结果.士气变化) {
      this.游戏状态.修改士气(战斗结果.士气变化);
    }

    // 处理战利品（俘获目标）
    if (战斗结果.战利品?.俘获目标) {
      战斗结果.战利品.俘获目标.forEach(目标信息 => {
        const 新母畜 = this.工厂管理器.获取母畜工厂().从战斗俘获创建({
          目标信息,
          俘获来源: `战斗俘获`,
        });
        this.游戏状态.添加母畜(新母畜);
      });
    }

    // 更新统计
    this.游戏状态.更新统计('总战斗次数');
    if (战斗结果.是否胜利) {
      this.游戏状态.更新统计('总胜利次数');
    }
  }

  预估战斗结果(出击配置, 目标ID) {
    /**
     * 预估战斗结果（不消耗行动点）
     */
    const 目标情报 = this.情报系统.获取目标情报(目标ID);
    if (!目标情报) return null;

    const 战力估值 = this.情报系统.获取战力估值(目标ID);
    if (!战力估值) return null;

    const 完整配置 = {
      部曲列表: 出击配置.部曲列表.map(部曲 => ({
        冠军: this.游戏状态.获取冠军(部曲.冠军ID),
        喽啰配置: 部曲.喽啰配置,
      })),
      士气: this.游戏状态.获取士气(),
    };

    return this.战斗系统.预估战斗结果(完整配置, {
      最小: 战力估值.估计最小,
      最大: 战力估值.估计最大,
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // 高层API - 繁殖
  // ═══════════════════════════════════════════════════════════════

  生育冠军(母畜ID) {
    /**
     * 母畜生育冠军
     */
    const 母畜 = this.游戏状态.获取母畜(母畜ID);
    if (!母畜) {
      return { 成功: false, 原因: '母畜不存在' };
    }

    // 检查行动点需求
    const 臣服度 = 母畜.获取属性('臣服度');
    const 行动点需求 = 臣服度 >= 25 ? 1 : 2;

    const 消耗结果 = this.时间系统.消耗行动点(行动点需求);
    if (!消耗结果.成功) {
      return { 成功: false, 原因: 消耗结果.原因 };
    }

    const 结果 = this.繁殖系统.生育冠军(母畜);

    if (结果.成功) {
      this.游戏状态.添加冠军(结果.冠军);
    }

    return 结果;
  }

  生育喽啰(母畜ID) {
    /**
     * 母畜生育喽啰
     */
    const 母畜 = this.游戏状态.获取母畜(母畜ID);
    if (!母畜) {
      return { 成功: false, 原因: '母畜不存在' };
    }

    // 检查行动点需求
    const 臣服度 = 母畜.获取属性('臣服度');
    if (臣服度 < 25) {
      const 消耗结果 = this.时间系统.消耗行动点(1);
      if (!消耗结果.成功) {
        return { 成功: false, 原因: 消耗结果.原因 };
      }
    }

    return this.繁殖系统.生育喽啰(母畜);
  }

  // ═══════════════════════════════════════════════════════════════
  // 高层API - 法术
  // ═══════════════════════════════════════════════════════════════

  施放法术(法术名, 目标ID = null) {
    /**
     * 施放法术
     */
    let 目标 = null;
    if (目标ID) {
      目标 = this.游戏状态.获取冠军(目标ID) ?? this.游戏状态.获取母畜(目标ID);
    }

    const 结果 = this.法术系统.施放法术(法术名, 目标);

    // 处理特殊效果
    if (结果.成功 && 结果.效果结果) {
      this.应用法术效果(法术名, 结果.效果结果);
    }

    return 结果;
  }

  应用法术效果(法术名, 效果结果) {
    // 根据效果类型处理
    if (效果结果.需要应用到 === '时间系统') {
      if (效果结果.效果类型 === '行动点增加') {
        this.时间系统.恢复行动点(效果结果.增量);
      }
    }

    if (效果结果.需要应用到 === '情报系统') {
      // 情报相关效果
    }

    if (效果结果.需要应用到 === '军队状态') {
      if (效果结果.效果类型 === '士气增加') {
        this.游戏状态.修改士气(效果结果.增量);
      }
    }

    if (效果结果.需移除母畜) {
      this.游戏状态.移除母畜(效果结果.目标ID);
      this.游戏状态.更新统计('总献祭母畜数');
    }

    // 魔力获得
    if (效果结果.魔力获得) {
      this.游戏状态.获取领主().获得魔力(效果结果.魔力获得);
      this.游戏状态.更新统计('总获得魔力', 效果结果.魔力获得);
    }
  }

  献祭母畜(母畜ID) {
    /**
     * 献祭母畜获得魔力
     */
    const 母畜 = this.游戏状态.获取母畜(母畜ID);
    if (!母畜) {
      return { 成功: false, 原因: '母畜不存在' };
    }

    const 结果 = this.法术系统.献祭母畜(母畜);

    if (结果.成功 && 结果.需移除母畜) {
      this.游戏状态.移除母畜(母畜ID);
      this.游戏状态.更新统计('总献祭母畜数');
      this.游戏状态.更新统计('总获得魔力', 结果.魔力获得);
    }

    return 结果;
  }

  // ═══════════════════════════════════════════════════════════════
  // 高层API - 黑市
  // ═══════════════════════════════════════════════════════════════

  获取黑市商品() {
    return this.黑市系统.获取可用商品列表();
  }

  购买商品(商品名, 数量 = 1) {
    const 结果 = this.黑市系统.购买商品(商品名, 数量);

    if (结果.成功) {
      // 应用商品效果
      this.应用商品效果(结果.效果);
    }

    return 结果;
  }

  应用商品效果(效果) {
    if (!效果) return;

    switch (效果.类型) {
      case '获得母畜':
        const 新母畜 = this.工厂管理器.获取母畜工厂().从黑市购买创建(效果);
        this.游戏状态.添加母畜(新母畜);
        break;

      case '武装升级':
        // 武装升级需要UI交互选择喽啰
        break;

      case '属性增加':
      case '属性设置':
        // 需要目标选择
        break;

      case '士气增加':
        this.游戏状态.修改士气(效果.增加量);
        break;

      case '魔力水晶':
        this.游戏状态.获取领主()?.获得魔力(效果.魔力恢复);
        break;

      // 其他效果类型...
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // 高层API - 侦察与情报
  // ═══════════════════════════════════════════════════════════════

  创建侦察目标(目标配置) {
    /**
     * 创建新的侦察目标
     */
    return this.情报系统.创建目标(目标配置.目标ID ?? this.生成目标ID(), 目标配置);
  }

  生成目标ID() {
    return `target_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`;
  }

  获取目标情报(目标ID) {
    return this.情报系统.获取目标情报(目标ID);
  }

  获取所有侦察目标() {
    return this.情报系统.获取所有目标();
  }

  // ═══════════════════════════════════════════════════════════════
  // 插件系统
  // ═══════════════════════════════════════════════════════════════

  注册插件(插件) {
    /**
     * 注册插件
     * 插件结构: { 名称, 版本, 初始化(控制器), 钩子: { 钩子名: 处理函数 } }
     */
    this.插件列表.push(插件);

    // 注册钩子
    if (插件.钩子) {
      Object.entries(插件.钩子).forEach(([钩子名, 处理函数]) => {
        if (!this.插件钩子.has(钩子名)) {
          this.插件钩子.set(钩子名, []);
        }
        this.插件钩子.get(钩子名).push({
          插件名: 插件.名称,
          处理函数,
        });
      });
    }

    // 如果已初始化，立即初始化插件
    if (this.已初始化 && typeof 插件.初始化 === 'function') {
      插件.初始化(this);
    }
  }

  执行插件钩子(钩子名, 数据) {
    const 钩子列表 = this.插件钩子.get(钩子名);
    if (!钩子列表) return;

    钩子列表.forEach(({ 插件名, 处理函数 }) => {
      try {
        处理函数(数据, this);
      } catch (错误) {
        console.error(`插件钩子执行失败 [${插件名}:${钩子名}]:`, 错误);
      }
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // 调试与工具
  // ═══════════════════════════════════════════════════════════════

  获取游戏概览() {
    if (!this.游戏状态) return null;

    return {
      ...this.游戏状态.获取游戏概览(),
      时间: this.时间系统.获取时间状态(),
      资源: this.资源系统.获取所有资源(),
      黑市: this.黑市系统.获取黑市状态(),
    };
  }

  获取详细状态() {
    if (!this.游戏状态) return null;

    return {
      游戏状态: this.游戏状态.获取详细状态(),
      时间系统: this.时间系统.获取时间状态(),
      资源系统: this.资源系统.获取所有资源(),
      情报系统: this.情报系统.获取所有目标(),
      任务统计: this.任务注册表.获取所有统计(),
    };
  }

  设置调试模式(启用) {
    this.配置.调试模式 = 启用;
    this.事件总线.设置调试模式(启用);
  }

  // ─── 快捷访问器 ───

  get 周次() {
    return this.时间系统?.当前周次 ?? 0;
  }

  get 行动点() {
    return this.时间系统?.剩余行动点 ?? 0;
  }

  get 领主() {
    return this.游戏状态?.获取领主();
  }

  get 冠军列表() {
    return this.游戏状态?.获取所有冠军() ?? [];
  }

  get 母畜列表() {
    return this.游戏状态?.获取所有母畜() ?? [];
  }

  get 喽啰总数() {
    return this.游戏状态?.获取喽啰总数() ?? 0;
  }

  get 士气() {
    return this.游戏状态?.获取士气() ?? 0;
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 游戏控制器 };
export default 游戏控制器;
