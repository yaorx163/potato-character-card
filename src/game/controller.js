// ═══════════════════════════════════════════════════════════════
// game/controller.js
// 游戏控制器 - 统一管理所有系统，提供高层API
// ═══════════════════════════════════════════════════════════════

import { 游戏状态 } from './state.js';
import { 事件总线 } from '../systems/event-bus.js';
import { 公式引擎 } from '../systems/formula.js';
import { 时间系统 } from '../systems/time.js';
import { 资源系统 } from '../systems/resource.js';
import { 任务系统 } from '../systems/task.js';
import { 战斗系统 } from '../systems/combat.js';
import { 繁殖系统 } from '../systems/breeding.js';
import { 法术系统 } from '../systems/spell.js';
import { 黑市系统 } from '../systems/market.js';

import { 属性定义注册表, 任务定义注册表, 法术定义注册表, 商品定义注册表 } from '../core/registries.js';
import { 工厂管理器 } from '../core/factories.js';

import { 初始化属性配置 } from '../config/attributes.js';
import { 初始化任务配置 } from '../config/tasks.js';
import { 初始化法术配置 } from '../config/spells.js';
import { 初始化商品配置 } from '../config/items.js';
import { 初始化公式配置 } from '../config/formulas.js';

import { 女性随机配置, 初始化女性随机配置 } from '../config/female-generation.js';
import { 可袭击地点类型配置 } from '../config/raid-targets.js';

/**
 * 游戏控制器
 * 作为游戏的中央协调器，负责初始化、管理所有系统并提供统一API
 */
class 游戏控制器 {
  constructor(配置 = {}) {
    // ─── 控制器状态 ───
    this.已初始化 = false;
    this.配置 = {
      游戏版本: '1.0.0',
      调试模式: false,
      自动保存: true,
      自动保存间隔: 5, // 每5周自动保存
      ...配置,
    };

    // ─── 核心组件占位 ───
    this.事件总线 = null;
    this.游戏状态 = null;

    // ─── 注册表 ───
    this.属性注册表 = null;
    this.任务注册表 = null;
    this.法术注册表 = null;
    this.商品注册表 = null;

    // ─── 工厂 ───
    this.工厂管理器 = null;

    // ─── 引擎与系统 ───
    this.公式引擎 = null;
    this.时间系统 = null;
    this.资源系统 = null;
    this.任务系统 = null;
    this.战斗系统 = null;
    this.繁殖系统 = null;
    this.法术系统 = null;
    this.黑市系统 = null;

    // ─── 存档管理 ───
    this.存档适配器 = 配置.存档适配器 ?? null;
    this.当前存档名 = null;

    // ─── 游戏循环状态 ───
    this.游戏运行中 = false;
  }

  // ═══════════════════════════════════════════════════════════════
  // 初始化
  // ═══════════════════════════════════════════════════════════════

  初始化() {
    /**
     * 初始化游戏控制器及所有子系统
     * 必须在开始游戏前调用
     */
    if (this.已初始化) {
      console.warn('游戏控制器已初始化，跳过重复初始化');
      return this;
    }

    // 1. 创建事件总线
    this.事件总线 = new 事件总线({
      调试模式: this.配置.调试模式,
      启用历史记录: true,
    });

    // 2. 创建注册表
    this.属性注册表 = new 属性定义注册表();
    this.任务注册表 = new 任务定义注册表();
    this.法术注册表 = new 法术定义注册表();
    this.商品注册表 = new 商品定义注册表();

    // 3. 创建公式引擎
    this.公式引擎 = new 公式引擎();

    // 4. 加载默认配置
    this.加载默认配置();

    // 5. 创建工厂管理器
    this.工厂管理器 = new 工厂管理器(this.属性注册表);
    this.配置工厂();

    // 6. 创建各系统（暂时不传入游戏状态依赖）
    this.创建系统();

    // 7. 注入系统间依赖
    this.注入系统依赖();

    // 8. 注册周结算处理器
    this.注册周结算处理器();

    // 9. 初始化插件
    this.初始化插件();

    this.已初始化 = true;

    this.事件总线.发布('控制器初始化完成', { 版本: this.配置.游戏版本 });

    return this;
  }

  加载默认配置() {
    // 加载属性配置
    初始化属性配置(this.属性注册表);

    // 加载公式配置
    初始化公式配置(this.公式引擎);

    // 加载任务配置
    初始化任务配置(this.任务注册表);

    // 加载法术配置
    初始化法术配置(this.法术注册表);

    // 加载商品配置
    初始化商品配置(this.商品注册表);
  }

  配置工厂() {
    const 冠军工厂 = this.工厂管理器.获取冠军工厂();
    const 母畜工厂 = this.工厂管理器.获取母畜工厂();
    const 可袭击地点工厂 = this.工厂管理器.获取可袭击地点工厂();

    // 初始化女性随机配置

    const 女性配置实例 = new 女性随机配置();
    初始化女性随机配置(女性配置实例);
    this.工厂管理器.设置女性随机配置(女性配置实例);

    // 初始化可袭击地点类型配置
    if (可袭击地点类型配置) {
      可袭击地点工厂.批量注册目标类型(可袭击地点类型配置);
    }

    // 从配置导入效率系数（原有逻辑）
    try {
      const { 冠军效率系数配置, 身份雌性价值配置, 种族价值修正配置 } = require('../config/attributes.js');

      if (冠军效率系数配置) {
        冠军工厂.批量注册效率系数(冠军效率系数配置);
      }
      if (身份雌性价值配置) {
        母畜工厂.批量注册身份价值(身份雌性价值配置);
      }
      if (种族价值修正配置) {
        Object.entries(种族价值修正配置).forEach(([种族, 修正]) => {
          母畜工厂.注册种族价值修正(种族, 修正);
        });
      }
    } catch (e) {
      // 配置可能未导出，使用默认值
    }
  }

  创建系统() {
    // 时间系统
    this.时间系统 = new 时间系统(this.事件总线, {
      周行动点上限: 3,
    });

    // 资源系统
    this.资源系统 = new 资源系统(this.事件总线);
    this.资源系统.注册资源类型('母乳', {
      初始值: 0,
      最小值: 0,
      描述: '母畜产出的母乳，用于黑市交易',
    });

    // 战斗系统
    this.战斗系统 = new 战斗系统(this.事件总线, this.公式引擎);

    // 任务系统（需要任务注册表）
    this.任务系统 = new 任务系统(this.事件总线, this.任务注册表, this.时间系统, this.公式引擎);

    // 繁殖系统（需要冠军工厂和喽啰池，稍后绑定）
    this.繁殖系统 = new 繁殖系统(this.事件总线, this.工厂管理器.获取冠军工厂(), null, this.属性注册表);

    // 法术系统
    this.法术系统 = new 法术系统(this.事件总线, this.法术注册表, null);

    // 黑市系统
    this.黑市系统 = new 黑市系统(this.事件总线, this.商品注册表, this.资源系统);
  }

  注入系统依赖() {
    // 任务注册表注入系统依赖
    this.任务注册表.注入系统依赖({
      事件总线: this.事件总线,
      公式引擎: this.公式引擎,
      属性注册表: this.属性注册表,
      繁殖系统: this.繁殖系统,
      资源系统: this.资源系统,
      母畜工厂: this.工厂管理器.获取母畜工厂(),
    });
  }

  注册周结算处理器() {
    // 资源产出（泌乳）
    this.时间系统.注册周结算处理器(游戏状态 => {
      if (!游戏状态) return null;

      // 泌乳产出
      let 总泌乳量 = 0;
      const 泌乳母畜 = 游戏状态.获取泌乳状态母畜();

      泌乳母畜.forEach(母畜 => {
        const 产量 = this.公式引擎.计算('泌乳产量', {
          淫乱度: 母畜.获取属性('淫乱度'),
        });
        总泌乳量 += 产量;

        // 泌乳增加淫乱度
        母畜.修改属性('淫乱度', 3, this.属性注册表);
      });

      if (总泌乳量 > 0) {
        this.资源系统.增加资源('母乳', 总泌乳量, '周结算泌乳');
      }

      return {
        类型: '泌乳产出',
        泌乳母畜数: 泌乳母畜.length,
        总产量: 总泌乳量,
      };
    }, 100);

    // 士气衰减
    this.时间系统.注册周结算处理器(游戏状态 => {
      if (!游戏状态) return null;

      const 旧士气 = 游戏状态.获取士气();
      游戏状态.修改士气(-5);

      return {
        类型: '士气衰减',
        旧士气,
        新士气: 游戏状态.获取士气(),
        衰减量: 5,
      };
    }, 50);

    // 任务系统周重置
    this.时间系统.注册周结算处理器(() => {
      return this.任务系统.周结算处理();
    }, 30);

    // 自动保存
    this.时间系统.注册周结算处理器(游戏状态 => {
      if (!this.配置.自动保存) return null;

      if (this.时间系统.当前周次 % this.配置.自动保存间隔 === 0) {
        this.自动保存();
        return { 类型: '自动保存' };
      }
      return null;
    }, 10);

    // 新周处理：刷新黑市
    this.时间系统.注册新周处理器(游戏状态 => {
      const 刷新结果 = this.黑市系统.刷新商品(this.时间系统.当前周次, { 游戏状态 });

      this.法术系统.设置当前周次(this.时间系统.当前周次);
    }, 100);
  }

  // ═══════════════════════════════════════════════════════════════
  // 游戏生命周期
  // ═══════════════════════════════════════════════════════════════

  创建新游戏(配置 = {}) {
    /**
     * 创建新游戏
     */
    if (!this.已初始化) {
      this.初始化();
    }

    // 创建游戏状态
    this.游戏状态 = 游戏状态.创建新游戏({
      游戏版本: this.配置.游戏版本,
      存档名称: 配置.存档名称 ?? '新游戏',
      领主姓名: 配置.领主姓名,
      初始魔力: 配置.初始魔力 ?? 0,
      初始喽啰数量: 配置.初始喽啰数量 ?? 50,
      ...配置,
    });

    // 绑定游戏状态到各系统
    this.绑定游戏状态();

    // 发布新游戏事件
    this.事件总线.发布('新游戏开始', {
      存档名称: this.游戏状态.元数据.存档名称,
    });

    // 刷新首周黑市
    this.黑市系统.刷新商品(1, { 游戏状态: this.游戏状态 });

    this.游戏运行中 = true;

    // 执行插件钩子
    this.执行插件钩子('新游戏开始', { 游戏状态: this.游戏状态 });

    return this.游戏状态;
  }

  // ═══════════════════════════════════════════════════════════════
  // 游戏流程控制
  // ═══════════════════════════════════════════════════════════════

  结束当前周() {
    /**
     * 结束当前周，触发周结算
     */
    if (!this.游戏运行中) {
      return { 成功: false, 原因: '游戏未运行' };
    }

    // 执行插件钩子
    this.执行插件钩子('周结算前', {
      周次: this.时间系统.当前周次,
    });

    const 结果 = this.时间系统.结束当前周(this.游戏状态);

    // 执行插件钩子
    this.执行插件钩子('周结算后', {
      周次: this.时间系统.当前周次,
      结果,
    });

    return 结果;
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 游戏控制器 };
export default 游戏控制器;
