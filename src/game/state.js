// ═══════════════════════════════════════════════════════════════
// game/state.js
// 游戏状态 - 管理所有游戏实体和全局状态
// ═══════════════════════════════════════════════════════════════

import { 领主实体, 冠军实体, 母畜实体, 喽啰池 } from '../core/entities.js';

/**
 * 游戏状态
 * 集中管理所有游戏实体和全局状态数据
 */
class 游戏状态 {
  constructor(配置 = {}) {
    // ─── 核心实体 ───
    this.领主 = null;
    this.冠军列表 = new Map();
    this.母畜列表 = new Map();
    this.喽啰池 = new 喽啰池();

    // ─── 军队状态 ───
    this.军队状态 = {
      士气: 配置.初始士气 ?? 50,
      战斗力基础值: 配置.初始战斗力 ?? 100,
      士气上限: 100,
      士气下限: 0,
    };

    // ─── 全局变量 ───
    this.全局变量 = new Map();

    // ─── 游戏标记 ───
    this.游戏标记 = new Set();

    // ─── 统计数据 ───
    this.统计数据 = {
      总生育冠军数: 0,
      总生育喽啰数: 0,
      总战斗次数: 0,
      总胜利次数: 0,
      总献祭母畜数: 0,
      总消耗母乳: 0,
      总获得魔力: 0,
    };

    // ─── 游戏进度 ───
    this.游戏进度 = {
      已完成事件: new Set(),
      已解锁功能: new Set(),
      已触发里程碑: new Set(),
    };

    // ─── 侦察目标列表 ───
    this.侦察目标列表 = [];

    // ─── 事件监听器 ───
    this.状态变更监听器 = [];

    // ─── 元数据 ───
    this.元数据 = {
      创建时间: Date.now(),
      最后保存时间: null,
      游戏版本: 配置.游戏版本 ?? '1.0.0',
      存档名称: 配置.存档名称 ?? '默认存档',
    };
  }

  // ═══════════════════════════════════════════════════════════════
  // 领主管理
  // ═══════════════════════════════════════════════════════════════

  设置领主(领主实体) {
    const 旧领主 = this.领主;
    this.领主 = 领主实体;
    this.触发状态变更('领主变更', { 旧领主, 新领主: 领主实体 });
  }

  获取领主() {
    return this.领主;
  }

  领主是否存在() {
    return this.领主 !== null;
  }

  // ═══════════════════════════════════════════════════════════════
  // 冠军管理
  // ═══════════════════════════════════════════════════════════════

  添加冠军(冠军实体) {
    if (!冠军实体) return false;

    // 检查是否已存在
    if (this.冠军列表.some(c => c.实体ID === 冠军实体.实体ID)) {
      console.warn(`冠军已存在: ${冠军实体.实体ID}`);
      return false;
    }

    this.冠军列表.set(冠军实体.实体ID, 冠军实体);
    this.统计数据.总生育冠军数++;

    this.触发状态变更('冠军添加', { 冠军: 冠军实体 });
    return true;
  }

  移除冠军(冠军ID) {
    const 索引 = this.冠军列表.findIndex(c => c.实体ID === 冠军ID);
    if (索引 === -1) return null;

    const 移除的冠军 = this.冠军列表.splice(索引, 1)[0];
    this.触发状态变更('冠军移除', { 冠军: 移除的冠军 });
    return 移除的冠军;
  }

  获取冠军(冠军ID) {
    return this.冠军列表.find(c => c.实体ID === 冠军ID) ?? null;
  }

  获取冠军通过姓名(姓名) {
    return this.冠军列表.find(c => c.获取属性('姓名') === 姓名) ?? null;
  }

  获取所有冠军() {
    return [...this.冠军列表];
  }

  获取可用冠军() {
    /**
     * 获取当前可执行任务的冠军（未负伤、未外出等）
     */
    return this.冠军列表.filter(c => c.是否可执行任务?.() ?? true);
  }

  获取可战斗冠军() {
    /**
     * 获取当前可参与战斗的冠军
     */
    return this.冠军列表.filter(c => c.是否可战斗?.() ?? true);
  }

  获取冠军数量() {
    return this.冠军列表.length;
  }

  // ─── 冠军查询 ───

  筛选冠军(条件函数) {
    /**
     * 根据条件筛选冠军
     * @param 条件函数 - (冠军) => boolean
     */
    return this.冠军列表.filter(条件函数);
  }

  按属性排序冠军(属性名, 降序 = true) {
    /**
     * 按指定属性排序冠军
     */
    return [...this.冠军列表].sort((a, b) => {
      const 值A = a.获取属性(属性名) ?? 0;
      const 值B = b.获取属性(属性名) ?? 0;
      return 降序 ? 值B - 值A : 值A - 值B;
    });
  }

  获取最强冠军(属性名 = '力量') {
    if (this.冠军列表.length === 0) return null;
    return this.按属性排序冠军(属性名, true)[0];
  }

  // ═══════════════════════════════════════════════════════════════
  // 母畜管理
  // ═══════════════════════════════════════════════════════════════

  // 在游戏状态类中添加/修改以下方法

  /**
   * 添加已捕获的母畜到母畜列表
   */
  添加捕获母畜(母畜实体) {
    if (!母畜实体.是否已捕获()) {
      console.warn('尝试添加未捕获状态的母畜');
      母畜实体.标记捕获(this.当前回合);
    }

    this.母畜列表.set(母畜实体.实体ID, 母畜实体);
    return 母畜实体.实体ID;
  }

  /**
   * 获取所有已捕获的母畜
   */
  获取所有母畜() {
    return [...this.母畜列表.values()];
  }

  /**
   * 获取指定母畜
   */
  获取母畜(母畜ID) {
    return this.母畜列表.get(母畜ID);
  }

  /**
   * 移除母畜
   */
  移除母畜(母畜ID) {
    return this.母畜列表.delete(母畜ID);
  }

  添加母畜(母畜实体) {
    if (!母畜实体) return false;

    // 检查是否已存在
    if (this.母畜列表.some(m => m.实体ID === 母畜实体.实体ID)) {
      console.warn(`母畜已存在: ${母畜实体.实体ID}`);
      return false;
    }

    this.母畜列表.set(母畜实体.实体ID, 母畜实体);
    this.触发状态变更('母畜添加', { 母畜: 母畜实体 });
    return true;
  }

  移除母畜(母畜ID) {
    const 索引 = this.母畜列表.findIndex(m => m.实体ID === 母畜ID);
    if (索引 === -1) return null;

    const 移除的母畜 = this.母畜列表.splice(索引, 1)[0];
    this.触发状态变更('母畜移除', { 母畜: 移除的母畜 });
    return 移除的母畜;
  }

  获取母畜(母畜ID) {
    return this.母畜列表.find(m => m.实体ID === 母畜ID) ?? null;
  }

  获取母畜通过姓名(姓名) {
    return this.母畜列表.find(m => m.获取属性('姓名') === 姓名) ?? null;
  }

  获取所有母畜() {
    return [...this.母畜列表];
  }

  获取母畜数量() {
    return this.母畜列表.length;
  }

  // ─── 母畜分类查询 ───

  获取繁殖状态母畜() {
    /**
     * 获取处于繁殖状态且有剩余价值的母畜
     */
    return this.母畜列表.filter(m =>
      m.拥有标签('繁殖状态') &&
      m.获取属性('剩余雌性价值') > 0
    );
  }

  获取可生育冠军母畜() {
    /**
     * 获取可以生育冠军的母畜
     */
    return this.母畜列表.filter(m =>
      m.获取属性('剩余雌性价值') >= 100
    );
  }

  获取可生育喽啰母畜() {
    /**
     * 获取可以生育喽啰的母畜
     */
    return this.母畜列表.filter(m =>
      m.获取属性('剩余雌性价值') > 0 &&
      m.获取属性('臣服度') >= 25
    );
  }

  获取泌乳状态母畜() {
    /**
     * 获取可以泌乳的母畜（淫乱度>=25）
     */
    return this.母畜列表.filter(m =>
      m.获取属性('淫乱度') >= 25
    );
  }

  获取可献祭母畜() {
    /**
     * 获取可以献祭的母畜（淫乱度>=100）
     */
    return this.母畜列表.filter(m =>
      m.获取属性('淫乱度') >= 100
    );
  }

  获取忠诚母畜() {
    /**
     * 获取忠诚期母畜（臣服度>=90）
     */
    return this.母畜列表.filter(m =>
      m.获取属性('臣服度') >= 90
    );
  }

  获取归心母畜() {
    /**
     * 获取归心期及以上母畜（臣服度>=75）
     */
    return this.母畜列表.filter(m =>
      m.获取属性('臣服度') >= 75
    );
  }

  筛选母畜(条件函数) {
    /**
     * 根据条件筛选母畜
     * @param 条件函数 - (母畜) => boolean
     */
    return this.母畜列表.filter(条件函数);
  }

  按属性排序母畜(属性名, 降序 = true) {
    /**
     * 按指定属性排序母畜
     */
    return [...this.母畜列表].sort((a, b) => {
      const 值A = a.获取属性(属性名) ?? 0;
      const 值B = b.获取属性(属性名) ?? 0;
      return 降序 ? 值B - 值A : 值A - 值B;
    });
  }

  按种族分组母畜() {
    /**
     * 按种族对母畜进行分组
     */
    const 分组 = new Map();
    this.母畜列表.forEach(母畜 => {
      const 种族 = 母畜.获取属性('种族') ?? '未知';
      if (!分组.has(种族)) {
        分组.set(种族, []);
      }
      分组.get(种族).push(母畜);
    });
    return 分组;
  }

  按身份分组母畜() {
    /**
     * 按原身份对母畜进行分组
     */
    const 分组 = new Map();
    this.母畜列表.forEach(母畜 => {
      const 身份 = 母畜.获取属性('原身份') ?? '未知';
      if (!分组.has(身份)) {
        分组.set(身份, []);
      }
      分组.get(身份).push(母畜);
    });
    return 分组;
  }

  // ═══════════════════════════════════════════════════════════════
  // 喽啰池管理
  // ═══════════════════════════════════════════════════════════════

  获取喽啰池() {
    return this.喽啰池;
  }

  设置喽啰池(喽啰池实例) {
    this.喽啰池 = 喽啰池实例;
  }

  获取喽啰总数() {
    return this.喽啰池.获取总数量();
  }

  增加喽啰(数量, 武装等级 = '未武装') {
    this.喽啰池.增加喽啰(数量, 武装等级);
    this.统计数据.总生育喽啰数 += 数量;
    this.触发状态变更('喽啰变化', { 变化: 数量, 武装等级 });
  }

  减少喽啰(数量, 武装等级 = '未武装') {
    const 结果 = this.喽啰池.减少喽啰(数量, 武装等级);
    if (结果.成功) {
      this.触发状态变更('喽啰变化', { 变化: -结果.实际减少, 武装等级 });
    }
    return 结果;
  }

  武装升级喽啰(数量, 从等级, 到等级) {
    return this.喽啰池.武装升级(数量, 从等级, 到等级);
  }

  // ═══════════════════════════════════════════════════════════════
  // 军队状态管理
  // ═══════════════════════════════════════════════════════════════

  获取士气() {
    return this.军队状态.士气;
  }

  设置士气(值) {
    const 旧值 = this.军队状态.士气;
    this.军队状态.士气 = Math.max(
      this.军队状态.士气下限,
      Math.min(this.军队状态.士气上限, 值)
    );
    this.触发状态变更('士气变化', { 旧值, 新值: this.军队状态.士气 });
  }

  修改士气(增量) {
    const 旧值 = this.军队状态.士气;
    this.设置士气(this.军队状态.士气 + 增量);
    return this.军队状态.士气 - 旧值; // 返回实际变化量
  }

  获取基础战斗力() {
    return this.军队状态.战斗力基础值;
  }

  设置基础战斗力(值) {
    this.军队状态.战斗力基础值 = Math.max(0, 值);
  }

  修改基础战斗力(增量) {
    this.军队状态.战斗力基础值 = Math.max(0, this.军队状态.战斗力基础值 + 增量);
    return this.军队状态.战斗力基础值;
  }

  获取军队状态() {
    return { ...this.军队状态 };
  }

  获取军队概览() {
    return {
      士气: this.军队状态.士气,
      基础战斗力: this.军队状态.战斗力基础值,
      冠军数量: this.冠军列表.length,
      可战斗冠军: this.获取可战斗冠军().length,
      喽啰总数: this.喽啰池.获取总数量(),
      喽啰分组: this.喽啰池.获取分组详情(),
      加权战斗力: this.喽啰池.计算加权战斗力(),
    };
  }

  // ═══════════════════════════════════════════════════════════════
  // 全局变量管理
  // ═══════════════════════════════════════════════════════════════

  设置全局变量(键, 值) {
    const 旧值 = this.全局变量.get(键);
    this.全局变量.set(键, 值);
    this.触发状态变更('全局变量变更', { 键, 旧值, 新值: 值 });
  }

  获取全局变量(键, 默认值 = null) {
    return this.全局变量.has(键) ? this.全局变量.get(键) : 默认值;
  }

  删除全局变量(键) {
    const 存在 = this.全局变量.has(键);
    this.全局变量.delete(键);
    return 存在;
  }

  获取所有全局变量() {
    return Object.fromEntries(this.全局变量);
  }

  批量设置全局变量(变量对象) {
    Object.entries(变量对象).forEach(([键, 值]) => {
      this.全局变量.set(键, 值);
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // 游戏标记管理
  // ═══════════════════════════════════════════════════════════════

  添加游戏标记(标记) {
    this.游戏标记.add(标记);
  }

  移除游戏标记(标记) {
    this.游戏标记.delete(标记);
  }

  拥有游戏标记(标记) {
    return this.游戏标记.has(标记);
  }

  获取所有游戏标记() {
    return Array.from(this.游戏标记);
  }

  // ═══════════════════════════════════════════════════════════════
  // 统计数据管理
  // ═══════════════════════════════════════════════════════════════

  获取统计数据() {
    return { ...this.统计数据 };
  }

  更新统计(统计项, 增量 = 1) {
    if (this.统计数据.hasOwnProperty(统计项)) {
      this.统计数据[统计项] += 增量;
    }
  }

  设置统计(统计项, 值) {
    if (this.统计数据.hasOwnProperty(统计项)) {
      this.统计数据[统计项] = 值;
    }
  }

  // ═══════════════════════════════════════════════════════════════
  // 游戏进度管理
  // ═══════════════════════════════════════════════════════════════

  标记事件完成(事件名) {
    this.游戏进度.已完成事件.add(事件名);
  }

  事件是否完成(事件名) {
    return this.游戏进度.已完成事件.has(事件名);
  }

  解锁功能(功能名) {
    this.游戏进度.已解锁功能.add(功能名);
    this.触发状态变更('功能解锁', { 功能名 });
  }

  功能是否解锁(功能名) {
    return this.游戏进度.已解锁功能.has(功能名);
  }

  触发里程碑(里程碑名) {
    if (!this.游戏进度.已触发里程碑.has(里程碑名)) {
      this.游戏进度.已触发里程碑.add(里程碑名);
      this.触发状态变更('里程碑达成', { 里程碑名 });
      return true;
    }
    return false;
  }

  里程碑是否触发(里程碑名) {
    return this.游戏进度.已触发里程碑.has(里程碑名);
  }

  获取游戏进度() {
    return {
      已完成事件: Array.from(this.游戏进度.已完成事件),
      已解锁功能: Array.from(this.游戏进度.已解锁功能),
      已触发里程碑: Array.from(this.游戏进度.已触发里程碑),
    };
  }

  // ═══════════════════════════════════════════════════════════════
  // 侦察目标管理
  // ═══════════════════════════════════════════════════════════════

  添加侦察目标(目标信息) {
    /**
     * 目标信息: { 目标ID, 名称, 位置, 预估战力, 潜在目标列表 }
     */
    this.侦察目标列表.push({
      ...目标信息,
      添加时间: Date.now(),
    });
    return 目标信息.目标ID;
  }

  移除侦察目标(目标ID) {
    const 索引 = this.侦察目标列表.findIndex(t => t.目标ID === 目标ID);
    if (索引 !== -1) {
      return this.侦察目标列表.splice(索引, 1)[0];
    }
    return null;
  }

  获取侦察目标(目标ID) {
    return this.侦察目标列表.find(t => t.目标ID === 目标ID) ?? null;
  }

  获取所有侦察目标() {
    return [...this.侦察目标列表];
  }

  // ═══════════════════════════════════════════════════════════════
  // 状态变更监听
  // ═══════════════════════════════════════════════════════════════

  添加状态变更监听器(监听器) {
    /**
     * 监听器签名: (变更类型, 数据) => void
     */
    this.状态变更监听器.push(监听器);
    return () => {
      const 索引 = this.状态变更监听器.indexOf(监听器);
      if (索引 !== -1) {
        this.状态变更监听器.splice(索引, 1);
      }
    };
  }

  触发状态变更(变更类型, 数据) {
    this.状态变更监听器.forEach(监听器 => {
      try {
        监听器(变更类型, 数据);
      } catch (错误) {
        console.error('状态变更监听器错误:', 错误);
      }
    });
  }

  // ═══════════════════════════════════════════════════════════════
  // 游戏概览
  // ═══════════════════════════════════════════════════════════════

  获取游戏概览() {
    return {
      // 领主
      领主姓名: this.领主?.获取属性('姓名') ?? '未设置',
      魔力: this.领主?.获取属性('魔力') ?? 0,
      最大魔力: this.领主?.获取属性('最大魔力') ?? 100,

      // 实体数量
      冠军数量: this.冠军列表.length,
      母畜数量: this.母畜列表.length,
      喽啰总数: this.喽啰池.获取总数量(),

      // 军队
      士气: this.军队状态.士气,
      基础战斗力: this.军队状态.战斗力基础值,

      // 统计
      统计: { ...this.统计数据 },

      // 元数据
      存档名称: this.元数据.存档名称,
      游戏版本: this.元数据.游戏版本,
    };
  }

  获取详细状态() {
    return {
      概览: this.获取游戏概览(),
      冠军列表: this.冠军列表.map(c => ({
        ID: c.实体ID,
        姓名: c.获取属性('姓名'),
        力量: c.获取属性('力量'),
        敏捷: c.获取属性('敏捷'),
        智力: c.获取属性('智力'),
        标签: c.获取所有标签(),
      })),
      母畜列表: this.母畜列表.map(m => ({
        ID: m.实体ID,
        姓名: m.获取属性('姓名'),
        原身份: m.获取属性('原身份'),
        种族: m.获取属性('种族'),
        总雌性价值: m.获取属性('总雌性价值'),
        剩余雌性价值: m.获取属性('剩余雌性价值'),
        臣服度: m.获取属性('臣服度'),
        淫乱度: m.获取属性('淫乱度'),
        标签: m.获取所有标签(),
      })),
      喽啰详情: this.喽啰池.获取分组详情(),
      军队状态: this.军队状态,
      侦察目标: this.侦察目标列表,
      全局变量: this.获取所有全局变量(),
      游戏标记: this.获取所有游戏标记(),
      游戏进度: this.获取游戏进度(),
    };
  }

  // ═══════════════════════════════════════════════════════════════
  // 验证与检查
  // ═══════════════════════════════════════════════════════════════

  验证状态完整性() {
    /**
     * 验证游戏状态的完整性
     * @returns { 有效: boolean, 问题列表: string[] }
     */
    const 问题列表 = [];

    // 检查领主
    if (!this.领主) {
      问题列表.push('领主未设置');
    }

    // 检查冠军ID唯一性
    const 冠军ID集合 = new Set();
    this.冠军列表.forEach(c => {
      if (冠军ID集合.has(c.实体ID)) {
        问题列表.push(`重复的冠军ID: ${c.实体ID}`);
      }
      冠军ID集合.add(c.实体ID);
    });

    // 检查母畜ID唯一性
    const 母畜ID集合 = new Set();
    this.母畜列表.forEach(m => {
      if (母畜ID集合.has(m.实体ID)) {
        问题列表.push(`重复的母畜ID: ${m.实体ID}`);
      }
      母畜ID集合.add(m.实体ID);
    });

    // 检查母畜属性有效性
    this.母畜列表.forEach(m => {
      const 剩余 = m.获取属性('剩余雌性价值');
      const 总量 = m.获取属性('总雌性价值');
      if (剩余 > 总量) {
        问题列表.push(`母畜 ${m.实体ID} 剩余价值超过总价值`);
      }
      if (m.获取属性('臣服度') < 0 || m.获取属性('臣服度') > 100) {
        问题列表.push(`母畜 ${m.实体ID} 臣服度超出范围`);
      }
      if (m.获取属性('淫乱度') < 0 || m.获取属性('淫乱度') > 100) {
        问题列表.push(`母畜 ${m.实体ID} 淫乱度超出范围`);
      }
    });

    // 检查士气范围
    if (this.军队状态.士气 < 0 || this.军队状态.士气 > 100) {
      问题列表.push('士气超出有效范围');
    }

    return {
      有效: 问题列表.length === 0,
      问题列表,
    };
  }

  修复状态问题() {
    /**
     * 尝试修复状态中的问题
     */
    const 修复记录 = [];

    // 修复士气范围
    if (this.军队状态.士气 < 0) {
      this.军队状态.士气 = 0;
      修复记录.push('士气修复为0');
    }
    if (this.军队状态.士气 > 100) {
      this.军队状态.士气 = 100;
      修复记录.push('士气修复为100');
    }

    // 修复母畜属性范围
    this.母畜列表.forEach(m => {
      const 剩余 = m.获取属性('剩余雌性价值');
      const 总量 = m.获取属性('总雌性价值');

      if (剩余 > 总量) {
        m.设置属性('剩余雌性价值', 总量);
        修复记录.push(`修复母畜 ${m.实体ID} 剩余价值`);
      }

      let 臣服度 = m.获取属性('臣服度');
      if (臣服度 < 0) {
        m.设置属性('臣服度', 0);
        修复记录.push(`修复母畜 ${m.实体ID} 臣服度下限`);
      }
      if (臣服度 > 100) {
        m.设置属性('臣服度', 100);
        修复记录.push(`修复母畜 ${m.实体ID} 臣服度上限`);
      }

      let 淫乱度 = m.获取属性('淫乱度');
      if (淫乱度 < 0) {
        m.设置属性('淫乱度', 0);
        修复记录.push(`修复母畜 ${m.实体ID} 淫乱度下限`);
      }
      if (淫乱度 > 100) {
        m.设置属性('淫乱度', 100);
        修复记录.push(`修复母畜 ${m.实体ID} 淫乱度上限`);
      }
    });

    return 修复记录;
  }

  // ═══════════════════════════════════════════════════════════════
  // 重置与清理
  // ═══════════════════════════════════════════════════════════════

  重置游戏状态() {
    /**
     * 完全重置游戏状态
     */
    this.领主 = null;
    this.冠军列表 = [];
    this.母畜列表 = [];
    this.喽啰池 = new 喽啰池();

    this.军队状态 = {
      士气: 50,
      战斗力基础值: 100,
      士气上限: 100,
      士气下限: 0,
    };

    this.全局变量.clear();
    this.游戏标记.clear();
    this.侦察目标列表 = [];

    this.统计数据 = {
      总生育冠军数: 0,
      总生育喽啰数: 0,
      总战斗次数: 0,
      总胜利次数: 0,
      总献祭母畜数: 0,
      总消耗母乳: 0,
      总获得魔力: 0,
    };

    this.游戏进度 = {
      已完成事件: new Set(),
      已解锁功能: new Set(),
      已触发里程碑: new Set(),
    };

    this.元数据.创建时间 = Date.now();
    this.元数据.最后保存时间 = null;

    this.触发状态变更('游戏重置', {});
  }

  // ═══════════════════════════════════════════════════════════════
  // 序列化与反序列化
  // ═══════════════════════════════════════════════════════════════

  序列化() {
    /**
     * 将游戏状态序列化为可存储的对象
     */
    this.元数据.最后保存时间 = Date.now();

    return {
      版本: this.元数据.游戏版本,
      元数据: { ...this.元数据 },

      领主: this.领主?.序列化() ?? null,
      冠军列表: this.冠军列表.map(c => c.序列化()),
      母畜列表: this.母畜列表.map(m => m.序列化()),
      喽啰池: this.喽啰池.序列化(),

      军队状态: { ...this.军队状态 },
      全局变量: Object.fromEntries(this.全局变量),
      游戏标记: Array.from(this.游戏标记),
      统计数据: { ...this.统计数据 },
      侦察目标列表: this.侦察目标列表,

      游戏进度: {
        已完成事件: Array.from(this.游戏进度.已完成事件),
        已解锁功能: Array.from(this.游戏进度.已解锁功能),
        已触发里程碑: Array.from(this.游戏进度.已触发里程碑),
      },
    };
  }

  从序列化恢复(数据) {
    /**
     * 从序列化数据恢复游戏状态
     */
    if (!数据) {
      throw new Error('无效的存档数据');
    }

    // 版本检查
    if (数据.版本 && 数据.版本 !== this.元数据.游戏版本) {
      console.warn(`存档版本不匹配: ${数据.版本} vs ${this.元数据.游戏版本}`);
      // 可在此处添加版本迁移逻辑
    }

    // 恢复元数据
    if (数据.元数据) {
      Object.assign(this.元数据, 数据.元数据);
    }

    // 恢复领主
    if (数据.领主) {
      this.领主 = 领主实体.从序列化恢复(数据.领主);
    }

    // 恢复冠军列表
    this.冠军列表 = (数据.冠军列表 ?? []).map(数据 =>
      冠军实体.从序列化恢复(数据)
    );

    // 恢复母畜列表
    this.母畜列表 = (数据.母畜列表 ?? []).map(数据 =>
      母畜实体.从序列化恢复(数据)
    );

    // 恢复喽啰池
    if (数据.喽啰池) {
      this.喽啰池 = 喽啰池.从序列化恢复(数据.喽啰池);
    }

    // 恢复军队状态
    if (数据.军队状态) {
      Object.assign(this.军队状态, 数据.军队状态);
    }

    // 恢复全局变量
    this.全局变量.clear();
    if (数据.全局变量) {
      Object.entries(数据.全局变量).forEach(([键, 值]) => {
        this.全局变量.set(键, 值);
      });
    }

    // 恢复游戏标记
    this.游戏标记.clear();
    if (数据.游戏标记) {
      数据.游戏标记.forEach(标记 => this.游戏标记.add(标记));
    }

    // 恢复统计数据
    if (数据.统计数据) {
      Object.assign(this.统计数据, 数据.统计数据);
    }

    // 恢复侦察目标
    this.侦察目标列表 = 数据.侦察目标列表 ?? [];

    // 恢复游戏进度
    if (数据.游戏进度) {
      this.游戏进度.已完成事件 = new Set(数据.游戏进度.已完成事件 ?? []);
      this.游戏进度.已解锁功能 = new Set(数据.游戏进度.已解锁功能 ?? []);
      this.游戏进度.已触发里程碑 = new Set(数据.游戏进度.已触发里程碑 ?? []);
    }

    this.触发状态变更('存档加载', { 版本: 数据.版本 });
  }

  // ═══════════════════════════════════════════════════════════════
  // 静态工厂方法
  // ═══════════════════════════════════════════════════════════════

  static 创建新游戏(配置 = {}) {
    /**
     * 创建新游戏状态的工厂方法
     */
    const 状态 = new 游戏状态(配置);

    // 创建默认领主
    const 领主 = new 领主实体({
      姓名: 配置.领主姓名 ?? '无名领主',
      魔力: 配置.初始魔力 ?? 0,
      最大魔力: 配置.最大魔力 ?? 100,
    });
    状态.设置领主(领主);

    // 初始化默认喽啰武装等级
    状态.喽啰池.注册武装等级('低级武装', { 战斗力: 110 });
    状态.喽啰池.注册武装等级('中级武装', { 战斗力: 130 });
    状态.喽啰池.注册武装等级('高级武装', { 战斗力: 180 });
    状态.喽啰池.注册武装等级('精英武装', { 战斗力: 250 });

    // 添加初始喽啰
    if (配置.初始喽啰数量) {
      状态.喽啰池.增加喽啰(配置.初始喽啰数量);
    }

    return 状态;
  }

  static 从存档加载(存档数据, 配置 = {}) {
    /**
     * 从存档数据加载游戏状态
     */
    const 状态 = new 游戏状态(配置);
    状态.从序列化恢复(存档数据);
    return 状态;
  }
}

// ═══════════════════════════════════════════════════════════════
// 导出
// ═══════════════════════════════════════════════════════════════

export { 游戏状态 };
export default 游戏状态;
